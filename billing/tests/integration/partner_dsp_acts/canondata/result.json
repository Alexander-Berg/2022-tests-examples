{
    "test_dsp_income_acting.test_dsp_income_acting[firm_1/RUB]": {
        "next_unacted_rows_path": [
            {
                "act_effective_nds_pct": 20.0,
                "act_effective_tax_policy_pct_mdh_id": "91f77dca-81d8-4f6e-b3d1-04fa78ce6b50",
                "act_row_id": "6",
                "act_sum": 6.0,
                "act_sum_wo_nds": 6.0,
                "client_id": 3,
                "contract_id": 4,
                "currency": "RUB",
                "events_currency": "RUB",
                "events_month_dt": "2020-09-01T00:00:00+0300",
                "events_sum": 5.0,
                "mdh_product_id": "3",
                "tariffer_service_id": 80,
                "tax_policy_mdh_id": "93fb537f-e424-49b6-8b3a-b735f9164708"
            }
        ],
        "output_acted_rows_path": [
            {
                "ContractStateData": {
                    "uri": "file://test_dsp_income_acting.test_dsp_income_acting_firm_1_RUB_/extracted"
                },
                "act_effective_nds_pct": 20.0,
                "act_effective_tax_policy_pct_mdh_id": "91f77dca-81d8-4f6e-b3d1-04fa78ce6b50",
                "act_finish_dt": "2020-10-31 00:00:00",
                "act_row_id": "1",
                "act_start_dt": "2020-10-01 00:00:00",
                "act_sum": 6.0,
                "act_sum_wo_nds": 6.0,
                "client_id": 1,
                "contract_id": 1,
                "currency": "RUB",
                "events_currency": "RUB",
                "events_month_dt": "2020-09-01T00:00:00+0300",
                "events_sum": 5.0,
                "mdh_product_id": "1",
                "tariffer_service_id": 80,
                "tax_policy_mdh_id": "93fb537f-e424-49b6-8b3a-b735f9164708"
            },
            {
                "ContractStateData": {
                    "uri": "file://test_dsp_income_acting.test_dsp_income_acting_firm_1_RUB_/extracted.0"
                },
                "act_effective_nds_pct": 20.0,
                "act_effective_tax_policy_pct_mdh_id": "91f77dca-81d8-4f6e-b3d1-04fa78ce6b50",
                "act_finish_dt": "2020-10-31 00:00:00",
                "act_row_id": "2",
                "act_start_dt": "2020-10-01 00:00:00",
                "act_sum": 6.0,
                "act_sum_wo_nds": 6.0,
                "client_id": 2,
                "contract_id": 2,
                "currency": "RUB",
                "events_currency": "RUB",
                "events_month_dt": "2020-09-01T00:00:00+0300",
                "events_sum": 5.0,
                "mdh_product_id": "2",
                "tariffer_service_id": 80,
                "tax_policy_mdh_id": "93fb537f-e424-49b6-8b3a-b735f9164708"
            },
            {
                "ContractStateData": {
                    "uri": "file://test_dsp_income_acting.test_dsp_income_acting_firm_1_RUB_/extracted.1"
                },
                "act_effective_nds_pct": 20.0,
                "act_effective_tax_policy_pct_mdh_id": "91f77dca-81d8-4f6e-b3d1-04fa78ce6b50",
                "act_finish_dt": "2020-10-31 00:00:00",
                "act_row_id": "3",
                "act_start_dt": "2020-10-01 00:00:00",
                "act_sum": 3.0,
                "act_sum_wo_nds": 3.0,
                "client_id": 1,
                "contract_id": 1,
                "currency": "RUB",
                "events_currency": "RUB",
                "events_month_dt": "2020-08-01T00:00:00+0300",
                "events_sum": 2.0,
                "mdh_product_id": "1",
                "tariffer_service_id": 80,
                "tax_policy_mdh_id": "93fb537f-e424-49b6-8b3a-b735f9164708"
            },
            {
                "ContractStateData": {
                    "uri": "file://test_dsp_income_acting.test_dsp_income_acting_firm_1_RUB_/extracted.2"
                },
                "act_effective_nds_pct": 20.0,
                "act_effective_tax_policy_pct_mdh_id": "91f77dca-81d8-4f6e-b3d1-04fa78ce6b50",
                "act_finish_dt": "2020-10-31 00:00:00",
                "act_row_id": "4",
                "act_start_dt": "2020-10-01 00:00:00",
                "act_sum": 3.0,
                "act_sum_wo_nds": 3.0,
                "client_id": 2,
                "contract_id": 2,
                "currency": "RUB",
                "events_currency": "RUB",
                "events_month_dt": "2020-08-01T00:00:00+0300",
                "events_sum": 2.0,
                "mdh_product_id": "2",
                "tariffer_service_id": 80,
                "tax_policy_mdh_id": "93fb537f-e424-49b6-8b3a-b735f9164708"
            },
            {
                "ContractStateData": {
                    "uri": "file://test_dsp_income_acting.test_dsp_income_acting_firm_1_RUB_/extracted.3"
                },
                "act_effective_nds_pct": 20.0,
                "act_effective_tax_policy_pct_mdh_id": "91f77dca-81d8-4f6e-b3d1-04fa78ce6b50",
                "act_finish_dt": "2020-10-31 00:00:00",
                "act_row_id": "5",
                "act_start_dt": "2020-10-01 00:00:00",
                "act_sum": 6.0,
                "act_sum_wo_nds": 6.0,
                "client_id": 1,
                "contract_id": 3,
                "currency": "RUB",
                "events_currency": "RUB",
                "events_month_dt": "2020-09-01T00:00:00+0300",
                "events_sum": 5.0,
                "mdh_product_id": "1",
                "tariffer_service_id": 80,
                "tax_policy_mdh_id": "93fb537f-e424-49b6-8b3a-b735f9164708"
            }
        ]
    },
    "test_dsp_income_acting.test_dsp_income_acting[firm_4/USD]": {
        "next_unacted_rows_path": [
            {
                "act_effective_nds_pct": 0.0,
                "act_effective_tax_policy_pct_mdh_id": "0afe9d15-202e-4498-af61-423d92ad5782",
                "act_row_id": "6",
                "act_sum": 5.0,
                "act_sum_wo_nds": 5.0,
                "client_id": 3,
                "contract_id": 4,
                "currency": "USD",
                "events_currency": "USD",
                "events_month_dt": "2020-09-01T00:00:00+0300",
                "events_sum": 5.0,
                "mdh_product_id": "3",
                "tariffer_service_id": 80,
                "tax_policy_mdh_id": "87561f18-5f5b-46d8-8c3d-a82d4a06ebab"
            }
        ],
        "output_acted_rows_path": [
            {
                "ContractStateData": {
                    "uri": "file://test_dsp_income_acting.test_dsp_income_acting_firm_4_USD_/extracted"
                },
                "act_effective_nds_pct": 0.0,
                "act_effective_tax_policy_pct_mdh_id": "0afe9d15-202e-4498-af61-423d92ad5782",
                "act_finish_dt": "2020-10-31 00:00:00",
                "act_row_id": "1",
                "act_start_dt": "2020-10-01 00:00:00",
                "act_sum": 5.0,
                "act_sum_wo_nds": 5.0,
                "client_id": 1,
                "contract_id": 1,
                "currency": "USD",
                "events_currency": "USD",
                "events_month_dt": "2020-09-01T00:00:00+0300",
                "events_sum": 5.0,
                "mdh_product_id": "1",
                "tariffer_service_id": 80,
                "tax_policy_mdh_id": "87561f18-5f5b-46d8-8c3d-a82d4a06ebab"
            },
            {
                "ContractStateData": {
                    "uri": "file://test_dsp_income_acting.test_dsp_income_acting_firm_4_USD_/extracted.0"
                },
                "act_effective_nds_pct": 0.0,
                "act_effective_tax_policy_pct_mdh_id": "0afe9d15-202e-4498-af61-423d92ad5782",
                "act_finish_dt": "2020-10-31 00:00:00",
                "act_row_id": "2",
                "act_start_dt": "2020-10-01 00:00:00",
                "act_sum": 5.0,
                "act_sum_wo_nds": 5.0,
                "client_id": 2,
                "contract_id": 2,
                "currency": "USD",
                "events_currency": "USD",
                "events_month_dt": "2020-09-01T00:00:00+0300",
                "events_sum": 5.0,
                "mdh_product_id": "2",
                "tariffer_service_id": 80,
                "tax_policy_mdh_id": "87561f18-5f5b-46d8-8c3d-a82d4a06ebab"
            },
            {
                "ContractStateData": {
                    "uri": "file://test_dsp_income_acting.test_dsp_income_acting_firm_4_USD_/extracted.1"
                },
                "act_effective_nds_pct": 0.0,
                "act_effective_tax_policy_pct_mdh_id": "0afe9d15-202e-4498-af61-423d92ad5782",
                "act_finish_dt": "2020-10-31 00:00:00",
                "act_row_id": "3",
                "act_start_dt": "2020-10-01 00:00:00",
                "act_sum": 2.0,
                "act_sum_wo_nds": 2.0,
                "client_id": 1,
                "contract_id": 1,
                "currency": "USD",
                "events_currency": "USD",
                "events_month_dt": "2020-08-01T00:00:00+0300",
                "events_sum": 2.0,
                "mdh_product_id": "1",
                "tariffer_service_id": 80,
                "tax_policy_mdh_id": "87561f18-5f5b-46d8-8c3d-a82d4a06ebab"
            },
            {
                "ContractStateData": {
                    "uri": "file://test_dsp_income_acting.test_dsp_income_acting_firm_4_USD_/extracted.2"
                },
                "act_effective_nds_pct": 0.0,
                "act_effective_tax_policy_pct_mdh_id": "0afe9d15-202e-4498-af61-423d92ad5782",
                "act_finish_dt": "2020-10-31 00:00:00",
                "act_row_id": "4",
                "act_start_dt": "2020-10-01 00:00:00",
                "act_sum": 2.0,
                "act_sum_wo_nds": 2.0,
                "client_id": 2,
                "contract_id": 2,
                "currency": "USD",
                "events_currency": "USD",
                "events_month_dt": "2020-08-01T00:00:00+0300",
                "events_sum": 2.0,
                "mdh_product_id": "2",
                "tariffer_service_id": 80,
                "tax_policy_mdh_id": "87561f18-5f5b-46d8-8c3d-a82d4a06ebab"
            },
            {
                "ContractStateData": {
                    "uri": "file://test_dsp_income_acting.test_dsp_income_acting_firm_4_USD_/extracted.3"
                },
                "act_effective_nds_pct": 0.0,
                "act_effective_tax_policy_pct_mdh_id": "0afe9d15-202e-4498-af61-423d92ad5782",
                "act_finish_dt": "2020-10-31 00:00:00",
                "act_row_id": "5",
                "act_start_dt": "2020-10-01 00:00:00",
                "act_sum": 5.0,
                "act_sum_wo_nds": 5.0,
                "client_id": 1,
                "contract_id": 3,
                "currency": "USD",
                "events_currency": "USD",
                "events_month_dt": "2020-09-01T00:00:00+0300",
                "events_sum": 5.0,
                "mdh_product_id": "1",
                "tariffer_service_id": 80,
                "tax_policy_mdh_id": "87561f18-5f5b-46d8-8c3d-a82d4a06ebab"
            }
        ]
    },
    "test_dsp_income_group_rows.test_dsp_income_group_rows": {
        "next_unacted_events": [
            {
                "Amount": 0.1,
                "AmountCurrency": "RUB",
                "AmountWithoutNDS": 0.1,
                "BillableAmount": 0.01,
                "BillableAmountCurrency": "RUB",
                "BillableEventType": null,
                "ClientID": 1,
                "ContractID": 1,
                "ContractObject": null,
                "CostCur": null,
                "CurrencyRate": 1.0,
                "CurrencyRateDate": 1599771600,
                "DSPID": null,
                "EventCostVATCorrected": null,
                "EventDate": 1605042000,
                "EventTime": null,
                "FakePrice": null,
                "ImpID": null,
                "LBMessageUID": "5",
                "OutputStatus": "tariffed",
                "PageID": null,
                "PartnerCost": null,
                "PartnerPrice": null,
                "PartnerStatID": null,
                "PlaceID": null,
                "Price": null,
                "ProductID": 2,
                "ProductMdhID": "2",
                "TaxPolicyID": 1,
                "TaxPolicyMdhID": "93fb537f-e424-49b6-8b3a-b735f9164708",
                "TaxPolicyPercentID": 281,
                "TaxPolicyPercentMdhID": "91f77dca-81d8-4f6e-b3d1-04fa78ce6b50",
                "TypeID": null,
                "UnixTime": null,
                "YandexPrice": null,
                "_chunk_record_index": null,
                "_offset": null,
                "_partition": null,
                "_topic": null,
                "_topic_cluster": null
            }
        ],
        "output_prepared_rows": [
            {
                "act_effective_nds_pct": 20.0,
                "act_effective_tax_policy_pct_mdh_id": "91f77dca-81d8-4f6e-b3d1-04fa78ce6b50",
                "act_row_id": "2020-09-01T00:00:00+0300@1@1@80@RUB@2@RUB@1",
                "act_sum": 0.12,
                "act_sum_wo_nds": 0.1,
                "client_id": 1,
                "contract_id": 1,
                "currency": "RUB",
                "events_currency": "RUB",
                "events_month_dt": "2020-09-01T00:00:00+0300",
                "events_sum": 0.01,
                "mdh_product_id": "2",
                "tariffer_service_id": 80,
                "tax_policy_mdh_id": "93fb537f-e424-49b6-8b3a-b735f9164708"
            },
            {
                "act_effective_nds_pct": 20.0,
                "act_effective_tax_policy_pct_mdh_id": "91f77dca-81d8-4f6e-b3d1-04fa78ce6b50",
                "act_row_id": "2020-10-01T00:00:00+0300@1@1@80@RUB@2@RUB@1",
                "act_sum": 0.48,
                "act_sum_wo_nds": 0.4,
                "client_id": 1,
                "contract_id": 1,
                "currency": "RUB",
                "events_currency": "RUB",
                "events_month_dt": "2020-10-01T00:00:00+0300",
                "events_sum": 0.3,
                "mdh_product_id": "2",
                "tariffer_service_id": 80,
                "tax_policy_mdh_id": "93fb537f-e424-49b6-8b3a-b735f9164708"
            },
            {
                "act_effective_nds_pct": 20.0,
                "act_effective_tax_policy_pct_mdh_id": "91f77dca-81d8-4f6e-b3d1-04fa78ce6b50",
                "act_row_id": "2020-10-01T00:00:00+0300@2@2@80@RUB@2@RUB@1",
                "act_sum": 0.48,
                "act_sum_wo_nds": 0.4,
                "client_id": 2,
                "contract_id": 2,
                "currency": "RUB",
                "events_currency": "RUB",
                "events_month_dt": "2020-10-01T00:00:00+0300",
                "events_sum": 0.3,
                "mdh_product_id": "2",
                "tariffer_service_id": 80,
                "tax_policy_mdh_id": "93fb537f-e424-49b6-8b3a-b735f9164708"
            }
        ],
        "output_reverse_events_index": [
            {
                "ActRowID": "2020-10-01T00:00:00+0300@1@1@80@RUB@2@RUB@1",
                "LBMessageUID": "1"
            },
            {
                "ActRowID": "2020-10-01T00:00:00+0300@1@1@80@RUB@2@RUB@1",
                "LBMessageUID": "2"
            },
            {
                "ActRowID": "2020-10-01T00:00:00+0300@1@1@80@RUB@2@RUB@1",
                "LBMessageUID": "3"
            },
            {
                "ActRowID": "2020-09-01T00:00:00+0300@1@1@80@RUB@2@RUB@1",
                "LBMessageUID": "4"
            },
            {
                "ActRowID": "2020-10-01T00:00:00+0300@2@2@80@RUB@2@RUB@1",
                "LBMessageUID": "6"
            },
            {
                "ActRowID": "2020-10-01T00:00:00+0300@2@2@80@RUB@2@RUB@1",
                "LBMessageUID": "7"
            },
            {
                "ActRowID": "2020-10-01T00:00:00+0300@2@2@80@RUB@2@RUB@1",
                "LBMessageUID": "8"
            }
        ]
    },
    "test_generate_act_meta.test_generate_act_meta": {
        "log_no_meta_when_not_acted": [
            [
                "generate_act_meta",
                20,
                "Last generated interval hasn't been processed yet"
            ]
        ],
        "new_meta_07": {
            "act_dt": "2020-07-31",
            "drop_events_after_month_day": 2,
            "log_interval": {
                "topics": [
                    {
                        "cluster": "c1",
                        "partitions": [
                            {
                                "first_offset": 1,
                                "next_offset": 3,
                                "partition": 1
                            }
                        ],
                        "topic": "log"
                    }
                ]
            },
            "prev_run_id": "2020-06-30",
            "ref_contracts_interval": {
                "topics": [
                    {
                        "cluster": "c1",
                        "partitions": [
                            {
                                "first_offset": 0,
                                "next_offset": 2,
                                "partition": 1
                            }
                        ],
                        "topic": "contr"
                    }
                ]
            },
            "run_id": "2020-07-31",
            "tariffed_till_meta": {
                "log_interval": {
                    "topics": [
                        {
                            "cluster": "c1",
                            "partitions": [
                                {
                                    "first_offset": 1,
                                    "next_offset": 3,
                                    "partition": 1
                                }
                            ],
                            "topic": "log"
                        }
                    ]
                },
                "ref_contracts_interval": {
                    "topics": [
                        {
                            "cluster": "c1",
                            "partitions": [
                                {
                                    "first_offset": 0,
                                    "next_offset": 2,
                                    "partition": 1
                                }
                            ],
                            "topic": "contr"
                        }
                    ]
                },
                "run_id": "2020-08-03T11:00:00"
            }
        },
        "new_meta_08_shift_10": {
            "act_dt": "2020-08-31",
            "drop_events_after_month_day": 10,
            "log_interval": {
                "topics": [
                    {
                        "cluster": "c1",
                        "partitions": [
                            {
                                "first_offset": 3,
                                "next_offset": 7,
                                "partition": 1
                            }
                        ],
                        "topic": "log"
                    }
                ]
            },
            "prev_run_id": "2020-07-31",
            "ref_contracts_interval": {
                "topics": [
                    {
                        "cluster": "c1",
                        "partitions": [
                            {
                                "first_offset": 0,
                                "next_offset": 4,
                                "partition": 1
                            }
                        ],
                        "topic": "contr"
                    }
                ]
            },
            "run_id": "2020-08-31",
            "tariffed_till_meta": {
                "log_interval": {
                    "topics": [
                        {
                            "cluster": "c1",
                            "partitions": [
                                {
                                    "first_offset": 5,
                                    "next_offset": 7,
                                    "partition": 1
                                }
                            ],
                            "topic": "log"
                        }
                    ]
                },
                "ref_contracts_interval": {
                    "topics": [
                        {
                            "cluster": "c1",
                            "partitions": [
                                {
                                    "first_offset": 0,
                                    "next_offset": 4,
                                    "partition": 1
                                }
                            ],
                            "topic": "contr"
                        }
                    ]
                },
                "run_id": "2020-09-11T11:00:00"
            }
        },
        "new_meta_08_shift_2": {
            "act_dt": "2020-08-31",
            "drop_events_after_month_day": 2,
            "log_interval": {
                "topics": [
                    {
                        "cluster": "c1",
                        "partitions": [
                            {
                                "first_offset": 3,
                                "next_offset": 5,
                                "partition": 1
                            }
                        ],
                        "topic": "log"
                    }
                ]
            },
            "prev_run_id": "2020-07-31",
            "ref_contracts_interval": {
                "topics": [
                    {
                        "cluster": "c1",
                        "partitions": [
                            {
                                "first_offset": 0,
                                "next_offset": 3,
                                "partition": 1
                            }
                        ],
                        "topic": "contr"
                    }
                ]
            },
            "run_id": "2020-08-31",
            "tariffed_till_meta": {
                "log_interval": {
                    "topics": [
                        {
                            "cluster": "c1",
                            "partitions": [
                                {
                                    "first_offset": 3,
                                    "next_offset": 5,
                                    "partition": 1
                                }
                            ],
                            "topic": "log"
                        }
                    ]
                },
                "ref_contracts_interval": {
                    "topics": [
                        {
                            "cluster": "c1",
                            "partitions": [
                                {
                                    "first_offset": 0,
                                    "next_offset": 3,
                                    "partition": 1
                                }
                            ],
                            "topic": "contr"
                        }
                    ]
                },
                "run_id": "2020-09-03T11:00:00"
            }
        },
        "new_meta_09_error": "AssertionError('Not enough tariffed tables')",
        "no_meta_when_not_acted": null
    },
    "test_generate_act_meta.test_generate_act_meta_raw_log": {
        "act_dt": "2020-07-31",
        "drop_events_after_month_day": 1,
        "log_interval": {
            "topics": [
                {
                    "cluster": "c1",
                    "partitions": [
                        {
                            "first_offset": 1,
                            "next_offset": 3,
                            "partition": 1
                        }
                    ],
                    "topic": "log"
                }
            ]
        },
        "prev_run_id": "2020-06-30",
        "run_id": "2020-07-31",
        "tariffed_till_meta": {
            "log_interval": {
                "topics": [
                    {
                        "cluster": "c1",
                        "partitions": [
                            {
                                "first_offset": 1,
                                "next_offset": 3,
                                "partition": 1
                            }
                        ],
                        "topic": "log"
                    }
                ]
            }
        }
    }
}
