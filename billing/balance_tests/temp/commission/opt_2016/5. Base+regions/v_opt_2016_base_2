with
-- –æ–ø–æ—Ä–Ω—ã–µ –¥–∞—Ç—ã
s_dates as (
        -- –Ω–∞—á–∞–ª–æ —Ñ–∏–Ω. –≥–æ–¥–∞
    select date'2015-03-01'   as fin_year_dt
      from dual
),
s_base as (
select distinct
           c.contract_eid                             as contract_eid,
       -- BALANCE-21757, BALANCE-21758
       -- –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å, –∞–≤—Ç–æ: –¥–ª—è –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –≤ —Ñ–∏—Ä–º–µ 1
       -- –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä–∞ –∏–∑ –ë–Æ.
       -- —á–∞—Å—Ç—å –æ–±–æ—Ä–æ—Ç–æ–≤ "–≤–∏—Å—è—Ç" –Ω–∞ —Å—Ç–∞—Ä—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–∞—Ö (—Ñ–∏—Ä–º–∞ 1),
       -- —á–∞—Å—Ç—å –æ–±–æ—Ä–æ—Ç–æ–≤ ‚Äî –Ω–∞ –Ω–æ–≤—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–∞—Ö (—Ñ–∏—Ä–º—ã –±–∏–∑–Ω–µ—Å —é–Ω–∏—Ç–æ–≤).
       -- —ç—Ç–∏ –¥–æ–≥–æ–≤–æ—Ä—ã –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π external_id, –Ω–æ —Ä–∞–∑–Ω—ã–µ id.
       -- —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞–ª—Å—è –∫–æ–Ω—Ç—Ä–æ–ª—å –æ–±–æ—Ä–æ—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ id,
       -- –ø–æ–¥–º–µ–Ω—è–µ–º id –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–æ–≤, –ø–æ–∫–∞–∑—ã–≤–∞—è id –Ω–æ–≤—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–æ–≤.
       case
        when c.contract_commission_type in (4, 10)
         and c.firm_id = 1
        then nvl((
              select distinct l.value_num
                from xxxx_new_comm_contract_basic l
               where l.contract_id = c.contract_id
                 and l.code = 'LINK_CONTRACT_ID'
--                 )
                 and l.value_num is not null),
              c.contract_id)
        else c.contract_id
       end                                        as contract_id,
       c.invoice_eid                              as invoice_eid,
       c.invoice_id                               as invoice_id,
       c.invoice_dt                               as invoice_dt,
       c.contract_from_dt                         as contract_from_dt,
       c.contract_till_dt                         as contract_till_dt,
       c.currency                                 as currency,
       c.nds                                      as nds, 
       c.nds_pct                                  as nds_pct,
       c.loyal_client                             as loyal_clients,
       -- BALANCE-17175
       decode(
        nvl(c.commission_type, c.discount_type),
        22, 1,
        29, 1,  -- –ê—É–¥–∏–æ—Ä–µ–∫–ª–∞–º–∞ –¥–æ–ª–∂–∞ —É—á–∏—Ç—ã–≤–∞—Ç—å—Å—è –∫–∞–∫ –º–µ–π–¥–∏–∫–∞
        nvl(c.commission_type, c.discount_type)
       )                                        as discount_type,
--     29                                       as discount_type_src,
       nvl(c.commission_type, c.discount_type)  as discount_type_src,
       c.payment_type                             as payment_type,
                                              -- ?  as commission_payback_type
       c.commission_payback_pct                   as commission_payback_pct,
       c.contract_commission_type                 as commission_type
  from xxxx_new_comm_contract_basic c
  where (
                                                -- BALANCE-17175
                                                (
                                                    -- ?????? ?????, ????????? ? 2015
--                                                  --?  invoice_dt >= date'2015-03-01' and
                                                    -- —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ\–ø—Ä–æ—Ñ—ã
                                                    c.contract_commission_type in (1, 2, 8) and
                                                    -- —Ç–æ —É—á–∏—Ç—ã–≤–∞–µ–º –µ—â–µ –∏ –∫–æ–¥ 22
                                                    nvl(c.commission_type, c.discount_type) in
                                                    (1, 2, 3, 7, 11, 12, 14, 17, 19, 22, 25, 28, 29)
                                                )
                                                or
                                                (
                                                    -- –ü–æ –ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ —Å–º–æ—Ç—Ä–∏–º –≤—Å—ë
                                                    c.contract_commission_type in (10) and 1=1
                                                )
                                                or
                                                (
                                                    -- –∏–Ω–∞—á–µ, –∫–∞–∫ —Ä–∞–Ω–µ–µ
                                                    nvl(c.commission_type,
                                                        c.discount_type) in
                                                    (1, 2, 3, 7, 11, 12, 14, 17, 19, 28, 29)
                                                )
                                              )
)
,
-- ----------------------------------------------------------------------------
-- –æ—Å–Ω–æ–≤–Ω–∞—è –≤—ã–±–æ—Ä–∫–∞ –ø–æ –∞–∫—Ç–∞–º
-- ----------------------------------------------------------------------------
-- –≤—Å–µ –∞–∫—Ç—ã –ø–æ —Å—á–µ—Ç–∞–º
s_acts as (
    select b.contract_eid,
           b.contract_id,
           b.invoice_eid,
           b.invoice_id,
           b.invoice_dt,
           b.contract_from_dt,
           b.contract_till_dt,
           b.currency,
           b.nds,
           b.payment_type,
            b.commission_type,
           b.discount_type,
           case
           when nvl(xxx.is_loyal, 0) = 1 and b.discount_type = 7
            then 1
            else 0
           end                               as is_loyal,
           xxx.client_id                                      as client_id,
           xxx.act_dt                                         as act_dt,
           trunc(xxx.act_dt, 'MM')                            as from_dt,
           add_months(trunc(xxx.act_dt, 'MM'), 1) - 1/84600   as till_dt,
           count(distinct b.nds)      over (partition by b.contract_id) as nds_count,
           count(distinct b.currency) over (partition by b.contract_id) as currency_count,
           xxx.amount                                         as amt_w_nds,
           xxx.amount-xxx.amount_nds-xxx.amount_nsp           as amt,
           xxx.amount*cr.rate                                 as amt_w_nds_rub,
           (xxx.amount-xxx.amount_nds-xxx.amount_nsp)*cr.rate as amt_rub
      from s_base        b
      join xxxx_new_comm_contract_basic     xxx on b.invoice_id = xxx.invoice_id
                                              and xxx.hidden <4
                                              and xxx.act_dt >= (select fin_year_dt from s_dates)
      join xxxx_currency_rate              cr on cr.cc = b.currency
                                              and cr.rate_dt = trunc(xxx.act_dt)
     where b.commission_type in (1, 2, 3, 4, 5, 6, 8, 10, 11)
   and (
          -- base, prof
          (
            b.commission_type in (1, 2, 8)
        and (
                -- BALANCE-22085
                -- ¬ ÌÓ‚˚ı ‡ÍÚ‡ı ÔÓ ÌÓ‚˚Ï Ë ÔÓ‰ÎÂÌÌ˚Ï ‰Ó„Ó‚Ó‡Ï
              --  * ÓÚ·‡Ò˚‚‡ÂÏ Ï‡ÍÂÚ (11)
               --  * ‚ÍÎ˛˜‡ÂÏ ¿‚ÚÓ (25)
            xxx.act_dt >= date'2016-03-01' and 
            b.contract_till_dt >= date'2016-03-01' and 
            b.discount_type in (1, 2, 3, 7, 12, 25) and 
            -- BALANCE-22203
            -- BALANCE-22331: ‚ ÌÓ‚˚ı ÛÒÎÓ‚Ëˇı ÓÒÚ‡‚ÎˇÂÏ ÚÓÎ¸ÍÓ Û·ÎË
            b.currency = 'RUR'
              -- ¬ ÌÓ‚˚ı ‡ÍÚ‡ı ÔÓ ÌÂÔÓ‰ÎÂÌÌ˚Ï ‰Ó„Ó‚Ó‡Ï Ë ÒÚ‡˚ı ‡ÍÚ‡ı
               -- ÓÒÚ‡‚ÎˇÂÏ ÒÚ‡˚Â ÛÒÎÓ‚Ëˇ
                -- BALANCE-22319
             or xxx.act_dt >= date'2016-03-01' and b.contract_till_dt < date'2016-03-01' and b.discount_type in (1, 2, 3, 7, 11, 12)
             or xxx.act_dt  < date'2016-03-01' and b.discount_type in  (1, 2, 3, 7, 11, 12)
            
            )
          )
          -- ua
       or (b.commission_type = 6 and b.discount_type in (1, 2, 3, 7, 12))
          -- spec
       or (b.commission_type = 3 and b.discount_type in (17))
          -- auto
       or (b.commission_type = 4 and b.discount_type in (19))
          -- sprav
       or (b.commission_type = 5 and b.discount_type = 12)
          -- estate
       or (b.commission_type = 10 and 1=1)
          -- audio
       or (b.commission_type = 11 and b.discount_type_src = 29)
          -- market		
       or (b.commission_type in (12, 13) and b.discount_type_src = 11)
              
)
),
s_acts_all as (
    select b.*
      from s_acts   b
     where b.commission_type = 1
        -- BALANCE-22203
),
-- –∞–∫—Ç—ã –±–µ–∑ –ª–æ—è–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
s_acts_wo_lc as (
    select d.*
      from s_acts_all d
     where d.is_loyal = 0
),
-- –∞–∫—Ç–Ω—ã –ø–æ –ª–æ—è–ª—å–Ω—ã–º –∫–ª–∏–µ–Ω—Ç–∞–º
s_acts_lc as (
    select d.*
      from s_acts_all d
     where d.is_loyal = 1
),
-- ----------------------------------------------------------------------------
-- –æ—Å–Ω–æ–≤–Ω–∞—è –≤—ã–±–æ—Ä–∫–∞ –ø–æ –æ–ø–ª–∞—Ç–∞–º
-- ----------------------------------------------------------------------------
s_opt_2015_payments as (
  select b.contract_eid,
       b.contract_id,
       b.invoice_eid,
       b.invoice_id,
       b.invoice_dt,
       b.contract_from_dt,
       b.contract_till_dt,
       b.currency,
       b.nds,
       b.payment_type,
       b.commission_type,
       b.discount_type,
       oebs.comiss_date,
       trunc(oebs.comiss_date, 'MM')                   as from_dt,
       add_months(
        trunc(oebs.comiss_date, 'MM'), 1)-1/84600      as till_dt,
       oebs.oebs_payment*100/(100 + b.nds*b.nds_pct)         as amt,
       oebs.oebs_payment                                     as amt_w_nds
  from s_base        b
  join xxxx_oebs_cash_payment_test            oebs on oebs.invoice_id = b.invoice_id
                                            and oebs.comiss_date  >= date'2015-03-01'
                                            and oebs.comiss_date  is not null
 where b.commission_type in (1, 2, 3, 4, 5, 6, 8, 10, 11)
   and (
          -- base, prof
          (
            b.commission_type in (1, 2, 8)
        and (
               -- BALANCE-22085
                b.invoice_dt >= date'2016-03-01'        and
                b.discount_type in (1, 2, 3, 7, 12, 25) and
                -- BALANCE-22203
                -- BALANCE-22331: ÔÓ ÌÓ‚˚Ï ÛÒÎÓ‚ËˇÏ Ò˜ËÚ‡ÂÏ ÚÓÎ¸ÍÓ Û·ÎË
                b.currency = 'RUR'
             or b.invoice_dt  < date'2016-03-01' and b.discount_type in (1, 2, 3, 7, 11, 12)
            )
          )
          -- ua
       or (b.commission_type = 6 and b.discount_type in (1, 2, 3, 7, 12))
          -- spec
       or (b.commission_type = 3 and b.discount_type in (17))
          -- auto
       or (b.commission_type = 4 and b.discount_type in (19))
          -- sprav
       or (b.commission_type = 5 and b.discount_type = 12)
          -- estate
       or (b.commission_type = 10 and 1=1)
          -- audio
       or (b.commission_type = 11 and b.discount_type_src = 29)
      )
),
s_payments as (
    select b.*
      from s_opt_2015_payments b
     where b.commission_type = 1
        -- BALANCE-22203
),
-- ----------------------------------------------------------------------------
-- –ë–∞–∑–æ–≤–æ–µ –ö–í (–º–µ—Å—è—á–Ω–æ–µ)
-- ----------------------------------------------------------------------------
-- –ê–∫—Ç—ã –ø–æ –õ–ö. –û—Ç–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–ª–∏–µ–Ω—Ç–æ–≤, —É –∫–æ—Ç–æ—Ä—ã—Ö –∑–∞ –º–µ—Å—è—Ü < 50–∫
s_kv_acts_lc as (
    select contract_eid, contract_id,
           currency, discount_type,
           nds, from_dt, till_dt, payment_type,
           client_id,
           sum(amt_w_nds)       as amt_w_nds,
           sum(amt)             as amt
      from s_acts_lc
     group by contract_eid, contract_id,
              currency, discount_type,
              nds, from_dt, till_dt, payment_type,
              client_id
        -- BALANCE-19689
        -- –î–ª—è –õ–ö –±–∞–∑–æ–≤–∞—è –ø—Ä–µ–º–∏—è –Ω–∞ —É—Å–ª—É–≥–∏ –ø–æ –î–∏—Ä–µ–∫—Ç—É –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ,
        -- –µ—Å–ª–∏ –≤ –¥–∞–Ω–Ω–æ–º –º–µ—Å—è—Ü–µ —É—Å–ª—É–≥ –ø–æ –î–∏—Ä–µ–∫—Ç—É –±—ã–ª–æ –æ–∫–∞–∑–∞–Ω–æ (–ø–æ –∞–∫—Ç–∞–º)
        -- –Ω–∞ 50 000 —Ç.—Ä. (–±–µ–∑ –ù–î–°) –∏ –±–æ–ª–µ–µ
     having sum(amt_rub) >= 50000
),
s_kv_lc as (
    select contract_eid, contract_id,
           currency, discount_type,
           nds, from_dt, till_dt, payment_type,
           sum(amt_w_nds)       as amt_w_nds,
           sum(amt)             as amt,
           sum(amt)*.1          as reward
      from s_kv_acts_lc
     group by contract_eid, contract_id,
              currency, discount_type,
              nds, from_dt, till_dt, payment_type
),
-- –°–∫–ª–∞–¥—ã–≤–∞–µ–º –∞–∫—Ç—ã –∏ –æ–ø–ª–∞—Ç—ã
s_kv_src as (
    select contract_eid, contract_id,
           currency, discount_type,
           contract_from_dt, contract_till_dt,
           nds, from_dt, till_dt, payment_type,
           sum(amt_acts)            as amt_to_charge,
           sum(amt_oebs_w_nds)      as amt_to_pay_w_nds,
           -- BALANCE-22195: —Å—á–∏—Ç–∞–µ–º —Å—É–º–º—É –æ–ø–ª–∞—Ç –ø–æ —Å—Ç–∞—Ä—ã–º —É—Å–ª–æ–≤–∏—è–º
           -- –∏ –ø–æ –Ω–æ–≤—ã–º —É—Å–ª–æ–≤–∏—è–º —Ä–∞–∑–¥–µ–ª—å–Ω–æ, —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∫ –Ω–∏–º —Ä–∞–∑–Ω—ã–π
           -- –ø—Ä–æ—Ü–µ–Ω—Ç
           nvl(sum(case when invoice_dt < date'2016-03-01'
					 -- BALANCE-22330: ÂÒÎË Ò˜ÂÚ ‚˚ÒÚ‡‚ÎÂÌ ÔÓ ÌÂ
                          -- ÔÓ‰ÎÂÌÌÓÏÛ ‰Ó„Ó‚ÓÛ (Ì‡ ‚‡ÊÌÓ ÍÓ„‰‡),
                          -- ÚÓ Ú‡Í ÊÂ Ò˜ËÚ‡ÂÏ Â„Ó Ó·ÓÓÚÓÏ ÔÓ ÛÒÎÓ‚ËˇÏ 2015
                          or invoice_dt >= date'2016-03-01' and
                             contract_till_dt < date'2016-03-01'
                    then amt_oebs
                    else 0
               end), 0)             as amt_to_pay_2015,
           nvl(sum(case when invoice_dt >= date'2016-03-01'
                          -- BALANCE-22330: ÚÓÎ¸ÍÓ ‰Îˇ ÔÓ‰ÎÂÌÌ˚ı ‰Ó„Ó‚ÓÓ‚
                         and contract_till_dt >= date'2016-03-01'
                    then amt_oebs
                    else 0
               end), 0)             as amt_to_pay_2016,
           sum(amt_oebs)            as amt_to_pay
      from (
            select contract_eid, contract_id, currency, nds, discount_type,
                   contract_from_dt, contract_till_dt,
                   from_dt, till_dt, payment_type, invoice_dt,
                   amt  as amt_acts, amt_w_nds  as amt_acts_w_nds,
                   0    as amt_oebs, 0          as amt_oebs_w_nds
              from s_acts_wo_lc
             union all
            select contract_eid, contract_id, currency, nds, discount_type,
                   contract_from_dt, contract_till_dt,
                   from_dt, till_dt, payment_type, invoice_dt,
                   0    as amt_acts, 0          as amt_acts_w_nds,
                   amt  as amt_oebs, amt_w_nds  as amt_oebs_w_nds
              from s_payments
           )
     group by contract_eid, contract_id, currency, payment_type,
              contract_from_dt, contract_till_dt,
              nds, discount_type, from_dt, till_dt
),
-- –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∫–æ–Ω—Ç—Ä–æ–ª—é (–∑–∞—Ä–∞–Ω–µ–µ —Å—á–∏—Ç–∞–µ–º –±—é–¥–∂–µ–æ–æ–±—Ä–∞–∑—É—é—â–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤)
s_kv_control_src as (
    select d.*,
           -- –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –æ–±–æ—Ä–æ—Ç–∞ –ø–æ –î–∏—Ä–µ–∫—Ç—É –ø–æ –∫–ª–∏–µ–Ω—Ç—É –∫
           -- –æ–±–æ—Ä–æ—Ç—É –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É (–ê–≥–µ–Ω—Ç—Å—Ç–≤–∞)
           nvl(ratio_to_report(amt_rub_direct)
              over (partition by contract_id, from_dt), 0) as ratio
      from (
        select contract_id, from_dt, till_dt, client_id,
               contract_from_dt, contract_till_dt,
               nds_count, currency_count,
               sum(amt_rub)                                  as amt_rub,
               sum(decode(discount_type, 7, amt_rub, null))  as amt_rub_direct
          from s_acts_all
         where discount_type <> 25
         group by contract_id, from_dt, till_dt, client_id,
                  contract_from_dt, contract_till_dt,
                  nds_count, currency_count
           ) d
),
s_kv_control_pre as (
    select d.*,
           -- —É—á–∏—Ç—ã–≤–∞–µ–º, —á—Ç–æ –≤ –∫–∞–∫–æ–º-—Ç–æ –º–µ—Å—è—Ü–µ –º–æ–∂–µ—Ç –Ω–µ –±—ã—Ç—å –æ–±–æ—Ä–æ—Ç–∞
           case
            when add_months(from_dt, -1) = from_dt_1m_ago
            then case when ratio_1m_ago >= 0.7 then 1 else 0 end
            else 0
           end                                          as is_there_boc_1m_ago
      from (
        select d.*,
               lag(from_dt, 1) over (partition by contract_id
                                         order by from_dt)   as from_dt_1m_ago,
               lag(max_client_ratio_by_direct, 1, 0)
                               over (partition by contract_id
                                         order by from_dt)   as ratio_1m_ago,
               case when max_client_ratio_by_direct >= 0.7 then 1 else 0
                end as is_there_boc
          from (
            select contract_id, from_dt, till_dt,
                   contract_from_dt, contract_till_dt,
                   nds_count, currency_count,
                   sum(amt_rub)                 as amt_rub,
                   count(distinct client_id)    as client_count,
                   round(max(ratio), 2)         as max_client_ratio_by_direct
              from s_kv_control_src
             group by contract_id, from_dt, till_dt,
                      contract_from_dt, contract_till_dt,
                      nds_count, currency_count
               ) d
           ) d
),
-- –®—Ç—Ä–∞—Ñ—ã
--  - –æ–±–æ—Ä–æ—Ç –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É >= 100–∫
--  - –∫–ª–∏–µ–Ω—Ç–æ–≤ >= 5
--  - –Ω–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –æ–±–æ—Ä–æ—Ç–æ–º > 70% (–æ–∫—Ä—É–≥–ª—è–µ—Ç—Å—è –¥–æ —Ü–µ–ª—ã—Ö –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤) –ø–æ –î–∏—Ä–µ–∫—Ç—É
--  - –Ω–µ—Ç –Ω–µ—Ä–µ–∑–∏–¥–µ–Ω—Ç–æ–≤
--  - —Ç–æ–ª—å–∫–æ 1 –≤–∞–ª—é—Ç–∞ –≤ —Å—á–µ—Ç–∞—Ö
s_kv_control as (
    select d.*,
           case
           when (
                    (from_dt < date'2015-07-01' and amt_rub >= 100000)
                    or
                    (from_dt >= date'2015-07-01' and amt_rub >= 200000)
                )
            and client_count >= 5
            and (
                    -- –î–æ–≥–æ–≤–æ—Ä—ã 2015 –≥–æ–¥–∞
                    (from_dt < date'2016-03-01' and is_there_boc = 0)
                    or
                    -- –î–æ–≥–æ–≤–æ—Ä—ã 2016 –≥–æ–¥–∞
                    (
                        from_dt >= date'2016-03-01'
                        -- BALANCE-22211: –Ω–µ –Ω–∞–∫–∞–∑—ã–≤–∞–µ–º, –µ—Å–ª–∏ –≤ –æ–¥–Ω–æ–º –∏–∑
                        -- –¥–≤—É—Ö –ø–æ–¥—Ä—è–¥ –∏–¥—É—â–∏—Ö –º–µ—Å—è—Ü–µ–≤ –Ω–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å –ë–û–ö
                    and (is_there_boc = 0 or is_there_boc_1m_ago = 0)
                    )
                )
            and nds_count = 1
            and currency_count = 1
           then 0
           else 1
            end as failed
      from s_kv_control_pre d
),
-- –°—É–º–º–∞ –ö–í –±–µ–∑ –∫–æ–Ω—Ç—Ä–æ–ª—è –∞–∫—Ç—ã <= –æ–ø–ª–∞—Ç
s_kv_pre as (
    select d.contract_id, contract_eid,
           d.from_dt, d.till_dt,
           d.payment_type,
           d.nds, d.currency,
           d.discount_type,
           sum(d.amt_to_charge)         as turnover_to_charge,
           sum(case
                -- BALANCE-22195: —Ä–µ—à–∞–µ–º –∫–∞–∫–∏–µ —É—Å–ª–æ–≤–∏—è –ø—Ä–∏–º–µ–Ω—è—Ç—å –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
                -- "–∫ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é" –ø–æ –¥–∞—Ç–µ –∞–∫—Ç–∞. –Ω–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è, 2016
                when d.from_dt >= date'2016-03-01' and
                     -- BALANCE-22330: ÚÓÎ¸ÍÓ ‰Îˇ ÌÓ‚˚ı Ë ÔÓÎÓÌ„ËÓ‚‡ÌÌ˚ı
                     d.contract_till_dt >= date'2016-03-01'
                then
                    d.amt_to_charge*decode(d.discount_type,
                        -- –ê–≤—Ç–æ.—Ä—É —Å—á–∏—Ç–∞–µ–º –ø–æ —à–∫–∞–ª–µ
                        25, case
                                when d.amt_to_charge >= 5000000 then 0.2
                                when d.amt_to_charge >= 4000000 then 0.18
                                when d.amt_to_charge >= 3000000 then 0.16
                                when d.amt_to_charge >= 2000000 then 0.14
                                when d.amt_to_charge >= 1000000 then 0.12
                                when d.amt_to_charge >=   50000 then 0.10
                                else 0
                            end,
                        -- –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö ‚Äî 8%
                        decode(f.failed,
                            0, 0.08,
                            0))
                -- BALANCE-22195: —Å—Ç–∞—Ä—ã–µ —É—Å–ª–æ–≤–∏—è, 2015
                else d.amt_to_charge*decode(f.failed,
                        0, 0.1,
                        0)
               end)                     as reward_to_charge,
           sum(d.amt_to_pay)            as turnover_to_pay,
           sum(d.amt_to_pay_w_nds)      as turnover_to_pay_w_nds,
           -- BALANCE-19851
           -- –®—Ç—Ä–∞—Ñ–æ–≤–∞—Ç—å –ø–æ –æ–ø–ª–∞—Ç–∞–º –Ω–µ –¥–æ–ª–∂–Ω—ã
           -- BALANCE-22195: –ø—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ –∏ –Ω–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è —Ä–∞–∑–¥–µ–ª—å–Ω–æ
           sum(d.amt_to_pay_2016*decode(d.discount_type,
                    -- –ê–≤—Ç–æ.—Ä—É —Å—á–∏—Ç–∞–µ–º –∏–Ω–∞—á–µ
                    25, case
                            when d.amt_to_pay >= 5000000 then 0.2
                            when d.amt_to_pay >= 4000000 then 0.18
                            when d.amt_to_pay >= 3000000 then 0.16
                            when d.amt_to_pay >= 2000000 then 0.14
                            when d.amt_to_pay >= 1000000 then 0.12
                            -- BALANCE-22241: –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ä–æ–≥–∞ –ø–æ
                            -- –æ–ø–ª–∞—Ç–∞–º –Ω–µ—Ç, –¥–æ–ª–∂–Ω—ã —É—á–µ—Å—Ç—å –≤—Å—ë. –Ω–æ
                            -- —Ä–µ–∞–ª—å–Ω–æ –≤—ã–ø–ª–∞—Ç–∏–º –Ω–µ –±–æ–ª–µ–µ, —á–µ–º –ø–æ –∞–∫—Ç–∞–º
                            else                              0.10
                        end,
                    -- –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö ‚Äî 8%
                    0.08) +
                  d.amt_to_pay_2015*0.1)    as reward_to_pay
      from s_kv_src         d
      -- BALANCE-19851
      left outer
      join s_kv_control     f on f.contract_id = d.contract_id
                             and f.from_dt = d.from_dt
                             and f.till_dt = d.till_dt
     group by d.contract_eid, d.contract_id, d.from_dt, d.till_dt, payment_type,
              d.discount_type, d.currency, d.nds
),
-- –ö–í —Å —Ä–∞–∑–±–∏–≤–∫–æ–π –ø–æ —Ç–∏–ø–∞–º —Ä–µ–∫–ª–∞–º—ã, –±–µ–∑ –∫–æ–Ω—Ç—Ä–æ–ª—è, —á—Ç–æ –æ–ø–ª–∞—Ç –Ω–µ –±–æ–ª–µ–µ, —á–µ–º –∞–∫—Ç–æ–≤
s_kv01 as (
    select contract_eid, contract_id, from_dt, till_dt,
           discount_type, currency, nds,
           -- –∫ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é
           turnover_to_charge,
           reward_to_charge,
           -- –∫ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—é (—Å–º. s_kv10)
           0                as turnover_to_pay,
           0                as turnover_to_pay_w_nds,
           decode(payment_type,
                -- BALANCE-19979: –¥–ª—è –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—ã –ø–ª–∞—Ç–∏–º –æ—Ç –∞–∫—Ç–æ–≤
                2, reward_to_charge,
                -- –ø–æ—Å—Ç–æ–ø–ª–∞—Ç–∞
                3, 0)       as reward_to_pay
      from s_kv_pre
),
-- –ö–í —Å –∫–æ–Ω—Ç—Ä–æ–ª–µ–º, —á—Ç–æ –æ–ø–ª–∞—Ç –Ω–µ –±–æ–ª–µ–µ, —á–µ–º –∞–∫—Ç–æ–≤
-- –±–µ–∑ —Ä–∞–∑–±–∏–≤–∫–∏ –ø–æ —Ç–∏–ø–∞–º —Ä–µ–∫–ª–∞–º—ã
s_kv10 as (
    select contract_eid, contract_id, from_dt, till_dt,
           currency, nds,
           -- –∫ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é (—Å–º. s_kv01)
           0                                    as turnover_to_charge,
           0                                    as reward_to_charge,
           -- –∫ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—é
           turnover_to_pay,
           turnover_to_pay_w_nds,
           (least(reward_to_charge_sum, reward_to_pay_sum) -
                least(reward_to_charge_sum_prev, reward_to_pay_sum_prev)
           )                                    as reward_to_pay
      from (
            select d.*,
                   sum(reward_to_charge)
                    over(partition by contract_id
                             order by from_dt)          as reward_to_charge_sum,
                   sum(reward_to_charge)
                    over(partition by contract_id
                             order by from_dt) -
                                    reward_to_charge    as reward_to_charge_sum_prev,
                   sum(reward_to_pay)
                    over(partition by contract_id
                             order by from_dt)          as reward_to_pay_sum,
                   sum(reward_to_pay)
                    over(partition by contract_id
                             order by from_dt) -
                                    reward_to_pay       as reward_to_pay_sum_prev
              from (
                    -- –£–±–∏—Ä–∞–µ–º –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é –ø–æ —Ç–∏–ø–∞–º —Ä–µ–∫–ª–∞–º—ã
                select d.contract_id, contract_eid,
                       d.from_dt, d.till_dt, payment_type,
                       d.nds, d.currency,
                       sum(turnover_to_charge)      as turnover_to_charge,
                       sum(reward_to_charge)        as reward_to_charge,
                       sum(turnover_to_pay)         as turnover_to_pay,
                       sum(turnover_to_pay_w_nds)   as turnover_to_pay_w_nds,
                       sum(reward_to_pay)           as reward_to_pay
                  from s_kv_pre         d
                    -- –æ–ø–ª–∞—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ—Å—Ç–æ–ø–ª–∞—Ç—ã
                 where payment_type = 3
                 group by d.contract_eid, d.contract_id,
                          d.from_dt, d.till_dt, payment_type,
                          d.currency, d.nds
                   ) d
           ) s
-- ),
-- -- –°–ö–í (–ø–æ–ª—É–≥–æ–¥–∏–µ)
-- -- BALANCE-19948, BALANCE-19941
-- s_skv as (
--     select d.*,
--            bo.pk_comm.calc_base_skv(d.amt_rub, d.from_dt) as reward
--       from (
--         select d.contract_eid, d.contract_id, d.from_dt, d.till_dt, d.nds,
--                -- BALANCE-15641
--                sum(amt_w_nds_rub)               as amt_w_nds_rub,
--                sum(amt_rub)                     as amt_rub
--           from bo.v_opt_2015_base_skv d
--          where failed = 0
--          group by d.contract_eid, d.contract_id, d.from_dt, d.till_dt, d.nds
--            ) d
)
-- —Ä–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å
select contract_id,
       contract_eid,
       from_dt,
       till_dt,
       nds,
       currency,
       discount_type,
       reward_type,
       turnover_to_charge,                          -- –æ–±–æ—Ä–æ—Ç –∫ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—é
       reward_to_charge,                            -- –∫ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—é
       turnover_to_pay_w_nds,
       turnover_to_pay,                             -- –æ–±–æ—Ä–æ—Ç –∫ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é
       reward_to_pay                                -- –∫ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é
  from (
        select contract_eid, contract_id,
               from_dt, till_dt,
               discount_type,
               currency, nds,
               turnover_to_charge,
               reward_to_charge,
               turnover_to_pay,
               turnover_to_pay_w_nds,
               reward_to_pay,
               1            as reward_type
          from s_kv01
         union all
        select contract_eid, contract_id,
               from_dt, till_dt,
               71           as discount_type,
               currency, nds,
               amt          as turnover_to_charge,
               reward       as reward_to_charge,
               null         as turnover_to_pay,
               null         as turnover_to_pay_w_nds,
               reward       as reward_to_pay,
               1            as type
          from s_kv_lc
         union all
        select contract_eid, contract_id,
               from_dt, till_dt,
               null         as discount_type,
               currency, nds,
               turnover_to_charge,
               reward_to_charge,
               turnover_to_pay,
               turnover_to_pay_w_nds,
               reward_to_pay,
               10           as reward_type
          from s_kv10
        --  union all
        -- select contract_eid, contract_id,
        --        from_dt, till_dt,
        --        null                             as discount_type,
        --        -- BALANCE-15641
        --        'RUR'                            as currency,
        --        nds,
        --        amt_rub                          as turnover_to_charge,
        --        reward                           as reward_to_charge,
        --        amt_rub                          as turnover_to_pay,
        --        amt_w_nds_rub                    as turnover_to_pay_w_nds,
        --        reward                           as reward_to_pay,
        --        2                                as type
        --   from s_skv
        --  union all
        -- select contract_eid, contract_id,
        --        from_dt, till_dt,
        --        null                             as discount_type,
        --        'RUR'                            as currency,
        --        1                                as nds,
        --        amt_rub                          as turnover_to_charge,
        --        reward                           as reward_to_charge,
        --        amt_rub                          as turnover_to_pay,
        --        amt_w_nds_rub                    as turnover_to_pay_w_nds,
        --        reward                           as reward_to_pay,
        --        3                                as type
        --   from bo.v_opt_2015_base_spec_reg
       ) 
         order by contract_id, from_dt, discount_type, currency, nds;
