// <<< AUTOGENERATED BY YANDEX.SCRIPT FROM mail/model/mail-model.ts >>>

package com.yandex.xplat.testopithecus

import com.yandex.xplat.common.*
import com.yandex.xplat.eventus.common.*
import com.yandex.xplat.eventus.*
import com.yandex.xplat.mapi.*
import com.yandex.xplat.testopithecus.common.*

public open class ScreenTitle {
    companion object {
        @JvmStatic val rootSettings: String = "Settings"
        @JvmStatic val helpAndFeedback: String = "Help and feedback"
        @JvmStatic
        open fun folder(folder: FolderName, unreadCounter: Int): String {
            return "${folder} ${unreadCounter}"
        }

    }
}

public open class Message(override var from: String, override var subject: String, override var timestamp: Long, override var firstLine: String, override var threadCounter: Int? = null, override var read: Boolean = false, override var important: Boolean = false, override var attachments: YSArray<AttachmentView> = mutableListOf(), override var to: String = "(No recipients)"): MessageView {
    open fun threadSize(): Int {
        val counter = this.threadCounter
        return if (counter != null) counter else 1
    }

    open override fun tostring(): String {
        val attachNames: YSArray<String> = this.attachments.map( {
            attach ->
            attach.displayName
        })
        return "MessageView(from=${this.from}, subject=${this.subject}, timestamp=${this.timestamp}, read=${this.read}, important=${this.important}, threadCounter=${this.threadCounter}, firstLine=${this.firstLine}, attachments=${attachNames})"
    }

    open fun copy(): Message {
        return Message(this.from, this.subject, this.timestamp, this.firstLine, this.threadCounter, this.read, this.important, this.attachments, this.to)
    }

    companion object {
        @JvmStatic
        open fun fromMeta(meta: MessageMeta): Message {
            return Message(meta.sender, meta.subjectText, meta.timestamp, meta.firstLine, if (meta.threadCount == null) null else stringToInt32(meta.threadCount!!), !meta.unread, meta.lid.contains("7"), if (meta.attachments == null) mutableListOf() else meta.attachments!!.attachments.map( {
                item ->
                MessageAttach.fromMetaAttach(item)
            }))
        }

        @JvmStatic
        open fun matches(first: MessageView, second: MessageView, isCompactMode: Boolean = false, isFull: Boolean = false): Boolean {
            var matchFrom: Boolean
            val matchImportant: Boolean = if (isCompactMode) true else first.important == second.important
            val firstAttachmentsLength: Int = first.attachments.size
            val secondAttachmentsLength: Int = second.attachments.size
            if (first.from.length > second.from.length) {
                matchFrom = first.from.includes(second.from)
            } else {
                matchFrom = second.from.includes(first.from)
            }
            if (first.subject != second.subject) {
                Log.error("Different subjects: ${first.subject}, ${second.subject}")
                return false
            }
            if (first.read != second.read) {
                Log.error("Different read status: ${first.read}, ${second.read}")
                return false
            }
            if (firstAttachmentsLength != secondAttachmentsLength) {
                Log.error("Different attachments length: ${firstAttachmentsLength}, ${secondAttachmentsLength}")
                return false
            }
            if (first.threadCounter != second.threadCounter) {
                Log.error("Different thread counter: ${first.threadCounter}, ${second.threadCounter}")
                return false
            }
            if (first.firstLine.substr(0, 10) != second.firstLine.substr(0, 10) && !isFull) {
                Log.error("Different first line: ${first.firstLine.substr(0, 10)}, ${second.firstLine.substr(0, 10)}")
                return false
            }
            if (!matchImportant) {
                Log.error("Different importance status: ${first.important}, ${second.important}")
                return false
            }
            if (!matchFrom) {
                Log.error("Different froms (one must be included into other): ${first.from}, ${second.from}")
                return false
            }
            return true
        }

    }
}

public open class MessageAttach(override val displayName: String): AttachmentView {
    companion object {
        @JvmStatic
        open fun fromMetaAttach(item: Attachment): AttachmentView {
            return MessageAttach(item.displayName)
        }

    }
}

public open class FullMessage(head: Message, override var to: YSSet<String> = YSSet<String>(), override var body: String = "", override var lang: LanguageName = TranslatorLanguageName.english, val translations: YSMap<LanguageName, String> = mutableMapOf<LanguageName, String>(), override val quickReply: Boolean = false, override val smartReplies: YSArray<String> = mutableListOf()): FullMessageView {
    override val head: MessageView
    var mutableHead: Message
    init {
        this.head = head
        this.mutableHead = head
    }
    open override fun tostring(): String {
        return "(${this.head.tostring()}, to=${this.to.values()}, body=${this.body}, quickReply=${this.quickReply}, smartReplies=${this.smartReplies})"
    }

    open fun copy(): FullMessage {
        val translationsCopy = mutableMapOf<LanguageName, String>()
        this.translations.__forEach( {
            translation, language ->
            translationsCopy.set(language, translation)
        })
        return FullMessage(this.mutableHead.copy(), this.to, this.body, this.lang, translationsCopy, this.quickReply, this.smartReplies)
    }

    companion object {
        @JvmStatic
        open fun fromMeta(meta: MessageMeta, body: String = "", lang: LanguageName = TranslatorLanguageName.english, translations: YSMap<LanguageName, String> = mutableMapOf<LanguageName, String>(), quickReply: Boolean = false, smartReplies: YSArray<String> = mutableListOf()): FullMessage {
            return FullMessage(Message.fromMeta(meta), YSSet<String>(), body, lang, translations, quickReply, smartReplies)
        }

        @JvmStatic
        open fun matches(first: FullMessageView, second: FullMessageView): Boolean {
            for (to in first.to.values()) {
                if (!second.to.has(to)) {
                    Log.error("Different to: ${first.to.values()}, ${second.to.values()}")
                    return false
                }
            }
            if (first.body != second.body) {
                Log.error("Different body: ${first.body}, ${second.body}")
                return false
            }
            return Message.matches(first.head, second.head, false, true)
        }

    }
}

public typealias MessageId = ID

public typealias FolderId = ID

public open class MailAppModelHandler(var accountsData: YSArray<AccountMailboxData>) {
    var accountsManager: AccountsManager
    init {
        this.accountsManager = AccountsManager(accountsData.map( {
            data ->
            data.client.oauthAccount.account
        }))
    }
    open fun choseAccountFromAccountsManager(account: UserAccount): Unit {
        this.accountsManager.logInToAccount(account)
    }

    open fun logInToAccount(account: UserAccount): Unit {
        this.accountsManager.logInToAccount(account)
    }

    open fun revokeToken(account: UserAccount): Unit {
        this.accountsManager.revokeToken(account)
    }

    open fun exitFromReloginWindow(): Unit {
        this.accountsManager.exitFromReloginWindow()
    }

    open fun switchToAccountByOrder(loginOrder: Int): Unit {
        this.accountsManager.switchToAccountByOrder(loginOrder)
    }

    open fun switchToAccountByLogin(login: Login): Unit {
        this.accountsManager.switchToAccount(login)
    }

    open fun isLoggedIn(): Boolean {
        return this.accountsManager.isLoggedIn()
    }

    open fun getCurrentAccount(): AccountMailboxData {
        if (!this.hasCurrentAccount()) {
            fail("Account was requested, but is not set")
        }
        return this.accountsData[this.accountsManager.currentAccount!!]
    }

    open fun getCurrentAccountType(): AccountType2 {
        if (!this.hasCurrentAccount()) {
            fail("Account was requested, but is not set")
        }
        return this.accountsData[this.accountsManager.currentAccount!!].client.oauthAccount.type
    }

    open fun getLoggedInAccounts(): YSArray<UserAccount> {
        return this.accountsManager.getLoggedInAccounts()
    }

    open fun hasCurrentAccount(): Boolean {
        return (this.accountsManager.currentAccount != null && this.accountsManager.currentAccount!! < this.accountsData.size)
    }

    open fun logoutAccount(login: Login): Unit {
        this.accountsManager.logoutAccount(login)
    }

    open fun copy(): MailAppModelHandler {
        val accountsDataCopy = this.accountsData.map( {
            acc ->
            acc.copy()
        })
        val result = MailAppModelHandler(accountsDataCopy)
        result.accountsManager = this.accountsManager.copy()
        return result
    }

}

public open class AccountSettingsModel(var groupBySubjectEnabled: Boolean, var sortingEmailsByCategoryEnabled: Boolean, var signature: String, var placeForSignature: SignaturePlace, var folderList: YSArray<FolderName>) {
    var folderToNotificationOption: YSMap<FolderName, NotificationOption>
    var notificationSound: NotificationSound = NotificationSound.yandexMail
    var phoneNumber: String = ""
    var accountUsingEnabled: Boolean = true
    var pushNotificationForAllEnabled: Boolean = true
    var themeEnabled: Boolean = true
    private var ignoredFolders: YSArray<FolderName> = mutableListOf(DefaultFolderName.sent, DefaultFolderName.trash, DefaultFolderName.spam, DefaultFolderName.draft, DefaultFolderName.template, DefaultFolderName.archive, DefaultFolderName.outgoing)
    init {
        this.folderToNotificationOption = mutableMapOf<FolderName, NotificationOption>()
        folderList.filter( {
            folderName ->
            !this.ignoredFolders.contains(folderName)
        }).forEach(__LBL__MailModel_1@ {
            folderName ->
            this.folderToNotificationOption.set(folderName as FolderName, NotificationOption.syncAndNotifyMe)
        })
    }
}

public open class AccountMailboxData(val client: MailboxClient, var messagesDB: MessageListDatabase, var defaultEmail: String, var aliases: YSArray<String>, var contacts: YSArray<Contact>, var filters: YSArray<FilterResponseData>, var accountSettings: AccountSettingsModel, var zeroSuggest: YSArray<String>, var translationLangs: YSArray<LanguageName>, var promoteMail360: Boolean) {
    open fun copy(): AccountMailboxData {
        val accountSettingsCopy = AccountSettingsModel(this.accountSettings.groupBySubjectEnabled, this.accountSettings.sortingEmailsByCategoryEnabled, this.accountSettings.signature, this.accountSettings.placeForSignature, this.accountSettings.folderList)
        val aliasesCopy = copyArray(this.aliases)
        val contactsCopy = copyArray(this.contacts)
        val filtersCopy = copyArray(this.filters)
        val messagesDBCopy = this.messagesDB.copy()
        val zeroSuggestCopy = copyArray(this.zeroSuggest)
        val translationLangsCopy = copyArray(this.translationLangs)
        return AccountMailboxData(this.client, messagesDBCopy, this.defaultEmail, aliasesCopy, contactsCopy, filtersCopy, accountSettingsCopy, zeroSuggestCopy, translationLangsCopy, this.promoteMail360)
    }

}

public open class DeviceTypeModel {
    private var deviceType: DeviceType = DeviceType.Phone
    open fun getDeviceType(): DeviceType {
        return this.deviceType
    }

    open fun setDeviceType(deviceType: DeviceType): Unit {
        this.deviceType = deviceType
    }

    companion object {
        @JvmStatic val instance: DeviceTypeModel = DeviceTypeModel()
    }
}

public open class MailboxModel(val mailAppModelHandler: MailAppModelHandler): AppModel {
    override var supportedFeatures: YSArray<FeatureID> = copyArray(MailboxModel.allSupportedFeatures)
    val containerGetter: ContainerGetterModel
    val messageListDisplay: MessageListDisplayModel
    val markableRead: MarkableReadModel
    val markableImportant: MarkableImportantModel
    val messageNavigator: OpenMessageModel
    val deletableMessages: DeleteMessageModel
    val groupMode: GroupModeModel
    val rotatable: RotatableModel
    val readOnlyExpandableThreads: ReadOnlyExpandableThreadsModel
    val expandableThreads: ExpandableThreadsModel
    val folderNavigator: FolderNavigatorModel
    val creatableFolder: CreatableFolderModel
    val wysiwyg: WysiwygModel
    val login: LoginModel
    val multiAccount: MultiAccountModel
    val contextMenu: ContextMenuModel
    val shortSwipe: ShortSwipeModel
    val longSwipe: LongSwipeModel
    val archiveMessage: ArchiveMessageModel
    val accountSettingsModel: AccountSettingModel
    val generalSettingsModel: GeneralSettingsModel
    val rootSettingsModel: RootSettingsModel
    val aboutSettingsModel: AboutSettingsModel
    val spammable: SpamableModel
    val search: SearchModel
    val advancedSearch: AdvancedSearchModel
    val zeroSuggest: ZeroSuggestModel
    val createLabel: LabelModel
    val manageLabels: ManageLabelsModel
    val manageFolders: ManageFoldersModel
    val storiesBlockModel: StoriesBlockModel
    val undo: UndoModel
    val pin: PinModel
    val applicationState: ApplicationRunningStateModel
    val tabs: TabsModel
    val accountManager: AccountManagerModel
    val expiredToken: ExpiringTokenModel
    val switchContext2Pane: SwitchContextIn2paneModel
    val translatorBarModel: TranslatorBarModel
    val translatorLanguageListModel: TranslatorLanguageListModel
    val translatorLanguageListSearchModel: TranslatorLanguageListSearchModel
    val translatorSettingsModel: TranslatorSettingsModel
    val validatorModel: ValidatorModel
    val quickReplyModel: QuickReplyModel
    val smartReplyModel: SmartReplyModel
    val applyLabelModel: ApplyLabelModel
    val moveToFolderModel: MoveToFolderModel
    val clearFolderModel: ClearFolderModel
    val backendActionsModel: BackendActionsModel
    val shtorkaModel: ShtorkaModel
    val shtorkaIOSModel: ShtorkaIOSModel
    val shtorkaAndroidModel: ShtorkaAndroidModel
    val tabBarModel: TabBarModel
    val tabBarIOSModel: TabBarIOSModel
    val tabBarAndroidModel: TabBarAndroidModel
    val snapshotValidatingModel: SnapshotValidatingModel
    val composeModel: ComposeModel
    val filtersListModel: FiltersListModel
    val filterConditionLogicModel: FilterConditionLogicModel
    val filterUpdateRuleMoreModel: FilterUpdateRuleMoreModel
    val filterCreateOrUpdateRuleModel: FilterCreateOrUpdateRuleModel
    init {
        val accountsSettings: YSArray<AccountSettingsModel> = mailAppModelHandler.accountsData.map(__LBL__MailModel_2@ {
            account ->
            return@__LBL__MailModel_2 account.accountSettings
        })
        this.messageListDisplay = MessageListDisplayModel(this.mailAppModelHandler)
        this.pin = PinModel()
        this.accountSettingsModel = AccountSettingModel(accountsSettings, this.mailAppModelHandler.accountsManager, this.mailAppModelHandler)
        this.generalSettingsModel = GeneralSettingsModel(this.pin)
        this.aboutSettingsModel = AboutSettingsModel()
        this.rootSettingsModel = RootSettingsModel(this.messageListDisplay, this.mailAppModelHandler.accountsManager)
        this.advancedSearch = AdvancedSearchModel(this.messageListDisplay)
        this.markableRead = MarkableReadModel(this.messageListDisplay, this.mailAppModelHandler)
        this.spammable = SpamableModel(this.messageListDisplay, this.mailAppModelHandler)
        this.storiesBlockModel = StoriesBlockModel()
        this.containerGetter = ContainerGetterModel(this.messageListDisplay)
        this.createLabel = LabelModel(this.mailAppModelHandler)
        this.manageLabels = ManageLabelsModel(this.mailAppModelHandler)
        this.manageFolders = ManageFoldersModel(this.mailAppModelHandler)
        this.archiveMessage = ArchiveMessageModel(this.messageListDisplay, this.mailAppModelHandler)
        this.deletableMessages = DeleteMessageModel(this.messageListDisplay, this.mailAppModelHandler)
        this.undo = UndoModel(this.deletableMessages, this.archiveMessage, this.spammable, this.mailAppModelHandler, this.messageListDisplay)
        this.filtersListModel = FiltersListModel(this.accountSettingsModel)
        this.filterUpdateRuleMoreModel = FilterUpdateRuleMoreModel()
        this.filterConditionLogicModel = FilterConditionLogicModel()
        this.filterCreateOrUpdateRuleModel = FilterCreateOrUpdateRuleModel(this.filterConditionLogicModel)
        this.folderNavigator = FolderNavigatorModel(this.messageListDisplay, this.mailAppModelHandler, this.undo)
        this.markableImportant = MarkableImportantModel(this.messageListDisplay, this.mailAppModelHandler)
        this.rotatable = RotatableModel()
        this.applicationState = ApplicationRunningStateModel()
        this.readOnlyExpandableThreads = ReadOnlyExpandableThreadsModel(this.messageListDisplay, this.mailAppModelHandler)
        this.expandableThreads = ExpandableThreadsModel(this.readOnlyExpandableThreads, this.messageListDisplay)
        this.translatorSettingsModel = TranslatorSettingsModel()
        this.validatorModel = ValidatorModel()
        this.translatorBarModel = TranslatorBarModel(this.translatorSettingsModel)
        this.translatorLanguageListModel = TranslatorLanguageListModel(this.translatorSettingsModel, this.mailAppModelHandler, this.translatorBarModel)
        this.wysiwyg = WysiwygModel()
        this.composeModel = ComposeModel(this.mailAppModelHandler)
        this.quickReplyModel = QuickReplyModel(this.composeModel)
        this.smartReplyModel = SmartReplyModel(this.quickReplyModel, this.generalSettingsModel)
        this.messageNavigator = OpenMessageModel(this.markableImportant, this.expandableThreads, this.messageListDisplay, this.createLabel, this.deletableMessages, this.mailAppModelHandler, this.archiveMessage, this.translatorBarModel, this.translatorLanguageListModel, this.translatorSettingsModel, this.smartReplyModel, this.quickReplyModel)
        this.search = SearchModel(this.messageListDisplay, this.messageNavigator)
        this.zeroSuggest = ZeroSuggestModel(this.mailAppModelHandler, this.search, this.messageListDisplay)
        this.creatableFolder = CreatableFolderModel(this.mailAppModelHandler)
        this.contextMenu = ContextMenuModel(this.deletableMessages, this.markableImportant, this.markableRead, this.mailAppModelHandler, this.messageListDisplay, this.spammable, this.composeModel, this.archiveMessage, this.messageNavigator, this.translatorBarModel)
        this.shortSwipe = ShortSwipeModel(this.deletableMessages, this.archiveMessage, this.markableRead)
        this.longSwipe = LongSwipeModel(this.deletableMessages, this.archiveMessage)
        this.login = LoginModel(mailAppModelHandler, this.messageListDisplay)
        this.multiAccount = MultiAccountModel(mailAppModelHandler)
        this.accountManager = AccountManagerModel(mailAppModelHandler)
        this.expiredToken = ExpiringTokenModel(mailAppModelHandler)
        this.groupMode = GroupModeModel(this.markableRead, this.deletableMessages, this.archiveMessage, this.markableImportant, this.spammable, this.messageListDisplay)
        this.applyLabelModel = ApplyLabelModel(this.mailAppModelHandler, this.messageNavigator, this.contextMenu, this.messageListDisplay, this.groupMode, this.createLabel)
        this.moveToFolderModel = MoveToFolderModel(this.mailAppModelHandler, this.messageNavigator, this.contextMenu, this.messageListDisplay, this.groupMode)
        this.tabs = TabsModel(this.messageListDisplay, this.mailAppModelHandler, this.undo)
        val storiesBlockViewCounter = StoriesBlockViewCounter(this.storiesBlockModel, this.messageListDisplay)
        this.messageListDisplay.attach(storiesBlockViewCounter)
        this.rotatable.attach(storiesBlockViewCounter)
        this.switchContext2Pane = SwitchContextIn2paneModel()
        this.translatorLanguageListSearchModel = TranslatorLanguageListSearchModel(this.translatorLanguageListModel)
        this.clearFolderModel = ClearFolderModel(mailAppModelHandler)
        this.backendActionsModel = BackendActionsModel(mailAppModelHandler, this.creatableFolder, this.createLabel)
        this.tabBarModel = TabBarModel(this.messageListDisplay, this.messageNavigator, this.groupMode, this.zeroSuggest, this.rootSettingsModel, this.composeModel, this.folderNavigator, DeviceTypeModel.instance)
        this.tabBarIOSModel = TabBarIOSModel(mailAppModelHandler)
        this.tabBarAndroidModel = TabBarAndroidModel(mailAppModelHandler)
        this.shtorkaModel = ShtorkaModel(mailAppModelHandler, this.tabBarModel)
        this.shtorkaIOSModel = ShtorkaIOSModel()
        this.shtorkaAndroidModel = ShtorkaAndroidModel()
        this.snapshotValidatingModel = SnapshotValidatingModel()
    }
    open override fun getFeature(feature: FeatureID): Any {
        return FeatureRegistry().register(MessageListDisplayFeature.`get`, this.messageListDisplay).register(FolderNavigatorFeature.`get`, this.folderNavigator).register(MessageViewerFeature.`get`, this.messageNavigator).register(MessageViewerAndroidFeature.`get`, this.messageNavigator).register(ThreadViewNavigatorFeature.`get`, this.messageNavigator).register(MarkableReadFeature.`get`, this.markableRead).register(MarkableImportantFeature.`get`, this.markableImportant).register(GroupModeFeature.`get`, this.groupMode).register(RotatableFeature.`get`, this.rotatable).register(ExpandableThreadsModelFeature.`get`, this.readOnlyExpandableThreads).register(ExpandableThreadsFeature.`get`, this.expandableThreads).register(DeleteMessageFeature.`get`, this.deletableMessages).register(SpamableFeature.`get`, this.spammable).register(CreatableFolderFeature.`get`, this.creatableFolder).register(WysiwygFeature.`get`, this.wysiwyg).register(YandexLoginFeature.`get`, this.login).register(YandexTeamLoginFeature.`get`, this.login).register(ContextMenuFeature.`get`, this.contextMenu).register(ShortSwipeFeature.`get`, this.shortSwipe).register(LongSwipeFeature.`get`, this.longSwipe).register(ArchiveMessageFeature.`get`, this.archiveMessage).register(UndoFeature.`get`, this.undo).register(MultiAccountFeature.`get`, this.multiAccount).register(SearchFeature.`get`, this.search).register(AdvancedSearchFeature.`get`, this.advancedSearch).register(ZeroSuggestFeature.`get`, this.zeroSuggest).register(CreatableLabelFeature.`get`, this.createLabel).register(LabelNavigatorFeature.`get`, this.folderNavigator).register(FilterNavigatorFeature.`get`, this.folderNavigator).register(ContainerGetterFeature.`get`, this.containerGetter).register(AccountSettingsFeature.`get`, this.accountSettingsModel).register(IosAccountSettingsFeature.`get`, this.accountSettingsModel).register(AndroidAccountSettingsFeature.`get`, this.accountSettingsModel).register(AboutSettingsFeature.`get`, this.aboutSettingsModel).register(GeneralSettingsFeature.`get`, this.generalSettingsModel).register(IosGeneralSettingsFeature.`get`, this.generalSettingsModel).register(AndroidGeneralSettingsFeature.`get`, this.generalSettingsModel).register(RootSettingsFeature.`get`, this.rootSettingsModel).register(IOSRootSettingsFeature.`get`, this.rootSettingsModel).register(AndroidRootSettingsFeature.`get`, this.rootSettingsModel).register(StoriesBlockFeature.`get`, this.storiesBlockModel).register(MailRuLoginFeature.`get`, this.login).register(GoogleLoginFeature.`get`, this.login).register(OutlookLoginFeature.`get`, this.login).register(HotmailLoginFeature.`get`, this.login).register(RamblerLoginFeature.`get`, this.login).register(YahooLoginFeature.`get`, this.login).register(CustomMailServiceLoginFeature.`get`, this.login).register(PinFeature.`get`, this.pin).register(ApplicationRunningStateFeature.`get`, this.applicationState).register(ManageableFolderFeature.`get`, this.manageFolders).register(ManageableLabelFeature.`get`, this.manageLabels).register(TabsFeature.`get`, this.tabs).register(AccountsListFeature.`get`, this.accountManager).register(ExpiringTokenFeature.`get`, this.expiredToken).register(SwitchContext2PaneFeature.`get`, this.switchContext2Pane).register(TranslatorBarFeature.`get`, this.translatorBarModel).register(ValidatorFeature.`get`, this.validatorModel).register(TranslatorLanguageListFeature.`get`, this.translatorLanguageListModel).register(TranslatorLanguageListSearchFeature.`get`, this.translatorLanguageListSearchModel).register(TranslatorSettingsFeature.`get`, this.translatorSettingsModel).register(QuickReplyFeature.`get`, this.quickReplyModel).register(SmartReplyFeature.`get`, this.smartReplyModel).register(ApplyLabelFeature.`get`, this.applyLabelModel).register(MoveToFolderFeature.`get`, this.moveToFolderModel).register(ClearFolderInFolderListFeature.`get`, this.clearFolderModel).register(BackendActionsFeature.`get`, this.backendActionsModel).register(TabBarFeature.`get`, this.tabBarModel).register(TabBarIOSFeature.`get`, this.tabBarIOSModel).register(TabBarAndroidFeature.`get`, this.tabBarAndroidModel).register(ShtorkaFeature.`get`, this.shtorkaModel).register(ShtorkaIOSFeature.`get`, this.shtorkaIOSModel).register(ShtorkaAndroidFeature.`get`, this.shtorkaAndroidModel).register(SnapshotValidatingFeature.`get`, this.snapshotValidatingModel).register(ComposeRecipientFieldsFeature.`get`, this.composeModel).register(ComposeRecipientSuggestFeature.`get`, this.composeModel).register(ComposeSenderSuggestFeature.`get`, this.composeModel).register(ComposeSubjectFeature.`get`, this.composeModel).register(ComposeBodyFeature.`get`, this.composeModel).register(ComposeFeature.`get`, this.composeModel).register(FilterCreateOrUpdateRuleFeature.`get`, this.filterCreateOrUpdateRuleModel).register(FiltersListFeature.`get`, this.filtersListModel).`get`(feature)
    }

    open override fun copy(): AppModel {
        val accountDataHandlerCopy = this.mailAppModelHandler.copy()
        val model: MailboxModel = MailboxModel(accountDataHandlerCopy)
        model.supportedFeatures = this.supportedFeatures
        model.messageNavigator.openedMessage = this.messageNavigator.openedMessage
        model.rotatable.landscape = this.rotatable.landscape
        if (this.groupMode.selectedOrders != null) {
            model.groupMode.selectedOrders = copySet(this.groupMode.selectedOrders)
        }
        for (id in this.readOnlyExpandableThreads.expanded.values()) {
            model.readOnlyExpandableThreads.expanded.add(id)
        }
        return model
    }

    open override fun getCurrentStateHash(): Long {
        return MailboxModelHasher().getMailboxModelHash(this)
    }

    open override fun dump(model: App): String {
        var s = ""
        if (!this.messageListDisplay.accountDataHandler.hasCurrentAccount()) {
            return "There is no logged in account"
        }
        val threadMids = this.messageListDisplay.getMessageIdList(10)
        s += "${this.messageListDisplay.getCurrentContainer().name}\n"
        for (i in (0 until threadMids.size step 1)) {
            val threadMid = threadMids[i]
            if (this.messageListDisplay.isInThreadMode()) {
                val thread = this.mailAppModelHandler.getCurrentAccount().messagesDB.makeMessageThreadView(threadMid)
                val msgHead = thread.mutableHead
                val threadSelector = if (msgHead.threadCounter != null) "${msgHead.threadCounter!!}v" else ""
                s += "${reduced(threadMid)} ${msgHead.from}\t${if (msgHead.read) "o" else "*"}" + "\t${msgHead.subject}\t${threadSelector}\t${msgHead.timestamp}\n"
                if (msgHead.threadCounter != null) {
                    for (mid in this.mailAppModelHandler.getCurrentAccount().messagesDB.getMessagesInThreadByMid(threadMid)) {
                        s += this.dumpMessage(mid)
                    }
                }
            } else {
                s += this.dumpMessage(threadMid)
            }
        }
        return s
    }

    private fun dumpMessage(mid: MessageId): String {
        val messagesDB = this.mailAppModelHandler.getCurrentAccount().messagesDB
        val message = messagesDB.storedMessage(mid)
        return ("\t\t${reduced(mid)} ${message.head.from}\t${if (message.head.read) "o" else "*"}\t${message.head.subject}" + "\t${messagesDB.storedFolder(mid)}\t${message.mutableHead.timestamp}" + "\t${setToArray(messagesDB.getMessageLabels(mid)).join(",")}\n")
    }

    companion object {
        @JvmStatic var allSupportedFeatures: YSArray<FeatureID> = mutableListOf(MessageListDisplayFeature.`get`.name, FolderNavigatorFeature.`get`.name, MessageViewerFeature.`get`.name, MessageViewerAndroidFeature.`get`.name, ThreadViewNavigatorFeature.`get`.name, MarkableReadFeature.`get`.name, MarkableImportantFeature.`get`.name, GroupModeFeature.`get`.name, RotatableFeature.`get`.name, ExpandableThreadsModelFeature.`get`.name, ExpandableThreadsFeature.`get`.name, DeleteMessageFeature.`get`.name, SpamableFeature.`get`.name, CreatableFolderFeature.`get`.name, WysiwygFeature.`get`.name, ArchiveMessageFeature.`get`.name, YandexLoginFeature.`get`.name, YandexTeamLoginFeature.`get`.name, MultiAccountFeature.`get`.name, ContextMenuFeature.`get`.name, ShortSwipeFeature.`get`.name, LongSwipeFeature.`get`.name, SearchFeature.`get`.name, AdvancedSearchFeature.`get`.name, ZeroSuggestFeature.`get`.name, CreatableLabelFeature.`get`.name, LabelNavigatorFeature.`get`.name, FilterNavigatorFeature.`get`.name, ContainerGetterFeature.`get`.name, StoriesBlockFeature.`get`.name, AccountSettingsFeature.`get`.name, IosAccountSettingsFeature.`get`.name, AndroidAccountSettingsFeature.`get`.name, AboutSettingsFeature.`get`.name, GeneralSettingsFeature.`get`.name, IosGeneralSettingsFeature.`get`.name, AndroidGeneralSettingsFeature.`get`.name, RootSettingsFeature.`get`.name, IOSRootSettingsFeature.`get`.name, AndroidRootSettingsFeature.`get`.name, UndoFeature.`get`.name, MailRuLoginFeature.`get`.name, GoogleLoginFeature.`get`.name, OutlookLoginFeature.`get`.name, HotmailLoginFeature.`get`.name, RamblerLoginFeature.`get`.name, YahooLoginFeature.`get`.name, CustomMailServiceLoginFeature.`get`.name, PinFeature.`get`.name, ApplicationRunningStateFeature.`get`.name, AccountsListFeature.`get`.name, ExpiringTokenFeature.`get`.name, ManageableFolderFeature.`get`.name, ManageableLabelFeature.`get`.name, TabsFeature.`get`.name, SwitchContext2PaneFeature.`get`.name, TranslatorBarFeature.`get`.name, ValidatorFeature.`get`.name, TranslatorLanguageListFeature.`get`.name, TranslatorLanguageListSearchFeature.`get`.name, TranslatorSettingsFeature.`get`.name, QuickReplyFeature.`get`.name, SmartReplyFeature.`get`.name, ApplyLabelFeature.`get`.name, MoveToFolderFeature.`get`.name, ClearFolderInFolderListFeature.`get`.name, BackendActionsFeature.`get`.name, ShtorkaFeature.`get`.name, ShtorkaIOSFeature.`get`.name, ShtorkaAndroidFeature.`get`.name, TabBarFeature.`get`.name, TabBarIOSFeature.`get`.name, TabBarAndroidFeature.`get`.name, SnapshotValidatingFeature.`get`.name, ComposeRecipientFieldsFeature.`get`.name, ComposeRecipientSuggestFeature.`get`.name, ComposeSenderSuggestFeature.`get`.name, ComposeSubjectFeature.`get`.name, ComposeBodyFeature.`get`.name, ComposeFeature.`get`.name, FiltersListFeature.`get`.name, FilterCreateOrUpdateRuleFeature.`get`.name, FilterConditionLogicFeature.`get`.name, FilterUpdateRuleMoreFeature.`get`.name)
    }
}

