import XCTest

final class ComparisonListOpenTest: ComparisonBaseTest {

    func testOpen() {
        Allure.addTestPalmLink("https://testpalm.yandex-team.ru/testcase/bluemarketapps-3504")
        Allure.addEpic("Сравнение")
        Allure.addFeature("Экран списков сравнения")
        Allure.addTitle("Переход на экран сравнения КМ.")

        let navigationBar = NavigationBarPage.current
        var comparisonList: ComparisonListPage!
        var comparison: ComparisonPage!

        "Перейти в сравнения".ybm_run { _ in
            comparisonList = goToComparison()
        }

        "Тапнуть на название категории".ybm_run { _ in
            wait(forVisibilityOf: comparisonList.fistComparisonCell.element)
            comparison = comparisonList.fistComparisonCell.tap()
        }

        "Проверяем что открылась правильная категория".ybm_run { _ in
            XCTAssertTrue(navigationBar.title.isVisible)
            XCTAssertEqual(navigationBar.title.label, "Средства для посудомоечных машин")

            wait(forExistanceOf: comparison.allCharacteristics.element)
            XCTAssertTrue(comparison.allCharacteristics.element.isVisible)

            let modelCell = comparison.collectionView.modelCell(with: 0)
            wait(forExistanceOf: modelCell.element)
            XCTAssertEqual(
                modelCell.title.element.label,
                "Fairy Platinum All in 1 капсулы (лимон) для посудомоечной машины, 8 шт."
            )
            XCTAssertEqual(modelCell.price.element.label, "251 ₽")
            XCTAssertTrue(modelCell.photo.element.exists)

            let opinionCell = comparison.collectionView.opinionCell(with: 0)
            wait(forExistanceOf: opinionCell.element)
            XCTAssertEqual(opinionCell.count.element.label, "269 отзывов")
            XCTAssertEqual(opinionCell.rating.element.label, "4.5")

            comparison.collectionView.element.swipe(to: .down, untilVisible: comparison.deleteListButton.element)
            XCTAssertTrue(comparison.deleteListButton.element.isVisible)
        }
    }
}
