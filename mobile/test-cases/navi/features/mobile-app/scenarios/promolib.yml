components: promolib
testing:
  - regress
integration_run:
  - promolib

specs:
  Работа баннеров поисковой рекламы и промолибы.:
    - info: |
        Для тестирования промолибы нужно создавать рекламную компанию. С вопросами обращаться к менеджерам.
        Удобно использовать сборку release_stesting. В этом случае используется тестовый сервер Промолибы, на котором должны сейчас быть баннеры (если их включили). 
        Алгоритм нахождения Промолибы:
        - Скачать сборку release_stesting с беты.
        - Пройти через интро-скрины и перейти на главный экран.
        - Если промолибы нет (такое может быть), то перейти на другой экран, затем вернуться на карту. Она должна там появиться.
        - Можно почистить данные (если это Андроид) или переустановить (если iOS) и повторить.
        Если на release сборке удаётся этим же алгоритмом находить промолибу, можно тестить на ней.
    - do: |
        Проверка общих условий (справедливы для баннера поисковой рекламы и для промолибы):
        - Проверить, когда скорость > 0
        - Посмотреть на экранах "Поиск", "Карта", "Мои места", "Меню"
        - Открыть  long-tap меню
        - Во время поиска тап на пин, затем на появившийся баллун
        - Во время поиска тап на крестик - отмену поиска
        - Построить маршрут (и во время маршрута)
        - Если баннер скрылся, то назад он не возвращается. Пример: если в поиске выбрали "рестораны", появился баннер "МакДоналдс", перешли в "Закладки", затем обратно на карту, баннер пропадает.
    - assert: |
        - Баннер показывается, и держится 4 секунды
        - Баннер может показываться только на экране с картой
        - Баннер скрывается
        - Баннер скрывается
        - Баннер скрывается
        - Баннер не показывается
        - Баннер не показывается
    - do: |
        Проверка специальных условий для Промолибы:
        - Проверить в landscape ориентации
        - Имеет приоритет ниже, чем баннер поисковой рекламы. То есть во время показа баннера поисковой рекламы промолиба показываться не может.
        - Проверить в дневном и ночном режимах
        - Проверить переход из дневного режима в ночной
        - Проверить взаимодействие с SearchLib-ой
    - assert: |
        - Баннер не показывается
        - Баннер не показывается
        - Баннер меняет цвет согласно выбранному режиму
        - Баннер изменяется так же, как и фон
        - Промолиба и SearchLib-а не показываются одновременно
    - do: |
        Проверка взаимодействия с баннером (любым):
        - Тап на него. В этот момент может открыться внешняя ссылка или выполниться поиск (для поискового баннера)
        - Тап на крестик
        - Свайпнуть баннер. На Android'e - влево/вправо, на iOS - вверх
        - Выгрузить/ свернуть приложение во время показа баннера
        - Позвонить или принять звонок во время показа баннера
    - assert: Все эти действия приводят к закрытию баннера.
    - do: |
        Проверка логирования.
        - При открытии баннера
        - При закрытии/тапе по баннер
    - assert: |
        - При показе в логах появляется:
        - Для баннера поисковой рекламы: "monetization.banner-show" с полями:
        "id" - идентификатор баннера
        - Для промолибы: "promolib-show"
        2)При закрытии в логах появляется:
        - Для баннера поисковой рекламы: "monetization.banner-close" с полями:
        "id" - идентификатор баннера
        "reason" - причина закрытия. Одна из click/close/swipe/default. default - по логике приложения, например, перешли на другой экран.
        - Для Промолибы: "promolib-hide" с полем:
        "reason" - причина закрытия. Одна из click/close/swipe/default/timeout. default - как выше. timeout - закрытие по таймауту. Это происходит, когда Promolib SDK этого захочет.
        3)Дополнительно при тапе на баннер поисковой рекламы появляется "monetization.banner-tap" с "id".
    - do: |
        Проверка вёрстки. 
        Не съехала для разных баннеров на разных девайсах. 
        Промолиба имеет фиксированный размер по ширине, и на планшетах и больших iPhone’ах занимает не всё пространство по ширине. Баннер промолибы перекрывает светофор пробок.
    - assert: |
        http://jing.yandex-team.ru/files/sushcheva/2017-05-23_1148.png - android
        http://jing.yandex-team.ru/files/sushcheva/2017-05-23_1151.png - ios
        Текст на баннерах может быть разный

    - platforms:
      - ios
      - android
    - tags:
        - metric


  Проверка отключения поисковой рекламы и промолибы на гу:
    - description: |
        - В каршеринге не должна отображаться поисковая реклама и баннеры промолибы, ни на экране карты ни в меню.
        - На ГУ тоже не должна отображаться реклама.
    - do: |
        - Запустить Навигатор,
        - Перейти на экран карты
    - assert: Промолиба не отображается
    - do: |
        - Перейти в Меню
        - Вернуться на экран карты
    - assert: Промолиба не отображается
    - do: Перейти на экран категорий поиска
    - assert: В категория поиска нет брендированных пунктов
    - do: |
        - Построить маршрут
        - Проехать по маршруту
    - assert: По маршруту не появляются брендированные пины и билборды
    - do: Перейти в раздел Меню
    - assert: |
        - Убедиться что в Инструментах не отображается пункт Скидки и подарки
        - В Настройки -> Карта и интерфейс нет подраздела Другие настройки (в нем были настройки рекламы)

    - platforms:
      - motrex
      - geely
      - autochip
      - vaz
      - carsharing_t3
      - nissan
      - t3am
    - testing:
      - acceptance_navi


  Работа баннеров поисковой рекламы и промолибы (быстрая проверка).:
    - description: |
        Корректное отображение и взаимодействие с баннером промолибы/баннером поисковой рекламы.
        Промолиба это рекламное предложение. Промолиба имеет фиксированный размер по ширине, и на планшетах и больших iPhone’ах занимает не всё пространство по ширине. Располагается в верхней части экрана
        Уточнение по логике показа (6.12.2019): Сейчас логика такая, что на пользователя максимальная частота в сутки 3 показа (в совокупности на все сервисы). Если закрыл баннер, то не показ опять же всех сервисов в течение 14 дней (именно в навике, в остальных закрытие на 7 дней)
        Как выглядит промолиба: https://jing.yandex-team.ru/files/fedonina71/photo_2020-08-21%2017.55.21.jpeg
    - info: |
        - Выполнить чистую установку(iOS) либо чистку данных(Android) приложения
        - Показ промолибы (для проверки UI и логики скрытия) можно профорсировать с помощью сниффера Charles и инструмента Rewrite. Чтобы заработало, нужно настроить Charles, настроить и включить SSL Proxying для ответа от https://mobile.yandexadexchange.net, открыть Tools > Rewrite и импортировать приложенный( https://jing.yandex-team.ru/files/kuznetsovmark/2promolib_fde_idfa_uuid.xml ). Этот файл меняет продовые пейджы промолибы на тестовый и меняет uuid и idfa в запросах к БК.
        - Теперь на запуске приложения получаем баннер на главном экране. Каждый раз, когда вместо баннера приходит 204 No Content, увеличить на единицу вручную uuid и idfa.
    - do: |
        Проверка взаимодействия с баннером (любым):
        - Тап на него. В этот момент может открыться внешняя ссылка или выполниться поиск (для поискового баннера)
        - Тап на крестик
        - Свайпнуть баннер. На Android’e - влево/вправо, на iOS - вверх
    - assert: Все эти действия приводят к закрытию баннера.
    - do: |
        - Выполнить чистую установку(iOS) либо чистку данных(Android) приложения
        Проверка вёрстки:
        - Проверяем верстку на разных устройствах, с разными размерами экрана.
        - Меняем ориентацию девайса
    - assert: Верстка не съехала для разных баннеров на разных девайсах.

    - platforms:
      - ios
      - android
    - tags:
        - assessors
    - testing:
      - acceptance_navi


  Логика отображения промобаннера iOS:
    - info: |
        - Выполнить чистую установку
        - Пройти интроскрины
        - Charles -> Tools -> Rewrite и импортировать приложенный ( https://jing.yandex-team.ru/files/kuznetsovmark/2promolib_fde_idfa_uuid.xml )
        - Каждый раз, когда вместо баннера приходит 204 No Content, увеличить на единицу вручную uuid и idfa в Rewrite
        - Приложение не запущено
    - do: |
        - Построить маршрут через Xcode и запустить ведение по маршруту через Xcode
        - Запустить приложение
    - assert: |
        - Появляется промобаннер
        - Курсор находится в freedrive ведении
        - Спустя 4 секунды ведения, промобаннер скрывается

    - platforms:
        - ios
    - testing:
        - acceptance_navi


  Логика отображения баннера Android:
    - info: |
        - Выполнить чистку данных приложения
        - Пройти интроскрины
        - Charles -> Tools -> Rewrite и импортировать приложенный ( https://jing.yandex-team.ru/files/kuznetsovmark/2promolib_fde_idfa_uuid.xml )
        - Каждый раз, когда вместо баннера приходит 204 No Content, увеличить на единицу вручную uuid и idfa в Rewrite
        - Приложение не запущено
        - На девайсе отключен socks
    - do: |
        - Построить маршрут через Mock Location и запустить ведение по маршруту через Mock Location
        - Включить socks на девайсе
        - Запустить приложение
    - assert: |
        - Появляется промобаннер
        - Курсор находится в freedrive ведении
        - Спустя 4 секунды ведения, промобаннер скрывается

    - platforms:
        - android
    - tags:
        - assessors
    - testing:
        - acceptance_navi