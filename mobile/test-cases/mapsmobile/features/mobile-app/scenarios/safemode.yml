components: safemode
testing:
  - regress

aliases:
  - &активация_защищенного_режима
    - info: |
        Защищенный режим - это особый режим приложения с урезанной функциональностью, позволяющий избежать крэшей на старте
        В защищенном режиме отключаются все эксперименты и чистится кэш
        Защищенный режим активируется после трех крэшей, если прошло менее 30 секунд от момента запуска приложения
    - do: |
        Включить эксперимент, используя интент:
        [collapsed-image](https://jing.yandex-team.ru/files/polikashinaol/включение_экп_safe_mode.png){title=QR-код}

        `yandexmaps://add_exp?safe_mode`
    - do: |
        Менее чем за 30 сек от запуска приложения сымитировать крэш
        (Меню -> Настройки > Debug Panel > Various > (ios) Make NSExpection crash / (android) Make JVM crash)
    - assert: Приложение крэшится
    - do: Запустить приложение
    - do: |
        Менее чем за 30 сек от запуска приложения сымитировать крэш
        (Меню -> Настройки > Debug Panel > Various > (ios) Make NSExpection crash / (android) Make JVM crash)
    - assert: Приложение крэшится
    - do: Запустить приложение
    - do: |
        Менее чем за 30 сек от запуска приложения сымитировать крэш
        (Меню -> Настройки > Debug Panel > Various > (ios) Make NSExpection crash / (android) Make JVM crash)
    - assert: Приложение крэшится
    - do: Запустить приложение
    - assert: Приложение запустилось в защищенном режиме

specs:
  Защищенный режим. Включение:
    - *активация_защищенного_режима
    - do: Перейти в Настройки > Debug Panel > Experiments
    - assert: |
        В разделе Test Buckets отсутствуют эксперименты
        В разделе Known UI Experiments тоглы всех экспериментов выключены

    - platforms:
        - ios
        - android
    - testing:
        - acceptance_maps
    - tags:
        - assessors


  Защищенный режим. Невозможность включения экспериментов:
    - *активация_защищенного_режима
    - do: |
        Включить несколько экспериментов, например
        новые настройки (Меню -> Настройки > Debug Panel > Experiments > new_maps_settings)
        курсоры навигатора (Меню -> Настройки > Debug Panel > Experiments > navi_cursors)
    - do: Перезапустить приложение с выгрузкой из памяти
    - assert: |
        Эксперименты не включились:
        Новый ui экрана настроек не применен
        В разделе Настройки > Маршруты нет настройки "Курсор"

    - platforms:
        - ios
        - android
    - tags:
        - assessors


  Защищенный режим. Зачистка startup конфига:
    - *активация_защищенного_режима
    - do: Тап на пин станции метро в Москве
    - assert: |
        Открылась мини-карточка станции метро
        В карточке не отображается иконка человека с количеством людей на станции
    - do: Перейти в Настройки > Маршруты > Звук > Голос
    - assert: |
        Отображаются только стандартные голоса (Алиса, Оксана, Дмитрий)
        Блок "Доступные" для скачивания отсутствует

    - platforms:
        - ios
        - android
    - tags:
        - assessors


  Защищенный режим. Зачистка кэша:
    - *активация_защищенного_режима
    - do: Позумить и поскролить карту
    - do: Перейти в настройки девайса > Приложения > Яндекс Карты > Память > Кэш (на разных девайсах путь в настройках может отличаться)
    - assert: При использовании приложения размер кэша увеличивается
    - do: Открыть на просмотр несколько карточек организаций
    - assert: При использовании приложения размер кэша увеличивается
    - do: Перезапустить приложение с выгрузкой из памяти
    - assert: Размер кэша приложения в настройках девайса сильно уменьшился

    - platforms:
        - android
    - tags:
        - assessors


  Защищенный режим. Отключение:
    - *активация_защищенного_режима
    - do: Перейти в Настройки > Debug Panel > Experiments
    - assert: |
        В разделе Test Buckets отсутствуют эксперименты
        В разделе Known UI Experiments тоглы всех экспериментов выключены
    - do: Перевести время на девайсе на 2 часа вперед
    - do: Перезапустить приложение
    - assert: Приложение вышло из защищенного режима
    - do: Перейти в Настройки > Debug Panel > Experiments
    - assert: |
        В разделе Test Buckets присутствуют эксперименты
        В разделе Known UI Experiments тоглы некоторых экспериментов снова включены

    - platforms:
        - ios
        - android
    - testing:
        - acceptance_maps
    - tags:
        - assessors


  Защищенный режим. Отсутсвие перезапросов для startup config:
    - info: |
        Защищенный режим - это особый режим приложения с урезанной функциональностью, позволяющий избежать крэшей на старте
        В защищенном режиме отключаются все эксперименты и чистится кэш
        Защищенный режим активируется после трех крэшей
    - info: Устройство подключено к Чарльз для перехвата трафика
    - do: |
        Подготовить подмену кода ответа на 401 для конфига
        iOS: https://mobile-maps-common.s3.yandex.net/configs/production/*/ru.yandex.traffic/@*/
        Android: https://mobile-maps-common.s3.yandex.net/configs/production/*/ru.yandex.yandexmaps/@*/
        т. к. приложение ходит в нужную ручку один раз в день, то достаточно перевести время девайса на 24 часа, скопировать указанный URL и вставить в инструмент Rewrite
    - do: Переустановить приложение
    - assert: Приложение запрашивает конфиг на старте
    - do: Перезапустить приложение
    - assert: Приложение перезапрашивает конфиг, т. к. не получил его при первом старте приложения
    - do: |
        Включить эксперимент, используя интент:
        [collapsed-image](https://jing.yandex-team.ru/files/polikashinaol/включение_экп_safe_mode.png){title=QR-код}

        `yandexmaps://add_exp?safe_mode`
    - do: |
        Менее чем за 30 сек от запуска приложения сымитировать крэш
        (Меню -> Настройки > Debug Panel > Various > (ios) Make NSExpection crash / (android) Make JVM crash)
    - assert: Приложение крэшится
    - do: Запустить приложение
    - do: |
        Менее чем за 30 сек от запуска приложения сымитировать крэш
        (Меню -> Настройки > Debug Panel > Various > (ios) Make NSExpection crash / (android) Make JVM crash)
    - assert: Приложение крэшится
    - do: Запустить приложение
    - do: |
        Менее чем за 30 сек от запуска приложения сымитировать крэш
        (Меню -> Настройки > Debug Panel > Various > (ios) Make NSExpection crash / (android) Make JVM crash)
    - assert: Приложение крэшится
    - do: Запустить приложение
    - assert: Приложение запустилось в защищенном режиме
    - do: Перезапустить приложение
    - assert: Приложение не запрашивает конфиг

    - platforms:
        - ios
        - android


  Защищенный режим. Отсутсвие зачистки без включения эксперимента safe_mode:
    - info: |
        Защищенный режим - это особый режим приложения с урезанной функциональностью, позволяющий избежать крэшей на старте
        В защищенном режиме отключаются все эксперименты и чистится кэш
        Защищенный режим активируется после трех крэшей
    - do: Переустановить приложение
    - do: |
        Менее чем за 30 сек от запуска приложения сымитировать крэш
        (Меню -> Настройки > Debug Panel > Various > (ios) Make NSExpection crash / (android) Make JVM crash)
    - assert: Приложение крэшится
    - do: Запустить приложение
    - do: |
        Менее чем за 30 сек от запуска приложения сымитировать крэш
        (Меню -> Настройки > Debug Panel > Various > (ios) Make NSExpection crash / (android) Make JVM crash)
    - assert: Приложение крэшится
    - do: Запустить приложение
    - do: |
        Менее чем за 30 сек от запуска приложения сымитировать крэш
        (Меню -> Настройки > Debug Panel > Various > (ios) Make NSExpection crash / (android) Make JVM crash)
    - assert: Приложение крэшится
    - do: Запустить приложение
    - assert: Приложение не запустилось в защищенном режиме
    - do: Перейти в Настройки > Debug Panel > Experiments
    - assert: |
        В разделе Test Buckets присутствуют эксперименты
        В разделе Known UI Experiments тоглы некоторых экспериментов включены

    - platforms:
        - ios
        - android
    - tags:
        - assessors


  Защищенный режим. Зачистка кэшей showcase_config:
    - *активация_защищенного_режима
    - do: Тап на таб Поиск
    - assert: |
        Отображаются поисковые категории
        Блок со сторис и подборками отсутствует

    - platforms:
        - ios
    - tags:
        - assessors


  Защищенный режим. Зачистка кэшей mapstyle_config:
    - *активация_защищенного_режима
    - do: Посмотреть подписи улиц на карте зумясь к ним
    - do: |
        Отображаются подписи улиц на карте
        Под подписями отображаются желтые маркеры

    - platforms:
        - ios
    - tags:
        - assessors


  Защищенный режим. Зачистка кэшей notification_config:
    - info: |
        Защищенный режим - это особый режим приложения с урезанной функциональностью, позволяющий избежать крэшей на старте
        В защищенном режиме отключаются все эксперименты и чистится кэш
        Защищенный режим активируется после трех крэшей
    - do: |
        Включить эксперименты, используя интент:
        [collapsed-image](https://jing.yandex-team.ru/files/linakolpakova/exps.b0ff55d.png){title=QR-код}

        `yandexmaps://add_exp?transport_emergency_notification&safe_mode`
    - do: Включить testing (Меню -> Настройки -> дебаг-панель -> Environment -> Mobmaps proxy host)
    - do: Закрыть дебаг-панель
    - do: Перезапустить приложение
    - do: Открыть спан Москвы
    - do: Отображается нотификация
    - do: |
        Менее чем за 30 сек от запуска приложения сымитировать крэш
        (Меню -> Настройки > Debug Panel > Various > (ios) Make NSExpection crash / (android) Make JVM crash)
    - assert: Приложение крэшится
    - do: Запустить приложение
    - do: |
        Менее чем за 30 сек от запуска приложения сымитировать крэш
        (Меню -> Настройки > Debug Panel > Various > (ios) Make NSExpection crash / (android) Make JVM crash)
    - assert: Приложение крэшится
    - do: Запустить приложение
    - do: |
        Менее чем за 30 сек от запуска приложения сымитировать крэш
        (Меню -> Настройки > Debug Panel > Various > (ios) Make NSExpection crash / (android) Make JVM crash)
    - assert: Приложение крэшится
    - do: Запустить приложение
    - assert: Приложение запустилось в защищенном режиме
    - do: |
        Включить эксперимент, используя интент:
        [collapsed-image](https://jing.yandex-team.ru/files/linakolpakova/transport_emergency.c7ded8a.png){title=QR-код}

        `yandexmaps://add_exp?transport_emergency_notification`
    - do: Открыть спан Москвы
    - assert: Нотификация не отображается

    - platforms:
        - ios
    - tags:
        - assessors

