components: taxi_native_payment
testing:
  - regress

specs:

  Оплата такси за наличный расчет:
    - info: |
        Нужно тестировать во внутренней сети (подключить к Charles с включенным TunnelBlick)
          Дебаг-панель -> Webview -> Taxi webview base url -> testing
          Дебаг-панель -> Webview -> Taxi orders history webview base url -> testing
          Дебаг-панель -> Environment -> Passport Environment -> TESTING
          Дебаг-панель -> Environment -> Mobmaps Proxy host -> TESTING
          Дебаг-панель -> Environment -> PaymentSDK Environment -> TESTING
        Авторизоваться аккаунтом тестового паспорта yndx-kripp-le-ami606 gen2752
        В дебаг-панели включить эксперимент taxi_native_order_in_taxi_tab со значением ALWAYS_OPEN
    - do: Построить маршрут в пределах видимой области экрана
    - assert: Построен маршрут
    - do: Перейти в таб Такси
    - assert: |
        Открыт таб Такси
        Отображается дефолтный способ оплаты - наличные
    - do: Тап Заказать такси
    - assert: Отображается экран с Лицензионным соглашением
    - do: Принять лицензионное соглашение
    - assert: Происходит переход в вебвью, идет поиск машины
    - do: Закрыть вебвью и вернуться на главный экран
    - assert: Отображается плашка со статусом заказа
    - do: Дождаться пока заказ пройдет через все статусы (поиск, машина едет к вам, в пути, прибыли)
    - assert: Плашка с заказом не отображается
    - do: Тап меню - История поездок и заказов
    - assert: Отображается завершенная поездка

    - platforms:
        - ios
        - android
    - tags:
        - newbie
    - testing:
        - lite_acceptance_maps


  Оплата такси за безналичный расчет:
    - info: Нужно тестировать во внутренней сети (подключить к Charles с включенным TunnelBlick)
    - do: |
        Использовать интент [collapsed-image](https://jing.yandex-team.ru/files/nikmakarov23/taxi_native_order_in_taxi_tab%3DALWAYS_OPEN.png){title=QR-код}

        `yandexmaps://add_exp?taxi_native_order_in_taxi_tab=ALWAYS_OPEN`
    - do: Включить тычку Дебаг-панель -> Webview -> Taxi webview base url -> testing
    - do: Включить тычку Дебаг-панель -> Webview -> Taxi orders history webview base url -> testing
    - do: Включить тычку Дебаг-панель -> Environment -> Passport Environment -> TESTING
    - do: Дебаг-панель -> Environment -> Mobmaps Proxy host -> TESTING
    - do: Включить тычку Дебаг-панель -> Environment -> PaymentSDK Environment -> TESTING
    - do: Перезапустить приложение
    - do: Авторизоваться аккаунтом тестового паспорта login m4pst3st2 pass yandex123
    - do: Построить маршрут в пределах видимой области экрана
    - assert: Построен маршрут
    - do: Перейти в таб Такси
    - assert: |
        Открыт таб Такси
        Отображается дефолтный способ оплаты - наличные
    - do: Выбрать другой способ оплаты - банковскую карту
    - do: Тап готово
    - assert: |
        В способе оплаты отображается банковская карта
        Если карта не отображается, ее необходимо верифицировать через тестинг ГО (https://wiki.yandex-team.ru/maps/mobile/testing/how-to-make-plus-points-testing/#glava4.nakrutkaballovpljusabezsmsiregistracii)
    - do: Тап Заказать такси
    - assert: Отображается экран с Лицензионным соглашением
    - do: Принять лицензионное соглашение
    - assert: Происходит переход в вебвью, идет поиск машины
    - do: Закрыть вебвью и вернуться на главный экран
    - assert: Отображается плашка со статусом заказа
    - do: Дождаться пока заказ пройдет через все статусы (поиск, машина едет к вам, в пути, прибыли)
    - assert: Плашка с заказом не отображается
    - do: Тап меню - История поездок и заказов
    - assert: Отображается завершенная поездка

    - platforms:
        - ios
        - android
    - testing:
        - lite_acceptance_maps
    - integration_run:
        - payment_sdk
    - tags:
        - newbie


  Добавление банковской карты в нативной карточке Такси:
    - info: |
        В дебаг-панели включен эксперимент - taxi_native_order_in_taxi_tab со значением ALWAYS OPEN
        Пользователь авторизован
        Построен маршрут на Такси
    - do: Тап на выбор способа оплаты
    - assert: |
        Отображается экран способа оплаты
        Могут отображаться ранее добавленные карты
    - do: Тап Привязать карту
    - assert: Открывается экран ввода данных новой карты
    - do: Добавить карту, созданную через бота в телеграмм https://t.me/+rSZy5ecx2lszNWVi
    - do: Ввести код из смс
    - assert: |
        Вебвью подтверждения карты закрывается
        Отображается экран с надписью "Карта добавлена" и кнопкой подтверждения
    - do: Подтвердить добавление карты
    - assert: |
        Отображается экран способа оплаты
        Надпись "Подтвердите карту" у неверифицированной карты пропала

    - platforms:
        - android
        - ios
    - tags:
        - advertisement
    - integration_run:
        - payment_sdk


  Верификация банковской карты в нативной карточке Такси:
    - description: |
        Чтобы увидеть банковскую карту как неверифицированную, нужно с другого девайса в Go или через веб-интерфейс Паспорта с ПК привязать карту.
        Банковская карта, привязанная на устройстве с установленными Картами, будет отображаться как верифицированная (даже через Go).
    - info: |
        В дебаг-панели включен эксперимент - taxi_native_order_in_taxi_tab со значением ALWAYS OPEN
        Пользователь авторизован
        Добавлена банковская карта через Go на устройстве с установленными Картами
        Добавлена банковская карта через Go/веб-интерфейс Паспорта на другом устройстве
        Построен маршрут на Такси
    - do: Тап на выбор способа оплаты
    - assert: |
        Отображается экран способа оплаты
        Отображается верифицированная банковская карта (добавленная на этом же устройстве)
        Отображается неверифицированная банковская карта (добавленная на другом устройстве) с подписью "Подтвердите карту"
    - do: Тап на неверифицированную карту
    - assert: Открывается вебвью с полем для ввода кода подтверждения карты
    - do: Ввести код из смс
    - assert: |
        Вебвью подтверждения карты закрывается
        Отображается экран с надписью "Карта добавлена" и кнопкой подтверждения
    - do: Подтвердить добавление карты
    - assert: |
        Отображается экран способа оплаты
        Надпись "Подтвердите карту" у неверифицированной карты пропала

    - platforms:
        - android
        - ios
    - tags:
        - advertisement
    - integration_run:
        - payment_sdk


  Оплата нативного такси через Google pay:
    - info: |
        Установленно приложение Google Pay и добавлена карта из [инструкции](https://wiki.yandex-team.ru/jandekskarty/testing/navi/rasxody-po-korp-karte/)
        Необходимо находиться во внутренней сети VPN через Charles
        Пользователь авторизован
        Включить эксперименты
        Дебаг-панель -> Experiments -> taxi_native_order_in_taxi_tab -> WEB_VIEW_ALWAYS_OPEN
        Дебаг-панель -> Experiments -> taxi_webview_googlepay -> включить
    - do: Построить маршрут
    - do: Открыть таб такси
    - do: Тап по кнопке способа оплаты
    - do: Выбрать Google Pay как способ оплаты
    - do: Тап "Готово"
    - assert: Способ оплаты изменился на Google Pay
    - do: Выбрать любой тариф
    - do: Тап "Заказать такси"
    - assert: |
        При выборе тафира способ оплаты не сбросился
        Происходит переход в вебвью
        Идет поиск машины
    - do: Выйти из вебвью
    - do: Дождаться окончания поездки
    - assert: |
        Поездка завершена

    - platforms:
        - android
    - integration_run:
        - payment_sdk


  Отмена пользовательского соглашения при первом заказе такси:
    - info: |
        Пользователь авторизован
        Пользователь не вызывал такси ранее
        В дебаг-панели включить эксперимент taxi_native_order_in_taxi_tab со значением ALWAYS_OPEN
        Построен маршрут на такси
        Выбран тип оплаты по умолчанию - наличными
    - do: Тап "Заказать такси"
    - assert: |
        Отображается попап с информацией о пользовательском соглашении
        На экране присутствует: ссылка на условия использования,
        Кнопка Продолжения и кнопка Отмены
    - do: Тап на ссылку условий использования
    - assert: Открылось вебвью с выбором языка
    - do: Выбрать любой язык
    - assert: Отображается пользовательское соглашение
    - do: Закрыть вебвью
    - do: Тап "Отменить"
    - assert: |
        Открыт таб Такси
        Отображается способ оплаты по умолчанию - наличные
    - do: Тап "Заказать такси"
    - assert: |
        Отображается попап с информацией о пользовательском соглашении
        На экране присутствует: ссылка на условия использования,
        Кнопка Продолжения и кнопка Отмены

    - platforms:
        - android
        - ios
    - testing:
        - lite_acceptance_maps
    - tags:
        - newbie


  Принятие пользовательского соглашения при первом заказе такси:
    - info: |
        Пользователь авторизован
        Пользователь не вызывал такси ранее
        У пользователя добавлена карта оплаты
        В дебаг-панели включить эксперимент taxi_native_order_in_taxi_tab со значением ALWAYS_OPEN
        Построен маршрут на такси
    - do: Тап "Заказать такси"
    - assert: |
        Отображается попап с информацией о пользовательском соглашении
        На экране присутствует: ссылка на условия использования,
        Кнопка Продолжения и кнопка Отмены
    - do: Тап на ссылку условий использования
    - assert: Открылось вебвью с выбором языка
    - do: Выбрать любой язык
    - assert: Отображается пользовательское соглашение
    - do: Закрыть вебвью
    - do: Тап на кнопку продолжения заказа такси
    - assert: Открылось вебвью с созданным заказом
    - do: Закрыть поиск такси
    - do: Тап "Заказать такси"
    - assert: |
        Попап  с информацией о пользовательском соглашении не показывается
        Открылось вебвью с созданным заказом

    - platforms:
        - android
        - ios
    - testing:
        - lite_acceptance_maps
    - tags:
        - newbie


  Оплата такси через Apple Pay:
    - info: |
        Проверка производится только на сборке Testflight или Store
        В приложение Wallet добавлена карта
        Пользователь авторизован аккаунтом, привязанным ко Стаффу
        Получены эксперименты:
        Дебаг-панель -> Experiments -> taxi_native_order_in_taxi_tab -> ALWAYS_OPEN
        Дебаг-панель -> Experiments -> taxi_open_webview = WEB_VIEW_ALWAYS_OPEN
        Дебаг-панель -> Experiments -> taxi_webview_applepay
        Необходимо строить короткий маршрут на такси для небольшой стоимости заказа
    - do: Построить маршрут
    - do: Выбрать таб Такси
    - do: Тап по кнопке способа оплаты
    - do: Выбрать Apple Pay, как способ оплаты
    - do: Тап по "Готово"
    - assert: Выбран Apple Pay, как способ оплаты
    - do: Выбрать любой тариф такси
    - do: Тап по "Заказать такси"
    - assert: Отображается штора подтверждения оплаты
    - do: Подтвердить оплату
    - assert: |
        Происходит переход в вебвью
        Идет поиск машины
        В шторе с информацией о заказе выбран Apple Pay, как способ оплаты
    - do: Выйти из вебвью
    - assert: Внизу экрана отображается плашка со статусом заказа такси
    - do: Тап по Смотреть в плашке
    - assert: |
        Происходит переход в вебвью
        В шторе с информацией о заказе выбран Apple Pay, как способ оплаты
    - do: Дождаться окончания поездки
    - assert: |
        Поездка завершена
        Происходит оплата заказа и списание средств
        На главном экране МЯК не отображается плашка со статусом заказа такси

    - platforms:
        - ios
    - integration_run:
        - payment_sdk


  #Отсутствие способа оплаты Apple Pay в такси, если карта не добавлена: КЕЙС ЗАКОММЕНТИРОВАН В СВЯЗИ С ОКЛЮЧЕНИЕМ APPLE PAY В РОССИИ
  #  - info: |
  #    Проверка производится только на сборке Testflight или Store
  #    В приложение Wallet добавлена карта
  #    Пользователь авторизован аккаунтом, привязанным ко Стаффу
  #    Получены эксперименты:
  #    Дебаг-панель -> Experiments -> taxi_native_order_in_taxi_tab -> ALWAYS_OPEN
  #    Дебаг-панель -> Experiments -> taxi_open_webview = WEB_VIEW_ALWAYS_OPEN
  #    Дебаг-панель -> Experiments -> taxi_webview_applepay
  # - do: Построить маршрут
  # - do: Выбрать таб Такси
  # - do: Тап по кнопке способа оплаты
  # - do: Выбрать Apple Pay, как способ оплаты
  # - do: Тап по "Готово"
  # - assert: Выбран Apple Pay, как способ оплаты
  # - do: Свернуть/развернуть приложение
  # - assert: Выбран Apple Pay, как способ оплаты
  # - do: Удалить карту из приложения Wallet
  # - do: Перезапустить МЯК
  # - assert: |
  #    Откыт экран выбора маршрута
  #    Выбран таб Такси
  #    Наличные выбраны, как способ оплаты
  # - do: Тап по кнопке способа оплаты
  # - assert: Apple Pay, как способ оплаты не отображается
  #
  # - platforms:
  #    - ios
  # - tags:
  #    - assessors
  # - testing:
  #    - acceptance_maps


  Сохранение способа оплаты Apple Pay при отмене заказе такси:
    - info: |
        Проверка производится только на сборке Testflight или Store
        В приложение Wallet добавлена карта
        Пользователь авторизован аккаунтом, привязанным ко Стаффу
        Получены эксперименты:
        Дебаг-панель -> Experiments -> taxi_native_order_in_taxi_tab -> ALWAYS_OPEN
        Дебаг-панель -> Experiments -> taxi_open_webview = WEB_VIEW_ALWAYS_OPEN
        Дебаг-панель -> Experiments -> taxi_webview_applepay
        Для тестирования подбирайте такой маршрут, чтобы ожидание машины составляло около 5 минут или более
        Необходимо отменить заказ до того как машина приедет в начальную точку во избежание снятия средств
    - do: Построить маршрут
    - do: Выбрать таб Такси
    - do: Тап по кнопке способа оплаты
    - do: Выбрать Apple Pay, как способ оплаты
    - do: Тап по "Готово"
    - assert: Выбран Apple Pay, как способ оплаты
    - do: Выбрать любой тариф такси
    - do: Тап по "Заказать такси"
    - assert: Отображается штора подтверждения оплаты
    - do: Подтвердить оплату
    - assert: |
        Происходит переход в вебвью
        Идет поиск машины
        В шторе с информацией о заказе выбран Apple Pay, как способ оплаты
    - do: Тап на Отменить
    - do: Подтвердить отмену заказа
    - assert: Заказ успешно отменен
    - do: Закрыть вебвью
    - assert: В нативной карточке такси выбран Apple Pay, как способ оплаты

    - platforms:
        - ios
    - integration_run:
        - payment_sdk


  Автоматический выбор последнего использованого для заказа способа оплаты при включенном эксперименте taxi_unverified_card_error:
    - info: |
        Получены эксперименты:
        Дебаг-панель -> Webview -> Taxi webview base url -> testing
        Дебаг-панель -> Environment -> Passport Environment -> TESTING
        Дебаг-панель -> Environment -> Mobmaps Proxy host -> TESTING
        Дебаг-панель -> Environment -> PaymentSDK Environment -> TESTING
        Дебаг-панель -> Experiments -> taxi_native_order_in_taxi_tab -> ALWAYS_OPEN
        Дебаг-панель -> Experiments -> taxi_unverified_card_error -> SHOW (или DONT_SHOW для данного ТК не важно)
        Нужно тестировать во внутренней сети (подключить к Charles с включенным TunnelBlick)
        Авторизоваться аккаунтом тестового паспорта yndx-kripp-le-ami606 gen2752
        Для проверки необходимо иметь дополнительное Android-устройство с установленной версией Яндекс.Go отсюда:
        https://beta.m.soft.yandex.ru/description?app=taxi&platform_shortcut=android&branch=dev-develop (ветка dev-develop).
    - do: Сгенерить новую банковскую карту с помощью https://t.me/+rSZy5ecx2lszNWVi
    - do: Открыть Яндекс.Go на доп. Android-устройстве, залогиниться вышеупомянутым аккаунтом.
    - do: добавить эту банковскую карту
    - do: Заказать там (в Go) такси, используя только что добавленную карту.
    - do: Отменить поездку.
    - do: Построить в мобильном приложении Карт (уже на основном устройсте) маршрут между двумя точками в Москве.
    - do: Открыть таб Такси.
    - assert: |
        В способа оплаты отображается признак отсутствия верификации (восклицательный знак).
    - do: Нажать на иконку со способом оплаты.
    - assert: |
        Выбранной ранее добавленная карта.
        Она должна быть неверифицирована.

    - platforms:
        - android
        - ios

  Автоматический выбор последнего использованого для заказа способа оплаты при вЫключенном эксперименте taxi_unverified_card_error:
    - info: |
        Получены эксперименты:
        Дебаг-панель -> Webview -> Taxi webview base url -> testing
        Дебаг-панель -> Environment -> Passport Environment -> TESTING
        Дебаг-панель -> Environment -> Mobmaps Proxy host -> TESTING
        Дебаг-панель -> Environment -> PaymentSDK Environment -> TESTING
        Дебаг-панель -> Experiments -> taxi_native_order_in_taxi_tab -> ALWAYS_OPEN
        Дебаг-панель -> Experiments -> taxi_unverified_card_error -> null
        Нужно тестировать во внутренней сети (подключить к Charles с включенным TunnelBlick)
        Для проверки необходимо иметь дополнительное Android-устройство с установленной версией Яндекс.Go отсюда:
        https://beta.m.soft.yandex.ru/description?app=taxi&platform_shortcut=android&branch=dev-develop (ветка dev-develop, умеет ходить в тестинг паспорта)
        Авторизоваться аккаунтом тестового паспорта yndx-kripp-le-ami606 gen2752
    - do: Сгенерить новую банковскую карту с помощью https://t.me/+rSZy5ecx2lszNWVi
    - do: Открыть Яндекс.Go на доп. Android-устройстве, залогиниться вышеупомянутым аккаунтом.
    - do: добавить эту банковскую карту
    - do: Заказать там (в Go) такси, используя только что добавленную карту.
    - do: Отменить поездку.
    - do: Построить в мобильном приложении Карт маршрут между двумя точками в Москве.
    - do: Открыть таб Такси.
    - do: Нажать на иконку со способом оплаты.
    - assert: |
        В списке должна присутствовать только что добавленная банковская карта.
        Она должна быть неверифицирована.
        Она не должна быть выбрана.
        До прохождения верификации у карты отсутствует чек-бокс.

    - platforms:
        - android
        - ios

  Заказ такси с использование неверифицированной карты и экспериментом taxi_unverified_card_error SHOW:
    - info: |
        Получены эксперименты:
        Дебаг-панель -> Webview -> Taxi webview base url -> testing
        Дебаг-панель -> Environment -> Passport Environment -> TESTING
        Дебаг-панель -> Environment -> Mobmaps Proxy host -> TESTING
        Дебаг-панель -> Environment -> PaymentSDK Environment -> TESTING
        Дебаг-панель -> Experiments -> taxi_native_order_in_taxi_tab -> ALWAYS_OPEN
        Дебаг-панель -> Experiments -> taxi_unverified_card_error -> SHOW
        Нужно тестировать во внутренней сети (подключить к Charles с включенным TunnelBlick)
        Авторизоваться аккаунтом тестового паспорта yndx-kripp-le-ami606 gen2752
        Для проверки необходимо иметь дополнительное Android-устройство с установленной версией Яндекс.Go отсюда:
        https://beta.m.soft.yandex.ru/description?app=taxi&platform_shortcut=android&branch=dev-develop (ветка dev-develop, умеет ходить в тестинг паспорта)
        Сгенерить новую банковскую карту с помощью https://t.me/+rSZy5ecx2lszNWVi
        Зайти в Яндекс.Go на доп-устройстве, залогиниться вышеупомянутым аккаунтом и добавить эту банковскую карту.
    - do: Построить маршрут между двумя точками в Москве на основном устройстве.
    - do: Зайти в таб такси на экран маршрутов.
    - do: Зайти в список способов оплаты.
    - assert: Только что добавленная карта должна быть помечена как неверифицированная.
    - do: Тап по этой карте.
    - assert: Должен начаться процесс верификации.
    - do: Отменить верификацию (back на Android или крестик в 3DS вебвью на iOS).
    - assert: |
        Карта должна остаться неверифицированной.
        Она должна быть выбрана.
    - do: тап на "Готово"
    - do: тап на "Заказать"
    - assert: Должна показаться ошибка с предложением верифицировать карту.
    - do: Нажать на "Подтвердить"
    - assert: Должен запуститься процесс верификации карты.
    - do: Верифицировать карту.
    - do: Пройти дополнительные шаги, нужные для заказа, если таковые требуются, например принятие лицензионного соглашения.
    - assert: Открылось вебвью такси, там отображается информация о текущем заказе.

    - platforms:
        - android
        - ios
    - testing:
        - acceptance_maps

  Заказ такси с использование неверифицированной карты и экспериментом taxi_unverified_card_error DONT_SHOW:
    - info: |
        Получены эксперименты:
        Дебаг-панель -> Webview -> Taxi webview base url -> testing
        Дебаг-панель -> Environment -> Passport Environment -> TESTING
        Дебаг-панель -> Environment -> Mobmaps Proxy host -> TESTING
        Дебаг-панель -> Environment -> PaymentSDK Environment -> TESTING
        Дебаг-панель -> Experiments -> taxi_native_order_in_taxi_tab -> ALWAYS_OPEN
        Дебаг-панель -> Experiments -> taxi_unverified_card_error -> SHOW
        Нужно тестировать во внутренней сети (подключить к Charles с включенным TunnelBlick)
        Авторизоваться аккаунтом тестового паспорта yndx-kripp-le-ami606 gen2752
        Для проверки необходимо иметь дополнительное Android-устройство с установленной версией Яндекс.Go отсюда:
        https://beta.m.soft.yandex.ru/description?app=taxi&platform_shortcut=android&branch=dev-develop (ветка dev-develop, умеет ходить в тестинг паспорта)
        Сгенерить новую банковскую карту с помощью https://t.me/+rSZy5ecx2lszNWVi
        Зайти в Яндекс.Go на доп-устройстве, залогиниться вышеупомянутым аккаунтом и добавить эту банковскую карту.
    - do: Построить маршрут между двумя точками в Москве на основном устройстве.
    - do: Зайти в таб такси на экран маршрутов.
    - do: Зайти в список способов оплаты.
    - assert: Только что добавленная карта должна быть помечена как неверифицированная.
    - do: Тап по этой карте.
    - assert: Должен начаться процесс верификации.
    - do: Отменить верификацию (back на Android или крестик в 3DS вебвью на iOS).
    - assert: |
        Карта должна остаться неверифицированной.
        Она должна быть выбрана.
    - do: тап на "Готово"
    - do: тап на "Заказать"
    - assert: Должен открыться список способов оплаты.
    - do: Выбрать наличные или верифицированную карту.
    - do: тап на "Готово"
    - do: тап на "Заказать"
    - do: Пройти дополнительные шаги, нужные для заказа, если таковые требуются, например принятие лицензионного соглашения.
    - assert: Открылось вебвью такси, там отображается информация о текущем заказе.

    - platforms:
        - android
        - ios
