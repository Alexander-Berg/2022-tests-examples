components: parkings_payment
testing:
  - regress

aliases:
  - &exp_and_environment_auth
    - info: |
        Авторизоваться тестовым аккаунтом: yndx.tula.testers@yandex.ru / thisislegitpassword
    - do: |
        Использовать интент [collapsed-image](https://jing.yandex-team.ru/files/kuznetsova22/parking.png){title=QR-код}

        `yandexmaps://add_exp?parking_payment_enabled`
    - do: Дебаг-панель -> Environment -> Mobmaps Proxy host -> testing
    - do: Закрыть дебаг-панель
    - do: Перезапустить приложение
    - do: Открыть спан Москвы
    - do: Тап Слои -> Парковки
    - do: Закрыть экран слоев


  - &exp_and_environment_anon
    - info: Пользователь не авторизован
    - do: |
        Использовать интент [collapsed-image](https://jing.yandex-team.ru/files/kuznetsova22/parking.png){title=QR-код}

        `yandexmaps://add_exp?parking_payment_enabled`
    - do: Дебаг-панель -> Environment -> Mobmaps Proxy host -> testing
    - do: Закрыть дебаг-панель
    - do: Перезапустить приложение
    - do: Открыть спан Москвы
    - do: Тап Слои -> Парковки
    - do: Закрыть экран слоев


specs:
  Оплата парковки с помощью парковочного счета и завершение:
    - *exp_and_environment_auth
    - do: На экране карты выбрать парковку и тап по шильдику с ценой
    - assert: |
        Открывается карточка парковочной зоны
        Присутствует кнопка "Оплатить парковку"
    - do: Тап "Оплатить парковку"
    - assert: |
        Открылась карточка с выбором времени парковки
        По умолчанию выбрано 6 минут
        Отображается сумма, которая спишется с парковочного счета
    - do: Тап "Припарковаться"
    - assert: |
        Карточка выбора времени парковки закрылась
        Открылась карточка активной парковочной сессии
        Отображается:
          - Номер зоны
          - Время парковки
          - Кнопки "Завершить" и "Продлить"
    - do: Тап "Завершить"
    - assert: |
        Карточка активной парковочной сессии закрылась
        Открыта карточка завершенной парковочной сессии
        Отображается:
          - Номер парковочной зоны
          - Название и госномер автомобиля
          - Длительность парковочной сессии
          - Стоимость
          - Кнопка "Закрыть"

    - platforms:
        - ios
        - android
    - tags:
        - newbie


  ##Оплата парковки с помощью парковочного счета и завершение через плашку активной сессии: <- В МЯК не готово еще


  Оплата парковки с помощью парковочного счета + продление:
    - *exp_and_environment_auth
    - do: На экране карты выбрать парковку и тап по шильдику с ценой
    - assert: |
        Открывается карточка парковочной зоны
        Присутствует кнопка "Оплатить парковку"
    - do: Тап "Оплатить парковку"
    - assert: |
        Открылась карточка с выбором времени парковки
        По умолчанию выбрано 6 минут
        Отображается сумма, которая спишется с парковочного счета
    - do: Тап "Припарковаться"
    - assert: |
        Карточка выбора времени парковки закрылась
        Открылась карточка активной парковочной сессии
        Отображается:
          - Номер зоны
          - Время парковки
          - Кнопки "Завершить" и "Продлить"
    - do: Тап "Продлить"
    - assert: |
        Открылась карточка с выбором времени парковки
        По умолчанию выбрано 6 минут
        Отображается сумма, которая спишется с парковочного счета
    - do: Тап "Припарковаться"
    - assert: |
        Карточка выбора времени парковки закрылась
        Открылась карточка активной парковочной сессии
        Отображается:
          - Номер зоны
          - Время парковки(время первой сессии + продление)
          - Кнопки "Завершить" и "Продлить"(не активна)
          - Плашка о возможности продления через N минут, где N - время первой сессии

    - platforms:
        - ios
        - android


  ##Оплата парковки с помощью парковочного счета + продление через плашку активной сессии: <- В МЯК не готово еще

  Отсутствие продления парковки до завершения первой парковочной сессии:
    - *exp_and_environment_auth
    - do: На экране карты выбрать парковку и тап по шильдику с ценой
    - assert: |
        Открывается карточка парковочной зоны
        Присутствует кнопка "Оплатить парковку"
    - do: Тап "Оплатить парковку"
    - assert: |
        Открылась карточка с выбором времени парковки
        По умолчанию выбрано 6 минут
        Отображается сумма, которая спишется с парковочного счета
    - do: Тап "Припарковаться"
    - assert: |
        Карточка выбора времени парковки закрылась
        Открылась карточка активной парковочной сессии
        Отображается:
          - Номер зоны
          - Время парковки
          - Кнопки "Завершить" и "Продлить"
    - do: Тап "Продлить"
    - assert: |
        Открылась карточка с выбором времени парковки
        По умолчанию выбрано 6 минут
        Отображается сумма, которая спишется с парковочного счета
    - do: Тап "Припарковаться"
    - assert: |
        Карточка выбора времени парковки закрылась
        Открылась карточка активной парковочной сессии
        Отображается:
          - Номер зоны
          - Время парковки(время первой сессии + продление)
          - Кнопки "Завершить" и "Продлить"(не активна)
          - Плашка о возможности продления через N минут, где N - время первой сессии
    - do: Тап "Продлить"
    - assert: Кнопка не тапабельна

    - platforms:
        - ios
        - android


  Повторное продление парковки после завершения первой парковочной сессии:
    - *exp_and_environment_auth
    - do: На экране карты выбрать парковку и тап по шильдику с ценой
    - assert: |
        Открывается карточка парковочной зоны
        Присутствует кнопка "Оплатить парковку"
    - do: Тап "Оплатить парковку"
    - assert: |
        Открылась карточка с выбором времени парковки
        По умолчанию выбрано 6 минут
        Отображается сумма, которая спишется с парковочного счета
    - do: Тап "Припарковаться"
    - assert: |
        Карточка выбора времени парковки закрылась
        Открылась карточка активной парковочной сессии
        Отображается:
          - Номер зоны
          - Время парковки
          - Кнопки "Завершить" и "Продлить"
    - do: Тап "Продлить"
    - assert: |
        Открылась карточка с выбором времени парковки
        По умолчанию выбрано 6 минут
        Отображается сумма, которая спишется с парковочного счета
    - do: Тап "Припарковаться"
    - assert: |
        Карточка выбора времени парковки закрылась
        Открылась карточка активной парковочной сессии
        В карточке отображается плашка о возможности продления через N минут, где N - время первой сессии
    - do: Подождать пока закончится первая парковочная сессия(не продление)
    - do: Тап "Продлить"
    - do: Тап "Припарковаться"
    - assert: |
        Карточка выбора времени парковки закрылась
        Открылась карточка активной парковочной сессии
        В карточке отображается плашка о возможности продления через N минут, где N - время первой продленной сессии

    - platforms:
        - ios
        - android


  Оплата парковки после авторизации аккаунтом с авто:
    - *exp_and_environment_anon
    - do: На экране карты выбрать парковку и тап по шильдику с ценой
    - assert: |
        Открывается карточка парковочной зоны
        Присутствует кнопка "Оплатить парковку"
    - do: Тап "Оплатить парковку"
    - assert: Открывается Аккаунт менеджер
    - do: Авторизоваться в аккаунт yndx.tula.testers@yandex.ru / thisislegitpassword
    - assert: |
        Аккаунт менеджер закрылся
        Открыта карточка парковки
    - do: Тап "Оплатить парковку"
    - assert: |
        Открылась карточка с выбором времени парковки
        По умолчанию выбрано 6 минут
        Отображается сумма, которая спишется с парковочного счета
    - do: Тап "Припарковаться"
    - assert: |
        Карточка выбора времени парковки закрылась
        Открылась карточка активной парковочной сессии

    - platforms:
        - ios
        - android


  ##Оплата картой и завершение
  ##Оплата картой + продление через карту и завершение
  ##Оплата картой + продление + продление
  ##Смешнанная оплата парксчет+карта


  Отображение плашки про бесплатную парковку:
    - info: |
        Девайс подключен к снифферу
        Через MapLocal подменить ответ на ручку https://mobmaps-proxy-api-ext.c.maps.yandex.net/v1/parking/* на готовый [JSON](https://jing.yandex-team.ru/files/kuznetsova22/check_price)
    - *exp_and_environment_auth
    - do: На экране карты выбрать парковку и тап по шильдику с ценой
    - do: Тап "Оплатить парковку"
    - assert: |
        Открылась карточка с выбором времени парковки
        В карточке отображется:
          - Плашка про бесплатный период
          - Кнопка "Понятно"
    - do: Тап "Понятно"
    - assert: |
        Карточка выбора времени парковки закрылась
        Отображается карточка парковочной зоны

    - platforms:
        - android
        - ios
    - tags:
        - newbie


  Оплата парковки с помощью карты и завершение:
    - info: |
        Включить эксперимент parking_payment_enabled
        Дебаг-панель -> Environment -> Mobmaps Proxy host -> testing
        Подключение к внутренней сети vpn
        Пользователь авторизован аккаунтом с привязанным номером телефона
        У пользователя недостаточно средств на парковочном счете для полной оплаты парковки
        С акканута не производилась ранее оплата парковки тестовой картой
        Добавлено авто
        Открыт спан Москвы
        Открыта карточка парковочной зоны с кнопкой "Оплатить парковку"
    - do: Тап "Оплатить парковку"
    - assert: |
        Открылась карточка с выбором времени парковки
        Отображается кнопка "Припарковаться"
    - do: Увеличить время парковки пока кнопка "Припарковаться" не изменится на кнопку "Перейти к оплате"
    - assert: |
        Отображается кнопка "Перейти к оплате"
    - do: Тап "Перейти к оплате"
    - assert: |
        Открылось WebView оплаты картой
        На странице отображается надпись "У вас нет добавленных банковских карт"
        Отображается кнопка "Добавить карту и оплатить"
    - do: Тап "Добавить карту и оплатить"
    - assert: |
        Открылся веб-сайт партнера-банка
    - do: |
        Заполнить поля данными тестовой карты:
        PAN: 4150 3999 9900 0900
        CVV2: 620
        ExpDate: 01/21
    - do: Тап "Оплатить"
    - assert: |
        Веб-сайт партнера-банка закрылся после процесса перезагрузки
        Карточка выбора времени парковки закрылась
        Открылась карточка активной парковочной сессии с кнопками "Завершить" и "Продлить"
    - do: Тап "Завершить"
    - assert: |
        Карточка активной парковочной сессии закрылась
        Открыта карточка завершенной парковочной сессии

    - platforms:
        - android
        - ios
    - tags:
        - newbie


  Оплата парковки с помощью карты и продление:
    - info: |
        Включить эксперимент parking_payment_enabled
        Дебаг-панель -> Environment -> Mobmaps Proxy host -> testing
        Подключение к внутренней сети vpn
        Пользователь авторизован аккаунтом с привязанным номером телефона
        У пользователя недостаточно средств на парковочном счете для полной оплаты парковки
        С акканута производилась ранее оплата парковки тестовой картой
        Добавлено авто
        Открыт спан Москвы
        Открыта карточка парковочной зоны с кнопкой "Оплатить парковку"
    - do: Тап "Оплатить парковку"
    - assert: |
        Открылась карточка с выбором времени парковки
        Отображается кнопка "Припарковаться"
    - do: Увеличить время парковки пока кнопка "Припарковаться" не изменится на кнопку "Перейти к оплате"
    - assert: |
        Отображается кнопка "Перейти к оплате"
    - do: Тап "Перейти к оплате"
    - assert: |
        Открылось WebView оплаты картой
        Отображается, добавленная ранее, тестовая карта
        Рядом с картой отображается неактивный чекбокс
        Присутствует кнопка "Добавить карту и оплатить"
    - do: Тап на чекбокс тестовой карты
    - assert: |
        Выбрана тестовая карта для оплаты
        Чекбокс стал активным, поменяв свой цвет
        Появилась кнопка "Оплатить" с указнием суммы
    - do: Тап "Оплатить"
    - assert: |
        Выбвью оплаты закрылось
        Карточка выбора времени парковки закрылась
        Открылась карточка активной парковочной сессии
    - do: Тап "Продлить"
    - assert: |
        Открылась карточка с выбором времени парковки
        Отображается кнопка "Перейти к оплате"
    - do: Тап "Перейти к оплате"
    - assert: |
        Открылось WebView оплаты картой
        Чекбокс выбранной ранее тестовой карты активен
        Отображается кнопка "Оплатить" с указанием суммы к оплате
    - do: Тап "Оплатить"
    - assert: |
        WebView оплаты закрылось
        Карточка выбора времени парковки закрылась
        Открылась карточка активной парковочной сессии

    - platforms:
        - android
        - ios


  Показ поясняющего экрана про номер телефона(iOS):
    - info: |
        Включить эксперимент parking_payment_enabled
        Дебаг-панель -> Environment -> Mobmaps Proxy host -> testing
        Пользователь авторизован в аккаунт без привязанного номера телефона
        Открыта карточка парковки с оплатой(Тап по шильдику с ценой)
    - do: Тап "Оплатить парковку"
    - assert: |
        Открывается поясняющий экран про номер телефона:
          Отображается надпись о необходимости привязать номер телефона
          Присутствуют кнопки "Привязать телефон" и "В другой раз"
    - do: Тап "В другой раз"
    - assert: |
        Поясняющий экран закрылся
        Открыта карточка парковочной зоны

    - platforms:
        - ios
    - tags:
        - assessors


  Показ поясняющего экрана про номер телефона(Android):
    - info: |
        Включить эксперимент parking_payment_enabled
        Дебаг-панель -> Environment -> Mobmaps Proxy host -> testing
        Пользователь авторизован в аккаунт без привязанного номера телефона
        Открыта карточка парковки с оплатой(Тап по шильдику с ценой)
    - do: Тап "Оплатить парковку"
    - assert: |
        Открывается карточка выбора времени для парковочной сессии
        Присутствует плашка ошибки и кнопка "Обновить"
    - do: Тап "Обновить"
    - assert: |
        Поверх карточки выбора времени для парковочной сессии открывается поясняющий экран про номер телефона:
          Отображается надпись о необходимости привязать номер телефона
          Присутствуют кнопки "Привязать телефон" и "В другой раз"
    - do: Тап "В другой раз"
    - assert: |
        Поясняющий экран закрылся
        Открывается карточка выбора времени для парковочной сессии
        Присутствует плашка ошибки и кнопка "Обновить"

    - platforms:
        - android
    - tags:
        - assessors


  Привязка поясняющего номера телефона через поясняющий экран(iOS):
    - info: |
        Включить эксперимент parking_payment_enabled
        Экперемент parking_landing_ampp_url отключен
        Дебаг-панель -> Environment -> Mobmaps Proxy host -> testing
        Пользователь авторизован в аккаунт без привязанного номера телефона
        Открыта карточка парковки с оплатой(Тап по шильдику с ценой)
    - do: Тап "Оплатить парковку"
    - assert: |
        Открывается поясняющий экран про номер телефона:
          Отображается надпись о необходимости привязать номер телефона
          Присутствуют кнопки "Привязать телефон" и "В другой раз"
    - do: Тап "Привязать телефон"
    - assert: |
        Открывается WebView паспорта с залогиненным пользователем
        Отображается поле для ввода основного номера телефона и кнопка сохраненния
    - do: Привязать номер телефона в WebView паспорта
    - do: Закрыть WebView
    - assert: |
        Открыта карточка парковочной зоны
    - do: Тап "Оплатить парковку"
    - assert: |
        Открыта карточка выбора времени парковочной сессии
        Поясняющий экран про номер телефона не показан

    - platforms:
        - ios
    - tags:
        - newbie


  Привязка номера телефона через поясняющий экран (Android):
    - info: |
        Включить эксперимент parking_payment_enabled
        Дебаг-панель -> Environment -> Mobmaps Proxy host -> testing
        Пользователь авторизован в аккаунт без привязанного номера телефона
        Открыта карточка парковки с оплатой (Тап по шильдику с ценой)
    - do: Тап "Оплатить парковку"
    - assert: |
        Открывается карточка выбора времени для парковочной сессии
        Присутствует плашка ошибки и кнопка "Обновить"
        Поверх карточки выбора времени для парковочной сессии открывается поясняющий экран про номер телефона:
        - Отображается надпись о необходимости привязать номер телефона
        - Присутствуют кнопки "Привязать телефон" и "В другой раз"
    - do: Тап "Привязать телефон"
    - assert: |
        Открывается WebView паспорта с залогиненным пользователем
        Отображается поле для ввода основного номера телефона и кнопка сохраненния
    - do: Привязать номер телефона в WebView паспорта
    - do: Закрыть WebView
    - do: Тап "Обновить"
    - assert: |
        В карточке выбора времени парковочной сессии не отображается плашка с ошибкой
        Происходит перерасчет цены
        Поясняющий экран про номер телефона не показан

    - platforms:
        - android


  Отсутствие текущей парковочной сессии в истории:
    - info: |
        Включить эксперимент parking_payment_enabled
        Дебаг-панель -> Environment -> Mobmaps Proxy host -> testing
        Авторизоваться тестовым аккаунтом: yndx.tula.testers@yandex.ru / thisislegitpassword
        На аккаунт добавленно несколько авто
        Активна текущая парковочная сессия(в карточке парковки тап "Оплатить парковку" -> "Припарковаться")
    - do: Открыть Историю парковок(Меню -> Парковки -> История парковок)
    - assert: В истории отсутствует информация о текущей парковочной сессии
    - do: Открыть карточку текущей парковочной сессии(Debug panel - Various - Open parking session card)
    - do: Тап "Завершить"
    - do: Открыть Историю парковок(Меню -> Парковки -> История парковок)
    - assert: В истории отображается завершенная парковочная сессия из предыдущих шагов

    - platforms:
        - ios
        - android
    - tags:
        - assessors
        - newbie
