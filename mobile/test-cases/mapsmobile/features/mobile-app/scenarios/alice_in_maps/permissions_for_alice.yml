components: permissions_for_alice
testing:
  - regress
tags:
  - assessors
  - not_suitable_for_farm
integration_run:
  - alicekit

aliases:
  - &info_voice_activation_on_and_mic_on
    - info: Установлена локаль на устройстве ru_RU
    - do: Выключить эксперименты `use_datasync_settings` и `new_maps_settings` (Меню -> Настройки -> Debug-Panel - Experiments)
    - do: Перезапустить приложение
    - do: Включить Алису (Меню -> Настройки -> Основные -> Алиса)
    - do: Включить голосовую активацию Алисы (Меню -> Настройки -> Основные -> Алиса)
    - do: В настройках приложения на устройстве выдать доступ к микрофону девайса
    - do: Открыть главный экран приложения

  - &info_without_voice_activation_and_mic_off
    - info: Установлена локаль на устройстве ru_RU
    - info: Ранее доступ к микрофону не выдавался
    - do: Выключить эксперименты `use_datasync_settings` и `new_maps_settings` (Меню -> Настройки -> Debug-Panel - Experiments)
    - do: Перезапустить приложение
    - do: Включить Алису (Меню -> Настройки -> Основные -> Алиса)
    - do: Открыть главный экран приложения

specs:
  Разрешение доступа к микрофону при вызове Алисы на главном экране:
    - *info_without_voice_activation_and_mic_off
    - do: Тап по кнопке Алисы в поисковой строке
    - assert: |
        Открылся запрос на доступ к микрофону девайса
        Присутствуют кнопки разрешения и отклонения
    - do: Разрешить доступ к микрофону
    - assert: |
        Запрос на доступ к микрофону закрылся
        Открылась штора Алисы
        Проигрывается звук начала записи с микрофона

    - platforms:
        - android
        - ios
    - tags:
        - not_suitable_for_farm
        - refactor_ready
    - testing:
        - acceptance_maps


  Разрешение доступа к микрофону после отклонения при вызове Алисы на главном экране (iOS):
    - *info_without_voice_activation_and_mic_off
    - do: Тап по кнопке Алисы
    - assert: Открылся запрос на доступ к микрофону девайса
    - do: Запретить доступ к микрофону
    - assert: |
        Отображается сообщение "Яндекс Картам вас не слышно"
        Присутствуют кнопки Не сейчас, Настройки
    - do: Тап Не сейчас
    - assert: |
        Отображается главный экран приложения
        Алиса не запущена
    - do: Тап на кнопку Алисы
    - assert: |
        Отображается сообщение "Яндекс Картам вас не слышно"
        Присутствуют кнопки Не сейчас, Настройки
    - do: Перейти в настройки и разрешить доступ к микрофону
    - do: Вернуться в приложение
    - assert: Отображается главный экран приложения
    - do: Тап по кнопке Алисы
    - assert: Открылась штора Алисы

    - platforms:
        - ios
    - tags:
        - not_suitable_for_farm
        - refactor_ready


  Разрешение доступа к микрофону после отклонения при вызове Алисы на главном экране (Android):
    - *info_without_voice_activation_and_mic_off
    - do: Тап по кнопке Алисы
    - assert: Открылся запрос на доступ записывать аудио
    - do: Запретить доступ к микрофону
    - assert: |
        Отображается главный экран приложения
        Алиса не запущена
    - do: Тап на кнопку Алисы
    - assert: |
        Отображается запрос на разрешение доступа к микрофону девайса
        Присутствуют кнопки Разрешить и Не сейчас
    - do: Тап на Не сейчас
    - assert: |
        Отображается главный экран приложения
        Алиса не запущена
    - do: Тап на кнопку Алисы
    - assert: |
        Отображается запрос на разрешение доступа к микрофону
        Присутствуют кнопки Разрешить и Не сейчас
    - do: Тап на Разрешить
    - assert: |
        Отображается запрос на разрешение доступа записывать аудио
        Присутствуют кнопки Разрешить и Отклонить
    - do: Тап на Разрешить
    - assert: |
        Запрос на доступ к микрофону закрылся
        Открылась штора Алисы

    - platforms:
        - android
    - tags:
        - not_suitable_for_farm
        - refactor_ready


  Выдача доступа к контактам при попытке звонка через Алису после запрета:
    - info: |
        Добавлены контакты в адресную книгу на девайсе
        Ранее доступ к контактам из адресной книги не выдавался
    - *info_voice_activation_on_and_mic_on
    - do: Вызвать Алису
    - do: Попросить Алису позвонить одному из контактов в адресной книге (напр., "Позвони, маме")
    - assert: |
        В шторе Алисы отображается сообщение, что необходимо предоставить доступ к контактам
        Через несколько секунд штора закрывается
        Отображается запрос на выдачу доступа к контактам
        Присутствуют кнопки Запретить и Разрешить
    - do: Тап на Запретить
    - assert: |
        Запрос скрылся
        Звучит сообщение от Алисы, что без разрешения ничем не может помочь
        Отображается главный экран приложения
    - do: Вызвать Алису
    - do: Попросить Алису позвонить одному из контактов в адресной книге
    - assert: |
        Отображается штора Алисы
        В шторе отображается сообщение, что без разрешения это невозможно
        Через несколько секунд штора закрывается
        Отображается запрос на выдачу доступа к контактам
        Присутствуют кнопки Отклонить, Разрешить и Больше не показывать
    - do: Тап на Разрешить
    - assert: |
        Запрос скрылся
        Звучит сообщение от Алисы о начале синхронизации контактов
        Отображается главный экран приложения

    - platforms:
        - ios
        - android
    - tags:
        - not_suitable_for_farm
        - refactor_ready


  Запрос на выдачу доступа на совершение звонков через приложение:
    - info: |
        Установлена локаль на устройстве ru_RU
        Добавлены контакты в адресную книгу
        Выданы доступы в настройках приложения на устройстве:
          - к микрофону
          - к контактам из адресной книги
        Ранее доступ к совершению звонков не был разрешен
        Пользователь авторизован
        Отображается главный экран устройства
    - do: Вызвать Алису
    - do: Попросить Алису позвонить одному из контактов в адресной книге
    - assert: |
        Алиса отвечает голосом и текстом о начале набора номера
        Через несколько секунд появляется запрос на разрешение совершать звонки
        Присутствуют кнопки Отклонить и Разрешить
    - do: Тап на Отклонить
    - assert: Открывается экран системной звонилки
    - do: Вернуться в приложение
    - do: Вызвать Алису
    - do: Попросить Алису позвонить одному из контактов в адресной книге
    - assert: |
        Алиса отвечает голосом и текстом о начале набора номера
        Через несколько секунд появляется запрос на разрешение совершать звонки
        Присутствуют кнопки Отклонить, Разрешить и Больше не показывать
    - do: Тап на Разрешить
    - assert: Осуществляется вызов выбранному контакту

    - platforms:
        - android
    - tags:
        - not_suitable_for_farm
        - refactor_ready
