components: rate_me_alert
testing:
  - regress

specs:
  Показ алерта с просьбой оценить приложение после закрытия карточки топонима/остановки:
    - info: |
        Android: Получен эксперимент rate_me_after_closing_cards, выключен gp_in_app_review
        Ранее алерт не был показан
        Выполнены условия для показа рейтинговалки: набрано 10 событий и дата на устройстве переведена на 3 дня вперед
        Пример событий для показа рейтинговалки (в iOS считаются уникальные события, в Android повторяются):
        просмотр карточки организации/топонима/остановки/маршрута (каждый тип карточки засчитывается отдельно),
        любое действие в карточке (позвонить, открыть сайт, поделиться), просмотр публичного профиля,
        построение маршрута, переход в ведение, загрузка кеша, создание списка закладок, просмотр подборки/Stories
    - do: Открыть и закрыть карточку топонима/остановки
    - assert: |
        Карточка закрыта
        Появляется попап 'Оцените Яндекс.Карты' со звёздами
        В попапе присутствуют кнопки 'Не сейчас' и 'Отправить'
    - do: Тап 'Не сейчас'
    - assert: Попап закрывается

    - platforms:
        - android
        - ios
    - testing:
        - acceptance_maps
    - tags:
        - assessors
        - use_map


  Показ алерта с просьбой оценить приложение после закрытия фотогалереи:
    - info: |
        Ранее алерт не был показан
        Android: Получен эксперимент rate_me_after_closing_cards, выключен gp_in_app_review
        Выполнены условия для показа рейтинговалки: набрано 10 событий и дата на устройстве переведена на 3 дня вперед
        Пример событий для показа рейтинговалки (в iOS считаются уникальные события, в Android повторяются):
        просмотр карточки организации/топонима/остановки/маршрута (каждый тип карточки засчитывается отдельно),
        любое действие в карточке (позвонить, открыть сайт, поделиться), просмотр публичного профиля,
        построение маршрута, переход в ведение, загрузка кеша, создание списка закладок, просмотр подборки/Stories
    - do: Открыть полную карточку организации с 10 и более фотографиями
    - do: Тап по любой фотографии в фотогалерее карточки
    - assert: Открывается галерея организации
    - do: Закрыть галерею тапом по стрелке Назад
    - assert: |
        Галерея закрывается
        Открывается карточка организации
        Появляется попап 'Оцените Яндекс.Карты' со звёздами
        В попапе присутствуют кнопки 'Не сейчас' и 'Отправить'
    - do: Тап 'Не сейчас'
    - assert: |
        Попап закрывается
        Открыта карточка организации
    - do: Закрыть карточку организации
    - assert: |
        Карточка закрывается
        Открывается главный экран приложения
        Попап 'Оцените Яндекс.Карты' больше не показан
    - platforms:
        - android
        - ios
    - tags:
        - assessors


  Показ алерта с просьбой оценить приложение после выхода из Отзывы и исправления:
    - info: |
        Android: Получен эксперимент rate_me_after_closing_cards, выключен gp_in_app_review
        Ранее алерт не был показан
        Выполнены условия для показа рейтинговалки: набрано 10 событий и дата на устройстве переведена на 3 дня вперед
        Пример событий для показа рейтинговалки (в iOS считаются уникальные события, в Android повторяются):
        просмотр карточки организации/топонима/остановки/маршрута (каждый тип карточки засчитывается отдельно),
        любое действие в карточке (позвонить, открыть сайт, поделиться), просмотр публичного профиля,
        построение маршрута, переход в ведение, загрузка кеша, создание списка закладок, просмотр подборки/Stories
        Пользователь авторизован
        Открыт главный экран приложения
    - do: Тап на Меню
    - assert: |
        Отображается меню приложения
        В меню есть пункт 'Отзывы и исправления'
    - do: Тап по 'Отзывы и исправления'
    - assert: Открывается экран Отзывы и исправления
    - do: Закрыть экран тапом по стрелке Назад
    - assert: |
        Экран Отзывы и исправления закрывается
        Отображается меню приложения
        Появляется попап 'Оцените Яндекс.Карты' со звёздами
        В попапе присутствуют кнопки 'Не сейчас' и 'Отправить'
    - do: Тап 'Не сейчас'
    - assert: |
        Попап закрывается
        Открыт главный экран приложения
    - platforms:
        - android
        - ios
    - tags:
        - assessors


  Показ алерта с просьбой оценить приложение после добавления закладки:
    - info: |
        Android: Получен эксперимент rate_me_after_closing_cards, выключен gp_in_app_review
        Ранее алерт не был показан
        Выполнены условия для показа рейтинговалки: набрано 10 событий и дата на устройстве переведена на 3 дня вперед
        Пример событий для показа рейтинговалки (в iOS считаются уникальные события, в Android повторяются):
        просмотр карточки организации/топонима/остановки/маршрута (каждый тип карточки засчитывается отдельно),
        любое действие в карточке (позвонить, открыть сайт, поделиться), просмотр публичного профиля,
        построение маршрута, переход в ведение, загрузка кеша, создание списка закладок, просмотр подборки/Stories
        Открыта полная карточка организации, не добавленной в закладки
        Пользователь авторизован
    - do: Тап на кнопку сохранения карточки в закладки
    - assert: Открывается попап с пользовательскими списками и кнопками 'Отменить' и 'Создать список'
    - do: Тап по любому списку
    - assert: |
        Появляется попап 'Оцените Яндекс.Карты' со звёздами
        В попапе присутствуют кнопки 'Не сейчас' и 'Отправить'
    - do: Тап 'Не сейчас'
    - assert: |
        Попап закрывается
        Открыта полная карточка организации из предусловия.
        Организация сохранена в список, иконка окрасилась в  жёлтый, кнопка изменена на 'Сохранено'
    - platforms:
        - android
        - ios
    - tags:
        - assessors


  Показ алерта с просьбой оценить приложение после закрытия подборки/сторис:
    - info: |
        Android: Получен эксперимент rate_me_after_closing_cards, выключен gp_in_app_review
        Ранее алерт не был показан
        Выполнены условия для показа рейтинговалки: набрано 10 событий и дата на устройстве переведена на 3 дня вперед
        Пример событий для показа рейтинговалки (в iOS считаются уникальные события, в Android повторяются):
        просмотр карточки организации/топонима/остановки/маршрута (каждый тип карточки засчитывается отдельно),
        любое действие в карточке (позвонить, открыть сайт, поделиться), просмотр публичного профиля,
        построение маршрута, переход в ведение, загрузка кеша, создание списка закладок, просмотр подборки/Stories
        Открыт главный экран приложения
        На спане карты Москва
    - do: Тап на таб Поиск
    - assert: |
        Открыт экран Поиск
        В шторе присутствуют сторис и различные подборки
    - do: Тап по любой сторис/подборке
    - assert: Открывается сторис/подборка
    - do: Закрыть сторис/подборку тапом по крестику
    - assert: |
        Сторис/подборка закрывается
        Открыт экран Поиск
        Появляется попап 'Оцените Яндекс.Карты' со звёздами
        В попапе присутствуют кнопки 'Не сейчас' и 'Отправить'
    - do: Тап 'Не сейчас'
    - assert: |
        Попап закрывается
        Открыт экран Поиск
        Проскролл экрана сохранён
    - platforms:
        - android
        - ios
    - tags:
        - assessors


  Показ алерта с просьбой оценить приложение после сброса поиска:
    - info: |
        Android: Получен эксперимент rate_me_after_closing_cards, выключен gp_in_app_review
        Ранее алерт не был показан
        Выполнены условия для показа рейтинговалки: набрано 10 событий и дата на устройстве переведена на 3 дня вперед
        Пример событий для показа рейтинговалки (в iOS считаются уникальные события, в Android повторяются):
        просмотр карточки организации/топонима/остановки/маршрута (каждый тип карточки засчитывается отдельно),
        любое действие в карточке (позвонить, открыть сайт, поделиться), просмотр публичного профиля,
        остроение маршрута, переход в ведение, загрузка кеша, создание списка закладок, просмотр подборки/Stories
        Открыт главный экран приложения
    - do: Тап по строке поиска
    - assert: Открывается экран поиска на вкладке 'Категории'
    - do: Произвести поиск по любому запросу
    - assert: |
        Отображается список с результатами поиска
        На карте отображены пины
    - do: Закрыть поиск тапом по крестику
    - assert: |
        Поиск закрывается
        Появляется попап 'Оцените Яндекс.Карты' со звёздами
        В попапе присутствуют кнопки 'Не сейчас' и 'Отправить'
    - do: Тап на 'Не сейчас'
    - assert: |
        Попап закрывается
        Открыт главный экран приложения
    - platforms:
        - android
        - ios
    - tags:
        - assessors


  Отсутствие алерта с просьбой оценить приложение после двух раз показа:
    - info: |
        Android: Получен эксперимент rate_me_after_closing_cards, выключен gp_in_app_review
        Проверяем, что после двух раз срабатывания алерта, в следующий раз он покажется только спустя 7 дней после первого показа
        Выполнены условия для показа рейтинговалки: набрано 10 событий и дата на устройстве переведена на 3 дня вперед
        Пример событий для показа рейтинговалки (в iOS считаются уникальные события, в Android повторяются):
        просмотр карточки организации/топонима/остановки/маршрута (каждый тип карточки засчитывается отдельно),
        любое действие в карточке (позвонить, открыть сайт, поделиться), просмотр публичного профиля,
        построение маршрута, переход в ведение, загрузка кеша, создание списка закладок, просмотр подборки/Stories
    - do: Выполнить любое действие из списка, которое запускает показ рейтинговалки (в инструкции блок про рейтинговалку)
    - assert: |
        Появляется попап 'Оцените Яндекс.Карты' со звёздами
        В попапе присутствуют кнопки 'Не сейчас' и 'Отправить'
    - do: Тап 'Не сейчас'
    - assert: |
        Попап закрывается
        Открыт главный экран приложения
    - do: Набрать ещё 10 событий
    - do: На устройстве перевести дату на 7 дней вперёд
    - do: Выполнить любое действие из списка, которое запускает показ рейтинговалки
    - assert: |
        Появляется попап 'Оцените Яндекс.Карты' со звёздами
        В попапе присутствуют кнопки 'Не сейчас' и 'Отправить'
    - platforms:
        - android
        - ios
    - tags:
        - assessors


  Оценка приложения через попап (4-5 звёзд):
    - info: |
        Android: Получен эксперимент rate_me_after_closing_cards, выключен gp_in_app_review
        Ранее алерт не был показан
        Выполнены условия для показа рейтинговалки: набрано 10 событий и дата на устройстве переведена на 3 дня вперед
        Пример событий для показа рейтинговалки (в iOS считаются уникальные события, в Android повторяются):
        просмотр карточки организации/топонима/остановки/маршрута (каждый тип карточки засчитывается отдельно),
        любое действие в карточке (позвонить, открыть сайт, поделиться), просмотр публичного профиля,
        построение маршрута, переход в ведение, загрузка кеша, создание списка закладок, просмотр подборки/Stories
    - do: Выполнить любое событие из списка
    - assert: |
        Появляется попап 'Оцените Яндекс.Карты' со звёздами
        В попапе присутствуют кнопки 'Не сейчас' и 'Отправить'
    - do: Тап 4 или 5 звёзд в попапе и 'Отправить'
    - assert: Открывается страница Яндекс.Карт в сторе
    - platforms:
        - android
        - ios
    - tags:
        - assessors


  Оценка приложения через попап (1-3 звёзды):
    - info: |
        Android: Получен эксперимент rate_me_after_closing_cards, выключен gp_in_app_review
        Ранее алерт не был показан
        Выполнены условия для показа рейтинговалки: набрано 10 событий и дата на устройстве переведена на 3 дня вперед
        Пример событий для показа рейтинговалки (в iOS считаются уникальные события, в Android повторяются):
        просмотр карточки организации/топонима/остановки/маршрута (каждый тип карточки засчитывается отдельно),
        любое действие в карточке (позвонить, открыть сайт, поделиться), просмотр публичного профиля,
        построение маршрута, переход в ведение, загрузка кеша, создание списка закладок, просмотр подборки/Stories
    - do: Выполнить любое событие из списка
    - assert: |
        Появляется попап 'Оцените Яндекс.Карты' со звёздами
        В попапе присутствуют кнопки 'Не сейчас' и 'Отправить'
    - do: Тап 1, 2 или 3 звёзды в попапе и 'Отправить'
    - assert: |
        Открывается форма отправки обратной связи
        В поле для ввода отображается сообщение 'Расскажите, что бы вы улучшили в Яндекс.Картах'.
        Может открыться всплывающий системный поп-ап с выбором приложения почты
    - platforms:
        - android
        - ios
    - tags:
        - assessors

  Повторное отображение рейтинговалки через 4 месяца:
    - info: |
        Android: Получен эксперимент rate_me_after_closing_cards, выключен gp_in_app_review
        Выполнены условия для показа рейтинговалки: набрано 10 событий и дата на устройстве переведена на 3 дня вперед
        Пример событий для показа рейтинговалки (в iOS считаются уникальные события, в Android повторяются):
        просмотр карточки организации/топонима/остановки/маршрута (каждый тип карточки засчитывается отдельно),
        любое действие в карточке (позвонить, открыть сайт, поделиться), просмотр публичного профиля,
        построение маршрута, переход в ведение, загрузка кеша, создание списка закладок, просмотр подборки/Stories
        Рейтинговалка была показана
        Изменить дату на устройстве на 4 месяца вперед
        Приложение запущено. Отображается главный экран приложения
    - do: Тап по пину остановки
    - assert: Отображается миникарточка остановки
    - do: Тап по миникарточке
    - assert: Отображается полная карточка остановки
    - do: Закрыть карточку остановки
    - assert: |
        Карточка остановки не отображается
        Отображается аллерт рейтинговалки
    - platforms:
        - android
        - ios
    - tags:
        - assessors
        - use_map

  Системная рейтинговалка: #https://st.yandex-team.ru/MAPSMOBILETEST-866
    - info: |
        Установлена загруженная из Google Play сборка
        Получен эксперимент rate_me_percentage со значением 100
        Получен эксперимент "gp_in_app_review"
        Открыт главный экран
    - do: Тап на здание
    - assert: |
        На карте отображается поднятый пин здания
        Красными стрелочкой и точкой указан вход в здание
        В центре здания отобразилась плейсмарка красного цвета цвета с с белым изображением домика
        Открылась миникарточка топонима, карточка содержит: адрес (город, республику, страну, индекс (при наличии)); расстояние до здания, кнопка построения маршрута со временем доезда
    - do: Тап по миникарточке топонима/остановки
    - assert: Открывается полная карточка топонима/остановки
    - do: Закрыть карточку топонима/остановки тапом по крестику
    - assert: |
        Появляется поп-ап Google Play с просьбой оценить приложение
        Поп-ап может не отобразиться из-за квоты. В таком случае повторить шаг и убедиться, что в логах будет событие I/PlayCore: UID: [10203]  PID: [26259] ReviewService : requestInAppReview (ru.yandex.yandexmaps)
    - do: Тап 'Не сейчас'
    - assert: Поп-ап закрывается
    - do: Тап на здание
    - assert: Появляется поп-ап Google Play с просьбой оценить приложение
    - do: Оценить приложение следуя инструкциям в поп-апе
    - assert: Приложение оценено, поп-ап закрылся

    - platforms:
        - android
    - tags:
        - use_map


  Показ алерта с просьбой оценить приложение после завершения маршрута:
    - info: |
        Android: Получен эксперимент rate_me_after_closing_cards, выключен gp_in_app_review
        Ранее алерт не был показан
        Выполнены условия для показа рейтинговалки: набрано 10 событий и дата на устройстве переведена на 3 дня вперед
        Пример событий для показа рейтинговалки (в iOS считаются уникальные события, в Android повторяются):
        просмотр карточки организации/топонима/остановки/маршрута (каждый тип карточки засчитывается отдельно),
        любое действие в карточке (позвонить, открыть сайт, поделиться), просмотр публичного профиля,
        построение маршрута, переход в ведение, загрузка кеша, создание списка закладок, просмотр подборки/Stories
        В ведении должна происходить симуляция движения:
        Debug-panel > Routes > Demo movement
        Построен произвольный маршрут
    - do: Построить произвольный маршрут и перейти в ведение
    - assert: Открыт экран ведения по маршруту
    - do: Дождаться завершения маршрута
    - assert: |
        Маршрут завершен
        Появляется попап 'Оцените Яндекс.Карты' со звёздами
        В попапе присутствуют кнопки 'Не сейчас' и 'Отправить'
    - do: Тап 'Не сейчас'
    - assert: |
        Попап закрывается
        Открыт главный экран приложения

    - platforms:
        - ios
        - android
    - tags:
        - assessors
        - use_map

  Новый экран рейтинговалки:
    - info: |
        Android: Получен эксперимент rate_me_after_closing_cards, выключен gp_in_app_review
        В дебаг панели включена тычка (Debug Panel - Rate App - Always show rate dialog)
        Открыта карточка любого топонима/организации
    - do: Закрыть карточку топонима/организации
    - assert: |
        Карточка закрылась
        Появляется попап "Оцените Яндекс.Карты" со звёздами
        Звезды не выделенны
        В попапе присутствуют кнопки "Не сейчас" и "Отправить"
        Кнопка "Отправить" не кликабельна
    - do: Тап "Не сейчас"
    - assert: |
        Попап закрылся
        Открыт клавный экран приложения
    - do: Повторно вызвать попап "Оцените Яндекс.Карты"
    - do: Тап на любое количество звезд (1-5)
    - assert: |
        Выбранныые звезды выделились
        Кнопка "Отправить" разблокировалась
    - do: Тап "Отправить"
    - assert: |
        Попап закрывается
        Открыт главный экран приложения

    - platforms:
        - android
        - ios
    - tags:
        - assessors
        - use_map


  События вызова рейтинговалки:
    - info: |
        Включен эксперимент rate_me_after_closing_cards, выключен gp_in_app_review
        В дебаг панели включена тычка (Debug-Panel->Rate App->Always show rate dialog)
        Открыта карточка любого топонима
    - do: Закрыть карточку топонима
    - assert: Отображается экран рейтинговалки
    - do: Проделать те же действия для карточек организации и остановки
    - assert: При закрытии карточек отображается экран рейтинговалки
    - do: Открыть экран поиска
    - do: Закрыть экран поиска
    - assert: Отображается экран рейтинговалки
    - do: Открыть экран "Закладки"
    - do: Закрыть экран "Закладки"
    - assert: Отображается экран рейтинговалки
    - do: Выключить эксперимент rate_me_after_closing_cards
    - do: Открыть карточку любого топонима
    - do: Закрыть карточку топонима
    - assert: Не отображается экран рейтинговалки

    - platforms:
        - android
    - tags:
        - assessors
        - newbie
    - testing:
        - acceptance_maps


  Управление вероятностью показа рейтинговалки:
    - info: |
        ТК проходится на сборке без подписи store, так как на продовых сборках нет лог-панели
        Логи можно посмотреть, подключив устройство к logcat или в приложении открыв лог-панель свайпом двумя пальцами слева-направо
    - info: |
        Получен эксперимент rate_me_percentage с параметром 10%
        Получен эксперимент rate_me_after_closing_cards
        Выключен эксперимент gp_in_app_review
        Выполнены условия для показа рейтинговалки: набрано 10 событий и дата на устройстве переведена на 3 дня вперед
        Пример событий для показа рейтинговалки (в iOS считаются уникальные события, в Android повторяются):
        просмотр карточки организации/топонима/остановки/маршрута (каждый тип карточки засчитывается отдельно),
        любое действие в карточке (позвонить, открыть сайт, поделиться), просмотр публичного профиля,
        построение маршрута, переход в ведение, загрузка кеша, создание списка закладок, просмотр подборки/Stories
    - do: Открыть и закрыть карточку топонима
    - assert: |
        Алерт с рейтинговалкой не появился
        Пришел лог о том, что пользователю не повезло: User is not lucky
    - do: Изменить параметр эксперимента rate_me_percentage на 100%
    - do: Перезапустить приложение
    - do: Открыть и закрыть карточку топонима
    - assert: |
        Алерт с рейтинговалкой появился
        Пришел лог о том, что пользователю повезло: Dialog can be shown

    - platforms:
        - android
    - tags:
        - assessors
    - testing:
        - acceptance_maps


  Управление вероятностью показа рейтинговалки после неудачных попыток:
    - info: |
        Получен эксперимент rate_me_percentage с параметром 100%
        В дебаг-панели включен свитчер Rate App -> Always_show_rate_dialog
        Открыт главный экран приложения
    - do: Открыть и закрыть карточку остановки
    - assert: Отображается алерт с рейтинговалкой
    - do: Изменить параметр эксперимента rate_me_percentage на 30%
    - do: Перезапустить приложение
    - assert: Открыт главный экран приложения
    - do: Открыть и закрыть карточку Остановки
    - do: Повторять предыдущий шаг, пока не будет достигнуто, что дважды подряд после открытия/закрытия карточки остановки алерт не появлялся
    - assert: Дважды подряд после открытия/закрытия карточки остановки алерт не появлялся
    - do: Открыть и закрыть карточку Остановки
    - do: Повторять предыдущий шаг до тех пор, пока не будет достигнуто, что после открытия/закрытия карточки остановки алерт появился
    - assert: Отображается алерт с рейтинговалкой

    - platforms:
        - ios
    - tags:
        - assessors
    - testing:
        - acceptance_maps


  Появление алерта с предложением выбрать новые фото или оставить те, что есть при ограниченном доступе к фото:
    - info:
        Кейс для IOS 14+
        В настройках девайса выбран частичный доступ приложения к фото 
        Открыт главный экран приложения
    - do: Открыть экран с выбором фото для добавления (например в карточке организации)
    - assert: Появляется алерт с предложением выбрать новые фото или оставить те, что есть
    - do: Закрыть экран с выбором фото для добавления
    - do: Открыть еще несколько раз экран с выбором фото для добавления
    - assert: При каждой попытке открыть экран с выбором фото для добавления, появляется алерт с предложением выбрать новые фото или оставить те, что есть

    - platforms:
        - ios
    - tags:
        - assessors


  Отсутствие алерта с предложением выбрать новые фото или оставить те, что есть при полном доступе к фото:
    - info:
        Кейс для IOS 14+
        В настройках девайса выбран полный доступ приложения к фото 
        Открыт главный экран приложения
    - do: Открыть экран с выбором фото для добавления (например в карточке организации)
    - assert: Алерт с предложением выбрать новые фото или оставить те, что есть - отсутствует

    - platforms:
        - ios
    - tags:
        - assessors


  Появление алерта с оповещением об отсутствии доступа к фото при отсутствии доступа к фото:
    - info:
        Кейс для IOS 14+
        В настройках девайса выбран запрет на доступ приложения к фото 
        Открыт главный экран приложения
    - do: Открыть экран с выбором фото для добавления (например в карточке организации)
    - assert: Появляется алерт с оповещением об отсутствии доступа к фото

    - platforms:
        - ios
    - tags:
        - assessors
    - testing:
        - acceptance_maps