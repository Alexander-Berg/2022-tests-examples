import maps.b2bgeo.mvrp_solver.annealing_mvrp.tests_lib.mvrp_checker as mvrp_checker
import maps.b2bgeo.mvrp_solver.annealing_mvrp.tests_lib.tools as tools


def test_cocacola():
    """
    checks mvrp request of Coca Cola, 911 locations, 47 vehicles

    Solver deviation results (28 runs):
    log2_iterations  cost_best   cost_avr    cost_2std(%)  cost_99err(%)
    10000000.000     316206.704  324015.307  2.440         4.540
    """
    route = mvrp_checker.solve_and_check(
        open(tools.data_path('data/cocacola_request.json')).read(),
        open(tools.data_path('data/cocacola_distances.json')).read(),
        solver_arguments={'sa_iterations': 10000000},
        runs_count=5)

    expected_metrics = {
        "assigned_locations_count": 911.0,
        "balanced_group_duration_deviation_s": 0.0,
        "balanced_group_penalty": 0.0,
        "balanced_group_stop_count_deviation": 0.0,
        "depot_throughput_violation_kg": 0.0,
        "depot_throughput_violation_kg_per_hour": 0.0,
        "depot_throughput_violation_units": 0.0,
        "depot_throughput_violation_units_per_hour": 0.0,
        "dropped_locations_count": 0.0,
        "early_depot_count": 0.0,
        "early_locations_count": 0.0,
        "early_shifts_count": 0.0,
        "failed_max_work_duration_count": 0.0,
        "failed_min_work_duration_count": 0.0,
        "failed_time_window_depot_count": 0.679,
        "failed_time_window_depot_count_penalty": 678.571,
        "failed_time_window_depot_duration_penalty": 1441.367,
        "failed_time_window_depot_duration_s": 5087.179,
        "failed_time_window_locations_count": 0.0,
        "failed_time_window_locations_count_penalty": 0.0,
        "failed_time_window_locations_duration_penalty": 0.0,
        "failed_time_window_locations_duration_s": 0.0,
        "failed_time_window_shifts_count": 0.0,
        "failed_time_window_shifts_count_penalty": 0.0,
        "failed_time_window_shifts_duration_penalty": 0.0,
        "failed_time_window_shifts_duration_s": 0.0,
        "failed_work_duration_count": 0.0,
        "failed_work_duration_count_penalty": 0.0,
        "failed_work_duration_penalty": 0.0,
        "failed_work_duration_s": 0.0,
        "global_proximity": 9.435,
        "late_depot_count": 0.679,
        "late_locations_count": 0.0,
        "late_shifts_count": 0.0,
        "lateness_risk_locations_count": 0.321,
        "max_vehicle_runs": 2.107,
        "number_of_routes": 48.821,
        "objective_minimum": 19664086.279,
        "operations_per_second": 8775.425,
        "optimization_steps": 10000000.0,
        "overtime_duration_penalty": 0.0,
        "overtime_duration_s": 0.0,
        "overtime_penalty": 0.0,
        "overtime_shifts_count": 0.0,
        "overtime_shifts_count_penalty": 0.0,
        "proximity": 2.932,
        "total_cost": 321055.562,
        "total_cost_with_penalty": 324015.307,
        "total_depot_penalty": 0.0,
        "total_drop_penalty": 0.0,
        "total_duration_cost": 38688.907,
        "total_duration_s": 1392800.643,
        "total_early_count": 0.0,
        "total_early_duration_s": 0.0,
        "total_early_penalty": 0.0,
        "total_failed_delivery_deadline_count": 0.0,
        "total_failed_delivery_deadline_duration_s": 0.0,
        "total_failed_delivery_deadline_penalty": 0.0,
        "total_failed_time_window_count": 0.679,
        "total_failed_time_window_duration_s": 5087.179,
        "total_failed_time_window_penalty": 2119.939,
        "total_fixed_cost": 223928.571,
        "total_global_proximity_distance_m": 7184905.607,
        "total_global_proximity_duration_s": 1005822.214,
        "total_global_proximity_penalty": 0.0,
        "total_guaranteed_penalty": 2119.939,
        "total_late_count": 0.679,
        "total_late_duration_s": 5087.179,
        "total_late_penalty": 2119.939,
        "total_lateness_risk_probability": 90.364,
        "total_locations_cost": 0.0,
        "total_mileage_penalty": 0.0,
        "total_penalty": 2959.744,
        "total_probable_penalty": 839.806,
        "total_proximity_distance_m": 3813486.887,
        "total_proximity_duration_s": 575284.031,
        "total_proximity_penalty": 0.0,
        "total_runs_cost": 24410.714,
        "total_service_duration_s": 720900.0,
        "total_stop_count_penalty": 0.0,
        "total_stops": 806.964,
        "total_transit_distance_cost": 34027.37,
        "total_transit_distance_m": 4253421.214,
        "total_transit_duration_s": 656322.036,
        "total_unfeasibility_count": 0.0,
        "total_unfeasibility_penalty": 0.0,
        "total_waiting_duration_s": 15578.607,
        "total_work_breaks": 0.0,
        "used_vehicles": 44.786
    }

    rel_accuracies = {
        "failed_time_window_depot_count": 2.2765,
        "failed_time_window_depot_count_penalty": 2.2765,
        "failed_time_window_depot_duration_penalty": 2.8455,
        "failed_time_window_depot_duration_s": 2.8455,
        "global_proximity": 0.20309999999999997,
        "late_depot_count": 2.2765,
        "lateness_risk_locations_count": 3.807,
        "max_vehicle_runs": 0.299,
        "number_of_routes": 0.046,
        "objective_minimum": 0.022400000000000003,
        "operations_per_second": 0.5075999999999999,
        "proximity": 0.0758,
        "total_cost": 0.0315,
        "total_cost_with_penalty": 0.024399999999999998,
        "total_failed_time_window_count": 2.2765,
        "total_failed_time_window_duration_s": 2.8455,
        "total_failed_time_window_penalty": 2.536,
        "total_fixed_cost": 0.037200000000000004,
        "total_global_proximity_distance_m": 0.2047,
        "total_global_proximity_duration_s": 0.18960000000000002,
        "total_guaranteed_penalty": 2.536,
        "total_late_count": 2.2765,
        "total_late_duration_s": 2.8455,
        "total_late_penalty": 2.536,
        "total_lateness_risk_probability": 0.7884,
        "total_penalty": 1.7826,
        "total_probable_penalty": 1.2262,
        "total_proximity_distance_m": 0.0473,
        "total_proximity_duration_s": 0.0395,
        "total_runs_cost": 0.046,
        "total_transit_distance_cost": 0.029900000000000003,
        "total_transit_distance_m": 0.029900000000000003,
        "total_transit_duration_s": 0.0265,
        "total_waiting_duration_s": 0.5274,
        "used_vehicles": 0.037200000000000004
    }

    tools.check_metrics_are_close(route["metrics"], expected_metrics, rel_accuracies)


def test_danone():
    """
    Checks mvrp request of Danone, 100 locations, 60 vehicles.
    The cheapest vehicles must be used (it's checked via total_cost).

    Solver deviation results (50 runs):
    log2_iterations  cost_best  cost_avr   cost_2std(%)  cost_99err(%)
    10000000.000     36890.176  37199.461  2.480         3.870
    """
    route = mvrp_checker.solve_and_check(
        open(tools.data_path('data/danone_request.json')).read(),
        open(tools.data_path('data/danone_distances.json')).read(),
        solver_arguments={'sa_iterations': 10000000},
        runs_count=5)

    expected_metrics = {
        "assigned_locations_count": 101.0,
        "balanced_group_duration_deviation_s": 0.0,
        "balanced_group_penalty": 0.0,
        "balanced_group_stop_count_deviation": 0.0,
        "depot_throughput_violation_kg": 0.0,
        "depot_throughput_violation_kg_per_hour": 0.0,
        "depot_throughput_violation_units": 0.0,
        "depot_throughput_violation_units_per_hour": 0.0,
        "dropped_locations_count": 0.0,
        "early_depot_count": 0.0,
        "early_locations_count": 0.0,
        "early_shifts_count": 0.0,
        "failed_max_work_duration_count": 0.0,
        "failed_min_work_duration_count": 0.0,
        "failed_time_window_depot_count": 0.0,
        "failed_time_window_depot_count_penalty": 0.0,
        "failed_time_window_depot_duration_penalty": 0.0,
        "failed_time_window_depot_duration_s": 0.0,
        "failed_time_window_locations_count": 0.0,
        "failed_time_window_locations_count_penalty": 0.0,
        "failed_time_window_locations_duration_penalty": 0.0,
        "failed_time_window_locations_duration_s": 0.0,
        "failed_time_window_shifts_count": 0.0,
        "failed_time_window_shifts_count_penalty": 0.0,
        "failed_time_window_shifts_duration_penalty": 0.0,
        "failed_time_window_shifts_duration_s": 0.0,
        "failed_work_duration_count": 0.0,
        "failed_work_duration_count_penalty": 0.0,
        "failed_work_duration_penalty": 0.0,
        "failed_work_duration_s": 0.0,
        "global_proximity": 15.688,
        "late_depot_count": 0.0,
        "late_locations_count": 0.0,
        "late_shifts_count": 0.0,
        "lateness_risk_locations_count": 2.72,
        "objective_minimum": 2274282.998,
        "operations_per_second": 19210.206,
        "optimization_steps": 10000000.0,
        "overtime_duration_penalty": 0.0,
        "overtime_duration_s": 0.0,
        "overtime_penalty": 0.0,
        "overtime_shifts_count": 0.0,
        "overtime_shifts_count_penalty": 0.0,
        "proximity": 9.818,
        "total_cost": 37199.461,
        "total_cost_with_penalty": 37199.461,
        "total_depot_penalty": 0.0,
        "total_drop_penalty": 0.0,
        "total_duration_cost": 751.475,
        "total_duration_s": 270531.16,
        "total_early_count": 0.0,
        "total_early_duration_s": 0.0,
        "total_early_penalty": 0.0,
        "total_failed_delivery_deadline_count": 0.0,
        "total_failed_delivery_deadline_duration_s": 0.0,
        "total_failed_delivery_deadline_penalty": 0.0,
        "total_failed_time_window_count": 0.0,
        "total_failed_time_window_duration_s": 0.0,
        "total_failed_time_window_penalty": 0.0,
        "total_fixed_cost": 24640.0,
        "total_global_proximity_distance_m": 1447957.78,
        "total_global_proximity_duration_s": 132113.68,
        "total_global_proximity_penalty": 0.0,
        "total_guaranteed_penalty": 0.0,
        "total_late_count": 0.0,
        "total_late_duration_s": 0.0,
        "total_late_penalty": 0.0,
        "total_lateness_risk_probability": 121.38,
        "total_locations_cost": 0.0,
        "total_mileage_penalty": 0.0,
        "total_penalty": 0.0,
        "total_probable_penalty": 13461.451,
        "total_proximity_distance_m": 1196907.782,
        "total_proximity_duration_s": 103341.27,
        "total_proximity_penalty": 0.0,
        "total_service_duration_s": 184140.0,
        "total_stop_count_penalty": 0.0,
        "total_stops": 99.3,
        "total_transit_distance_cost": 4707.986,
        "total_transit_distance_m": 941597.16,
        "total_transit_duration_s": 86330.82,
        "total_unfeasibility_count": 0.0,
        "total_unfeasibility_penalty": 0.0,
        "total_waiting_duration_s": 60.34,
        "total_work_breaks": 0.0,
        "used_vehicles": 7.0
    }

    rel_accuracies = {
        "global_proximity": 0.238275,
        "lateness_risk_locations_count": 0.713775,
        "operations_per_second": 0.0933,
        "proximity": 0.14737499999999998,
        "total_fixed_cost": 0.021375,
        "total_global_proximity_distance_m": 0.23745,
        "total_global_proximity_duration_s": 0.20085000000000003,
        "total_lateness_risk_probability": 0.6148500000000001,
        "total_probable_penalty": 0.632925,
        "total_proximity_distance_m": 0.0909,
        "total_proximity_duration_s": 0.07139999999999999,
        "total_transit_distance_cost": 0.033225,
        "total_transit_distance_m": 0.033225,
        "total_waiting_duration_s": 1.5709500000000003
    }

    tools.check_metrics_are_close(route["metrics"], expected_metrics, rel_accuracies)
