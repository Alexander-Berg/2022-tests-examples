import maps.b2bgeo.mvrp_solver.annealing_mvrp.tests_lib.mvrp_checker as mvrp_checker
import maps.b2bgeo.mvrp_solver.annealing_mvrp.tests_lib.tools as tools
import json
import pytest


@pytest.mark.skip(reason="test is broken")
def test_location_groups_azbuka():
    """
    Checks mvrp request of Azbuka with location groups instead of multiorders.

    Solver deviation results (30 runs):
    log2_iterations  cost_best  cost_avr     cost_2std(%)  cost_99err(%)
    10000000.000     85186.393  3290762.283  972.400       71379.370
    """

    task = json.load(open(tools.data_path('data/azbuka_lg_request.json')))

    route = mvrp_checker.solve_and_check(
        json.dumps(task),
        open(tools.data_path('data/azbuka_distances.json')).read(),
        solver_arguments={'sa_iterations': 10000000, 'sa_thread_count': 4},
        runs_count=5)

    expected_metrics = {
        "assigned_locations_count": 266.68,
        "balanced_group_duration_deviation_s": 0.0,
        "balanced_group_penalty": 0.0,
        "balanced_group_stop_count_deviation": 0.0,
        "depot_throughput_violation_kg": 0.0,
        "depot_throughput_violation_kg_per_hour": 0.0,
        "depot_throughput_violation_units": 0.0,
        "depot_throughput_violation_units_per_hour": 0.0,
        "dropped_locations_count": 0.32,
        "early_depot_count": 0.0,
        "early_locations_count": 0.0,
        "early_shifts_count": 0.04,
        "failed_max_work_duration_count": 0.0,
        "failed_min_work_duration_count": 0.0,
        "failed_time_window_depot_count": 0.0,
        "failed_time_window_depot_count_penalty": 0.0,
        "failed_time_window_depot_duration_penalty": 0.0,
        "failed_time_window_depot_duration_s": 0.0,
        "failed_time_window_locations_count": 0.0,
        "failed_time_window_locations_count_penalty": 0.0,
        "failed_time_window_locations_duration_penalty": 0.0,
        "failed_time_window_locations_duration_s": 0.0,
        "failed_time_window_shifts_count": 0.12,
        "failed_time_window_shifts_count_penalty": 120.0,
        "failed_time_window_shifts_duration_penalty": 22.395,
        "failed_time_window_shifts_duration_s": 79.04,
        "failed_work_duration_count": 0.0,
        "failed_work_duration_count_penalty": 0.0,
        "failed_work_duration_penalty": 0.0,
        "failed_work_duration_s": 0.0,
        "global_proximity": 25.858,
        "late_depot_count": 0.0,
        "late_locations_count": 0.0,
        "late_shifts_count": 0.08,
        "max_vehicle_runs": 4.48,
        "number_of_routes": 34.96,
        "objective_minimum": 645042425.955,
        "operations_per_second": 39699.923,
        "optimization_steps": 10000008.28,
        "overtime_duration_penalty": 0.0,
        "overtime_duration_s": 0.0,
        "overtime_penalty": 0.0,
        "overtime_shifts_count": 0.0,
        "overtime_shifts_count_penalty": 0.0,
        "proximity": 15.374,
        "total_cost": 90619.889,
        "total_cost_with_penalty": 3290762.283,
        "total_depot_penalty": 0.0,
        "total_drop_penalty": 3200000.0,
        "total_duration_cost": 15436.326,
        "total_duration_s": 555707.72,
        "total_early_count": 0.04,
        "total_early_duration_s": 36.72,
        "total_early_penalty": 50.404,
        "total_failed_delivery_deadline_count": 0.0,
        "total_failed_delivery_deadline_duration_s": 0.0,
        "total_failed_delivery_deadline_penalty": 0.0,
        "total_failed_time_window_count": 0.12,
        "total_failed_time_window_duration_s": 79.04,
        "total_failed_time_window_penalty": 142.395,
        "total_fixed_cost": 32520.0,
        "total_global_proximity_distance_m": 2065005.28,
        "total_global_proximity_duration_s": 173754.36,
        "total_global_proximity_penalty": 0.0,
        "total_guaranteed_penalty": 3200142.395,
        "total_late_count": 0.08,
        "total_late_duration_s": 42.32,
        "total_late_penalty": 91.991,
        "total_locations_cost": 0.0,
        "total_mileage_penalty": 0.0,
        "total_penalty": 3200142.395,
        "total_proximity_distance_m": 4995870.046,
        "total_proximity_duration_s": 333749.361,
        "total_proximity_penalty": 0.0,
        "total_runs_cost": 0.0,
        "total_service_duration_s": 206920.8,
        "total_stop_count_penalty": 0.0,
        "total_stops": 90.96,
        "total_transit_distance_cost": 42663.563,
        "total_transit_distance_m": 5332945.4,
        "total_transit_duration_s": 348771.36,
        "total_unfeasibility_count": 0.0,
        "total_unfeasibility_penalty": 0.0,
        "total_waiting_duration_s": 15.56,
        "total_work_breaks": 0.0,
        "used_vehicles": 10.84
    }

    rel_accuracies = {
        "dropped_locations_count": 7.5,
        "early_shifts_count": 7.5,
        "failed_time_window_shifts_count": 4.1457749999999995,
        "failed_time_window_shifts_count_penalty": 4.1457749999999995,
        "failed_time_window_shifts_duration_penalty": 4.3245000000000005,
        "failed_time_window_shifts_duration_s": 4.3245000000000005,
        "global_proximity": 0.15645,
        "late_shifts_count": 5.19165,
        "max_vehicle_runs": 0.17070000000000002,
        "number_of_routes": 0.029025,
        "objective_minimum": 7.44135,
        "operations_per_second": 0.13440000000000002,
        "proximity": 0.119775,
        "total_cost": 0.0372,
        "total_cost_with_penalty": 7.293,
        "total_drop_penalty": 7.5,
        "total_early_count": 7.5,
        "total_early_duration_s": 7.5,
        "total_early_penalty": 7.5,
        "total_failed_time_window_count": 4.1457749999999995,
        "total_failed_time_window_duration_s": 4.3245000000000005,
        "total_failed_time_window_penalty": 4.150275,
        "total_fixed_cost": 0.09517499999999998,
        "total_global_proximity_distance_m": 0.16005,
        "total_global_proximity_duration_s": 0.13897500000000002,
        "total_guaranteed_penalty": 7.499625000000001,
        "total_late_count": 5.19165,
        "total_late_duration_s": 5.19165,
        "total_late_penalty": 5.19165,
        "total_penalty": 7.499625000000001,
        "total_proximity_distance_m": 0.030074999999999998,
        "total_proximity_duration_s": 0.031275,
        "total_transit_distance_cost": 0.022125000000000002,
        "total_transit_distance_m": 0.022125000000000002,
        "total_transit_duration_s": 0.023850000000000003,
        "total_waiting_duration_s": 6.670425,
        "used_vehicles": 0.09517499999999998
    }

    tools.check_metrics_are_close(route["metrics"], expected_metrics, rel_accuracies)


def test_location_groups_kse():
    """
    Checks mvrp request of KSE with location groups instead of multiorders.

    Solver deviation results (55 runs):
    log2_iterations  cost_best   cost_avr    cost_2std(%)  cost_99err(%)
    10000000.000     198509.472  209706.453  4.030         10.860
    """

    task = json.load(open(tools.data_path('data/kse_lg_request.json')))
    route = mvrp_checker.solve_and_check(
        json.dumps(task),
        open(tools.data_path('data/kse_distances.json')).read(),
        solver_arguments={'sa_iterations': 10000000, 'sa_thread_count': 4},
        runs_count=5)

    expected_metrics = {
        "assigned_locations_count": 1137.0,
        "balanced_group_duration_deviation_s": 0.0,
        "balanced_group_penalty": 0.0,
        "balanced_group_stop_count_deviation": 0.0,
        "depot_throughput_violation_kg": 0.0,
        "depot_throughput_violation_kg_per_hour": 0.0,
        "depot_throughput_violation_units": 0.0,
        "depot_throughput_violation_units_per_hour": 0.0,
        "dropped_locations_count": 0.0,
        "early_depot_count": 0.0,
        "early_locations_count": 0.0,
        "early_shifts_count": 0.0,
        "failed_max_work_duration_count": 0.0,
        "failed_min_work_duration_count": 0.0,
        "failed_time_window_depot_count": 0.0,
        "failed_time_window_depot_count_penalty": 0.0,
        "failed_time_window_depot_duration_penalty": 0.0,
        "failed_time_window_depot_duration_s": 0.0,
        "failed_time_window_locations_count": 0.0,
        "failed_time_window_locations_count_penalty": 0.0,
        "failed_time_window_locations_duration_penalty": 0.0,
        "failed_time_window_locations_duration_s": 0.0,
        "failed_time_window_shifts_count": 0.62,
        "failed_time_window_shifts_count_penalty": 620.0,
        "failed_time_window_shifts_duration_penalty": 1137.708,
        "failed_time_window_shifts_duration_s": 4015.44,
        "failed_work_duration_count": 0.0,
        "failed_work_duration_count_penalty": 0.0,
        "failed_work_duration_penalty": 0.0,
        "failed_work_duration_s": 0.0,
        "global_proximity": 2.11,
        "late_depot_count": 0.0,
        "late_locations_count": 0.0,
        "late_shifts_count": 0.62,
        "max_vehicle_runs": 1.0,
        "number_of_routes": 12.94,
        "objective_minimum": 11333170.911,
        "operations_per_second": 19010.863,
        "optimization_steps": 10000007.5,
        "overtime_duration_penalty": 0.0,
        "overtime_duration_s": 0.0,
        "overtime_penalty": 0.0,
        "overtime_shifts_count": 0.0,
        "overtime_shifts_count_penalty": 0.0,
        "proximity": 0.496,
        "total_cost": 207948.745,
        "total_cost_with_penalty": 209706.453,
        "total_depot_penalty": 0.0,
        "total_drop_penalty": 0.0,
        "total_duration_cost": 45650.825,
        "total_duration_s": 328685.94,
        "total_early_count": 0.0,
        "total_early_duration_s": 0.0,
        "total_early_penalty": 0.0,
        "total_failed_delivery_deadline_count": 0.0,
        "total_failed_delivery_deadline_duration_s": 0.0,
        "total_failed_delivery_deadline_penalty": 0.0,
        "total_failed_time_window_count": 0.62,
        "total_failed_time_window_duration_s": 4015.44,
        "total_failed_time_window_penalty": 1757.708,
        "total_fixed_cost": 38820.0,
        "total_global_proximity_distance_m": 1017323.62,
        "total_global_proximity_duration_s": 230962.04,
        "total_global_proximity_penalty": 0.0,
        "total_guaranteed_penalty": 1757.708,
        "total_late_count": 0.62,
        "total_late_duration_s": 4015.44,
        "total_late_penalty": 1757.708,
        "total_locations_cost": 0.0,
        "total_mileage_penalty": 0.0,
        "total_penalty": 1757.708,
        "total_proximity_distance_m": 261933.6,
        "total_proximity_duration_s": 60791.146,
        "total_proximity_penalty": 0.0,
        "total_runs_cost": 0.0,
        "total_service_duration_s": 277533.0,
        "total_stop_count_penalty": 0.0,
        "total_stops": 497.26,
        "total_transit_distance_cost": 123477.92,
        "total_transit_distance_m": 246955.84,
        "total_transit_duration_s": 51068.66,
        "total_unfeasibility_count": 0.0,
        "total_unfeasibility_penalty": 0.0,
        "total_waiting_duration_s": 84.28,
        "total_work_breaks": 0.0,
        "used_vehicles": 12.94
    }

    rel_accuracies = {
        "failed_time_window_shifts_count": 1.3839875,
        "failed_time_window_shifts_count_penalty": 1.3839875,
        "failed_time_window_shifts_duration_penalty": 2.0169625,
        "failed_time_window_shifts_duration_s": 2.0169625,
        "global_proximity": 0.11392499999999998,
        "late_shifts_count": 1.3839875,
        "number_of_routes": 0.0504875,
        "objective_minimum": 0.034912500000000006,
        "operations_per_second": 0.14542500000000003,
        "proximity": 0.06798749999999999,
        "total_cost": 0.036750000000000005,
        "total_cost_with_penalty": 0.0352625,
        "total_failed_time_window_count": 1.3839875,
        "total_failed_time_window_duration_s": 2.0169625,
        "total_failed_time_window_penalty": 1.6784249999999998,
        "total_fixed_cost": 0.0504875,
        "total_global_proximity_distance_m": 0.11366250000000001,
        "total_global_proximity_duration_s": 0.1075375,
        "total_guaranteed_penalty": 1.6784249999999998,
        "total_late_count": 1.3839875,
        "total_late_duration_s": 2.0169625,
        "total_late_penalty": 1.6784249999999998,
        "total_penalty": 1.6784249999999998,
        "total_proximity_distance_m": 0.056875,
        "total_proximity_duration_s": 0.061337499999999996,
        "total_transit_distance_cost": 0.044449999999999996,
        "total_transit_distance_m": 0.044449999999999996,
        "total_transit_duration_s": 0.06168749999999999,
        "total_waiting_duration_s": 2.8632625,
        "used_vehicles": 0.0504875
    }

    tools.check_metrics_are_close(route["metrics"], expected_metrics, rel_accuracies)


@pytest.mark.skip(reason="test is broken")
def test_solid_location_groups_azbuka():
    """
    Checks mvrp request of Azbuka with solid, dependent location groups instead of multiorders.

    Solver deviation results (30 runs):
    log2_iterations  cost_best  cost_avr   cost_2std(%)  cost_99err(%)
    10000000.000     87847.523  90320.700  4.080         7.300
    """

    task = json.load(open(tools.data_path('data/azbuka_solid_request.json')))

    route = mvrp_checker.solve_and_check(
        json.dumps(task),
        open(tools.data_path('data/azbuka_distances.json')).read(),
        solver_arguments={'sa_iterations': 10000000, 'sa_thread_count': 4},
        runs_count=5)

    expected_metrics = {
        "assigned_locations_count": 267.0,
        "balanced_group_duration_deviation_s": 0.0,
        "balanced_group_penalty": 0.0,
        "balanced_group_stop_count_deviation": 0.0,
        "depot_throughput_violation_kg": 0.0,
        "depot_throughput_violation_kg_per_hour": 0.0,
        "depot_throughput_violation_units": 0.0,
        "depot_throughput_violation_units_per_hour": 0.0,
        "dropped_locations_count": 0.0,
        "early_depot_count": 0.0,
        "early_locations_count": 0.0,
        "early_shifts_count": 0.08,
        "failed_max_work_duration_count": 0.0,
        "failed_min_work_duration_count": 0.0,
        "failed_time_window_depot_count": 0.0,
        "failed_time_window_depot_count_penalty": 0.0,
        "failed_time_window_depot_duration_penalty": 0.0,
        "failed_time_window_depot_duration_s": 0.0,
        "failed_time_window_locations_count": 0.0,
        "failed_time_window_locations_count_penalty": 0.0,
        "failed_time_window_locations_duration_penalty": 0.0,
        "failed_time_window_locations_duration_s": 0.0,
        "failed_time_window_shifts_count": 0.16,
        "failed_time_window_shifts_count_penalty": 160.0,
        "failed_time_window_shifts_duration_penalty": 45.084,
        "failed_time_window_shifts_duration_s": 159.122,
        "failed_work_duration_count": 0.0,
        "failed_work_duration_count_penalty": 0.0,
        "failed_work_duration_penalty": 0.0,
        "failed_work_duration_s": 0.0,
        "global_proximity": 26.182,
        "late_depot_count": 0.0,
        "late_locations_count": 0.0,
        "late_shifts_count": 0.08,
        "max_vehicle_runs": 4.92,
        "number_of_routes": 35.6,
        "objective_minimum": 5007715.458,
        "operations_per_second": 41902.181,
        "optimization_steps": 10000009.04,
        "overtime_duration_penalty": 0.0,
        "overtime_duration_s": 0.0,
        "overtime_penalty": 0.0,
        "overtime_shifts_count": 0.0,
        "overtime_shifts_count_penalty": 0.0,
        "proximity": 15.195,
        "total_cost": 90115.616,
        "total_cost_with_penalty": 90320.7,
        "total_depot_penalty": 0.0,
        "total_drop_penalty": 0.0,
        "total_duration_cost": 15545.182,
        "total_duration_s": 559626.56,
        "total_early_count": 0.08,
        "total_early_duration_s": 91.92,
        "total_early_penalty": 106.044,
        "total_failed_delivery_deadline_count": 0.0,
        "total_failed_delivery_deadline_duration_s": 0.0,
        "total_failed_delivery_deadline_penalty": 0.0,
        "total_failed_time_window_count": 0.16,
        "total_failed_time_window_duration_s": 159.122,
        "total_failed_time_window_penalty": 205.084,
        "total_fixed_cost": 31320.0,
        "total_global_proximity_distance_m": 2080985.64,
        "total_global_proximity_duration_s": 175630.08,
        "total_global_proximity_penalty": 0.0,
        "total_guaranteed_penalty": 205.084,
        "total_late_count": 0.08,
        "total_late_duration_s": 67.202,
        "total_late_penalty": 99.04,
        "total_locations_cost": 0.0,
        "total_mileage_penalty": 0.0,
        "total_penalty": 205.084,
        "total_proximity_distance_m": 5090281.859,
        "total_proximity_duration_s": 339270.679,
        "total_proximity_penalty": 0.0,
        "total_runs_cost": 0.0,
        "total_service_duration_s": 206220.0,
        "total_stop_count_penalty": 0.0,
        "total_stops": 90.0,
        "total_transit_distance_cost": 43250.434,
        "total_transit_distance_m": 5406304.2,
        "total_transit_duration_s": 353372.64,
        "total_unfeasibility_count": 0.0,
        "total_unfeasibility_penalty": 0.0,
        "total_waiting_duration_s": 33.92,
        "total_work_breaks": 0.0,
        "used_vehicles": 10.44
    }

    rel_accuracies = {
        "early_shifts_count": 6.056925,
        "failed_time_window_shifts_count": 4.0924625,
        "failed_time_window_shifts_count_penalty": 4.0924625,
        "failed_time_window_shifts_duration_penalty": 4.329149999999999,
        "failed_time_window_shifts_duration_s": 4.329149999999999,
        "global_proximity": 0.167475,
        "late_shifts_count": 6.056925,
        "max_vehicle_runs": 0.09852499999999999,
        "number_of_routes": 0.0317625,
        "objective_minimum": 0.036312500000000004,
        "operations_per_second": 0.1642375,
        "proximity": 0.14542500000000003,
        "total_cost": 0.0343875,
        "total_cost_with_penalty": 0.0357,
        "total_early_count": 6.056925,
        "total_early_duration_s": 6.188524999999999,
        "total_early_penalty": 6.0649750000000004,
        "total_failed_time_window_count": 4.0924625,
        "total_failed_time_window_duration_s": 4.329149999999999,
        "total_failed_time_window_penalty": 4.1041875,
        "total_fixed_cost": 0.09773749999999999,
        "total_global_proximity_distance_m": 0.16843750000000002,
        "total_global_proximity_duration_s": 0.14769999999999997,
        "total_guaranteed_penalty": 4.1041875,
        "total_late_count": 6.056925,
        "total_late_duration_s": 6.4924125,
        "total_late_penalty": 6.07355,
        "total_penalty": 4.1041875,
        "total_proximity_distance_m": 0.0286125,
        "total_proximity_duration_s": 0.029312500000000002,
        "total_transit_distance_cost": 0.023625000000000004,
        "total_transit_distance_m": 0.023625000000000004,
        "total_transit_duration_s": 0.024849999999999997,
        "total_waiting_duration_s": 7.8725499999999995,
        "used_vehicles": 0.09773749999999999
    }

    tools.check_metrics_are_close(route["metrics"], expected_metrics, rel_accuracies)


@pytest.mark.skip(reason="test is broken")
def test_solid_location_groups_kse():
    """
    Checks mvrp request of KSE with solid, dependent location groups instead of multiorders.

    Solver deviation results (55 runs):
    log2_iterations  cost_best   cost_avr    cost_2std(%)  cost_99err(%)
    10000000.000     213479.522  238466.093  22.540        32.170
    """

    task = json.load(open(tools.data_path('data/kse_solid_request.json')))
    route = mvrp_checker.solve_and_check(
        json.dumps(task),
        open(tools.data_path('data/kse_distances.json')).read(),
        solver_arguments={'sa_iterations': 10000000, 'sa_thread_count': 4},
        runs_count=5)

    expected_metrics = {
        "assigned_locations_count": 1137.0,
        "balanced_group_duration_deviation_s": 0.0,
        "balanced_group_penalty": 0.0,
        "balanced_group_stop_count_deviation": 0.0,
        "depot_throughput_violation_kg": 0.0,
        "depot_throughput_violation_kg_per_hour": 0.0,
        "depot_throughput_violation_units": 0.0,
        "depot_throughput_violation_units_per_hour": 0.0,
        "dropped_locations_count": 0.0,
        "early_depot_count": 0.0,
        "early_locations_count": 0.34,
        "early_shifts_count": 0.0,
        "failed_max_work_duration_count": 0.0,
        "failed_min_work_duration_count": 0.0,
        "failed_time_window_depot_count": 0.0,
        "failed_time_window_depot_count_penalty": 0.0,
        "failed_time_window_depot_duration_penalty": 0.0,
        "failed_time_window_depot_duration_s": 0.0,
        "failed_time_window_locations_count": 0.34,
        "failed_time_window_locations_count_penalty": 340.0,
        "failed_time_window_locations_duration_penalty": 20400.6,
        "failed_time_window_locations_duration_s": 6120.18,
        "failed_time_window_shifts_count": 0.78,
        "failed_time_window_shifts_count_penalty": 780.0,
        "failed_time_window_shifts_duration_penalty": 1661.059,
        "failed_time_window_shifts_duration_s": 5862.56,
        "failed_work_duration_count": 0.0,
        "failed_work_duration_count_penalty": 0.0,
        "failed_work_duration_penalty": 0.0,
        "failed_work_duration_s": 0.0,
        "global_proximity": 2.181,
        "late_depot_count": 0.0,
        "late_locations_count": 0.0,
        "late_shifts_count": 0.78,
        "max_vehicle_runs": 1.0,
        "number_of_routes": 12.98,
        "objective_minimum": 12771302.875,
        "operations_per_second": 18276.391,
        "optimization_steps": 10000010.32,
        "overtime_duration_penalty": 0.0,
        "overtime_duration_s": 0.0,
        "overtime_penalty": 0.0,
        "overtime_shifts_count": 0.0,
        "overtime_shifts_count_penalty": 0.0,
        "proximity": 0.528,
        "total_cost": 215284.434,
        "total_cost_with_penalty": 238466.093,
        "total_depot_penalty": 0.0,
        "total_drop_penalty": 0.0,
        "total_duration_cost": 47366.664,
        "total_duration_s": 341039.98,
        "total_early_count": 0.34,
        "total_early_duration_s": 6120.18,
        "total_early_penalty": 20740.6,
        "total_failed_delivery_deadline_count": 0.0,
        "total_failed_delivery_deadline_duration_s": 0.0,
        "total_failed_delivery_deadline_penalty": 0.0,
        "total_failed_time_window_count": 1.12,
        "total_failed_time_window_duration_s": 11982.74,
        "total_failed_time_window_penalty": 23181.659,
        "total_fixed_cost": 38940.0,
        "total_global_proximity_distance_m": 1044793.26,
        "total_global_proximity_duration_s": 233134.06,
        "total_global_proximity_penalty": 0.0,
        "total_guaranteed_penalty": 23181.659,
        "total_late_count": 0.78,
        "total_late_duration_s": 5862.56,
        "total_late_penalty": 2441.059,
        "total_locations_cost": 0.0,
        "total_mileage_penalty": 0.0,
        "total_penalty": 23181.659,
        "total_proximity_distance_m": 276719.506,
        "total_proximity_duration_s": 64270.117,
        "total_proximity_penalty": 0.0,
        "total_runs_cost": 0.0,
        "total_service_duration_s": 276555.0,
        "total_stop_count_penalty": 0.0,
        "total_stops": 494.0,
        "total_transit_distance_cost": 128977.77,
        "total_transit_distance_m": 257955.54,
        "total_transit_duration_s": 53590.8,
        "total_unfeasibility_count": 0.0,
        "total_unfeasibility_penalty": 0.0,
        "total_waiting_duration_s": 10894.18,
        "total_work_breaks": 0.0,
        "used_vehicles": 12.98
    }

    rel_accuracies = {
        "early_locations_count": 1.75925,
        "failed_time_window_locations_count": 1.75925,
        "failed_time_window_locations_count_penalty": 1.75925,
        "failed_time_window_locations_duration_penalty": 1.75925,
        "failed_time_window_locations_duration_s": 1.75925,
        "failed_time_window_shifts_count": 0.9321875000000001,
        "failed_time_window_shifts_count_penalty": 0.9321875000000001,
        "failed_time_window_shifts_duration_penalty": 1.194375,
        "failed_time_window_shifts_duration_s": 1.194375,
        "global_proximity": 0.13574999999999998,
        "late_shifts_count": 0.9321875000000001,
        "number_of_routes": 0.030687500000000003,
        "objective_minimum": 0.131625,
        "operations_per_second": 0.10825,
        "proximity": 0.04699999999999999,
        "total_cost": 0.0229375,
        "total_cost_with_penalty": 0.140875,
        "total_duration_cost": 0.028874999999999998,
        "total_duration_s": 0.028874999999999998,
        "total_early_count": 1.75925,
        "total_early_duration_s": 1.75925,
        "total_early_penalty": 1.75925,
        "total_failed_time_window_count": 0.48568749999999994,
        "total_failed_time_window_duration_s": 0.7545000000000001,
        "total_failed_time_window_penalty": 1.508,
        "total_fixed_cost": 0.030687500000000003,
        "total_global_proximity_distance_m": 0.1360625,
        "total_global_proximity_duration_s": 0.1264375,
        "total_guaranteed_penalty": 1.508,
        "total_late_count": 0.9321875000000001,
        "total_late_duration_s": 1.194375,
        "total_late_penalty": 1.0534375000000002,
        "total_penalty": 1.508,
        "total_proximity_distance_m": 0.03862499999999999,
        "total_proximity_duration_s": 0.041749999999999995,
        "total_transit_distance_cost": 0.026625,
        "total_transit_distance_m": 0.026625,
        "total_transit_duration_s": 0.040687499999999995,
        "total_waiting_duration_s": 0.904125,
        "used_vehicles": 0.030687500000000003
    }

    tools.check_metrics_are_close(route["metrics"], expected_metrics, rel_accuracies)
