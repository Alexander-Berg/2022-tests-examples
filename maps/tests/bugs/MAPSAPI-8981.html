<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251" />
<title>Поиск стоянок</title>
<style type="text/css">
    html {
        font-family: Verdana, Arial, Helvetica, Sans-Serif;
    }
    body {
        text-align: center;
        margin: 0;
        padding: 0;
        vertical-align: top;
    }
    #map {
        margin: 40px auto;
        margin-bottom: 20px;
        width: 480px;
        height: 380px;
        border: 1px solid #999;
    }
    #output {
        margin: 24px auto;
        margin-top: 16px;
        width: 72%;
    }
    .details {
        margin: 18px auto;
        border-collapse: collapse;
        border-spacing: 0px;
    }
    .details td {
        border: 1px solid #bbb;
        font-size: 12px;
        padding: 2px 5px;
    }
    .details thead td {
        font-weight: bold;
        border: 1px solid #888;
        border-collapse: separate;
        background: #bfbfbf;
        margin: 0px;
    }
    .details .time {
        text-align: left;
    }
    #circlesize {
    linear-gradient(to top, #f2f2f2 0px, #e3e3e3 40%, #d6d6d6 50%, #e3e3e3 60%, #f2f2f2 100%);
        background: -o-linear-gradient(bottom, #f2f2f2 0px, #e3e3e3 40%, #d6d6d6 50%, #e3e3e3 60%, #f2f2f2 100%) transparent;
        border-radius: 1px;
        border-top: 1px solid #C0C0C0;
        box-shadow: 0px 1px 2px 0px #333333;
        cursor: default;
        height: 380px;
        position: absolute;
        right: 230px;
        top: 40px;
        width: 7px;
    }
    #thumb {
        background: linear-gradient(to top, #F2F2F2 0px, #CFCFCF 60%, #F4F4F4 100%);
        background: -o-linear-gradient(bottom, #F2F2F2 0px, #CFCFCF 60%, #F4F4F4 100%) transparent;
        border-radius: 1px;
        border-top: 1px solid #C0C0B0;
        box-shadow: 0px 1px 1px 1px #888888;
        height: 7px;
        left: -5px;
        margin: 0px auto;
        position: absolute;
        top: 187px;
        width: 18px;
    }
    #thumb:hover, #thumb.active {
        background: linear-gradient(to top, #F2F2F2 0px, #D2D2D2 60%, #F4F4F4 100%);
        background: -o-linear-gradient(bottom, #F2F2F2 0px, #D2D2D2 60%, #F4F4F4 100%) transparent;
        border: 1px solid #DD9900;
        box-shadow: 0px 0px 1px 1px rgba(255, 163, 0, 0.7);
        left: -6px;
    }
    #selector, #selector2 {
        background: linear-gradient(to top, #F2F2F2 0px, #CFCFCF 60%, #F4F4F4 100%);
        background: -o-linear-gradient(bottom, #F2F2F2 0px, #CFCFCF 60%, #F4F4F4 100%) transparent;
        border-radius: 3px;
        box-shadow: 0px 1px 3px 0px #333;
        cursor: default;
        font-family: "Arial";
        font-size: 14px;
        height: 20px;
        padding: 3px 3px 0px 5px;
        position: absolute;
        right: 40px;
        text-align: left;
        top: 40px;
        width: 100px;
    }
    #selector2 {
        left: 58px;
        right: auto;
        width: 124px;
    }
    #selector::selection, #selector2::selection, #list>li::selection, #list2>li::selection {
        background: transparent;
    }
    #selector:hover, #selector.active, #selector2:hover, #selector2.active {
        background: linear-gradient(to top, #F2F2F2 0px, #DEDEDE 60%, #F6F6F6 100%);
        background: -o-linear-gradient(bottom, #F2F2F2 0px, #DEDEDE 60%, #F6F6F6 100%) transparent;
        box-shadow: 0px 0px 2px 1px rgba(255, 163, 0, 0.8);
        /*box-shadow: 0px 0px 2px 1px #FFA300, inset -1px -1px 5px 1px #888;*/
    }
    .arrow {
        /*background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAALCAYAAABlNU3NAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDowNTgwMTE3NDA3MjA2ODExODcxRkRGMkYyNERFQjIwNyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDo3NUFFMDk1QzM2MDIxMUUxODgxMEQ1OTMzRkE4MDA1OCIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo3NUFFMDk1QjM2MDIxMUUxODgxMEQ1OTMzRkE4MDA1OCIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjA2ODAxMTc0MDcyMDY4MTE4NzFGREYyRjI0REVCMjA3IiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjA1ODAxMTc0MDcyMDY4MTE4NzFGREYyRjI0REVCMjA3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+R+9qKQAAALtJREFUeNpi/P//PwMtARMDjQELuRo9PT3RhYS2b9/+DlkeyEdYABTgAVLngVgFi3l3gFgbqOEXDvuEgPgk0AxzIP0OVxCBNBfgMKAAj+Eg0AJ1WAu+OPgFNGQrkN6KpmYrVBwXABmcDGUno4cAtkgugPqGkK9gYAIQs0HZbFA+bguArgWF91wody6Ujwt4QzFOMVzJtAYasTV4DMdwLZqvQBHPwAjLaLBkhZSqhNBTBLI8sYCR1jkZIMAAzLs+qWnPOqMAAAAASUVORK5CYII=') -2px 5px/32px no-repeat;*/
        background: url('/graphics/2.gif') 3px 9px no-repeat;
        position: absolute;
        right: 3px;
        top: 0px;
        width: 12px;
        height: 20px;
    }
    #list, #list2 {
        display: none;
        background: linear-gradient(to top, #F2F2F2 0px, #CFCFCF 60%, #F4F4F4 100%);
        background: -o-linear-gradient(bottom, #F2F2F2 0px, #CFCFCF 60%, #F4F4F4 100%) transparent;
        border-radius: 3px;
        box-shadow: 2px 2px 4px 0px rgba(51, 51, 51, 0.7);
        cursor: default;
        font-family: "Arial";
        font-size: 14px;
        padding: 0px;
        position: absolute;
        right: 42px;
        text-align: left;
        top: 64px;
        width: 104px;
        height: auto;
        overflow: hidden;
        border-left: 1px solid #ccc;
    }
    #list2{
        left: 60px;
        right: auto;
        width: 126px;
    }
    #list>li, #list2>li {
        list-style: none;
        padding: 3px 4px;
    }
    #list2>li {
        padding: 1px 4px 3px 4px;
    }
    #list>li:hover, #list2>li:hover {
        background: linear-gradient(to top, rgba(30, 190, 255, 0.196) 0px, rgba(30, 180, 230, 0.478) 50%, rgba(30, 190, 255, 0.196) 100%);
        background: -o-linear-gradient(bottom, rgba(30, 190, 255, 0.196) 0px, rgba(30, 180, 230, 0.478) 50%, rgba(30, 190, 230, 0.196) 100%) transparent;
    }
    #metroSwitch {
        font-size: 11px;
    }
    #metro_checkbox, .checkbox {
        display: inline-block;
        width: 18px;
        height: 18px;
        background: url('/graphics/checkbox.png');
        background-position: 0px 0px;
        background-repeat: no-repeat;
        margin-right: 12px;
    }
    #metro_checkbox:hover {
        background-position: -18px 0px;
    }
    #metro_checkbox.enabled {
        background-position: -36px 0px;
    }
    #metro_checkbox.enabled:hover {
        background-position: -54px 0px;
    }
    #metro_radius {
        width: 22px;
        margin 0px 10px;
    }
    .checkbox {
        background: url('/graphics/tick.png');
        margin-right: 6px;
    }
</style>
<script type="text/javascript">
    function getElementsByClass(searchClass, node, tag) {
        var result = new Array();
        if ( node == null )
            node = document;
        if ( tag == null )
            tag = '*';
        var els = node.getElementsByTagName(tag);
        var elsLen = els.length;

        var pattern = new RegExp("(^|\\s)"+searchClass+"(\\s|$)");
        for (i = 0, j = 0; i < elsLen; i++) {
            if ( pattern.test(els[i].className) ) {
                result[j] = els[i];
                j++;
            }
        }
        return result;
    }
    function getWidth() {
        return document.compatMode=='CSS1Compat' && !window.opera ? document.documentElement.clientWidth : document.body.clientWidth
    }
</script>
<script type="text/javascript">

var myMap, myPlacemark, myCircle, marks = [];

var w1 = 0, w2 = 0

var sort_type = 1

var zoom = 11;
var center = [59.943698339361, 30.311436586921];

function createMap(){
    myMap = new ymaps.Map ("map", {
        center: center,
        zoom: zoom,
    });

    myMap.controls.add(new ymaps.control.ZoomControl());

    var coords = [59.93428, 30.335099];
    myMap.setCenter(coords, zoom, {})

    /*var bounds = myMap.getBounds()
     if (coords[0] < bounds[0][0] || coords[0] > bounds[1][0] ||
     coords[1] < bounds[0][1] || coords[1] > bounds[1][1]) {
     myMap.setCenter(coords, zoom, {})
     }*/


    myPlacemark = new ymaps.Placemark(coords, {}, { preset: 'twirl#houseIcon' });
    myMap.geoObjects.add(myPlacemark);

    myCircle = new ymaps.Circle([coords,1000], {}, {
        fillColor: "#2470DB77",
        strokeColor: "#0099CC",
        strokeOpacity: 0.8,
        strokeWidth: 3
    });

    myCircle.contains = function(p) {
        var distance = myMap.options.get('projection').getCoordSystem().getDistance(p.geometry.getCoordinates(), myCircle.geometry.getCoordinates());
        return (distance <= myCircle.geometry.getRadius());
    }

    myMap.geoObjects.add(myCircle);

}

function addMarks() {
    var count = 0
    var t = null
    var str = ''
    var a = []
    for (var i = 0; i < marks.length; i++) {
        var p = new ymaps.Placemark(marks[i].coords.reverse(), { iconContent: i+1,
            balloonContent: marks[i].baloon.content,
            balloonContentHeader: marks[i].baloon.header,
            balloonContentFooter: marks[i].baloon.footer }, {})
        myMap.geoObjects.add(p);
        if (myCircle.contains(p)) {
            p.options.set({
                preset: 'twirl#greenStretchyIcon',
            });
            p.properties.set({
                walk: 1,
            });
            count++
            var d = myMap.options.get('projection').getCoordSystem().getDistance(p.geometry.getCoordinates(), myCircle.geometry.getCoordinates())
            a.push({obj: p, index: i, distance: d})
        } else {
            p.options.set({
                preset: 'twirl#blueStretchyIcon',
            });
        }
    }
    if (count > 0) {
        t = printHeader()
        if (sort_type == 1) a.sort(function(a, b) {
            if (a.distance < b.distance) return -1;
            if (a.distance > b.distance) return  1;
            return 0;
        });
        for (var j = 0; j < a.length; j++) {
            var p = a[j].obj
            var i = a[j].index
            var d = a[j].distance
            str += '<tr><td>' + (i+1) + '</td><td class="time">' + marks[i].baloon.footer + '</td><td>' + marks[i].baloon.header.replace(/^"(.*)"$/, '$1').replace(/"{2,}/g, '"') + '</td>'
                + '<td>' + Math.round(d) + ' м.</td><td><img src="/graphics/walk.png" width="16" height="16" /></td></tr>'
        }

        t.innerHTML += str
        document.getElementById('output').appendChild(t)
        document.getElementById('count').innerHTML = count
        if (count % 100 % 10 == 0 || count % 100 % 10 > 4 || count % 100 > 10 && count % 100 < 20) document.getElementById('name').innerHTML = 'остановок'
        else if (count % 100 % 10 > 1) document.getElementById('name').innerHTML = 'остановки'
        attachHandlers()
        myMap.setZoom(14, {})
    }
    if (document.body.clientHeight > screen.availHeight) {
        w2 = getWidth()
        document.body.style.paddingRight = ''
        document.getElementById('circlesize').style.right = 230 - (w1 - w2) + 'px'
    } else {
        w1 = getWidth()
        document.body.style.paddingRight = (w2 > 0 ? w1 - w2 : 17) + 'px'
        document.getElementById('circlesize').style.right = ''
    }
}

function printHeader() {
    var period = 'В ближайшем месяце'
    if (location.search.slice(1) == 'week') period = 'В ближайшую неделю'
    if (location.search.slice(1) == '2weeks') period = 'В ближайшие 2 недели'
    document.getElementById('output').innerHTML = period + ' поблизости будет <span id="count">' + 0 + '</span> <span id="name">остановка</span> Экомобиля:'
    var t = document.createElement('table')
    t.className = 'details sort'
    t.innerHTML += '<thead><td>Номер</td><td>Время</td><td>Адрес</td><td>Расстояние</td><td>&nbsp;</td></thead>'
    return t
}

function updateRadius() {
    var y = parseInt(document.getElementById('thumb').style.top)
    if (y == -1) y = 0;
    var r = Math.round(y / 374 * 1000 + 500);
    myCircle.geometry.setRadius(r)
}

function recalculate() {
    var count = 0
    var t = null
    var notable = (getElementsByClass('details', null, 'table').length == 0)
    if (!notable) t = getElementsByClass('details', null, 'table')[0]
    var str = ''
    var a = []
    myMap.geoObjects.each(function(p) {
        if (p.geometry.getType() == 'Circle' || p.options.get('preset') == 'twirl#houseIcon') return
        if (myCircle.contains(p)) {
            p.options.set({
                preset: 'twirl#greenStretchyIcon',
            });
            p.properties.set({
                walk: 1,
            });
            count++
            var d = myMap.options.get('projection').getCoordSystem().getDistance(p.geometry.getCoordinates(), myCircle.geometry.getCoordinates())
            a.push({obj: p, distance: d})
        } else {
            p.options.set({
                preset: 'twirl#blueStretchyIcon',
            });
            p.properties.set({
                walk: 0,
            });
        }
    });

    if (sort_type == 1) a.sort(function(a, b) {
        if (a.distance < b.distance) return -1;
        if (a.distance > b.distance) return  1;
        return 0;
    });
    for (var i = 0; i < a.length; i++) {
        var p = a[i].obj
        var d = a[i].distance
        str += '<tr><td>' + p.properties.get('iconContent') + '</td><td class="time">' + p.properties.get('balloonContentFooter') + '</td><td>' + p.properties.get('balloonContentHeader').replace(/^"(.*)"$/, '$1').replace(/"{2,}/g, '"') + '</td>'
            + '<td>' + Math.round(d) + ' м.</td><td><img src="/graphics/walk.png" width="16" height="16" /></td></tr>'
    }

    if (count > 0) {
        if (!notable) {
            t.getElementsByTagName('tbody')[0].innerHTML = str
        } else {
            t = printHeader()
            t.innerHTML += str
            document.getElementById('output').appendChild(t)
        }
        if (!metro) {
            document.getElementById('count').innerHTML = count
            if (count % 100 % 10 == 0 || count % 100 % 10 > 4 || count % 100 > 10 && count % 100 < 20) document.getElementById('name').innerHTML = 'остановок'
            else if (count % 100 % 10 > 1) document.getElementById('name').innerHTML = 'остановки'
            else if (count % 100 % 10 == 1) document.getElementById('name').innerHTML = 'остановка'
        }
        attachHandlers()
    } else {
        document.getElementById('output').innerHTML = ''
    }
    if (document.body.clientHeight > screen.availHeight) {
        w2 = getWidth()
        document.body.style.paddingRight = ''
        document.getElementById('circlesize').style.right = 230 - (w1 - w2) + 'px'
    } else {
        w1 = getWidth()
        document.body.style.paddingRight = (w2 > 0 ? w1 - w2 : 17) + 'px'
        document.getElementById('circlesize').style.right = ''
    }
    if (metro) recalculateMetro()
}

var stations = []
var metro_radius = 700

var metro = false

function findNearMetro() {
    ymaps.geocode(center, {
        kind: 'metro',
        boundedBy: [[59.80257409043927, 30.01815663710933], [60.06446428256283, 30.677336324609346]],
        results: 160
    }).then(function(res) {
        res.geoObjects.each(function(st) {
            var c = new ymaps.Circle([st.geometry.getCoordinates(), metro_radius], {}, {
                fillColor: "#FFFFFF66",
                strokeColor: "#FFFFFF",
                strokeOpacity: 0.8,
                strokeWidth: 3,
                visible: false});
            stations.push({name: st.properties.get('name'), coords: st.geometry.getCoordinates(), obj: c});

            c.contains = function(p) {
                var distance = myMap.options.get('projection').getCoordSystem().getDistance(p.geometry.getCoordinates(), this.geometry.getCoordinates());
                return (distance <= this.geometry.getRadius());
            }

            myMap.geoObjects.add(c);

        });
        stations.sort(function(a, b) {
            var d1 = myMap.options.get('projection').getCoordSystem().getDistance(a.coords, myCircle.geometry.getCoordinates());
            var d2 = myMap.options.get('projection').getCoordSystem().getDistance(b.coords, myCircle.geometry.getCoordinates());
            if (d1 < d2) return -1;
            if (d1 > d2) return  1;
            return 0;
        });
        recalculateMetro();
    });
}

function updateMetroRadius() {
    metro_radius = parseInt(document.getElementById('metro_radius').value)
    if (isNaN(metro_radius)) {
        metro_radius = 700
        document.getElementById('metro_radius').value = '700'
    }
    myMap.geoObjects.each(function(p) {
        if (p.geometry.getType() == 'Circle' && p != myCircle) {
            p.geometry.setRadius(metro_radius)
        }
    });
    removeMetro()
    recalculateMetro()
}

function recalculateMetro() {
    var notable = (getElementsByClass('details', null, 'table').length == 0)
    var count = 0
    var t = null
    var str = ''
    if (!notable) var t = getElementsByClass('details', null, 'table')[0]
    myMap.geoObjects.each(function(p) {

        if (p.geometry.getType() == 'Circle' || p.options.get('preset') == 'twirl#houseIcon' || p.properties.get('walk') == 1) return

        var suits = false
        var min_dist = 9999
        var station = -1
        for (var i = 0; i < stations.length; i++) {
            if (stations[i].obj.contains(p)) {
                if (!suits) {
                    count++
                    suits = true
                    p.options.set({
                        preset: 'twirl#greenStretchyIcon',
                    });
                    p.properties.set({
                        nearMetro: 1,
                    });
                }
                var d = myMap.options.get('projection').getCoordSystem().getDistance(p.geometry.getCoordinates(), stations[i].obj.geometry.getCoordinates())
                if (d < min_dist) {
                    min_dist = d
                    station = i
                }
            }
        }
        if (suits) {
            if (!stations[station].points) stations[station].points = []
            stations[station].points.push({ obj: p, distance: min_dist })
        } else {
            p.options.set({
                preset: 'twirl#blueStretchyIcon',
            });
        }
    });

    if (count > 0) {
        if (!notable) {
            var b = getElementsByClass('details', null, 'table')[0].getElementsByTagName('tbody')
            if (b.length > 1) getElementsByClass('details', null, 'table')[0].removeChild(b[1])
        }
        var flag = false
        if (sort_type == 1) {
            for (var i = 0; i < stations.length; i++) {
                if (stations[i].points) {
                    stations[i].points.sort(function(a, b) {
                        if (a.distance < b.distance) return -1;
                        if (a.distance > b.distance) return  1;
                        return 0;
                    });
                    for (var j = 0; j < stations[i].points.length; j++) {
                        var p = stations[i].points[j].obj
                        var address = p.properties.get('balloonContentHeader').replace(/^"(.*)"$/, '$1').replace(/"{2,}/g, '"')
                        if (address.indexOf('ст.') != 0) address = 'ст. м. ' + stations[i].name.slice(6) + ', ' + address
                        else address = 'ст. м. ' + stations[i].name.slice(6) + ',' + address.split(',')[1]
                        str += '<tr><td>' + p.properties.get('iconContent') + '</td><td class="time">' + p.properties.get('balloonContentFooter') + '</td><td>' + address + '</td>'
                            + '<td>' + Math.round(stations[i].points[j].distance) + ' м.</td><td><img src="/graphics/metro.png" /></td></tr>'
                        flag = true
                    }
                }
                stations[i].points = null
            }
        } else {
            var a = []
            for (var i = 0; i < stations.length; i++) {
                if (stations[i].points) {
                    for (var j = 0; j < stations[i].points.length; j++) {
                        a.push(stations[i].points[j])
                        a[a.length-1].station = stations[i].name
                    }
                }
                stations[i].points = null
            }
            a.sort(function(a, b) {
                if (a.obj.properties.get('iconContent') < b.obj.properties.get('iconContent')) return -1;
                if (a.obj.properties.get('iconContent') > b.obj.properties.get('iconContent')) return  1;
                return 0;
            });
            for (var i = 0; i < a.length; i++) {
                var p = a[i].obj
                var address = p.properties.get('balloonContentHeader').replace(/^"(.*)"$/, '$1').replace(/"{2,}/g, '"')
                if (address.indexOf('ст.') != 0) address = 'ст. м. ' + a[i].station.slice(6) + ', ' + address
                else address = 'ст. м. ' + a[i].station.slice(6) + ',' + address.split(',')[1]
                str += '<tr><td>' + p.properties.get('iconContent') + '</td><td class="time">' + p.properties.get('balloonContentFooter') + '</td><td>' + address + '</td>'
                    + '<td>' + Math.round(a[i].distance) + ' м.</td><td><img src="/graphics/metro.png" /></td></tr>'
                flag = true
            }
        }
        if (flag && notable) t = printHeader()
        t.innerHTML += str
        if (notable) document.getElementById('output').appendChild(t)
        var c = notable ? 0 : t.getElementsByTagName('tbody')[0].getElementsByTagName('tr').length
        count = c + count //parseInt(document.getElementById('count').innerHTML) + count
        document.getElementById('count').innerHTML = count
        if (count % 100 % 10 == 0 || count % 100 % 10 > 4 || count % 100 > 10 && count % 100 < 20) document.getElementById('name').innerHTML = 'остановок'
        else if (count % 100 % 10 > 1) document.getElementById('name').innerHTML = 'остановки'
        if (document.body.clientHeight > screen.availHeight) {
            w2 = getWidth()
            document.body.style.paddingRight = ''
            document.getElementById('circlesize').style.right = 230 - (w1 - w2) + 'px'
        } else {
            w1 = getWidth()
            document.body.style.paddingRight = (w2 > 0 ? w1 - w2 : 17) + 'px'
            document.getElementById('circlesize').style.right = ''
        }
        attachHandlers()
    }
}

function removeMetro() {
    var notable = (getElementsByClass('details', null, 'table').length == 0)
    if (notable) return
    var count = 0
    myMap.geoObjects.each(function(p) {

        if (p.geometry.getType() == 'Circle' || p.options.get('preset') == 'twirl#houseIcon') return

        if (p.properties.get('nearMetro') == 1) {
            count++
            p.properties.set({
                nearMetro: 0,
            });
            if (p.properties.get('walk') != 1) {
                p.options.set({
                    preset: 'twirl#blueStretchyIcon',
                });
            }
        }
    });

    if (!notable) {
        var b = getElementsByClass('details', null, 'table')[0].getElementsByTagName('tbody')
        if (b.length > 1) {
            getElementsByClass('details', null, 'table')[0].removeChild(b[1])
        } else {
            if (b[0].getElementsByTagName('tr')[0].lastChild.firstChild.getAttribute('src') == '/graphics/metro.png') {
                document.getElementById('output').innerHTML = ''
                document.body.style.paddingRight = (w2 > 0 ? w1 - w2 : 17) + 'px'
                document.getElementById('circlesize').style.right = ''
                return
            }
        }
    }

    count = parseInt(document.getElementById('count').innerHTML) - count
    document.getElementById('count').innerHTML = count
    if (count % 100 % 10 == 0 || count % 100 % 10 > 4 || count % 100 > 10 && count % 100 < 20) document.getElementById('name').innerHTML = 'остановок'
    else if (count % 100 % 10 > 1) document.getElementById('name').innerHTML = 'остановки'
    else if (count % 100 % 10 == 1) document.getElementById('name').innerHTML = 'остановка'
    if (document.body.clientHeight > screen.availHeight) {
        w2 = getWidth()
        document.body.style.paddingRight = ''
        document.getElementById('circlesize').style.right = 230 - (w1 - w2) + 'px'
    } else {
        w1 = getWidth()
        document.body.style.paddingRight = (w2 > 0 ? w1 - w2 : 17) + 'px'
        document.getElementById('circlesize').style.right = ''
    }
}

function orderByTime() {
    getElementsByClass('checkbox', document.getElementById('list2'), 'div')[0].style.background = ''
    getElementsByClass('checkbox', document.getElementById('list2'), 'div')[1].style.background = 'none'
    sort_type = 0
    recalculate()
}

function orderByDist() {
    getElementsByClass('checkbox', document.getElementById('list2'), 'div')[1].style.background = ''
    getElementsByClass('checkbox', document.getElementById('list2'), 'div')[0].style.background = 'none'
    sort_type = 1
    recalculate()
}

function attachHandlers() {
    var rows = getElementsByClass('details', null, 'table')[0].getElementsByTagName('tr')
    for (var i = 1; i < rows.length; i++) {
        rows[i].onmouseover = function() {
            this.style.background = '#dfdfdf'
        }
        rows[i].onmouseout = function() {
            this.style.background = ''
        }
        rows[i].onclick = function() {
            var id = this.firstChild.innerHTML
            myMap.geoObjects.each(function(p) {
                if (p.geometry.getType() == 'Circle' || p.options.get('preset') == 'twirl#houseIcon') return
                if (p.properties.get('iconContent') == id) { myMap.setCenter(p.geometry.getCoordinates()); p.balloon.open(); window.scrollTo(0, 0) }
            });
        }
    }
}

function detectIE() {
    var ua = navigator.userAgent
    if (ua.indexOf('MSIE') != -1) {
        var i = ua.indexOf('MSIE')
        if (parseInt(ua.slice(i+5, i+6)) < 9) {
            document.body.innerHTML = '<div style="margin: 200px auto; font-family: Verdana; text-align: center">Ваш браузер не поддерживается</div>'
            return true
        }
        return false
    }
}

function init() {
    if (detectIE()) return
    w1 = getWidth()
    document.body.style.paddingRight = '17px'
    var img = new Image('/graphics/tick.png')
    var s = document.createElement('script');
//    s.setAttribute('src', 'http://api-maps.yandex.ru/2.0-stable/?load=package.standard,package.geoObjects&mode=debug&lang=ru-RU');
    s.setAttribute('src', 'http://netmac.etna.maps.dev.yandex.net/2.0/build/index.xml?load=package.standard,package.geoObjects&mode=debug&lang=ru-RU');
    s.setAttribute('type', 'text/javascript');
    document.head.appendChild(s);
    var type = (location.search != '') ? '?type=' + location.search.slice(1) : ''
    var modes = ['week', '2weeks', 'month']
    for (var i = 0; i < 3; i++) {
        if (location.search == '?' + modes[i]) {
            document.getElementById('selector').innerHTML = document.getElementById('list').getElementsByTagName('li')[i].innerHTML + '<div class="arrow"></div>'
        }
    }

    if (navigator.userAgent.toLowerCase().indexOf('opera') == -1) {
        document.getElementById('metro_checkbox').style.verticalAlign = 'middle'
        document.getElementById('metro_checkbox').style.marginBottom = '6px'
        getElementsByClass('checkbox', document.getElementById('list2'), 'div')[0].style.verticalAlign = 'middle'
        getElementsByClass('checkbox', document.getElementById('list2'), 'div')[1].style.verticalAlign = 'middle'
        getElementsByClass('checkbox', document.getElementById('list2'), 'div')[0].style.marginBottom = '6px'
        getElementsByClass('checkbox', document.getElementById('list2'), 'div')[1].style.marginBottom = '6px'
    } else {
        document.getElementById('metro_checkbox').style.marginBottom = '-3px'
        getElementsByClass('checkbox', document.getElementById('list2'), 'div')[0].style.marginBottom = '-3px'
        getElementsByClass('checkbox', document.getElementById('list2'), 'div')[1].style.marginBottom = '-3px'
    }

    getElementsByClass('checkbox', document.getElementById('list2'), 'div')[0].style.background = 'none'

    document.getElementById('metro_checkbox').onclick = function() {
        if (this.className == '') {
            this.className = 'enabled'
            if (stations.length == 0) findNearMetro()
            else recalculateMetro()
            metro = true
        } else {
            this.className = ''
            removeMetro()
            metro = false
        }
    }

    document.getElementById('metro_radius').onkeydown = function(event) {
        var evt = event ? event: window.event;
        var code = (evt.charCode) ? evt.charCode : evt.keyCode;
        if (code == 13) updateMetroRadius()
    }

    document.getElementById('thumb').style.top = '187px'
    document.getElementById('thumb').onmousedown = function(event) {
        var e = event || window.event
        d = e.clientY - document.documentElement.scrollTop - document.getElementById('thumb').getBoundingClientRect()['top']
        document.getElementById('thumb').className = 'active'
        drag = true
    }

    document.onmousemove = function(event) {
        if (!drag) return
        var e = event || window.event
        var y = e.clientY - document.getElementById('circlesize').offsetTop - d
        if (y < -1) y = -1;
        if (y > 373) y = 373;
        document.getElementById('thumb').style.top = y + 'px'
        updateRadius()
    }

    document.onmouseup = function(event) {
        if (!drag) return
        d = 0
        document.getElementById('thumb').className = ''
        drag = false
        updateRadius()
        recalculate()
    }

    document.getElementById('list').onmouseover = function() {
        document.getElementById('selector').className = 'active'
    }
    document.getElementById('selector').onclick = function(event) {
        if (document.getElementById('list').style.display == '') document.getElementById('list').style.display = 'block'
        else document.getElementById('list').style.display = ''
        var e = event || window.event
        e.stopPropagation()
        e.cancelBubble = true
    }
    document.getElementById('list2').onmouseover = function() {
        document.getElementById('selector2').className = 'active'
    }
    document.getElementById('selector2').onclick = function(event) {
        if (document.getElementById('list2').style.display == '') document.getElementById('list2').style.display = 'block'
        else document.getElementById('list2').style.display = ''
        var e = event || window.event
        e.stopPropagation()
        e.cancelBubble = true
    }
    document.body.onclick = function(event) {
        document.getElementById('list').style.display = ''
        document.getElementById('selector').className = ''
        document.getElementById('list2').style.display = ''
        document.getElementById('selector2').className = ''
    }
    setTimeout(function() { ymaps.ready(createMap); document.getElementById('ifr').src = 'http://kudainfo.ru/get_eco_coords.php' + type; }, 4000);
}

document.onkeydown = function(event) {
    var e = event || window.event
    if (e.ctrlKey && e.keyCode == 88) {
        var txt = ''
        if (window.getSelection) {
            txt = window.getSelection();
        } else if (document.getSelection) {
            txt = document.getSelection();
        } else if (document.selection) {
            txt = document.selection.createRange().text;
        }
        if (txt != '') return true;
        if (!metro) {
            if (stations.length == 0) findNearMetro();
            else recalculateMetro();
            metro = true;
            document.getElementById('metro_checkbox').className = 'enabled';
        } else {
            removeMetro();
            metro = false;
            document.getElementById('metro_checkbox').className = '';
        }
        return false;
    }
    if (e.ctrlKey && e.keyCode == 83) {
        var txt = ''
        if (window.getSelection) {
            txt = window.getSelection();
        } else if (document.getSelection) {
            txt = document.getSelection();
        } else if (document.selection) {
            txt = document.selection.createRange().text;
        }
        if (txt != '') return true;
        if (sort_type == 0) {
            orderByDist()
        } else {
            orderByTime()
        }
        return false;
    }
}

var drag = false
var d = 0

</script>
</head>
<body onload="init()">
<div id="selector2">Упорядочить по<div class="arrow"></div></div>
<div id="list2">
    <li onclick="orderByTime()"><div class="checkbox"></div>Времени</li>
    <li onclick="orderByDist()"><div class="checkbox"></div>Расстоянию</li>
</div>
<div id="map"></div>
<div id="circlesize"><div id="thumb"></div></div>
<div id="selector">За неделю<div class="arrow"></div></div>
<div id="list">
    <li onclick="location.search = '?week'">За неделю</li>
    <li onclick="location.search = '?2weeks'">За 2 недели</li>
    <li onclick="location.search = '?month'">За месяц</li>
</div>
<div id="metroSwitch"><div id="metro_checkbox"></div>Искать также стоянки в радиусе <input type="text" id="metro_radius" value="700" maxlength="3" /> метров от станций метро</div>
<div id="output"></div>
<iframe id="ifr" src="" style="visibility: hidden; position: absolute; top: 0px; left: 0px; width: 10px; height: 10px;"></iframe>
</body>
</html>