#include "common.h"
#include "../test_tools/io_std.h"

#include <yandex/maps/coverage5/coverage.h>
#include <yandex/maps/coverage5/layer.h>

#include <boost/test/unit_test.hpp>

#include <fstream>
#include <sstream>

using namespace maps;
using namespace maps::coverage5::test;

typedef std::vector<coverage5::RegionId> RegionIDs;

const char* g_mmsGeoidCoverage = "mms/libcov_geoid.mms.1";


struct BBoxGeoIDTestData {
    std::string name;
    geolib3::BoundingBox bbox;
    RegionIDs ids;
};

BBoxGeoIDTestData g_geoidTestData[] {
    // small bboxes
    { "Moscow and obl", {{37.306299, 55.75298}, {37.614924, 56.185361}}, {213, 1, 225} },
    { "Spb and Lenobl", {{30.100545, 59.871874}, {30.348842, 59.922735}}, {2, 10174, 225} },
    { "Ekb and Sverdl. obl", {{60.506572, 56.8}, {61.334029, 57.078652}}, {54, 11162, 225} },
    { "N.Novgorod and obl", {{43.955539, 56.3}, {44, 56.35316}}, {47, 11079, 225} },
    { "Novosib and obl", {{82.90651, 55.000292}, {83.04651, 55.120292}}, {65, 11316, 225} },
    { "Rostov-on-Don and obl", {{39.595212,47.120266}, {39.737452, 47.23501}}, {39, 11029, 225} },
    { "Krasnodar and kraj", {{38.966719, 45.01637}, {38.986719, 45.03637}}, {35, 10995, 225} },
    { "Samara", {{49.984899, 53.124007}, {50.443133, 53.231785}}, {51, 11131, 225} },
    { "Kazan and Tatarstan", {{49.038646, 55.5842}, {49.338646, 55.8842}}, {43, 11119, 225} },
    { "Kharkov and obl", {{36.073572, 49.7922}, {36.473572, 50.1922}}, {147, 20538, 187} },
    { "Odessa and obl", {{30.526804, 46.2698}, {30.926804, 46.6698}}, {145, 20541, 187} },
    { "Orel and obl", {{35.8544, 52.7682}, {36.2544, 53.1682}}, {10, 10772, 225} },
    { "Ufa and Bash.", {{55.7681, 54.9324}, {56.1681, 54.9324}}, {172, 11111, 225} },
    { "Chelabinsk and obl", {{61.2067, 54.9652}, {61.6067, 55.3652}}, {56, 11225, 225} },
    { "N.Chelny and Tatarstan", {{52.1989, 55.5395}, {52.5989, 55.9395}}, {236, 11119, 225} },
    { "Tula and obl", {{37.4114, 53.9932}, {37.8114, 54.3932}}, {15, 10832, 225} },
    { "Dnepropetrovsk and obl", {{34.8109, 48.25}, {35.2109, 48.65}}, {141, 20537, 187} },
    { "Donetsk and obl", {{37.5665, 47.7877}, {37.9665, 48.1877}}, {142, 20536, 187} },
    { "Lvov and obl", {{23.8103, 49.6303}, {24.2103, 50.0303}}, {144, 20529, 187} },
    { "Zaporoj'e and obl", {{34.9859, 47.6395}, {35.3859, 48.0395}}, {960, 20539, 187} },
    { "Almaty and obl", {{76.7257, 43.0782}, {77.1257, 43.4782}}, {162, 29406} },
    { "Astana and Akmolinskaya obl", {{71.2527, 50.9624}, {71.6527, 51.3624}}, {163, 29403} },
    { "Krasnoyarsk and kraj", {{92.6598, 55.8133}, {93.0598, 56.2133}}, {62, 11309, 225} },
    { "Omsk and obl", {{73.1808, 54.789}, {73.5808, 55.189}}, {66, 11318, 225} },
    { "Poltava and obl", {{34.338, 49.2915}, {34.738, 49.7915}}, {964, 20549, 187} },
    { "Volgograd and obl", {{44.3046, 48.5093}, {44.7046, 48.9093}}, {38, 10950, 225} },
    { "Yaroslavl and obl", {{39.6939, 57.4241}, {40.0939, 57.8241}}, {16, 10841, 225} },
    { "Khabarovsk and obl, Evrejskaya AO", {{134.884, 48.276}, {135.284, 48.676}}, {76, 10243, 11457, 225} },
    { "Orenburg and obl", {{54.9097, 51.5695}, {55.3097, 51.9695}}, {48, 11084, 225} },
    { "Perm and kraj", {{56.0411, 57.8}, {56.4411, 58.2}}, {50, 11108, 225} },
    { "Saratov and obl", {{45.8237, 51.3379}, {46.2237, 51.7379}}, {194, 11146, 225} },
    { "Voronej and obl", {{38.9903, 51.4492}, {39.3903, 51.8492}}, {193, 10672, 225} },
    { "Kiev and obl", {{30.3223, 50.2511}, {30.7223, 50.6511}}, {143, 20544, 187} },
    { "Minsk and obl", {{27.3617, 53.7035}, {27.7617, 54.1035}}, {157, 29630} },
    { "Irkutsk and obl", {{104.076, 52.113}, {104.476, 52.513}}, {63, 11266, 225} },
    { "Vladivostok and Primor`e", {{131.728, 42.9341}, {132.128, 43.3341}}, {75, 11409, 225} },
    { "Tjumen and obl", {{65.3584, 56.9826}, {65.7584, 57.3826}}, {55, 11176, 225} },
    { "Penza and obl", {{44.7974, 52.9832}, {45.1974, 53.3832}}, {49, 11095, 225} },
    { "Kursk and obl", {{35.9817, 51.5172}, {36.3817, 51.9172}}, {8, 10705, 225} },
    { "Kirov and obl", {{49.4672, 58.4034}, {49.8672, 58.8034}}, {46, 11070, 225} },
    { "V.Novgorod and obl", {{31.0703, 58.3227}, {31.4703, 58.7227}}, {24, 10904, 225} },
    { "Sochi and Krasn. kraj", {{39.5223, 43.3828}, {39.9223, 43.7828}}, {239, 10995, 225} },
    { "Tver and obl", {{35.6922, 56.6555}, {36.0922, 57.0555}}, {14, 10819, 225} },
    { "Gelendzhik and Krasn. kraj", {{37.8824, 44.3582}, {38.2824, 44.7582}}, {10990, 10995, 225} },
    { "Anapa and Krasn. kraj", {{37.1231, 44.6898}, {37.5231, 45.0898}}, {1107, 10995, 225} },
    { "Tuapse and Krasn. kraj", {{38.8801, 43.8995}, {39.2801, 44.2995}}, {1058, 10995, 225} },
    { "Krasnaja Poljana and Krasn. kraj", {{40.161905, 43.654978}, {40.251512, 43.693852}}, {10994, 10995, 225} },
    { "Krasnaja Poljana, Adygeya and Krasn. kraj", {{40.0056, 43.4794}, {40.4056, 43.8794}}, {10994, 11004, 10995, 225} },
    { "Novorossijsk and Krasn. kraj", {{37.6767, 44.6205}, {37.8767, 44.8205}}, {970, 10995, 225} },
    { "Uzhgorod", {{22.0884, 48.4259}, {22.4884, 48.8259}}, {10358, 20530, 187} },
    { "Ivano-Frankovsk and obl", {{24.6171, 48.8117}, {24.8171, 49.0117}}, {10345, 20532, 187} },
    { "Lutsk, Volynskaya obl", {{25.2445, 50.7569}, {25.4445, 50.8569}}, {20222, 20550, 187} },
    { "Lutsk, Volynskaya and Rovenskaya obl", {{25.2445, 50.6569}, {25.4445, 50.8569}}, {20222, 20534, 20550, 187} },
    { "Ternopol and obl", {{25.4945, 49.4536}, {25.6945, 49.6536}}, {10357, 20531, 187} },
    { "Chernovtsy and obl", {{25.8349, 48.1923}, {26.0349, 48.3923}}, {10365, 20533, 187} },
    { "Rovno and obl", {{26.1508, 50.5198}, {26.3508, 50.7198}}, {10355, 20534, 187} },
    { "Khmelnitskij and obl", {{26.8787, 49.32}, {27.0787, 49.52}}, {961, 20535, 187} },
    { "Vinnitsa and obl", {{28.3737, 49.1336}, {28.5737, 49.3336}}, {963, 20545, 187} },
    { "Cherkassy and obl", {{31.9594, 49.3447}, {32.1594, 49.5447}}, {10363, 20546, 187} },
    { "Nikolaev and obl", {{31.8876, 46.865}, {32.0876, 47.065}}, {148, 20543, 187} },
    { "Kirovograd and obl", {{32.0665, 48.3104}, {32.4665, 48.7104}}, {20221, 20548, 187} },
    { "Herson and obl", {{32.5139, 46.5403}, {32.7139, 46.7403}}, {962, 20542, 187} },
    { "Sumy and obl", {{34.7029, 50.812}, {34.9029, 51.012}}, {965, 20552, 187} },
    { "Lugansk and obl", {{39.2076, 48.4721}, {39.4076, 48.6721}}, {222, 20540, 187} },
    { "Chernigov and obl", {{31.1984, 51.3911}, {31.3984, 51.5911}}, {966, 20551, 187} },
    { "Sevastopol and Krym", {{33.4246, 44.5175}, {33.6246, 44.7175}}, {959, 977, 187} },
    { "Simferopol and Krym", {{33.9971, 44.8523}, {34.1971, 45.0523}}, {146, 977, 187} },
    { "Zhitomir and obl", {{28.6574, 50.2546}, {28.6574, 50.2546}}, {10343, 187} },
    { "Stavropol and kraj", {{41.7652, 44.8429}, {42.1652, 45.2429}}, {36, 11069, 225} },
    { "Kola, Murmansk and obl", {{32.9778, 68.8633}, {33.1778, 69.0633}}, {20154, 23, 10897, 225} },
    { "Kaliningrad and obl", {{20.4008, 54.6197}, {20.6008, 54.8197}}, {22, 10857, 225} },
    { "Petrozavodsk and Kareliya", {{34.245, 61.6844}, {34.445, 61.8844}}, {10933, 225} },
    { "Pskov and obl", {{28.2621, 57.7044}, {28.4621, 57.9044}}, {10926, 225} },
    { "Ivanovo and obl", {{40.7797, 56.8176}, {41.1797, 57.2176}}, {10687, 225} },
    { "Vladimir and obl", {{40.2203, 55.9303}, {40.6203, 56.3303}}, {10658, 225} },
    { "Tambov and obl", {{41.2282, 52.5174}, {41.6282, 52.9174}}, {10802, 225} },
    { "Lipetsk and obl", {{39.3681, 52.4235}, {39.7681, 52.8235}}, {10712, 225} },
    { "Belgorod and obl", {{36.4067, 50.3943}, {36.8067, 50.7943}}, {10645, 225} },
    { "Elista and Kalmykiya", {{44.0788, 46.1288}, {44.4788, 46.5288}}, {11015, 225} },
    { "Maikop and Adygeya", {{39.983658, 44.528358}, {40.229992, 44.652005}}, {11004, 225} },
    { "Maikop, Adygeya and Krasnodarskiy kraj", {{39.754285, 44.454543}, {40.866986, 44.735047}}, {11004, 10995, 225} },
    { "Mahachkala and Dagestan", {{47.3904, 42.8802}, {47.5904, 43.0802}}, {11010, 225} },
    { "Cherkessk and K-Ch R", {{41.9676, 44.1386}, {42.1676, 44.3386}}, {11020, 225} },
    { "Nalchick and K-B R", {{43.518, 43.3907}, {43.718, 43.5907}}, {11013, 225} },
    { "Grozniy and Chechnya", {{45.5858, 43.2084}, {45.7858, 43.4084}}, {11024, 225} },
    { "Vladikavkaz and SO-A R", {{44.5882, 42.9378}, {44.7882, 43.1378}}, {11021, 225} },
    { "Nazran and Ingushetiya", {{44.6695, 43.329}, {44.8695, 43.329}}, {11012, 225} },
    { "Syiktyivkar and Komi", {{50.6919, 61.5582}, {50.8919, 61.7582}}, {10939, 225} },
    { "Kostroma and obl", {{40.8254, 57.6666}, {41.0254, 57.8666}}, {10699, 225} },
    { "Barnaul and Altajskij kraj", {{83.6572, 53.4513}, {83.8572, 53.4513}}, {11235, 225} },
    { "Blagoveshenskand Amurskaya obl", {{127.441, 50.1875}, {127.641, 50.3875}}, {11375, 225} },
    { "Birobidgan and Evrejskaya AO", {{132.835, 48.6929}, {133.035, 48.8929}}, {10243, 225} },
    { "Kemerovo and obl", {{85.9603, 55.2438}, {86.1603, 55.4438}}, {11282, 225} },
    { "Kurgan and obl", {{65.2197, 55.3416}, {65.4197, 55.5416}}, {11158, 225} },
    { "Gorno-Altaysk and Altaj", {{85.935474, 51.926625}, {86.0596, 52.0578}}, {10231, 225} },
    { "Gorno-Altaysk, Altaj, Altajskij kraj", {{85.7596, 51.8578}, {86.0596, 52.0578}}, {10231, 11235, 225} },
    { "Ulan-Ude and Buryatiya", {{107.483, 51.7407}, {107.683, 51.9407}}, {11330, 225} },
    { "Kyizyil and Tyva", {{94.3223, 51.6023}, {94.5223, 51.8023}}, {10233, 225} },
    { "Tomsk and obl", {{84.8914, 56.3603}, {85.0914, 56.5603}}, {11353, 225} },
    { "Hanty-Mansiysk and AO", {{68.9272, 60.9087}, {69.1272, 61.1087}}, {11193, 225} },
    { "Magadan and obl", {{150.699, 59.4605}, {150.899, 59.6605}}, {11403, 225} },
    { "Smolensk and obl", {{31.9345, 54.698}, {32.1345, 54.898}}, {10795, 225} },
    { "Kaluga and obl", {{36.1786, 54.4335}, {36.3786, 54.6335}}, {10693, 225} },
    { "Cheboksary and Chuvashiya", {{47.1643, 56.0132}, {47.3643, 56.2132}}, {11156, 225} },
    { "Bryansk and obl", {{34.3059, 53.162}, {34.5059, 53.362}}, {10650, 225} },
    { "Izhevsk and Udmurtiya", {{53.0898, 56.7015}, {53.2898, 56.9015}}, {11148, 225} },
    { "Yoshkar-Ola and Marij El", {{47.7802, 56.5219}, {47.9802, 56.7219}}, {11077, 225} },
    { "Petropavlovsk-Kamchatskiy and Kamch. kraj", {{158.536, 52.9564}, {158.736, 53.1564}}, {11398, 225} },
    { "Chita and Zabajkal`e", {{113.395, 51.9282}, {113.595, 52.1282}}, {21949, 225} },
    { "Astrakhan and obl", {{47.959, 46.2604}, {48.159, 46.4604}}, {10946, 225} },
    { "Saransk and Mordoviya", {{45.0904, 54.0956}, {45.2904, 54.2956}}, {11117, 225} },
    { "Ulyanovsk and obl", {{48.31216, 54.206953}, {48.51216, 54.406953}}, {11153, 225} },
    { "Arkhangelsk and obl", {{40.4742, 64.4508}, {40.6742, 64.6508}}, {10842, 225} },
    { "Salekhard and Yamalo-Nenetskij AO", {{66.5269, 66.4313}, {66.7269, 66.6313}}, {11232, 225} },
    { "Yakutsk and resp", {{129.656, 61.9407}, {129.856, 62.1407}}, {11443, 225} },
    { "Anadyr and Chukotka", {{177.421, 64.6363}, {177.621, 64.8363}}, {10251, 225} },
    { "Naryan-Mar and Nenetskij AO", {{52.9064, 67.5389}, {53.1064, 67.7389}}, {10176, 225} },
    { "Vologda and obl", {{39.7831, 59.1068}, {39.9831, 59.3068}}, {10853, 225} },
    { "Uelen - Chukotka", {{-169.902, 66.0558}, {-169.702, 66.2558}}, {10251, 225} },
    { "nowhere", {{30.2488, 85.8227}, {30.4488, 86.0227}}, {} },
    // big bboxes
    { "Moscow + obl, Ryazan + obl, Tulskaya obl", {{37.306299, 54.6202}, {39.7158, 55.690726}}, {11, 213, 10832, 10776, 1, 225} },
    { "Bryansk -- Yaroslavl", {{34.4059, 53.262}, {39.8939, 57.6241}}, {15, 14, 11, 16, 213, 10712, 10687, 10772, 10832, 10693, 10658, 10650, 10841, 10776, 1, 10795, 10819, 225} },
    { "Ukraine and South", {{34.245103, 48.193715}, {41.679343, 52.194963}}, {965, 964, 8, 222, 147, 141, 193, 20552, 20536, 10712, 20540, 10772, 10645, 20549, 20537, 20538, 10705, 10802, 10650, 10672, 11029, 10950, 187, 225} },
    { "Ural", {{49.587873, 53.831294}, {60.861157, 60.726230}}, {236, 46, 54, 172, 50, 11077, 11153, 11148, 11131, 11119, 11225, 11084, 11070, 11111, 11108, 11162, 10939, 225} },
    { "Sibir", {{88.784680, 60.494357}, {119.370617, 68.093307}}, {11266, 11309, 11443, 225} }
};

RegionIDs getRegionIDs(const coverage5::Regions& regions)
{
    RegionIDs ids;
    for (const coverage5::Region& region: regions) {
        ids.push_back(*region.id());
    }
    return ids;
}

BOOST_AUTO_TEST_CASE(tree_test_bbox_geoid)
{
    using namespace maps::coverage5;
    setTestsDataCwd();

    Coverage cov(g_mmsGeoidCoverage, SpatialRefSystem::Geodetic);

    for (const BBoxGeoIDTestData& test: g_geoidTestData) {
        RegionIDs regionIDs = getRegionIDs(
            cov["geoid"].regions(test.bbox, boost::none));
        BOOST_CHECK_MESSAGE(
            (regionIDs.size() == test.ids.size() && regionIDs == test.ids),
            "Region IDs check failed:\n\tBBox: " << test.bbox <<
            "\n\tName: " << test.name <<
            "\n\texpected: " << test.ids <<
            "\n\treceived: " << regionIDs);
    }
}
