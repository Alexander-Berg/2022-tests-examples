<!DOCTYPE html>
<!--
Title:
Геометрии регионов и стран мира на трех картах

Description:
Проверяем работу геометрии регионов и стран мира при работе трех контейнеров с картой.
Памятка по терминам: https://wiki.yandex-team.ru/eva/testing/Projects/maps-api/

Components:
regions

Estimated time:
180000

Precondition:
Открыть ссылку ${currentPagePath}

Step:
  Action:
  Осмотреть страницу и элементы на ней.

  Expectation:
  На странице отображаются три контейнера с картой.
  В каждом контейнере спан Белоруссии, при этом страна и регионы выделены синим, границы выделены.
  В контейнере слева вверху кнопки с выпадающими списками: "Регион: BY"; "Язык: en"; "Точность границ: 2".

Step:
  Action:
  Поводить курсором по окрашенным областям Белоруссии в каждом контейнере с картой.
 
  Expectation:
  На окрашенных областях курсор - палец, при наведении появляется хинт с наименованием областей на русском языке.

Step:
  Action:
  Клик в поле с выпадающим списком расположенное по центру в первом контейнере.
  В списке выбрать значение "английский".
 
  Expectation:
  После выбора список схлопывается, выбранное значение отображается в кнопке.

Step:
  Action:
  Поводить курсором по окрашенным областям Белоруссии в каждом контейнере с картой.
 
  Expectation:
  На окрашенных областях курсор - палец, при наведении появляется хинт с наименованием областей на английском языке.

Step:
  Action:
  Клик в крайнее левое поле с выпадающим списком расположенное в первом контейнере.
  В списке выбрать значение "Турция".
 
  Expectation:
  После выбора список схлопывается, выбранное значение отображается в кнопке "TR".
  Спан карты во всех трех контейнерах меняется на спан Турции, с окрашенными фоном и выделенными областями.

Step:
  Action:
  Клик в поле с выпадающим списком расположенное по центру в первом контейнере.
  В списке выбрать значение "турецкий".
 
  Expectation:
  После выбора список схлопывается, выбранное значение отображается в кнопке.
  
Step:
  Action:
  Поводить курсором по окрашенным областям Турции в каждом контейнере с картой.
 
  Expectation:
  На окрашенных областях курсор - палец, при наведении появляется хинт с наименованием областей на турецком языке.

Step:
  Action:
  Выполнить призум скролом мыши в первом контейнере с картой к пограничной области.
 
  Expectation:
  Происходит корректный зум карты, окрашенная область не пропадает.
  Во втором и третьем контейнере спан также меняется по аналогии с первым.

Step:
  Action:
  Клик в крайнее правое поле с выпадающим списком расположенное в первом контейнере.
  В списке выбрать значение "3".
 
  Expectation:
  Граница на спане карты меняется, становится точнее, после чего происходит смена спана карты на спан с обзором всей Турции.
  Выделение страны и областей внутри нее не пропадает.
  В других контейнерах спан меняется аналогично первому.

Step:
  Action:
  Клик в крайнее левое поле с выпадающим списком расположенное в первом контейнере.
  В списке выбрать значение "Страны миры".
 
  Expectation:
  Смена спана карты на спан с картой мира, при этом мир выделен синим фоном с разделением на страны, отчетливо видны границы..
  Во втором и третьем контейнере аналогичный спан карты.

Step:
  Action:
  Выполнить статичный и инертный драг карты в крайнем левом контейнере.
 
  Expectation:
  Происходит корректный драг карты, карта не пропадает, не мигает цветами.
  Окрашенные регионы мировой карты не пропадают.
  После окончания драга во втором и третьем контейнерах спан меняется на текущий спан первого контейнера с картой.
-->
<html lang="en">
<head>
    <title>2.1</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

    <link rel="stylesheet" href="https://yastatic.net/bootstrap/3.3.4/css/bootstrap.min.css"/>
    <script src="https://yastatic.net/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://yastatic.net/bootstrap/3.3.4/js/bootstrap.min.js"></script>

    <script src="https://api-maps.yandex.ru/2.1/?lang=ru-RU&mode=debug&ns=two"
            type="text/javascript"></script>
    <script src="../../helper.js"></script>
    <script type=text/javascript>
        var REGIONS_DATA = {
                    region: {
                        title: 'Регион',
                        items: [{
                            id: '001',
                            title: 'Страны мира'
                        }, {
                            id: 'AQ',
                            title: 'Антарктида'
                        }, {
                            id: 'BY',
                            title: 'Беларусь'
                        }, {
                            id: 'KZ',
                            title: 'Казахстан'
                        }, {
                            id: 'RU',
                            title: 'Россия'
                        }, {
                            id: 'TR',
                            title: 'Турция'
                        }, {
                            id: 'UA',
                            title: 'Украина'
                        }]
                    },
                    lang: {
                        title: 'Язык',
                        items: [{
                            id: 'en',
                            title: 'Английский'
                        }, {
                            id: 'be',
                            title: 'Белорусский'
                        }, {
                            id: 'kk',
                            title: 'Казахский'
                        }, {
                            id: 'ru',
                            title: 'Русский'
                        }, {
                            id: 'tr',
                            title: 'Турецкий'
                        }, {
                            id: 'uk',
                            title: 'Украинский'
                        }]
                    },
                    quality: {
                        title: 'Точность границ',
                        items: [{
                            id: '0',
                            title: '0'
                        }, {
                            id: '1',
                            title: '1'
                        }, {
                            id: '2',
                            title: '2'
                        }, {
                            id: '3',
                            title: '3'
                        }]
                    }
                },
        // Шаблон html-содержимого макета.
                optionsTemplate = [
                    '<div><div><div class="temp" style="line-height: 34px; background-color: #80808080;" id="regions-params">',
                    '{% for paramName, param in data.params %}',
                    '{% for key, value in state.values %}',
                    '{% if key == paramName %}',
                    '<div class="btn-group btn-group-xs">',
                    '<button{% if state.enabled %}{% else %} disabled{% endif %} type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">',
                    '<span>{{ param.title }}</span>',
                    '<span class="value">: {{ value }}</span>',
                    '&nbsp;<span class="caret"></span>',
                    '</button>',
                    '<ul class="dropdown-menu {{ paramName }}">',
                    '{% for item in param.items %}',
                    '<li{% if item.id == value %} class="active"{% endif %}>',
                    '<a href="#" data-param="{{ paramName }}" data-id="{{ item.id }}">',
                    '{{ item.title }}',
                    '</a>',
                    '</li>',
                    '{% endfor %}',
                    '</ul>',
                    '</div>&nbsp;',
                    '{% endif %}',
                    '{% endfor %}',
                    '{% endfor %}',
                    '</div></div></div>'
                ].join('');
        two.ready(Api('init'));

        function init(ymaps) {
            // Создадим собственный макет RegionControl.
            var RegionControlLayout = ymaps.templateLayoutFactory.createClass(optionsTemplate, {
                        build: function () {
                            RegionControlLayout.superclass.build.call(this);
                            this.handleClick = ymaps.util.bind(this.handleClick, this);
                            $(this.getParentElement)
                                    .on('click', 'a', this.handleClick);
                        },
                        clear: function () {
                            $(this.getParentElement)
                                    .off('click', 'a', this.handleClick);
                            RegionControlLayout.superclass.clear.call(this);
                        },
                        handleClick: function (e) {
                            //e.preventDefault();
                            var $target = $(e.currentTarget);
                            var state = this.getData().state;
                            var newValues = ymaps.util.extend({}, state.get('values'));
                            if (!$target.hasClass('active')) {
                                newValues[$target.data('param')] = $target.data('id');
                                state.set('values', newValues);
                            }
                        }
                    }),
            // Наследуем класс нашего контрола от ymaps.control.Button.
                    RegionControl = ymaps.util.defineClass(function (parameters) {
                        RegionControl.superclass.constructor.call(this, parameters);
                        this.regions = new ymaps.ObjectManager();
                        this.regions2 = new ymaps.GeoObjectCollection();
                        this.regions3 = new two.GeoObjectCollection();
                    }, ymaps.control.Button, /** @lends ymaps.control.Button */{
                        onAddToMap: function (map) {
                            RegionControl.superclass.onAddToMap.call(this, map);
                            map.geoObjects.add(this.regions);
                            map2.geoObjects.add(this.regions2);
                            map3.geoObjects.add(this.regions3);
                            this.setupStateMonitor();
                            this.loadRegions(this.state.get('values'));
                            this.loadRegions2(this.state.get('values'));
                            this.loadRegions3(this.state.get('values'));
                        },

                        onRemoveFromMap: function (map) {
                            map.geoObjects.remove(this.regions);
                            map2.geoObjects.remove(this.regions2);
                            map3.geoObjects.remove(this.regions3);
                            this.clearStateMonitor();
                            RegionControl.superclass.onRemoveFromMap.call(this, map);
                        },

                        setupStateMonitor: function () {
                            this.stateMonitor = new ymaps.Monitor(this.state);
                            this.stateMonitor.add('values', this.handleStateChange, this);
                        },

                        clearStateMonitor: function () {
                            this.stateMonitor.removeAll();
                        },

                        handleStateChange: function (params) {
                            this.loadRegions(params);
                            this.loadRegions2(params);
                            this.loadRegions3(params);
                        },

                        handleRegionsLoaded: function (res) {
                            this.regions
                                    .removeAll();

                            this.regions = new ymaps.ObjectManager();
                            this.regions
                                    .add(res.features.map(function (feature) {
                                        feature.id = feature.properties.iso3166;
                                        return feature;
                                    }));

                            map.geoObjects.add(this.regions);
                            this.getMap().setBounds(
                                    this.regions.getBounds(),
                                    {checkZoomRange: true}
                            );
                        },

                        handleRegionsLoaded2: function (res) {
                            console.log(1)
                            this.regions2
                                    .removeAll()
                                    .add(res.geoObjects);
                            map2.setBounds(
                                    this.regions.getBounds(),
                                    {checkZoomRange: true}
                            );
                        },

                        handleRegionsLoaded3: function (res) {
                            console.log(1)
                            this.regions3
                                    .removeAll()
                                    .add(res.geoObjects);
                            map3.setBounds(
                                    this.regions.getBounds(),
                                    {checkZoomRange: true}
                            );
                        },

                        loadRegions: function (params) {
                            this.disable();
                            var reg = ymaps.borders.load(params.region, params)
                                    .then(this.handleRegionsLoaded, this)
                                    .always(this.enable, this);
                            return reg;
                        },

                        loadRegions2: function (params) {
                            this.disable();
                            var reg;
                            reg = ymaps.regions.load(params.region, params)
                                    .then(this.handleRegionsLoaded2, this)
                                    .always(this.enable, this);
                            return reg;
                        },

                        loadRegions3: function (params) {
                            this.disable();
                            reg = two.regions.load(params.region, params)
                                    .then(this.handleRegionsLoaded3, this)
                                    .always(this.enable, this);
                            return reg;
                        }
                    }),

                    map = new ymaps.Map('map', {
                        center: [50, 30],
                        zoom: 3,
                        controls: ['typeSelector']
                    }, {
                        typeSelectorSize: 'small',
                        backgroundVisible: false
                    }),

                    map2 = new ymaps.Map('map2', {
                        center: [50, 30],
                        zoom: 3,
                        controls: ['typeSelector']
                    }, {
                        typeSelectorSize: 'small',
                        backgroundVisible: false
                    }),

                    map3 = new two.Map('map3', {
                        center: [50, 30],
                        zoom: 3,
                        controls: ['typeSelector']
                    }, {
                        typeSelectorSize: 'small',
                        backgroundVisible: false
                    }),

            // Создадим экземпляр RegionControl.
                    regionControl = new RegionControl({
                        state: {
                            enabled: true,
                            values: {
                                region: 'BY',
                                lang: 'ru',
                                quality: '2'
                            }
                        },
                        data: {
                            params: REGIONS_DATA
                        },
                        options: {
                            layout: RegionControlLayout
                        },
                        float: 'left',
                        maxWidth: [300]
                    });
            addGrid(map);
            // Добавим контрол на карту.
            map.controls.add(regionControl);
            // Узнавать о изменениях параметров RegionControl можно следующим образом.
            regionControl.events.add('statechange', function (e) {
                console.log(e.get('target').get('values'));
            });
            map.events.add('boundschange', function(e){
                map2.setCenter(e.get('newCenter'), e.get('newZoom'))
                map3.setCenter(e.get('newCenter'), e.get('newZoom'))
            })
        }

    </script>
</head>
<body>
<div id="map" style="height: 512px; width: 512px; border: 1px solid black"></div>
<div id="map2"
     style="height: 512px; width: 512px; margin-left: 522px; margin-top: -514px; border: 1px solid black"></div>
<div id="map3"
     style="height: 512px; width: 512px; margin-left: 1044px; margin-top: -514px; border: 1px solid black"></div>
</body>
</html>
