<!DOCTYPE HTML>
<!--
Title:
CSP: редактор геообъектов при применении правил CSP

Description:
Проверка функциональности редактора геообъектов при применении правил CSP.
Памятка по терминам: https://wiki.yandex-team.ru/eva/testing/Projects/maps-api/

Components: 
CSP

Estimated time:
240000

Precondition:
Открыть ссылку ${currentPagePath}

Step:
  Action:
  Осмотреть карту и элементы на ней. 

  Expectation:
  Карта отобразилась корректно, на карте спан Московской области.
  На спане карты два ряда объектов, сверху: синяя метка коллекции, синяя ломаная линия, синии прямоугольник и треугольник.
  В нижнем ряду аналогичные объекты зеленого цвета.
  Сверху в контейнере имеются кнопки "polyline", "polygon", "placemark", "editor".

Step:
  Action:
  Выполнить клик в кнопку "polyline".

  Expectation:
  Под контейнером с картой появляется текст: "CSP mode: Listening for "editorstatechange" event on all objects...; editorstatechange; editorstatechange".
  К курсору прилипает пунктирная синяя линия от крайней точки ломаной линии, при этом на линии появляются метки редактора.
  При перемещениях курсора под контейнером с картой отображаются события редактора вида: editingstart; drawingstart.
    
Step:
  Action:
  Поводить курсором в контейнере с картой, после чего выполнить клик в спан карты.

  Expectation:
  При перемещениях курсора в близи границ контейнера, спан карты смещается в сторону смещения курсора.
  По клику в спан карты на спане появляется белая метка редактора, от предыдущей метки к вновь выставленной протягивается прямая сплошная синяя линия.
  К курсору прилипает пунктирная синяя линия от последней выставленной метки ломаной линии, при этом на линии появляется промежуточная метка редактора.

Step:
  Action:
  Клик в выставленную на предыдущем шаге метку редактора.

  Expectation:
  Метка увеличивается, окрашивается желтым.
  Появляется контекстное меню с кнопками "Удалить точку", "Завершить".

Step:
  Action:
  Клик в кнопку "Завершить".

  Expectation:
  От курсора отлипает пунктирная линия, выставленная метка и построенная линия сохраняются на спане карты.
  Под контейнером с картой появляется текст: "editorstatechange; drawingstop".

Step:
  Action:
  Выполнить клик в кнопку "polygon".

  Expectation:
  Под контейнером с картой появляется текст: "editorstatechange; editorstatechange; editingstart; drawingstart".
  К курсору прилипает две пунктирных синих линии от левого верхнего и нижнего угла прямоугольника, при этом прямоугольнике с треугольником появляются метки редактора.

Step:
  Action:
  Поводить курсором в контейнере с картой, после чего выполнить клик в спан карты.

  Expectation:
  При перемещениях курсора в близи границ контейнера, спан карты смещается в сторону смещения курсора.
  По клику в спан карты на спане появляется белая метка редактора, область от выставленной метки к левому верхнему и нижнему углам прямоугольника окрашивается в синий.
  К курсору прилипает две пунктирных синих линии от последней выставленной метки и от верхнего углу многоугольника.

Step:
  Action:
  Клик в выставленную на предыдущем шаге метку редактора.

  Expectation:
  Метка увеличивается, окрашивается желтым.
  Появляется контекстное меню с кнопками "Удалить точку", "Завершить", "Добавить внутренний контур".

Step:
  Action:
  Клик в кнопку "Завершить".

  Expectation:
  От курсора отлипают пунктирные линии, выставленная метка и новая окрашенная область многоугольника сохраняются на спане карты.
  Под контейнером с картой появляется текст: "editorstatechange; drawingstop".  

Step:
  Action:
  Выполнить клик в кнопку "placemark".

  Expectation:
  Под контейнером с картой появляется текст: "editorstatechange; editorstatechange; editingstart; drawingstart".

Step:
  Action:
  Навести курсор на синюю метку коллекции, зажать ЛКМ и перенести метку на спане карты.

  Expectation:
  Захват метки корректный, метка перемещается на спане карты.

Step:
  Action:
  Выполнить клик в кнопку "placemark".

  Expectation:
  Под контейнером с картой появляется текст: "editorstatechange; drawingstop".

Step:
  Action:
  Выполнить клик в кнопку "editor".

  Expectation:
  На ломаной линии и многоугольнике в нижнем ряду появляются метки вершин и промежуточные метки редактора.
  Под контейнером с картой появляется блок текста: "editorstatechange(3 раза); editingstart(3 раза)".

Step:
  Action:
  Навести курсор на зеленую метку коллекции, зажать ЛКМ и перенести метку на спане карты.

  Expectation:
  Захват метки корректный, метка перемещается на спане карты.

Step:
  Action:
  Навести курсор на метку вершин зеленой ломаной линии, зажать ЛКМ и перенести метку на спане карты.

  Expectation:
  Захват метки корректный, метка перемещается на спане карты, при этом при перемещении линии от предыдущей метки к захваченной тянется пунктирная линия, после установки метки линия становистя сплошной.

Step:
  Action:
  Навести курсор на метку вершин зеленого многоугольника, зажать ЛКМ и перенести метку на спане карты.

  Expectation:
  Захват метки корректный, метка перемещается на спане карты, при этом при перемещении метки от соседних вершин фигуры к захваченной тянется пунктирная линия, после установки метки линия становистя сплошной, область окрашивается зеленым.  
-->
<html>
<head>
    <title>2.1</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta http-equiv="Content-Security-Policy"
          content="img-src 'self' data: blob: filesystem: *;media-src 'self' ;script-src 'self' 'unsafe-eval' https://*.yandex.ru 'nonce-eef8264c4994bf6409c51ac7c9614446' ;style-src 'self' 'unsafe-eval' data: blob: 'nonce-eef8264c4994bf6409c51ac7c9614446';">
    <script src="../../helper.js" nonce="eef8264c4994bf6409c51ac7c9614446"></script>
    <script src="../geoobject/geoCS.js"></script>

    <script type="text/javascript" nonce="eef8264c4994bf6409c51ac7c9614446">
        var define = function () {
                },
                module = {
                    exports: {}
                },
                exports = module.exports,
                modules = {};
    </script>
    <script type="text/javascript" src="https://api-maps.tst.c.maps.yandex.ru/2.1-dev/?mode=debug&namespace=ymaps&lang=ru_RU&csp[style_nonce]=eef8264c4994bf6409c51ac7c9614446&csp[_data_style]=1&host_config[hosts]"></script>
    <!--<script type="text/javascript" src="https://api-maps.tst.c.maps.yandex.ru/2.1-dev?&csp=true&mode=debag&lang=ru_RU"></script>-->
    <script type="text/javascript" nonce="eef8264c4994bf6409c51ac7c9614446">

        ymaps.ready(function(ymaps) {
            var map = new ymaps.Map('map', {
                    center: [55.73259667357658, 37.70153663432529],
                    zoom: 9,
                    behaviors: ['default', 'scrollZoom'],
                    controls: ['fullscreenControl']
                }),
                collection = new ymaps.GeoObjectCollection(),
                editorButton = new ymaps.control.Button({data: {content: 'editor'}, options: {selectOnClick: true}}),
                placemarkButton = new ymaps.control.Button({data: {content: 'placemark'}, options: {selectOnClick: true}}),
                polylineButton = new ymaps.control.Button({data: {content: 'polyline'}, options: {selectOnClick: true}}),
                polygonButton = new ymaps.control.Button({data: {content: 'polygon'}, options: {selectOnClick: true}});

            geoCSSource(ymaps, map, this);
            addGrid(map);
            document.getElementById('map').setAttribute('nonce','eef8264c4994bf6409c51ac7c9614446');


            __log__('CSP mode: Listening for "editorstatechange" event on all objects...');

            collection
                    .add(geoObjectPlacemark)
                    .add(geoObjectPolyline)
                    .add(geoObjectPolygon)
                    .add(placemark)
                    .add(polyline)
                    .add(polygon);

            editorButton.events
                    .add('select', function () {
                        collection.each(function (obj) {
                            obj.editor.startEditing();
                        });
                    })
                    .add('deselect', function () {
                        collection.each(function (obj) {
                            obj.editor.stopEditing();
                        });
                    });

            placemarkButton.events
                    .add('select', function () {
                        placemark.editor.startDrawing();
                    })
                    .add('deselect', function () {
                        placemark.editor.stopDrawing();
                    });

            polylineButton.events
                    .add('select', function () {
                        polyline.editor.startDrawing();
                    })
                    .add('deselect', function () {
                        polyline.editor.stopDrawing();
                    });

            polygonButton.events
                    .add('select', function () {
                        polygon.editor.startDrawing();
                    })
                    .add('deselect', function () {
                        polygon.editor.stopDrawing();
                    });

            collection.each(function (obj) {
                obj.events.add('editorstatechange', function (e) {
                    __log__('editorstatechange')
                });
            });
            collection.each(function (obj) {
                obj.editor.events.add(['drawingstart', 'drawingstop'], function (e) {
                    __log__(e.get('type'));
                });
            });

            collection.each(function (obj) {
                obj.editor.events.add(['editingstart', 'editingstop'], function (e) {
                    __log__(e.get('type'));
                });
            });
            collection.each(function (obj) {
                obj.options.set('editorMaxPoints', 18);
                obj.options.set('draggable', true);
            });
            map.geoObjects.add(collection);

            map.controls
                    .add(editorButton)
                    .add(placemarkButton)
                    .add(polygonButton)
                    .add(polylineButton);
        });
    </script>
</head>
<style type="text/css" nonce="eef8264c4994bf6409c51ac7c9614446">
    html, body, #map {
        margin: 0;
        padding: 0;
        height: 512px;
        width: 512px;
    }
</style>
<body>
    <div id="map"></div>
</body>
</html>