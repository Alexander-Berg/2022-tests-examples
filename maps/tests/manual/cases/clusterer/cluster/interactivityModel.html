<!DOCTYPE HTML>
<!--
Title:
Кластер: модели интерактивности.

Description:
Проверка работы моделей интерактивности с объектами кластеризации.
Памятка по терминам: https://wiki.yandex-team.ru/eva/testing/Projects/maps-api/

Components: 
clusterer

Estimated time:
360000

Precondition:
Открыть ссылку ${currentPagePath}

Step:
  Action:
  Дождаться полной прогрузки и осмотреть карту и элементы на ней.

  Expectation:
  Карта отобразилась корректно.
  На карте спан Европейской части России и несколько красных кластерных меток внутри со значением кластеризации.
  Сверху имеется кнопки "silent", "transpar...", "layer", "geoobject", "opaque".

Step:
  Action:
  Навести курсор на метку кластера, затем вывести курсор за пределы метки кластера.
  Последовательно выполнить клик, даблклик, клик ПКМ, скролзум по метке кластера, магнифайер ПКМ при наведенном на метку кластера курсоре.
  При наведенном на метку кластера курсоре зажать ЛКМ и выполнить драг карты.

  Expectation:
  Под контейнером с картой появляется текст:
  При наведении на метку кластера: map: mouseleave.
  При выводе курсора за метку кластера: map: mouseenter.
  При клике: map:mousedown.
  При даблклике происходит призум карты, кластерные метки распадаются, под картой: map:mousedown, map:mousedown, map:dblclick.
  При клике ПКМ: map: contextmenu.
  При скролзуме(корректный зум/отзум карты, кластерные метки распадаются/схлопываются): map:wheel.
  Зум магнифайером работает(корректный зум карты, кластерные метки распадаются), под контейнером появляется текст: map:mousedown.
  Корректный драг карты, текст под картой соотвествует клику: map:mousedown.

Step:
  Action:
  Выполнить клик в кнопку "opaque".
  Навести курсор на метку кластера, затем вывести курсор за пределы метки кластера.
  Последовательно выполнить клик, даблклик, клик ПКМ, скролзум по метке кластера, магнифайер ПКМ при наведенном на метку кластера курсоре.
  При наведенном на метку кластера курсоре зажать ЛКМ и выполнить драг карты.

  Expectation:
  При наведении на метку кластера: map: mouseleave.
  При выводе курсора за метку кластера: map: mouseenter.
  Поведения: клик, даблклик, клик ПКМ, скролзум, магнифайер, драг карты - не работают при наведении на кластерную метку, текст под контейнером с картой не появляется.
  (сравнить с поведением вне кластерной метки, поведения должны работать, текст в контейнере должен отображать события)

Step:
  Action:
  Выполнить клик в кнопку "opaque", выполнить клик в кнопку "geoobject".
  Навести курсор на метку кластера, затем вывести курсор за пределы метки кластера.
  Последовательно выполнить клик, даблклик, клик ПКМ, скролзум по метке кластера, магнифайер ПКМ при наведенном на метку кластера курсоре.
  При наведенном на метку кластера курсоре зажать ЛКМ и выполнить драг карты.

  Expectation:
  Под контейнером с картой появляется текст:
  При наведении на метку кластера: map: mouseleave.
  При выводе курсора за метку кластера: map: mouseenter.
  При клике: map:mousedown.
  При даблклике происходит призум карты, кластерные метки распадаются, под картой: map:mousedown, map:mousedown, map:dblclick.
  При клике ПКМ: map: contextmenu.
  При скролзуме(корректный зум/отзум карты, кластерные метки распадаются/схлопываются): map:wheel.
  Зум магнифайером работает(корректный зум карты, кластерные метки распадаются), под контейнером появляется текст: map:mousedown.
  Корректный драг карты, текст под картой соотвествует клику: map:mousedown.

Step:
  Action:
  Выполнить клик в кнопку "geoobject", выполнить клик в кнопку "layer".
  Навести курсор на метку кластера, затем вывести курсор за пределы метки кластера.
  Последовательно выполнить клик, даблклик, клик ПКМ, скролзум по метке кластера, магнифайер ПКМ при наведенном на метку кластера курсоре.
  При наведенном на метку кластера курсоре зажать ЛКМ и выполнить драг карты.

  Expectation:
  Под контейнером с картой появляется текст:
  При наведении на метку кластера: map: mouseleave.
  При выводе курсора за метку кластера: map: mouseenter.
  При клике: map:mousedown.
  При даблклике призум карты не происходит, кластерные метки не распадаются, под картой: map:mousedown, map:mousedown.
  При клике ПКМ: map: contextmenu.
  При скролзуме(корректный зум/отзум карты, кластерные метки распадаются/схлопываются): map:wheel.
  Зум магнифайером работает(корректный зум карты, кластерные метки распадаются), под контейнером появляется текст: map:mousedown.
  Корректный драг карты, текст под картой соотвествует клику: map:mousedown.

Step:
  Action:
  Выполнить клик в кнопку "layer", выполнить клик в кнопку "transpar...".
  Навести курсор на метку кластера, затем вывести курсор за пределы метки кластера.
  Последовательно выполнить клик, даблклик, клик ПКМ, скролзум по метке кластера, магнифайер ПКМ при наведенном на метку кластера курсоре.
  При наведенном на метку кластера курсоре зажать ЛКМ и выполнить драг карты.

  Expectation:
  Под контейнером с картой появляется текст:
  При наведении на метку кластера: map: mouseleave.
  При выводе курсора за метку кластера: map: mouseenter.
  При клике: map:mousedown, map:mouseup, map: click.
  При даблклике происходит призум карты, кластерные метки распадаются, под картой: map:mousedown, map:mouseup, map: click, map:mousedown, map:mouseup, map: click, map:dblclick.
  При клике ПКМ: map:mousedown, map:mouseup, map: contextmenu.
  При скролзуме(корректный зум/отзум карты, кластерные метки распадаются/схлопываются): map:wheel.
  Зум магнифайером работает(корректный зум карты, кластерные метки распадаются), под контейнером появляется текст: map:mousedown.
  Корректный драг карты, под картой поялвяется текст: map:mousedown.

Step:
  Action:
  Выполнить клик в кнопку "transpar...", выполнить клик в кнопку "silent".
  Навести курсор на метку кластера, затем вывести курсор за пределы метки кластера.
  Последовательно выполнить клик, даблклик, клик ПКМ, скролзум по метке кластера, магнифайер ПКМ при наведенном на метку кластера курсоре.
  При наведенном на метку кластера курсоре зажать ЛКМ и выполнить драг карты.

  Expectation:
  Под контейнером с картой появляется текст:
  При наведении на метку кластера: map: mouseleave.
  При выводе курсора за метку кластера: map: mouseenter.
  При клике: map:mousedown, map:mouseup, map: click.
  При даблклике происходит призум карты, кластерные метки распадаются, под картой: map:mousedown, map:mouseup, map: click, map:mousedown, map:mouseup, map: click, map:dblclick.
  При клике ПКМ: map:mousedown, map:mouseup, map: contextmenu.
  При скролзуме(корректный зум/отзум карты, кластерные метки распадаются/схлопываются): map:wheel.
  Зум магнифайером работает(корректный зум карты, кластерные метки распадаются), под контейнером появляется текст: map:mousedown.
  Корректный драг карты, под картой поялвяется текст: map:mousedown.
-->
<html>
<head>
    <title></title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

    <script src="../../../helper.js"></script>
    <script src="https://yandex.st/jquery/1.6.4/jquery.min.js" type="text/javascript"></script>
    <script type=text/javascript>

        Api('init');

        function init(ymaps) {
            var map = myMap = new ymaps.Map('map', {
                center: [59.96343157514998, 30.317977733422868],
                zoom: 7,
                // Добавим к стандартным поведениям карты зум колесом мыши.
                behaviors: ['default', 'scrollZoom'],
                controls: ['fullscreenControl']
            });

            addGrid(map);
            var log = new Log();

            var clusterer = new ymaps.Clusterer({
                preset: 'islands#redClusterIcons',
                disableClickZoom: true,
                openBalloonOnClick: false
            });
            var placemarksNumber = 200;
            var bounds = myMap.getBounds();
            var newPlacemarks = createGeoObjects(placemarksNumber, bounds);
            var i = 0;

            clusterer.add(newPlacemarks);
            map.geoObjects.add(clusterer);

            var events = ['click', 'contextmenu', 'dblclick', 'mousedown', 'mouseenter', 'mouseleave', 'mouseup',
                'multitouchend', 'multitouchstart', 'wheel'];

            var callback = function (e) {
                log.info('map: ' + e.get('type'));
                console.log('map: ' + e.get('type'))
            };

            var opaqueButton = new ymaps.control.Button('opaque');
            var geoobjectButton = new ymaps.control.Button('geoobject');
            var layerButton = new ymaps.control.Button('layer');
            var transparentButton = new ymaps.control.Button('transparent');
            var silentButton = new ymaps.control.Button('silent');

            // Объект получает все DOM-события и не прокидывает их на карту.
            // Поведения карты не будут работать при наведении или клике на объекты с данной моделью интерактивности
            opaqueButton.events.add('click', function () {
                clusterer.options.set('clusterInteractivityModel', 'default#opaque');
            });

            // Объект получает все DOM-события. На карту прокидываются события 'wheel' и 'mousedown'.
            // У события 'mousedown' выставляется флаг 'preventDefault'=true. Если на карте включены поведения 'scrollZoom' или 'magnifier',
            // они будут работать через объекты с данной моделью интерактивности, в отличие от объектов с моделью 'default#opaque'.
            geoobjectButton.events.add('click', function () {
                clusterer.options.set('clusterInteractivityModel', 'default#geoObject');
            });

            // Объект получает все DOM-события. На карту прокидываются события 'wheel' и 'mousedown'.
            // Если на карте включены поведения 'scrollZoom', 'drag' или 'magnifier',
            // они будут работать через объекты с данной моделью интерактивности
            layerButton.events.add('click', function () {
                clusterer.options.set('clusterInteractivityModel', 'default#layer');
            });

            // Объект получает все DOM-события, а затем прокидывает их на карту.
            transparentButton.events.add('click', function () {
                clusterer.options.set('clusterInteractivityModel', 'default#transparent');
            });

            // Объект перестает кидать события интерактивности, но пропускает их на карту.
            silentButton.events.add('click', function () {
                clusterer.options.set('clusterInteractivityModel', 'default#silent');
            });

            map.controls
                    .add(opaqueButton, {float: 'left'})
                    .add(geoobjectButton, {float: 'left'})
                    .add(layerButton, {float: 'left'})
                    .add(transparentButton, {float: 'left'})
                    .add(silentButton, {float: 'left'});

            map.events.add(events, callback);

            // change map zoom
            setTimeout(function () {
                map.setZoom(4)
            }, 1000);

            function createGeoObjects(number, bounds) {
                var placemarks = [];
                // Создаем нужное количество меток
                for (var i = 0; i < number; i++) {
                    // Генерируем координаты метки случайным образом.
                    coordinates = getRandomCoordinates(bounds);
                    // Создаем метку со случайными координатами.
                    if (Math.random() > 0.5) {
                        myPlacemark = new ymaps.Placemark(coordinates, {
                            balloonContent: i, hintContent: i, clusterCaption: i}, {});
                    } else {
                        myPlacemark = new ymaps.Placemark(coordinates, {
                            balloonContent: i, hintContent: i, iconContent: 'point', clusterCaption: 'point ' + i}, {preset: 'islands#greenStretchyIcon'});
                    }
                    placemarks.push(myPlacemark);
                }
                return placemarks;
            }

            function getRandomCoordinates(bounds) {
                var size = [bounds[1][0] - bounds[0][0], bounds[1][1] - bounds[0][1]];
                return [Math.random() * size[0] + bounds[0][0], Math.random() * size[1] + bounds[0][1]];
            }

        }
    </script>
</head>
<body style="position: relative; padding: 0; margin: 0;">
<div id="map" style="height: 512px; width: 512px;"></div>
</body>
</html>