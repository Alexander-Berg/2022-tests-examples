<!DOCTYPE HTML>
<!--
Title:
Кластерная метка: опции балуна c двумя колоннами

Description:
Применение опций кластеризации балуна(default) при пересоздании кластера.
Памятка по терминам: https://wiki.yandex-team.ru/eva/testing/Projects/maps-api/

Components:
clusterer

Estimated time:
420000

Precondition:
Открыть ссылку ${currentPagePath}

Step:
  Action:
  Осмотреть карту и элементы на ней.

  Expectation:
  Карта отобразилась корректно.
  На карте спан Москвы, с отображением метки кластера с цифрой "50".
  Сверху слева и справа имеются кнопки опций балуна кластера.
  Снизу слева имеется кнопка "caption".

Step:
  Action:
  Выполнить клик в кластерную метку.

  Expectation:
  Спан карты смещается для открытия балуна.В балуне две колонки(правая колонка гораздо шире левой, балун шире контейнера с картой).
  В левой колонке список меток вида "Заголовок метки №0". В правой отображается содержимое метки 0. У каждой колонки имеется скрол полоса, имеется кнопка закрытия балуна.
  В правой колонке заголовок "Заголовок метки №0", тело балуна (стих), футер "Футер метки № 0". Заголовок выделен жирным шрифтом, остальное содержимое балуна обычным.
  
Step:
  Action:
  Закрыть балун кластера кликом в кнопку закрытия - крестик.
  (при нахождении кнопки закрытия балуна под другими кнопками на спане, перемещаем спан карты драгом)

  Expectation:
  Балун кластера закрывается, на спане остается кластерная метка с цифрой 50.

Step:
  Action:
  Выполнить клик в кнопку "clusterBalloonContentLayoutWidth(в режиме панели не используется)".
  Выполнить даблклик ЛКМ в спан карты, вне кластерной метки.
  Клик в кластерную метку.

  Expectation:
  После даблклика происходит корректный призум карты. Кластерная метка не пропадает со спана карты.
  Спан карты смещается для открытия балуна.В балуне две колонки(правая колонка шире левой, балун полностью вмещается в контейнер с картой).
  В левой колонке список меток вида "Заголовок метки №0". В правой отображается содержимое метки 0. У каждой колонки имеется скрол полоса, имеется кнопка закрытия балуна.
  В правой колонке заголовок "Заголовок метки №0", тело балуна (стих), футер "Футер метки № 0". Заголовок выделен жирным шрифтом, остальное содержимое балуна обычным.
  
Step:
  Action:
  Закрыть балун кластера кликом в кнопку закрытия - крестик.
 
  Expectation:
  Балун кластера закрывается, на спане остается кластерная метка с цифрой 50.

Step:
  Action:
  Выполнить клик в кнопку "clusterBalloonContentLayoutWidth(в режиме панели не используется)".
  Выполнить клик в кнопку "update geoObject data from parent DataManager".
  Выполнить даблклик ПКМ в спан карты, вне кластерной метки.
  Клик в кластерную метку.

  Expectation:
  После даблклика происходит корректный отзум карты. Кластерная метка не пропадает со спана карты.
  Спан карты смещается для открытия балуна.В балуне одна колонки.
  В левой колонке список меток вида "Заголовок метки №0". У колонки имеется скрол полоса, имеется кнопка закрытия балуна.

Step:
  Action:
  Закрыть балун кластера кликом в кнопку закрытия - крестик.
 
  Expectation:
  Балун кластера закрывается, на спане остается кластерная метка с цифрой 50.

Step:
  Action:
  Выполнить клик в кнопку "update geoObject data from parent DataManager".
  Выполнить клик в кнопку "clusterBalloonContentLayoutHeight".
  Выполнить даблклик ЛКМ в спан карты, вне кластерной метки.
  Клик в кластерную метку.

  Expectation:
  После даблклика происходит корректный призум карты. Кластерная метка не пропадает со спана карты.
  Спан карты смещается для открытия балуна.В балуне одна колонка(левая колонка, балун высокий).
  В левой колонке список меток вида "Заголовок метки №0". 

Step:
  Action:
  Закрыть балун кластера кликом в кнопку закрытия - крестик.
 
  Expectation:
  Балун кластера закрывается, на спане остается кластерная метка с цифрой 50.

Step:
  Action:
  Выполнить клик в кнопку "clusterBalloonContentLayoutHeight".
  Выполнить клик в кнопку "clusterBalloonItemContentLayout*".
  Выполнить даблклик ПКМ в спан карты, вне кластерной метки.
  Клик в кластерную метку.

  Expectation:
  После даблклика происходит корректный отзум карты. Кластерная метка не пропадает со спана карты.
  Спан карты смещается для открытия балуна.В балуне одна колонка(левая).
  В левой колонке список меток вида "Заголовок метки №0". 

Step:
  Action:
  Закрыть балун кластера кликом в кнопку закрытия - крестик.
 
  Expectation:
  Балун кластера закрывается, на спане остается кластерная метка с цифрой 50.

Step:
  Action:
  Выполнить клик в кнопку "clusterBalloonItemContentLayout*".
  Выполнить клик в кнопку "update geoObject data".
  Выполнить даблклик ЛКМ в спан карты, вне кластерной метки.
  Клик в кластерную метку.

  Expectation:
  После даблклика происходит корректный призум карты. Кластерная метка не пропадает со спана карты.
  Спан карты смещается для открытия балуна.В балуне одна колонка(левая).
  В левой колонке список меток, при этом первое значение в списке число в диапазоне от 0 до 1, после список корректный "Заголовок метки №1". 

Step:
  Action:
  Закрыть балун кластера кликом в кнопку закрытия - крестик.
 
  Expectation:
  Балун кластера закрывается, на спане остается кластерная метка с цифрой 50.

Step:
  Action:
  Выполнить клик в кнопку "update geoObject data".
  Выполнить клик в кнопку "clusterBalloonPanelMaxMapArea".
  Выполнить даблклик ПКМ в спан карты, вне кластерной метки.
  Клик в кластерную метку.

  Expectation:
  После даблклика происходит корректный отзум карты. Кластерная метка не пропадает со спана карты.
  Спан карты смещается для открытия балуна. На спане карты снизу открывается панель балуна на всю ширину контейнера. В балуне две колонки(правая колонка шире левой, балун высокий).
  В левой колонке список меток, при этом первое значение в списке число в диапазоне от 0 до 1, после список корректный "Заголовок метки №1". В правой отображается содержимое метки 1. У каждой колонки имеется скрол полоса, имеется кнопка закрытия балуна.
  В правой колонке заголовок "число в диапазоне от 0 до 1", тело балуна (стих), футер "Футер метки № 0". Заголовок выделен жирным шрифтом, остальное содержимое балуна обычным.

Step:
  Action:
  Закрыть балун кластера кликом в кнопку закрытия - крестик.
 
  Expectation:
  Балун кластера закрывается, на спане остается кластерная метка с цифрой 50.

Step:
  Action:
  Выполнить клик в кнопку "clusterBalloonPanelMaxMapArea".
  Выполнить клик в кнопку "balloonLeftColumnWidth *".
  Выполнить даблклик ЛКМ в спан карты, вне кластерной метки.
  Клик в кластерную метку.

  Expectation:
  После даблклика происходит корректный призум карты. Кластерная метка не пропадает со спана карты.
  Спан карты смещается для открытия балуна. В балуне только одна колонка - левая.
  В левой колонке список меток, при этом первое значение в списке число в диапазоне от 0 до 1, после список корректный "Заголовок метки №1". 

Step:
  Action:
  Закрыть балун кластера кликом в кнопку закрытия - крестик.
 
  Expectation:
  Балун кластера закрывается, на спане остается кластерная метка с цифрой 50.

Step:
  Action:
  Выполнить клик в кнопку "balloonLeftColumnWidth *".
  Выполнить клик в кнопку "clusterBalloonPanelMaxMapArea".
  Выполнить клик в кнопку "caption".
  Выполнить даблклик ПКМ в спан карты, вне кластерной метки.
  Клик в кластерную метку.

  Expectation:
  После даблклика происходит корректный отзум карты. Кластерная метка не пропадает со спана карты.
  Спан карты смещается для открытия балуна. На спане карты снизу открывается панель балуна на всю ширину контейнера. В балуне две колонки(правая колонка шире левой, балун высокий).
  В левой колонке список меток вида "ClusterCaption Number0"(жирным шрифтом, Number - курсивом). В правой отображается содержимое метки 0. У каждой колонки имеется скрол полоса, имеется кнопка закрытия балуна.
  В правой колонке заголовок "ClusterCaption Number0", тело балуна (стих), футер "Футер метки № 0". Заголовок выделен жирным шрифтом, слово Number курсивом, остальное содержимое балуна обычным.

Step:
  Action:
  Закрыть балун кластера кликом в кнопку закрытия - крестик.
 
  Expectation:
  Балун кластера закрывается, на спане остается кластерная метка с цифрой 50.

Step:
  Action:
  Выполнить клик в кнопку "caption".
  Выполнить даблклик ПКМ в спан карты, вне кластерной метки.
  Клик в кластерную метку.

  Expectation:
  После даблклика происходит корректный отзум карты. Кластерная метка не пропадает со спана карты.
  Спан карты смещается для открытия балуна. На спане карты снизу открывается панель балуна на всю ширину контейнера. В балуне две колонки(правая колонка шире левой, балун высокий).
  В левой колонке список меток вида иконка с символом "i", "ClusterCaption Number0"(Caption - ссылка, выделено синим, подчеркнуто, Number - курсивом). В правой отображается содержимое метки 0. У каждой колонки имеется скрол полоса, имеется кнопка закрытия балуна.
  В правой колонке заголовок иконка с символом "i" "Cluster Number0", тело балуна (стих), футер "Футер метки № 0". Заголовок выделен жирным шрифтом, слово Number курсивом, остальное содержимое балуна обычным.

Step:
  Action:
  Выполнить клик в "Caption" в заголовке балуна кластера(в левой колонке).

  Expectation:
  Происходит редирект на главную страницу Яндекса по адресу https://yandex.ru/.
-->
<html>
<head>
    <title>2.1</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

    <script src="../../../helper.js"></script>
    <script type=text/javascript>

        Api('init');

        function init(ymaps) {
            ymaps = ym;

            var map = myMap = new ym.Map('map', {
                center: [55.72725771214265, 37.640390506634006],
                zoom: 10,
                behaviors: ['default', 'scrollZoom'],
                controls: []
            });

            addGrid(map);
            var log = new Log();
            __log__('Test case: option is changing after re-create cluster.');

            var fullscreen = new ymaps.control.FullscreenControl();
            map.controls.add(fullscreen, {float: 'none', position: {bottom: 35, right: 5}});

            var disableClickZoom = true;
            var openBalloonOnClick = openBalloonOnClick;
            var balloonPanelMaxMapArea = 0;
            var balloonLeftColumnWidth = 200;
            var balloonContentLayoutWidth = 300;
            var balloonContentLayoutHeight = 300;
            var balloonItemContentLayout = 'cluster#balloonTwoColumnsItemContent';

            var geoObjects = [];
            var customItemContentLayout = ymaps.templateLayoutFactory.createClass('<b>123 {{ properties.balloonContentBody|raw }}</b>');

            var clusterer = new ymaps.Clusterer({});
            map.geoObjects.add(clusterer);
            clusterer.createCluster = function (center, geoObjects) {
                var clusterPlacemark = ymaps.Clusterer.prototype.createCluster.call(this, center, geoObjects);
                clusterPlacemark.options.set('balloonContentLayout', 'cluster#balloonTwoColumns');
                clusterPlacemark.options.set('balloonPanelContentLayout', 'cluster#balloonTwoColumns');
                clusterPlacemark.options.set('disableClickZoom', disableClickZoom);
                clusterPlacemark.options.set('openBalloonOnClick', openBalloonOnClick);
                clusterPlacemark.options.set('balloonLeftColumnWidth', balloonLeftColumnWidth);
                clusterPlacemark.options.set('balloonContentLayoutWidth', balloonContentLayoutWidth);
                clusterPlacemark.options.set('balloonPanelMaxMapArea', balloonPanelMaxMapArea);
                clusterPlacemark.options.set('balloonContentLayoutHeight', balloonContentLayoutHeight);
                clusterPlacemark.options.set('balloonContentLayoutWidth', balloonContentLayoutWidth);
                clusterPlacemark.options.set('balloonContentLayoutHeight', balloonContentLayoutHeight);
                clusterPlacemark.options.set('balloonItemContentLayout', balloonItemContentLayout);
                return clusterPlacemark;
            };
            var panelSwitcherButton = new ymaps.control.Button('clusterBalloonPanelMaxMapArea');
            var leftColumnWidthButton = new ymaps.control.Button('balloonLeftColumnWidth *');
            var clusterBalloonContentLayoutWidthButton = new ymaps.control.Button('clusterBalloonContentLayoutWidth (в режиме панели не используется)');
            var clusterBalloonContentLayoutHeightButton = new ymaps.control.Button('clusterBalloonContentLayoutHeight');
            var itemContentButton = new ymaps.control.Button('clusterBalloonItemContentLayout *');
            var updateGeoObjectData = new ymaps.control.Button('update geoObject data');
            var updateGeoObjectData2 = new ymaps.control.Button('update geoObject data from parent DataManager');

            panelSwitcherButton.options.set('maxWidth', 99999);
            leftColumnWidthButton.options.set('maxWidth', 99999);
            clusterBalloonContentLayoutWidthButton.options.set('maxWidth', 99999);
            clusterBalloonContentLayoutHeightButton.options.set('maxWidth', 99999);
            itemContentButton.options.set('maxWidth', 99999);
            updateGeoObjectData.options.set('maxWidth', 99999);
            updateGeoObjectData2.options.set('maxWidth', 99999);

            panelSwitcherButton.events.add('click', function () {
                balloonPanelMaxMapArea = balloonPanelMaxMapArea == 0 ? Infinity : 0;
            });

            leftColumnWidthButton.events.add('click', function () {
                balloonLeftColumnWidth = balloonLeftColumnWidth > 250 ? 200 : 300;
            });

            clusterBalloonContentLayoutWidthButton.events.add('click', function () {
                balloonContentLayoutWidth = balloonContentLayoutWidth > 300 ? 200 : 400;
            });

            clusterBalloonContentLayoutHeightButton.events.add('click', function () {
                balloonContentLayoutHeight = balloonContentLayoutHeight > 250 ? 100 : 350;
            });

            itemContentButton.events.add('click', function () {
                balloonItemContentLayout = balloonItemContentLayout == 'cluster#balloonTwoColumnsItemContent' ?
                        customItemContentLayout :
                        'cluster#balloonTwoColumnsItemContent';
            });

            updateGeoObjectData.events.add('click', function () {
                geoObjects[0].properties.set('clusterCaption', Math.random());
            });

            updateGeoObjectData2.events.add('click', function () {
                var cluster = clusterer.getObjectState(geoObjects[0]).cluster;
                cluster.properties.set('geoObjects.0.properties.clusterCaption', Math.random());
            });

            var captionButton = new ymaps.control.Button('caption');
            captionButton.events
                    .add('select', function () {
                        var objects = clusterer.getGeoObjects();
                        for (var i = 0; i < objects.length; i++) {
                            objects[i].properties.set('clusterCaption', '<b>ClusterCaption <i>Number</i>' + i + '</b>')
                        }
                    })
                    .add('deselect', function () {
                        var objects = clusterer.getGeoObjects();
                        for (var i = 0; i < objects.length; i++) {
                            objects[i].properties.set('clusterCaption', '<img src="https://png-5.findicons.com/files/icons/42/basic/16/info.png"> Cluster<a href="http://www.yandex.ru">Caption</a> <i>Number</i>' + i)
                        }
                    });
            map.controls.add(captionButton, { float: 'none', position: {left: 5, bottom: 35} });


            map.controls.add(panelSwitcherButton, { float: 'none', position: {left: 5, top: 35} });
            map.controls.add(leftColumnWidthButton, { float: 'none', position: {left: 5, top: 5} });
            map.controls.add(clusterBalloonContentLayoutWidthButton, { float: 'none', position: {right: 5, top: 95} });
            map.controls.add(clusterBalloonContentLayoutHeightButton, { float: 'none', position: {right: 5, top: 35} });
            map.controls.add(itemContentButton, { float: 'none', position: {right: 5, top: 5} });
            map.controls.add(updateGeoObjectData, { float: 'none', position: {left: 5, top: 65} });
            map.controls.add(updateGeoObjectData2, { float: 'none', position: {right: 5, top: 65} });

            var content = [
                '',
                'Этот город завёрнут, как в саван, в туман, ',
                'И царит в нём безумье, порок и обман. ',
                'Город мрачных трущоб, весь изглоданный злом, ',
                'По ночам его мгла накрывает крылом.. . ',
                '',
                'И в глазницы домов смотрит ночь, словно ворон, ',
                'Этот город безукоризненно чёрен. ',
                'Только толпы теней, только Темзы свинец — ',
                'Этот город страшней, чем оживший мертвец. ',
                '',
                'И в роскошных дворцах вечный холод и тлен, ',
                'И часы мертвецам отбивает Биг-Бен. ',
                'Вы не бывали в Лондоне, сэр? ',
                'Этот город безукоризненно сер...'
            ].join('<br/>');

            for (var i = 0, l = 50; i < l; i++) {
                var placemark = new ymaps.GeoObject({
                    geometry: {
                        type: "Point",
                        coordinates: map.getCenter()
                    },
                    properties: {
                        balloonContentHeader: 'Заголовок метки №' + i,
                        balloonContentBody: 'Тело метки №' + i + content,
                        balloonContentFooter: 'Футер метки №' + i
                    }
                });
                geoObjects.push(placemark);
            }

            clusterer.add(geoObjects);

        }
    </script>
</head>
<body style="position: relative; padding: 0; margin: 0;">
<div id="map" style="height: 512px; width: 512px;"></div>
</body>
</html>