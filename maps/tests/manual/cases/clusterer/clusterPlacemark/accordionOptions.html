<!DOCTYPE HTML>
<!--
Title:
Кластерная метка: опции балуна аккордеон

Description:
Применение опций кластеризации балуна(Accordion) при пересоздании кластера.
Памятка по терминам: https://wiki.yandex-team.ru/eva/testing/Projects/maps-api/

Components:
clusterer

Estimated time:
420000

Precondition:
Открыть ссылку ${currentPagePath}

Step:
  Action:
  Осмотреть карту и элементы на ней.

  Expectation:
  Карта отобразилась корректно.
  На карте спан Москвы.
  В центре спана кластерная метка с цифрой "50".
  Сверху слева и справа имеются кнопки опций балуна кластера.
  Снизу слева имеется кнопка "caption".

Step:
  Action:
  Выполнить клик в кластерную метку.

  Expectation:
  Спан карты смещается для открытия балуна кластера.
  В открывшемся балуне кластера: список из меток, скрол полоса справа, кнопка закрытия.
  Напротив каждой метки в списке синий круг с синей точкой внутри.

Step:
  Action:
  Проскролить общий балун кластера, навести курсор на произвольную метку в балуне кластера и кликнуть ЛКМ в метку.

  Expectation:
  В балуне кластера 50 меток, с номерами от 0 до 49. 
  При наведении курсора на метку, текст метки становится красным.
  При клике у метки вниз выпадает содержимое балуна метки с заголовком ("Тело метки №..."); телом (стих); Футер ("Футер метки №...").

Step:
  Action:
  Закрыть балун кластера кликом в кнопку закрытия - крестик.
  (при нахождении кнопки закрытия балуна под другими кнопками на спане, перемещаем спан карты драгом)

  Expectation:
  Балун кластера закрывается, на спане остается кластерная метка с цифрой 50.

Step:
  Action:
  Выполнить клик в кнопку "clusterBalloonPanelMaxArea".
  Выполнить даблклик ЛКМ в спан карты, вне кластерной метки.
  Клик в кластерную метку.

  Expectation:
  После даблклика происходит корректный призум карты. Кластерная метка не пропадает со спана карты.
  Снизу открывается панель балуна на всю ширину контейнера.
  Спан карты смещается, таким образом, что кластерная метка находится в центре оставшейся части спана карты.
  В открывшемся балуне список из меток, скрол полоса справа, кнопка закрытия.
  Напротив каждой метки в списке синий круг с синей точкой внутри.

Step:
  Action:
  Проскролить общий балун кластера, навести курсор и выполнить клик ЛКМ в произвольно выбрануную метку.

  Expectation:
  При наведении курсора на метку, текст "Метка ..." становится красным.
  Панель балуна смещается влево и появляется панель с балуном с заголовком (Заголовок метки № ...); телом (стих); Футер ("Футер метки №...").
  У балуна есть кнопка закрытия.
  В общем балуне кластера полоса скрола увеличивается.
  Слева появляется бургер-меню балуна.

Step:
  Action:
  Навести курсор на бургер-меню и выполнить клик в него.

  Expectation:
  Панель балуна смещается вправо и появляется панель со списком меток.

Step:
  Action:
  Закрыть балун кластера кликом в кнопку закрытия - крестик.
 
  Expectation:
  Балун кластера закрывается, на спане остается кластерная метка с цифрой 50.

Step:
  Action:
  Выполнить клик в кнопку "clusterBalloonPanelMaxArea".
  Выполнить клик в кнопку "clusterBalloonItemContentLayout".
  Выполнить даблклик ПКМ в спан карты, вне кластерной метки.
  Клик в кластерную метку.

  Expectation:
  После даблклика происходит корректный отзум карты. Кластерная метка не пропадает со спана карты.
  Спан карты смещается, для открытия балуна.
  На спане карты открывается балун кластера, со списком меток.
  В открывшемся балуне список из меток, скрол полоса справа, кнопка закрытия.
  Напротив каждой метки в списке синий круг с синей точкой внутри.

Step:
  Action:
  Проскролить общий балун кластера, навести курсор на произвольную метку в балуне кластера и кликнуть ЛКМ в метку.

  Expectation:
  В балуне кластера 50 меток, с номерами от 0 до 49. 
  При наведении курсора на метку, текст метки становится красным.
  При клике у метки вниз выпадает содержимое балуна метки с заголовком ("123 Тело метки №..."); телом (стих); футер отсутвует. Все содержимое метки жирным шрифтом. 
  
Step:
  Action:
  Закрыть балун кластера кликом в кнопку закрытия - крестик.
  (при нахождении кнопки закрытия балуна под другими кнопками на спане, перемещаем спан карты драгом)
 
  Expectation:
  Балун кластера закрывается, на спане остается кластерная метка с цифрой 500.

Step:
  Action:
  Выполнить клик в кнопку "clusterBalloonItemContentLayout".
  Выполнить клик в кнопку "clusterBalloonContentLayoutWidth".
  Выполнить даблклик ЛКМ в спан карты, вне кластерной метки.
  Клик в кластерную метку.

  Expectation:
  После даблклика происходит корректный призум карты. Кластерная метка не пропадает со спана карты.
  Спан карты смещается, для открытия балуна.
  На спане карты открывается широкий балун кластера со списком меток.
  В открывшемся балуне список из меток, скрол полоса справа, кнопка закрытия.
  Напротив каждой метки в списке синий круг с синей точкой внутри.
 
Step:
  Action:
  Проскролить общий балун кластера, навести курсор на произвольную метку в балуне кластера и кликнуть ЛКМ в метку.

  Expectation:
  В балуне кластера 50 меток, с номерами от 0 до 49. 
  При наведении курсора на метку, текст метки становится красным.
  При клике у метки вниз выпадает содержимое балуна метки с заголовком ("Тело метки №..."); телом (стих); Футер ("Футер метки №...").
    
Step:
  Action:
  Закрыть балун кластера кликом в кнопку закрытия - крестик.
  (при нахождении кнопки закрытия балуна под другими кнопками на спане, перемещаем спан карты драгом)
 
  Expectation:
  Балун кластера закрывается, на спане остается кластерная метка с цифрой 500.  

Step:
  Action:
  Выполнить клик в кнопку "clusterBalloonContentLayoutWidth".
  Выполнить клик в кнопку "clusterBalloonContentLayoutHeigh".
  Выполнить даблклик ПКМ в спан карты, вне кластерной метки.
  Клик в кластерную метку.

  Expectation:
  После даблклика происходит корректный отзум карты. Кластерная метка не пропадает со спана карты.
  Спан карты смещается, для открытия балуна.
  На спане карты открывается узкий высокий балун кластера, со списком меток.
  В открывшемся балуне список из меток, скрол полоса справа, кнопка закрытия.
  Напротив каждой метки в списке синий круг с синей точкой внутри.

Step:
  Action:
  Проскролить общий балун кластера, навести курсор на произвольную метку в балуне кластера и кликнуть ЛКМ в метку.

  Expectation:
  В балуне кластера 50 меток, с номерами от 0 до 49. 
  При наведении курсора на метку, текст метки становится красным.
  При клике у метки вниз выпадает содержимое балуна метки с заголовком ("Тело метки №..."); телом (стих); Футер ("Футер метки №...").
 
Step:
  Action:
  Закрыть балун кластера кликом в кнопку закрытия - крестик.
  (при нахождении кнопки закрытия балуна под другими кнопками на спане, перемещаем спан карты драгом)
 
  Expectation:
  Балун кластера закрывается, на спане остается кластерная метка с цифрой 50.
  
Step:
  Action:
  Выполнить клик в кнопку "clusterBalloonContentLayoutHeigh".
  Выполнить клик в кнопку "icon Colors * +".
  Выполнить даблклик ЛКМ в спан карты, вне кластерной метки.
  Клик в кластерную метку.

  Expectation:
  После даблклика происходит корректный призум карты. Кластерная метка не пропадает со спана карты.
  Спан карты может смещаться, для открытия балуна.
  На спане карты открывается узкий (невысокий) балун кластера, со списком меток.
  В открывшемся балуне список из меток, скрол полоса справа, кнопка закрытия.
  Напротив каждой метки в списке круг с разноцветными кругами.
  
Step:
  Action:
  Проскролить общий балун кластера, навести курсор на произвольную метку в балуне кластера и кликнуть ЛКМ в метку.

  Expectation:
  В балуне кластера 50 меток, с номерами от 0 до 49, напротив каждой метки разноцветные круги с точкой внутри. 
  При наведении курсора на метку, текст метки становится красным.
  При клике у метки вниз выпадает содержимое балуна метки с заголовком ("Тело метки №..."); телом (стих); Футер ("Футер метки №...").
 
Step:
  Action:
  Закрыть балун кластера кликом в кнопку закрытия - крестик.
  (при нахождении кнопки закрытия балуна под другими кнопками на спане, перемещаем спан карты драгом)
 
  Expectation:
  Балун кластера закрывается, на спане остается кластерная метка с цифрой 50.

Step:
  Action:
  Выполнить клик в кнопку "icon Colors * +".
  Выполнить клик в кнопку "update geoObject data".
  Выполнить даблклик ПКМ в спан карты, вне кластерной метки.
  Клик в кластерную метку.

  Expectation:
  После даблклика происходит корректный отзум карты. Кластерная метка не пропадает со спана карты.
  Спан карты может смещаться, для открытия балуна.
  На спане карты открывается балун кластера, со списком меток.
  В открывшемся балуне список из меток, скрол полоса справа, кнопка закрытия.
  Напротив каждой метки в списке круг с синей точкой внутри.
  
Step:
  Action:
  Проскролить балун кластера скролом мыши к метке № 3, навести курсор на метку в балуне кластера и кликнуть ЛКМ в метку.
 
  Expectation:
  Вместо метки № 3 в списке число в диапазоне от 0 до 1, вида: 0.547047.....
  При наведении курсора на метку, текст метки становится красным.
  При клике у метки вниз выпадает содержимое балуна метки с заголовком ("Тело метки №..."); телом (стих); Футер ("Футер метки №...").

Step:
  Action:
  Закрыть балун кластера кликом в кнопку закрытия - крестик.
  (при нахождении кнопки закрытия балуна под другими кнопками на спане, перемещаем спан карты драгом)
 
  Expectation:
  Балун кластера закрывается, на спане остается кластерная метка с цифрой 500.  

Step:
  Action:
  Выполнить клик в кнопку "update geoObject data".
  Выполнить клик в кнопку "showIcons * +".
  Выполнить даблклик ПКМ в спан карты, вне кластерной метки.
  Клик в кластерную метку.

  Expectation:
  После даблклика происходит корректный отзум карты. Кластерная метка не пропадает со спана карты.
  Спан карты может смещаться, для открытия балуна.
  На спане карты открывается балун кластера, со списком меток.
  В открывшемся балуне список из меток, скрол полоса справа, кнопка закрытия.
  В балуне кластера пропали иконки кругов с точкой внутри.
  
Step:
  Action:
  Проскролить общий балун кластера, навести курсор на произвольную метку в балуне кластера и кликнуть ЛКМ в метку.

  Expectation:
  В балуне кластера 50 меток, с номерами от 0 до 49. 
  При наведении курсора на метку, текст метки становится красным.
  При клике у метки вниз выпадает содержимое балуна метки с заголовком ("Тело метки №..."); телом (стих); Футер ("Футер метки №...").
 
Step:
  Action:
  Закрыть балун кластера кликом в кнопку закрытия - крестик.
  (при нахождении кнопки закрытия балуна под другими кнопками на спане, перемещаем спан карты драгом)
 
  Expectation:
  Балун кластера закрывается, на спане остается кластерная метка с цифрой 50. 
  
Step:
  Action:
  Выполнить клик в кнопку "caption".
  Клик в кластерную метку.

  Expectation:
  Спан карты может смещаться, для открытия балуна.
  На спане карты открывается балун кластера, с открытым балуном метки.
  В открывшемся балуне список из меток, скрол полоса справа, кнопка закрытия.
  В балуне кластера наименования меток в списке сменились на "ClusterCaption Number..."(жирным шрифтом, Number - курсивом).
  В открытом балуне метки заголовок ("Тело метки №..."); тело (стих); Футер ("Футер метки №...").
  
Step:
  Action:
  Закрыть балун кластера кликом в кнопку закрытия - крестик.
  (при нахождении кнопки закрытия балуна под другими кнопками на спане, перемещаем спан карты драгом)
 
  Expectation:
  Балун кластера закрывается, на спане остается кластерная метка с цифрой 50.  
  
Step:
  Action:
  Выполнить клик в кнопку "caption".
  Клик в кластерную метку.

  Expectation:
  Спан карты может смещаться, для открытия балуна.
  На спане карты открывается балун кластера, с открытым балуном метки.
  В открывшемся балуне список из меток, скрол полоса справа, кнопка закрытия.
  В балуне кластера в спсике напротив каждой метки появилась круглая иконка "i" наименования меток в списке сменились на "ClusterCaption Number..."(не жирным шрифтом, Number - курсивом).
  В открытом балуне метки заголовок ("Тело метки №..."); тело (стих); Футер ("Футер метки №...").
 
Step:
  Action:
  Выполнить клик в "Caption" в списке балуна кластера.

  Expectation:
  Происходит редирект на главную страницу Яндекса по адресу https://yandex.ru/.
-->
<html>
<head>
    <title>2.1</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

    <script src="../../../helper.js"></script>
    <script type=text/javascript>

        Api('init');

        function init(ymaps) {
            ymaps = ym;

            var map = myMap = new ym.Map('map', {
                center: [55.72725771214265, 37.640390506634006],
                zoom: 10,
                behaviors: ['default', 'scrollZoom'],
                controls: []
            });

            addGrid(myMap);
            var log = new Log();
            __log__('Test case: option is changing after re-create cluster.');

            var fullscreen = new ymaps.control.FullscreenControl();
            map.controls.add(fullscreen, {float: 'none', position: {bottom: 35, right: 5}});

            var balloonPanelMaxMapArea = 0;
            var disableClickZoom = true;
            var openBalloonOnClick = true;
            var hasHint = true;
            var openEmptyHint = true;
            var balloonAccordionShowIcons = true;
            var balloonContentLayoutWidth = 200;
            var balloonContentLayoutHeight = 200;
            var balloonItemContentLayout = 'cluster#balloonAccordionItemContent';

            var clusterer = new ymaps.Clusterer({});
            map.geoObjects.add(clusterer);
            clusterer.createCluster = function (center, geoObjects) {
                var clusterPlacemark = ymaps.Clusterer.prototype.createCluster.call(this, center, geoObjects);
                clusterPlacemark.options.set('balloonContentLayout', 'cluster#balloonAccordion');
                clusterPlacemark.options.set('balloonPanelContentLayout', 'cluster#balloonAccordion');
                clusterPlacemark.options.set('disableClickZoom', disableClickZoom);
                clusterPlacemark.options.set('openBalloonOnClick', openBalloonOnClick);
                clusterPlacemark.options.set('hasHint', hasHint);
                clusterPlacemark.options.set('openEmptyHint', openEmptyHint);
                clusterPlacemark.options.set('balloonPanelMaxMapArea', balloonPanelMaxMapArea);
                clusterPlacemark.options.set('balloonAccordionShowIcons', balloonAccordionShowIcons);
                clusterPlacemark.options.set('balloonContentLayoutWidth', balloonContentLayoutWidth);
                clusterPlacemark.options.set('balloonContentLayoutHeight', balloonContentLayoutHeight);
                clusterPlacemark.options.set('balloonItemContentLayout', balloonItemContentLayout);
                return clusterPlacemark;
            };
            var geoObjects = [];

            var customItemContentLayout = ymaps.templateLayoutFactory.createClass('<b>123 {{ properties.balloonContentBody|raw }}</b>');

            var panelSwitcherButton = new ymaps.control.Button('clusterBalloonPanelMaxMapArea');
            var balloonAccordionShowIconsButton = new ymaps.control.Button('showIcons * +');
            var clusterBalloonContentLayoutWidthButton = new ymaps.control.Button('clusterBalloonContentLayoutWidth');
            var clusterBalloonContentLayoutHeightButton = new ymaps.control.Button('clusterBalloonContentLayoutHeight');
            var itemContentButton = new ymaps.control.Button('clusterBalloonItemContentLayout *');
            var iconColorsButton = new ymaps.control.Button('icon Colors * +');
            var updateGeoObjectData = new ymaps.control.Button('update geoObject data');

            panelSwitcherButton.options.set('maxWidth', 99999);
            balloonAccordionShowIconsButton.options.set('maxWidth', 99999);
            clusterBalloonContentLayoutWidthButton.options.set('maxWidth', 99999);
            clusterBalloonContentLayoutHeightButton.options.set('maxWidth', 99999);
            itemContentButton.options.set('maxWidth', 99999);
            iconColorsButton.options.set('maxWidth', 99999);
            updateGeoObjectData.options.set('maxWidth', 99999);

            panelSwitcherButton.events.add('click', function () {
                balloonPanelMaxMapArea = balloonPanelMaxMapArea == 0 ? Infinity : 0;
            });

            balloonAccordionShowIconsButton.events.add('click', function () {
                balloonAccordionShowIcons = !balloonAccordionShowIcons;
            });

            clusterBalloonContentLayoutWidthButton.events.add('click', function () {
                balloonContentLayoutWidth = balloonContentLayoutWidth > 300 ? 200 : 400;
            });

            clusterBalloonContentLayoutHeightButton.events.add('click', function () {
                balloonContentLayoutHeight = balloonContentLayoutHeight > 300 ? 100 : 350;
            });

            itemContentButton.events.add('click', function () {
                balloonItemContentLayout = balloonItemContentLayout == 'cluster#balloonAccordionItemContent' ?
                        customItemContentLayout : 'cluster#balloonAccordionItemContent';
            });

            updateGeoObjectData.events.add('click', function () {
                geoObjects[3].properties.set('clusterCaption', Math.random());
            });

            var useDefaultIconColor = true;
            iconColorsButton.events.add('click', function () {
                useDefaultIconColor = !useDefaultIconColor;
                if (useDefaultIconColor) {
                    for (var i = 0, l = geoObjects.length; i < l; i++) {
                        geoObjects[i].options.unset('iconColor');
                    }
                } else {
                    for (var i = 0, l = geoObjects.length; i < l; i++) {
                        geoObjects[i].options.set('iconColor', getRandomColor());
                    }
                }
            });

            map.controls.add(panelSwitcherButton, { float: 'none', position: {right: 5, top: 95} });
            map.controls.add(balloonAccordionShowIconsButton, { float: 'none', position: {left: 5, top: 5} });
            map.controls.add(clusterBalloonContentLayoutWidthButton, { float: 'none', position: {right: 5, top: 35} });
            map.controls.add(clusterBalloonContentLayoutHeightButton, { float: 'none', position: {right: 5, top: 5} });
            map.controls.add(itemContentButton, { float: 'none', position: {right: 5, top: 65} });
            map.controls.add(iconColorsButton, { float: 'none', position: {left: 5, top: 65} });
            map.controls.add(updateGeoObjectData, { float: 'none', position: {left: 5, top: 35} });

            var content = [
                '',
                'Этот город завёрнут, как в саван, в туман, ',
                'И царит в нём безумье, порок и обман. ',
                'Город мрачных трущоб, весь изглоданный злом, ',
                'По ночам его мгла накрывает крылом.. . ',
                '',
                'И в глазницы домов смотрит ночь, словно ворон, ',
                'Этот город безукоризненно чёрен. ',
                'Только толпы теней, только Темзы свинец — ',
                'Этот город страшней, чем оживший мертвец. ',
                '',
                'И в роскошных дворцах вечный холод и тлен, ',
                'И часы мертвецам отбивает Биг-Бен. ',
                'Вы не бывали в Лондоне, сэр? ',
                'Этот город безукоризненно сер...'
            ].join('<br/>');

            for (var i = 0, l = 50; i < l; i++) {
                var placemark = new ymaps.GeoObject({
                    geometry: {
                        type: "Point",
                        coordinates: map.getCenter()
                    },
                    properties: {
                        balloonContentHeader: 'Заголовок метки №' + i,
                        balloonContentBody: 'Тело метки №' + i + content,
                        balloonContentFooter: 'Футер метки №' + i
                    }
                });
                geoObjects.push(placemark);
            }

            clusterer.add(geoObjects);

            var captionButton = new ymaps.control.Button('caption');
            captionButton.events
                    .add('select', function () {
                        var objects = clusterer.getGeoObjects();
                        for (var i = 0; i < objects.length; i++) {
                            objects[i].properties.set('clusterCaption', '<b>ClusterCaption <i>Number</i>' + i + '</b>')
                        }
                    })
                    .add('deselect', function () {
                        var objects = clusterer.getGeoObjects();
                        for (var i = 0; i < objects.length; i++) {
                            objects[i].properties.set('clusterCaption', '<img src="https://png-5.findicons.com/files/icons/42/basic/16/info.png"> Cluster<a href="http://www.yandex.ru">Caption</a> <i>Number</i>' + i)
                        }
                    });
            map.controls.add(captionButton, { float: 'none', position: {left: 5, bottom: 35} });

            function getRandomColor() {
                return [
                    '#',
                    (55 + Math.round(Math.random() * 200)).toString(16),
                    (55 + Math.round(Math.random() * 200)).toString(16),
                    (55 + Math.round(Math.random() * 200)).toString(16)
                ].join('')
            }


        }
    </script>
</head>
<body style="position: relative; padding: 0; margin: 0;">
<div id="map" style="height: 512px; width: 512px;"></div>
</body>
</html>