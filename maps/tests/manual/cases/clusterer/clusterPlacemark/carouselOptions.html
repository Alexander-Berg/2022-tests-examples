<!DOCTYPE HTML>
<!--
Title:
Кластерная метка: опции балуна карусели

Description:
Применение опций кластеризации балуна(Carousel) при пересоздании кластера.
Памятка по терминам: https://wiki.yandex-team.ru/eva/testing/Projects/maps-api/

Components:
clusterer

Estimated time:
420000

Precondition:
Открыть ссылку ${currentPagePath}

Step:
  Action:
  Осмотреть карту и элементы на ней.

  Expectation:
  Карта отобразилась корректно.
  На карте спан Москвы.
  В центре спана кластерная метка с цифрой "50".
  Сверху слева и справа имеются кнопки опций балуна кластера.
  Снизу слева имеется кнопка "caption".

Step:
  Action:
  Выполнить клик в кластерную метку.

  Expectation:
  Спан карты смещается для открытия балуна кластера.
  На спане карты открывается балун кластера карусель: отображается содержимое метки: заголовок "Заголовок метки №0", тело(стих), футер "Футер метки № 0", внизу список меток "1, 2, 3, ...", имеются стрелки переключения балуна, скрол полоса, кнопка закрытия балуна.

Step:
  Action:
  Выполнить два клика в стрелку смены содержимого балуна расположенную справа.

  Expectation:
  В балуне меняется содержимое, отображается содержимое 3 метки. Внизу в списке выделена метка 3.
  В балуне корректное содержимое: "Заголовок метки №2", тело(стих), "Футер метки №2". 

Step:
  Action:
  Закрыть балун кластера кликом в кнопку закрытия - крестик.
  (при нахождении кнопки закрытия балуна под другими кнопками на спане, перемещаем спан карты драгом)

  Expectation:
  Балун кластера закрывается, на спане остается кластерная метка с цифрой 50.

Step:
  Action:
  Выполнить клик в кнопку "clusterBalloonPagerVisible".
  Выполнить даблклик ЛКМ в спан карты, вне кластерной метки.
  Клик в кластерную метку.

  Expectation:
  После даблклика происходит корректный призум карты. Кластерная метка не пропадает со спана карты.
  Спан карты смещается для открытия балуна кластера.
  На спане карты открывается балун кластера карусель: отображается содержимое метки: заголовок "Заголовок метки №0", тело(стих), футер "Футер метки № 0".
  В балуне отсутвует список меток снизу, имеются стрелки переключения балуна, скрол полоса, кнопка закрытия балуна.

Step:
  Action:
  Выполнить два клика в стрелку смены содержимого балуна расположенную слева.

  Expectation:
  В балуне меняется содержимое, отображается содержимое метки 48.
  В балуне корректное содержимое: "Заголовок метки №48", тело(стих), "Футер метки №48". 
  В балуне отсутвует список меток снизу, имеются стрелки переключения балуна, скрол полоса, кнопка закрытия балуна.

Step:
  Action:
  Закрыть балун кластера кликом в кнопку закрытия - крестик.
 
  Expectation:
  Балун кластера закрывается, на спане остается кластерная метка с цифрой 50.

Step:
  Action:
  Выполнить клик в кнопку "clusterBalloonPagerVisible".
  Выполнить клик в кнопку "clusterBalloonPanelMaxMapArea".
  Выполнить даблклик ПКМ в спан карты, вне кластерной метки.
  Клик в кластерную метку.

  Expectation:
  После даблклика происходит корректный отзум карты. Кластерная метка не пропадает со спана карты.
  Спан карты смещается, для открытия балуна, при этом кластерная метка смещается в центр спана карты.
  Внизу открывается панель балуна кластера, с открытым балуном метки №0.
  В открывшемся балуне список из меток снизу(1,2,3,4,5 ...), стрелки смены содержимого балуна, скрол полоса справа, кнопка закрытия.
  В балуне корректное содержимое: "Заголовок метки №0", тело(стих), "Футер метки №0". 

Step:
  Action:
  Закрыть балун кластера кликом в кнопку закрытия - крестик.
 
  Expectation:
  Балун кластера закрывается, на спане остается кластерная метка с цифрой 50.

Step:
  Action:
  Выполнить клик в кнопку "clusterBalloonPanelMaxMapArea".
  Выполнить клик в кнопку "clusterBalloonContentLayoutHeight".
  Выполнить даблклик ЛКМ в спан карты, вне кластерной метки.
  Клик в кластерную метку.

  Expectation:
  После даблклика происходит корректный призум карты. Кластерная метка не пропадает со спана карты.
  Спан карты смещается, для открытия балуна.
  На спане карты открывается высокий балун кластера, с открытым балуном метки.
  В открывшемся балуне внизу список из меток (1,2,3, ...), стрелки смены содержимого балуна, скрол полоса справа, кнопка закрытия.
  В балуне корректное содержимое: "Заголовок метки №0", тело(стих), "Футер метки №0". 
  
Step:
  Action:
  Закрыть балун кластера кликом в кнопку закрытия - крестик.
  (при нахождении кнопки закрытия балуна под другими кнопками на спане, перемещаем спан карты драгом)
 
  Expectation:
  Балун кластера закрывается, на спане остается кластерная метка с цифрой 50.  

Step:
  Action:
  Выполнить клик в кнопку "clusterBalloonContentLayoutHeight".
  Выполнить клик в кнопку "clusterBalloonContentLayoutWidth".
  Выполнить даблклик ПКМ в спан карты, вне кластерной метки.
  Клик в кластерную метку.

  Expectation:
  После даблклика происходит корректный отзум карты. Кластерная метка не пропадает со спана карты.
  Спан карты смещается, для открытия балуна.
  На спане карты открывается широкий балун кластера, с открытым балуном метки.
  В открывшемся балуне внизу список из меток (1,2,3, ...), стрелки смены содержимого балуна, скрол полоса справа, кнопка закрытия.
  В балуне корректное содержимое: "Заголовок метки №0", тело(стих), "Футер метки №0". 
  
Step:
  Action:
  Закрыть балун кластера кликом в кнопку закрытия - крестик.
  (при нахождении кнопки закрытия балуна под другими кнопками на спане, перемещаем спан карты драгом)
 
  Expectation:
  Балун кластера закрывается, на спане остается кластерная метка с цифрой 50.
  
Step:
  Action:
  Выполнить клик в кнопку "clusterBalloonContentLayoutWidth".
  Выполнить клик в кнопку "clusterBalloonContentLayout".
  Выполнить даблклик ЛКМ в спан карты, вне кластерной метки.
  Клик в кластерную метку.

  Expectation:
  После даблклика происходит корректный призум карты. Кластерная метка не пропадает со спана карты.
  Спан карты может смещаться, для открытия балуна.
  На спане карты открывается узкий (невысокий) балун кластера, с открытым балуном метки.
  В открывшемся балуне внизу список из меток (1,2,3, ...), стрелки смены содержимого балуна, скрол полоса справа, кнопка закрытия.
  В балуне корректное содержимое: "Заголовок метки №0"(большим жирным шрифтом), тело(стих). Содержимое балуна отображается жирным шрифтом, футер отсутсвует. 
  
Step:
  Action:
  Закрыть балун кластера кликом в кнопку закрытия - крестик.
  (при нахождении кнопки закрытия балуна под другими кнопками на спане, перемещаем спан карты драгом)
 
  Expectation:
  Балун кластера закрывается, на спане остается кластерная метка с цифрой 50.

Step:
  Action:
  Выполнить клик в кнопку "clusterBalloonContentLayout".
  Выполнить клик в кнопку "clusterBallooPagerType".
  Выполнить даблклик ПКМ в спан карты, вне кластерной метки.
  Клик в кластерную метку.

  Expectation:
  После даблклика происходит корректный отзум карты. Кластерная метка не пропадает со спана карты.
  Спан карты смещается для открытия панели балуна кластера.
  На спане карты открывается узкий (невысокий) балун кластера, с открытым балуном метки.
  В открывшемся балуне внизу вместо цифрового списка серые иконки отображения балунов, стрелки смены содержимого балуна, скрол полоса справа, кнопка закрытия.
  В балуне корректное содержимое: "Заголовок метки №0", тело(стих), "Футер метки №0".  

Step:
  Action:
  Закрыть балун кластера кликом в кнопку закрытия - крестик.
  (при нахождении кнопки закрытия балуна под другими кнопками на спане, перемещаем спан карты драгом)
 
  Expectation:
  Балун кластера закрывается, на спане остается кластерная метка с цифрой 50.

Step:
  Action:
  Выполнить клик в кнопку "clusterBallooPagerType".
  Выполнить клик в кнопку "clusterBallooPagerSize".
  Выполнить даблклик ПКМ в спан карты, вне кластерной метки.
  Клик в кластерную метку.

  Expectation:
  После даблклика происходит корректный отзум карты. Кластерная метка не пропадает со спана карты.
  Спан карты смещается для открытия панели балуна кластера.
  На спане карты открывается узкий (невысокий) балун кластера, с открытым балуном метки.
  В открывшемся балуне внизу список из меток (1,2,3,4,5,6,7,8,9...), стрелки смены содержимого балуна, скрол полоса справа, кнопка закрытия.
  В балуне корректное содержимое: "Заголовок метки №0", тело(стих), "Футер метки №0".  

Step:
  Action:
  Закрыть балун кластера кликом в кнопку закрытия - крестик.
  (при нахождении кнопки закрытия балуна под другими кнопками на спане, перемещаем спан карты драгом)
 
  Expectation:
  Балун кластера закрывается, на спане остается кластерная метка с цифрой 50.

Step:
  Action:
  Выполнить клик в кнопку "clusterBallooPagerSize".
  Выполнить клик в кнопку "clusterBallooCycling".
  Выполнить даблклик ЛКМ в спан карты, вне кластерной метки.
  Клик в кластерную метку.

  Expectation:
  После даблклика происходит корректный призум карты. Кластерная метка не пропадает со спана карты.
  Спан карты смещается для открытия балуна кластера.
  На спане карты открывается узкий (невысокий) балун кластера, с открытым балуном метки.
  В открывшемся балуне внизу список из меток (1,2,3, ...), скрол полоса справа, кнопка закрытия.
  В балуне имеется только одна стрелка смены содержимого балуна, расположенная справа. 
  В балуне корректное содержимое: "Заголовок метки №0", тело(стих), "Футер метки №0".  

Step:
  Action:
  Закрыть балун кластера кликом в кнопку закрытия - крестик.
  (при нахождении кнопки закрытия балуна под другими кнопками на спане, перемещаем спан карты драгом)
 
  Expectation:
  Балун кластера закрывается, на спане остается кластерная метка с цифрой 50.

Step:
  Action:
  Выполнить клик в кнопку "clusterBallooCycling".
  Выполнить клик в кнопку "update geoObject data".
  Выполнить даблклик ЛКМ в спан карты, вне кластерной метки.
  Клик в кластерную метку.

  Expectation:
  После даблклика происходит корректный призум карты. Кластерная метка не пропадает со спана карты.
  Спан карты смещается для открытия панели балуна кластера.
  На спане карты открывается узкий (невысокий) балун кластера, с открытым балуном метки.
  В открывшемся балуне внизу список из меток (1,2,3, ...), стрелки смены содержимого балуна, скрол полоса справа, кнопка закрытия.
  В балуне содержимое: заголовок меняется на число в диапазоне от 0 до 1, тело(стих), "Футер метки №0".  

Step:
  Action:
  Закрыть балун кластера кликом в кнопку закрытия - крестик.
  (при нахождении кнопки закрытия балуна под другими кнопками на спане, перемещаем спан карты драгом)
 
  Expectation:
  Балун кластера закрывается, на спане остается кластерная метка с цифрой 50.

Step:
  Action:
  Выполнить клик в кнопку "caption".
  Клик в кластерную метку.

  Expectation:
  Спан карты смещается для открытия панели балуна кластера.
  На спане карты открывается узкий (невысокий) балун кластера, с открытым балуном метки.
  В открывшемся балуне внизу список из меток (1,2,3, ...), стрелки смены содержимого балуна, скрол полоса справа, кнопка закрытия.
  В балуне содержимое: заголовок меняется на "ClusterCaption Number0"(ClusterCaption жирным шрифтом, Number - курсивом), тело(стих), "Футер метки №0".  

Step:
  Action:
  Закрыть балун кластера кликом в кнопку закрытия - крестик.
  (при нахождении кнопки закрытия балуна под другими кнопками на спане, перемещаем спан карты драгом)
 
  Expectation:
  Балун кластера закрывается, на спане остается кластерная метка с цифрой 50.

Step:
  Action:
  Выполнить клик в кнопку "caption".
  Клик в кластерную метку.

  Expectation:
  Спан карты смещается для открытия панели балуна кластера.
  На спане карты открывается узкий (невысокий) балун кластера, с открытым балуном метки.
  В открывшемся балуне внизу список из меток (1,2,3, ...), стрелки смены содержимого балуна, скрол полоса справа, кнопка закрытия.
  В балуне содержимое: заголовок меняется на иконку с символом "i" текстом "ClusterCaption Number0"(ClusterCaption жирным шрифтом, Number - курсивом), тело(стих), "Футер метки №0".  
  Caption в заголовке метки - ссылка, подчеркута и выделена цветом.

Step:
  Action:
  Выполнить клик в "Caption" в заголовке балуна кластера.

  Expectation:
  Происходит редирект на главную страницу Яндекса по адресу https://yandex.ru/.
-->
<html>
<head>
    <title>2.1</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

    <script src="../../../helper.js"></script>
    <script type=text/javascript>

        Api('init');

        function init(ymaps) {
            ymaps = ym;

            var map = myMap = new ym.Map('map', {
                center: [55.72725771214265, 37.640390506634006],
                zoom: 10,
                behaviors: ['default', 'scrollZoom'],
                controls: []
            });

            addGrid(myMap);
            var log = new Log();
            __log__('Test case: option is changing after re-create cluster.');

            var fullscreen = new ymaps.control.FullscreenControl();
            map.controls.add(fullscreen, {float: 'none', position: {bottom: 35, right: 5}});
            var disableClickZoom = true;
            var openBalloonOnClick = true;
            var balloonPanelMaxMapArea = 0;
            var balloonCycling = true;
            var balloonPagerSize = 5;
            var balloonPagerType = 'numeric';
            var balloonPagerVisible = true;
            var balloonContentLayoutWidth = 200;
            var balloonContentLayoutHeight = 200;
            var balloonItemContentLayout = 'cluster#balloonCarouselItemContent';

            var clusterer = new ymaps.Clusterer({});
            map.geoObjects.add(clusterer);
            clusterer.createCluster = function (center, geoObjects) {
                var clusterPlacemark = ymaps.Clusterer.prototype.createCluster.call(this, center, geoObjects);
                clusterPlacemark.options.set('balloonContentLayout', 'cluster#balloonCarousel');
                clusterPlacemark.options.set('balloonPanelContentLayout', 'cluster#balloonCarousel');
                clusterPlacemark.options.set('disableClickZoom', disableClickZoom);
                clusterPlacemark.options.set('openBalloonOnClick', openBalloonOnClick);
                clusterPlacemark.options.set('balloonCycling', balloonCycling);
                clusterPlacemark.options.set('balloonPagerSize', balloonPagerSize);
                clusterPlacemark.options.set('balloonPanelMaxMapArea', balloonPanelMaxMapArea);
                clusterPlacemark.options.set('balloonPagerType', balloonPagerType);
                clusterPlacemark.options.set('balloonPagerVisible', balloonPagerVisible);
                clusterPlacemark.options.set('balloonContentLayoutWidth', balloonContentLayoutWidth);
                clusterPlacemark.options.set('balloonContentLayoutHeight', balloonContentLayoutHeight);
                clusterPlacemark.options.set('balloonItemContentLayout', balloonItemContentLayout);
                return clusterPlacemark;
            };

            var geoObjects = [];

            var customItemContentLayout = ymaps.templateLayoutFactory.createClass('<h2>{{ properties.balloonContentHeader|raw }}</h2><b>123 {{ properties.balloonContentBody|raw }}</b>');

            var panelSwitcherButton = new ymaps.control.Button('clusterBalloonPanelMaxMapArea');
            var balloonCyclingButton = new ymaps.control.Button('clusterBalloonCycling *');
            var balloonPagerSizeButton = new ymaps.control.Button('clusterBalloonPagerSize *');
            var balloonPagerTypeButton = new ymaps.control.Button('clusterBalloonPagerType *');
            var balloonPagerVisibleButton = new ymaps.control.Button('clusterBalloonPagerVisible *');
            var itemContentButton = new ymaps.control.Button('clusterBalloonItemContentLayout *');
            var clusterBalloonContentLayoutWidthButton = new ymaps.control.Button('clusterBalloonContentLayoutWidth');
            var clusterBalloonContentLayoutHeightButton = new ymaps.control.Button('clusterBalloonContentLayoutHeight');
            var updateGeoObjectData = new ymaps.control.Button('update geoObject data');

            panelSwitcherButton.options.set('maxWidth', 99999);
            balloonCyclingButton.options.set('maxWidth', 99999);
            clusterBalloonContentLayoutWidthButton.options.set('maxWidth', 99999);
            clusterBalloonContentLayoutHeightButton.options.set('maxWidth', 99999);
            balloonPagerSizeButton.options.set('maxWidth', 99999);
            balloonPagerTypeButton.options.set('maxWidth', 99999);
            balloonPagerVisibleButton.options.set('maxWidth', 99999);
            itemContentButton.options.set('maxWidth', 99999);
            updateGeoObjectData.options.set('maxWidth', 99999);

            panelSwitcherButton.events.add('click', function () {
                balloonPanelMaxMapArea = balloonPanelMaxMapArea == 0 ? Infinity : 0;
            });

            balloonCyclingButton.events.add('click', function () {
                balloonCycling = !balloonCycling;
            });

            balloonPagerSizeButton.events.add('click', function () {
                balloonPagerSize = balloonPagerSize == 9 ? 5 : 9;
            });


            balloonPagerTypeButton.events.add('click', function () {
                balloonPagerType = balloonPagerType == 'numeric' ? 'marker' : 'numeric';
            });


            balloonPagerVisibleButton.events.add('click', function () {
                balloonPagerVisible = !balloonPagerVisible;
            });

            clusterBalloonContentLayoutWidthButton.events.add('click', function () {
                balloonContentLayoutWidth = balloonContentLayoutWidth > 300 ? 200 : 400;
            });

            clusterBalloonContentLayoutHeightButton.events.add('click', function () {
                balloonContentLayoutHeight = balloonContentLayoutHeight > 250 ? 100 : 300;
            });

            itemContentButton.events.add('click', function () {
                balloonItemContentLayout = balloonItemContentLayout == 'cluster#balloonCarouselItemContent' ?
                        customItemContentLayout :
                        'cluster#balloonCarouselItemContent';
            });

            updateGeoObjectData.events.add('click', function () {
                geoObjects[0].properties.set('clusterCaption', Math.random());
            });

            var captionButton = new ymaps.control.Button('caption');
            captionButton.events
                    .add('select', function () {
                        var objects = clusterer.getGeoObjects();
                        for (var i = 0; i < objects.length; i++) {
                            objects[i].properties.set('clusterCaption', '<b>ClusterCaption <i>Number</i>' + i + '</b>')
                        }
                    })
                    .add('deselect', function () {
                        var objects = clusterer.getGeoObjects();
                        for (var i = 0; i < objects.length; i++) {
                            objects[i].properties.set('clusterCaption', '<img src="https://png-5.findicons.com/files/icons/42/basic/16/info.png"> Cluster<a href="http://www.yandex.ru">Caption</a> <i>Number</i>' + i)
                        }
                    });
            map.controls.add(captionButton, { float: 'none', position: {left: 5, bottom: 35} });

            map.controls.add(panelSwitcherButton, { float: 'none', position: {right: 5, top: 95} });
            map.controls.add(balloonCyclingButton, { float: 'none', position: {left: 5, top: 35} });
            map.controls.add(balloonPagerSizeButton, { float: 'none', position: {left: 5, top: 65} });
            map.controls.add(balloonPagerTypeButton, { float: 'none', position: {left: 5, top: 95} });
            map.controls.add(balloonPagerVisibleButton, { float: 'none', position: {right: 5, top: 125} });
            map.controls.add(clusterBalloonContentLayoutWidthButton, { float: 'none', position: {right: 5, top: 35} });
            map.controls.add(clusterBalloonContentLayoutHeightButton, { float: 'none', position: {right: 5, top: 65} });
            map.controls.add(itemContentButton, { float: 'none', position: {right: 5, top: 5} });
            map.controls.add(updateGeoObjectData, { float: 'none', position: {left: 5, top: 5} });

            var content = [
                '',
                'Этот город завёрнут, как в саван, в туман, ',
                'И царит в нём безумье, порок и обман. ',
                'Город мрачных трущоб, весь изглоданный злом, ',
                'По ночам его мгла накрывает крылом.. . ',
                '',
                'И в глазницы домов смотрит ночь, словно ворон, ',
                'Этот город безукоризненно чёрен. ',
                'Только толпы теней, только Темзы свинец — ',
                'Этот город страшней, чем оживший мертвец. ',
                '',
                'И в роскошных дворцах вечный холод и тлен, ',
                'И часы мертвецам отбивает Биг-Бен. ',
                'Вы не бывали в Лондоне, сэр? ',
                'Этот город безукоризненно сер...'
            ].join('<br/>');

            for (var i = 0, l = 50; i < l; i++) {
                var placemark = new ymaps.GeoObject({
                    geometry: {
                        type: "Point",
                        coordinates: map.getCenter()
                    },
                    properties: {
                        balloonContentHeader: 'Заголовок метки №' + i,
                        balloonContentBody: 'Тело метки №' + i + content,
                        balloonContentFooter: 'Футер метки №' + i
                    }
                });
                geoObjects.push(placemark);
            }

            clusterer.add(geoObjects);

        }
    </script>
</head>
<body style="position: relative; padding: 0; margin: 0;">
<div id="map" style="height: 512px; width: 512px;"></div>
</body>
</html>