<!doctype html>
<!--
Title:
Гео запрос: проверка заданных условий 

Description:
Проверка заданных условий.
Памятка по терминам: https://wiki.yandex-team.ru/eva/testing/Projects/maps-api/

Components: 
geoQuery

Estimated time:
300000

Precondition:
Открыть ссылку ${currentPagePath}

Step:
  Action:
  Осмотреть карту и элементы на ней. 
  
  Expectation:
  Карта отобразилась корректно.
  На спане карты множество меток(голубых и синих), объекты полупрозрачных синих прямоугольников, кругов, синие линии разной толщины. 
  Слева в контейнере с картой ряд кнопок с условиями проверки, справа снизу две кнопки с условиями проверки.

Step:
  Action:
  Выполнить клик в кнопку "Lat>55.60"(верхняя слева). 
  
  Expectation:
  В центре спана появляется красная горизонтальная линия, метки коллекций выше линии становятся красными.
  Под контейнером с картой появляется строка "OK".

Step:
  Action:
  Выполнить клик в кнопку "Lat>55.45"(вторая сверху). 
  
  Expectation:
  В нижней трети спана появляется красная горизонтальная линия, метки коллекций ниже линии становятся красными.
  Под контейнером с картой появляется строка "OK".  

Step:
  Action:
  Выполнить клик в кнопку "Long > 3..."(третья сверху). 
  
  Expectation:
  В центре спана появляется красная вертикальная линия, метки коллекций справа от линии становятся красными.
  Под контейнером с картой появляется строка "OK".  

Step:
  Action:
  Выполнить клик в кнопку "Long < 3..."(четвертая сверху). 
  
  Expectation:
  В левой трети спана появляется красная вертикальная линия, метки коллекций слева от линии становятся красными.
  Под контейнером с картой появляется строка "OK".  

Step:
  Action:
  Выполнить клик в кнопку "== unde..."(пятая сверху). 
  
  Expectation:
  Объекты: прямоугольник, круг, метка, прямоугольник, линия справа слева и снизу справа становятся красными, светло-голубые метки коллекций ближе к левому верхнему углу также становятся красного цвета.
  Под контейнером с картой появляется строка "OK". 

Step:
  Action:
  Выполнить клик в кнопку "!="geo..."(шестая сверху). 
  
  Expectation:
  Все объекты на спане карты становятся красного цвета.
  Под контейнером с картой появляется строка "OK". 

Step:
  Action:
  Выполнить клик в кнопку "regexp "..."(седьмая сверху). 
  
  Expectation:
  Часть объектов на спане карты становятся синего цвета, 4 набора объектов: прямоугольник, круг, метка, прямоугольник, линия - красного цвета.
  Под контейнером с картой появляется строка "OK". 

Step:
  Action:
  Выполнить клик в кнопку "rlike "^0..."(восьмая сверху). 
  
  Expectation:
  На спане объекты синего цвета, за исключением трех наборов объектов: прямоугольник, круг, метка, прямоугольник, линия, расположенных в правом вертикальном ряду(объекты красного цвета).
  Под контейнером с картой появляется строка "OK". 

Step:
  Action:
  Выполнить клик в кнопку "hintCont..."(девятая сверху). 
  Навести курсор на выделенные красным объекты.
  
  Expectation:
  На спане объекты синего цвета, за исключением 5 объектов: прямоугольник, круг, метка, прямоугольник, линия.
  При наведении на объект курсор - рука, появляется хинт "some property".
  Под контейнером с картой появляется строка "OK". 

Step:
  Action:
  Выполнить клик в кнопку "hintCont..."(десятая сверху). 
  Навести курсор на выделенные синим объекты.
  
  Expectation:
  На спане все объекты становятся красного цвета, за исключением 5 объектов: прямоугольник, круг, метка, прямоугольник, линия.
  При наведении на объект курсор - рука, появляется хинт "some property".
  Под контейнером с картой появляется строка "OK". 

Step:
  Action:
  Выполнить клик в кнопку "custom ..."(одиннадцатая сверху). 
  
  Expectation:
  На спане часть объектов красного цвета, часть синего.
  Под контейнером с картой появляется строка "OK". 

Step:
  Action:
  Выполнить клик в кнопку "custom ..."(двенадцатая сверху). 
  
  Expectation:
  На спане часть объектов поменяли цвет с красного на синий и наоборот.
  Под контейнером с картой появляется строка "OK".   

Step:
  Action:
  Выполнить клик в кнопку "== Plac..."(тринадцатая сверху). 
  
  Expectation:
  На спане все метки коллекций стали красного цвета, остальные объекты - синего.
  Под контейнером с картой появляется строка "OK".

Step:
  Action:
  Выполнить клик в кнопку "!== Polyline"(четырнадцатая сверху). 
  
  Expectation:
  На спане все объекты и метки кроме линий стали красного цвета.
  Под контейнером с картой появляется строка "OK".   

Step:
  Action:
  Выполнить клик в кнопку "regexp ^..."(пятнадцатая сверху). 
  
  Expectation:
  На спане все метки и узкие прямоугольники красного цвета, остальные объекты синего цвета.
  Под контейнером с картой появляется строка "OK".   

Step:
  Action:
  Выполнить клик в кнопку "X >=79..."(шестнадцатая сверху). 
  
  Expectation:
  Слева в первой трети спана карты появляется вертикальная красная линия, правее которой все метки коллекции становятся красного цвета, остальные объекты синего цвета.
  Под контейнером с картой появляется строка "OK".  

Step:
  Action:
  Выполнить клик в кнопку "X <=79..."(семнадцатая сверху). 
  
  Expectation:
  Вертикальная линия в первой трети спана карты остается, метки левее линии становятся красного цвета, остальные объекты синего цвета.
  Под контейнером с картой появляется строка "OK". 

Step:
  Action:
  Выполнить клик в кнопку "Y <=411..."(справа снизу верхняя). 
  
  Expectation:
  На спане вверху появляется горизонтальная красная линия, метки выше линии становятся красного цвета, остальные объекты синего цвета.
  Под контейнером с картой появляется строка "OK". 

Step:
  Action:
  Выполнить клик в кнопку "Y >=411..."(справа снизу верхняя). 
  
  Expectation:
  Горизонтальная линия в вверху спана карты остается, метки ниже линии становятся красного цвета, остальные объекты синего цвета.
  Под контейнером с картой появляется строка "OK".
-->
<html>
<head>
<title></title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

<script src="../../helper.js"></script>
<script src="../../js/wgs84MercatorSource.js"></script>
<script type=text/javascript>

Api('init');

function init(ymaps) {
    ymaps = ym; // hack

    var map = myMap = new ym.Map('map', {
        center: [55.5541584321358, 37.93061981201168],
        zoom: 9,
        behaviors: ['default', 'scrollZoom'],
        controls: ['fullscreenControl']
    });

    wgs84MercatorSource(ym, myMap, this);
    addGrid(myMap);
    var log = new Log();

    log.info('GeoQueryResult search(): MAPSAPI-8043 - conditions without spaces');

    var result = ym.geoQuery(geoQueryResult);
    result.then(function () {
        result.addToMap(myMap);
    });

    var lat55_6 = new ymaps.Polyline([
                [55.6, 37.26978759765576],
                [55.6, 38.605749511718194]
            ], {hintContent: "latitude = 55.6"},
            {visible: false, strokeColor: '#FF0000', strokeWidth: 3});
    var lat55_45 = new ymaps.Polyline([
                [55.45, 37.26978759765576],
                [55.45, 38.605749511718194]
            ], {hintContent: "latitude = 55.45"},
            {visible: false, strokeColor: '#FF0000', strokeWidth: 3});

    var long37_6 = new ymaps.Polyline([
                [55.932822058184314, 37.6],
                [55.15804309347428, 37.6]
            ], {hintContent: "longitude = 37.6"},
            {visible: false, strokeColor: '#FF0000', strokeWidth: 3});
    var long37_9 = new ymaps.Polyline([
                [55.932822058184314, 37.9],
                [55.15804309347428, 37.9]
            ], {hintContent: "longitude = 37.9"},
            {visible: false, strokeColor: '#FF0000', strokeWidth: 3});

    var x79185 = new ymaps.Polyline([
                [55.184067753127366, 37.50324707031226],
                [55.93119684874074, 37.509863281249736]
            ],
            {hintContent: "x = 79185"}, {visible: false, strokeColor: '#FF0000', strokeWidth: 3});

    var y41110 = new ymaps.Polyline([
                [55.7256682875947, 37.2409484863276],
                [55.721709104899915, 38.634588623046376]
            ],
            {hintContent: "y = 41110"}, {visible: false, strokeColor: '#FF0000', strokeWidth: 3});


    var latitudeFilterButton1 = new ymaps.control.Button({data: {content: 'Lat>55.60'}, options: {selectOnClick: false}});
    var latitudeFilterButton2 = new ymaps.control.Button({data: {content: 'Lat<55.45'}, options: {selectOnClick: false}});
    var filterRlikeButton = new ymaps.control.Button({data: {content: 'rlike "^objectCollection"'}}, {selectOnClick: false});
    var filterEqualsButton = new ymaps.control.Button({data: {content: '== undefined'}}, {selectOnClick: false});
    var filterRegexpButton = new ymaps.control.Button({data: {content: 'regexp "3$"'}}, {selectOnClick: false});
    var filterInequalsButton = new ymaps.control.Button({data: {content: '!= "geoObjectCircle"'}}, {selectOnClick: false});
    var filterNullButton = new ymaps.control.Button({data: {content: 'hintContent != null'}}, {selectOnClick: false});
    var filterUndefinedButton = new ymaps.control.Button({data: {content: 'hintContent == undefined'}}, {selectOnClick: false});
    var filterTrueButton = new ymaps.control.Button({data: {content: 'custom == true'}}, {selectOnClick: false});
    var filterFalseButton = new ymaps.control.Button({data: {content: 'custom == false'}}, {selectOnClick: false});
    var equalsButton = new ymaps.control.Button({data: {content: '== Placemark'}}, {selectOnClick: false});
    var inequalsButton = new ymaps.control.Button({data: {content: '!= Polyline'}}, {selectOnClick: false});
    var regexpButton = new ymaps.control.Button({data: {content: 'regexp ^Po'}}, {selectOnClick: false});
    var aboveXButton = new ymaps.control.Button({data: {content: 'X >= 79185'}}, {selectOnClick: false});
    var belowXButton = new ymaps.control.Button({data: {content: 'X <= 79185'}}, {selectOnClick: false});
    var lessThanYButton = new ymaps.control.Button({data: {content: 'Y <= 41110'}}, {selectOnClick: false});
    var moreThanYButton = new ymaps.control.Button({data: {content: 'Y >= 41110'}}, {selectOnClick: false});
    var longitudeFilterButton1 = new ymaps.control.Button({data: {content: 'Long > 37.9'}}, {selectOnClick: false});
    var longitudeFilterButton2 = new ymaps.control.Button({data: {content: 'Long < 37.6'}}, {selectOnClick: false});


    // shows objects above the line
    latitudeFilterButton1.events.add('click', function () {
        testSearch(result, 'lat > 55.6');
        lat55_6.options.set('visible', true);
    });

    // shows objects below another line
    latitudeFilterButton2.events.add('click', function () {
        testSearch(result, 'lat < 55.45');
        lat55_45.options.set('visible', true);
    });

    // filter objects (rlike)
    filterRlikeButton.events.add('click', function () {
        testSearch(result, 'options.id rlike "^objectCollection"');
    });

    // filter objects (==)
    filterEqualsButton.events.add('click', function () {
        testSearch(result, 'options.id == undefined');
    });
    // filter objects (regexp)
    filterRegexpButton.events.add('click', function () {
        testSearch(result, 'options.id regexp "3$"');
    });

    // filter objects (!=)
    filterInequalsButton.events.add('click', function () {
        testSearch(result, 'options.id != "geoObjectCircle"');
    });

    // filter objects (!=)
    filterNullButton.events.add('click', function () {
        testSearch(result, 'properties.hintContent != null');
    });

    // filter objects (==)
    filterUndefinedButton.events.add('click', function () {
        testSearch(result, 'properties.hintContent == undefined');
    });

    // filter objects (==)
    filterTrueButton.events.add('click', function () {
        testSearch(result, 'properties.custom == true');
    });

    // filter objects
    filterFalseButton.events.add('click', function () {
        testSearch(result, 'properties.custom == false');
    });

    // filter objects (==)
    equalsButton.events.add('click', function () {
        testSearch(result, 'geometry.type == "Point"');
    });
    // filter objects (!=)
    inequalsButton.events.add('click', function () {
        testSearch(result, 'geometry.type != "LineString"');
    });
    // filter objects (regexp)
    regexpButton.events.add('click', function () {
        testSearch(result, 'geometry.type regexp "^Po"');
    });

    // filter objects (>=)
    aboveXButton.events.add('click', function () {
        /*var p = myMap.options.get('projection'),
         z = myMap.getZoom(),
         bounds = [p.toGlobalPixels([55.57283665890869,37.47331390380759], z)];
         log.info(bounds);*/
        testSearch(result, 'x >= 79185');
        x79185.options.set('visible', true);
    });
    // filter objects (<=)
    belowXButton.events.add('click', function () {
        /*var p = myMap.options.get('projection'),
         z = myMap.getZoom(),
         bounds = [p.toGlobalPixels([55.57283665890869,37.47331390380759], z)];
         log.info(bounds);*/
        testSearch(result, 'x <= 79185');
        x79185.options.set('visible', true);
    });

    // filter objects
    lessThanYButton.events.add('click', function () {
        /*var coord = geoObjectPlacemark.geometry.getCoordinates();
         var p = myMap.options.get('projection'),
         z = myMap.getZoom(),
         bounds = [p.toGlobalPixels([55.51521680447712,37.68205413818325], z)];
         log.info(bounds);*/
        testSearch(result, 'y <= 41110');
        y41110.options.set('visible', true);
    });

    // filter objects
    moreThanYButton.events.add('click', function () {
        /*var coord = geoObjectPlacemark.geometry.getCoordinates();
         var p = myMap.options.get('projection'),
         z = myMap.getZoom(),
         bounds = [p.toGlobalPixels([55.51521680447712,37.68205413818325], z)];
         log.info(bounds);*/
        testSearch(result, 'y >= 41110');
        y41110.options.set('visible', true);
    });

    // show all objects to the right of the line
    longitudeFilterButton1.events.add('click', function () {
        testSearch(result, 'long > 37.9');
        long37_9.options.set('visible', true);
    });

    // show all objects to the left of the line
    longitudeFilterButton2.events.add('click', function () {
        testSearch(result, 'lng < 37.6');
        long37_6.options.set('visible', true);
    });

    map.geoObjects
            .add(lat55_6)
            .add(lat55_45)
            .add(long37_6)
            .add(long37_9)
            .add(x79185)
            .add(y41110);

    map.controls
            .add(latitudeFilterButton1, {position: {left: 5, top: 5}})
            .add(latitudeFilterButton2, {position: {left: 5, top: 35}})
            .add(longitudeFilterButton1, {position: {left: 5, top: 65}})
            .add(longitudeFilterButton2, {position: {left: 5, top: 95}})
            .add(filterEqualsButton, {position: {left: 5, top: 125}})
            .add(filterInequalsButton, {position: {left: 5, top: 155}})
            .add(filterRegexpButton, {position: {left: 5, top: 185}})
            .add(filterRlikeButton, {position: {left: 5, top: 215}})
            .add(filterNullButton, {position: {left: 5, top: 245}})
            .add(filterUndefinedButton, {position: {left: 5, top: 275}})
            .add(filterTrueButton, {position: {left: 5, top: 305}})
            .add(filterFalseButton, {position: {left: 5, top: 335}})
            .add(equalsButton, {position: {left: 5, top: 365}})
            .add(inequalsButton, {position: {left: 5, top: 395}})
            .add(regexpButton, {position: {left: 5, top: 425}})
            .add(aboveXButton, {position: {left: 5, top: 455}})
            .add(belowXButton, {position: {left: 5, top: 485}})
            .add(lessThanYButton, {position: {right: 5, bottom: 65}})
            .add(moreThanYButton, {position: {right: 5, bottom: 35}});


    // function-helper for convenient search
    function testSearch(initialData, condition) {

        initialData.unsetOptions(['preset', 'fillColor', 'fillOpacity', 'strokeColor']);
        lat55_6.options.set('visible', false);
        lat55_45.options.set('visible', false);
        long37_6.options.set('visible', false);
        long37_9.options.set('visible', false);
        x79185.options.set('visible', false);
        y41110.options.set('visible', false);

        var filtered = initialData.search(condition);
        var parent = initialData.search(condition).getParent();
        validateValue(parent, initialData);
        filtered.each(function (obj) {
            obj.options.set('strokeColor', "#FF0000")
                    .set('preset', "islands#redIcon")
                    .set('fillColor', '#FF0000')
                    .set('fillOpacity', 0.2)
        });

        /*var iterator = filtered.getIterator(), obj;
         while (obj = iterator.getNext()) {
         if (obj == iterator.STOP_ITERATION) {
         log.info(obj + ' - STOP_ITERATION');
         return;
         }
         log.info(obj);
         obj.options.set('strokeColor', "#FF0000")
         .set('preset', "islands#redIcon")
         .set('fillColor', '#FF0000')
         .set('fillOpacity', 0.2)
         }*/
    }
}
</script>
</head>
<body style="position: relative; padding: 0; margin: 0;">
<div id="map" style="height: 512px; width: 512px;"></div>
</body>
</html>