<!DOCTYPE html>
<!--
Title:
Контрол поиска: кастомный поиск

Description:
Поиск по собственным объектам.
Памятка по терминам: https://wiki.yandex-team.ru/eva/testing/Projects/maps-api/

Components: 
smoke, regress

Estimated time:
300000

Precondition:
Открыть ссылку ${currentPagePath}

Step:
  Action:
  Осмотреть карту и элементы на ней. 

  Expectation:
  Карта отобразилась корректно.
  На карте спан Москвы с метками коллекций. 
  Сверху слева поисковый инпут, в инпуте подсказка "Адрес или объект", за инпутом кнопка "Найти".

Step:
  Action:
  Ввести в поисковый инпут "вокзал", клик в "Найти". 

  Expectation:
  Смена спана карты, на спан с меткой коллекции.
  Контрол масштабирования "+" неактивен, карта максимально призумлена.
  Под инпутом сниппет "Вокзал name; Вокзал description".

Step:
  Action:
  Клик в метку коллекции на спане карты. 

  Expectation:
  На месте метки появляется балун с содержимым "Вокзал".

Step:
  Action:
  Выполнить клик в поисковый инпут, затем удалить значение "вокзал", ввести в поисковый инпут "стадион", клик в "Найти". 

  Expectation:
  Смена спана карты, на спан с меткой коллекции.
  Контрол масштабирования "+" неактивен, карта максимально призумлена.
  Под инпутом сниппет "Стадион name; Стадион description".

Step:
  Action:
  Клик в метку коллекции на спане карты. 

  Expectation:
  На месте метки появляется балун с содержимым "Стадион".

Step:
  Action:
  Выполнить клик в поисковый инпут, затем удалить значение "стадион", ввести в поисковый инпут "школа", клик в "Найти". 

  Expectation:
  Смена спана карты, на спан с меткой коллекции.
  Контрол масштабирования "+" неактивен, карта максимально призумлена.
  Под инпутом сниппет "Школа name; Школа description".

Step:
  Action:
  Клик в метку коллекции на спане карты. 

  Expectation:
  На месте метки появляется балун с содержимым "Школа".

Step:
  Action:
  Выполнить клик в поисковый инпут, затем удалить значение "школа", ввести в поисковый инпут "магазин", клик в "Найти". 

  Expectation:
  Смена спана карты, на спан с меткой коллекции.
  Контрол масштабирования "+" неактивен, карта максимально призумлена.
  Под инпутом сниппет "Магазин name; Магазин description".

Step:
  Action:
  Клик в метку коллекции на спане карты. 

  Expectation:
  На месте метки появляется балун с содержимым "Магазин".

Step:
  Action:
  Выполнить клик в поисковый инпут, затем удалить значение "магазин", ввести в поисковый инпут "церковь", клик в "Найти". 

  Expectation:
  Спан карты не изменился, на карте открыт балун с содержанием "Магазин".
  Под поисковым инпутом появляется плашка с содержимым "По запросу ничего не найдено".

Step:
  Action:
  Выполнить клик в поисковый инпут, затем удалить значение "церковь", ввести в поисковый инпут "университет", клик в "Найти". 

  Expectation:
  Смена спана карты, на спан с меткой коллекции.
  Контрол масштабирования "+" неактивен, карта максимально призумлена.
  Под инпутом сниппет "Университет name; Университет description".

Step:
  Action:
  Клик в метку коллекции на спане карты. 

  Expectation:
  На месте метки появляется балун с содержимым "Университет".

Step:
  Action:
  Выполнить клик в поисковый инпут, затем удалить значение "университет", ввести в поисковый инпут "бар", клик в "Найти". 

  Expectation:
  Смена спана карты, на спан с меткой коллекции.
  Контрол масштабирования "+" неактивен, карта максимально призумлена.
  Под инпутом сниппет "Бар name; Бар description".

Step:
  Action:
  Клик в метку коллекции на спане карты. 

  Expectation:
  На месте метки появляется балун с содержимым "Бар".

Step:
  Action:
  Выполнить клик в поисковый инпут, затем удалить значение "бар", ввести в поисковый инпут "музей", клик в "Найти". 

  Expectation:
  Смена спана карты, на спан с меткой коллекции.
  Контрол масштабирования "+" неактивен, карта максимально призумлена.
  Под инпутом сниппет "Музей name; Музей description".

Step:
  Action:
  Клик в метку коллекции на спане карты. 

  Expectation:
  На месте метки появляется балун с содержимым "Музей".

Step:
  Action:
  Выполнить клик в поисковый инпут, затем удалить значение "музей", ввести в поисковый инпут "салон красоты", клик в "Найти". 

  Expectation:
  Смена спана карты, на спан с меткой коллекции.
  Контрол масштабирования "+" неактивен, карта максимально призумлена.
  Под инпутом сниппет "Салон красоты name; Салон красоты description".

Step:
  Action:
  Клик в метку коллекции на спане карты. 

  Expectation:
  На месте метки появляется балун с содержимым "Салон красоты".

Step:
  Action:
  Выполнить клик в поисковый инпут, затем удалить значение "салон красоты", ввести в поисковый инпут "прачечная", клик в "Найти". 

  Expectation:
  Смена спана карты, на спан с меткой коллекции.
  Контрол масштабирования "+" неактивен, карта максимально призумлена.
  Под инпутом сниппет "Прачечная name; Прачечная description".

Step:
  Action:
  Клик в метку коллекции на спане карты. 

  Expectation:
  На месте метки появляется балун с содержимым "Прачечная".
-->
<html>
<head>
    <title>API 2.0</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <script src="../../helper.js"></script>
    <script type=text/javascript>
        Api('init');
        function init(ymaps) {
            var myMap = new ymaps.Map('map', {
                        center: [55.7, 37.5],
                        zoom: 9,
                        behaviors: ['default', 'scrollZoom'],
                        controls: ['fullscreenControl']
                    }),
            // Создаем коллекцию.
                    myCollection = new ymaps.GeoObjectCollection(),
            // Создаем массив с данными.
                    myPoints = [
                        { coords: [55.77, 37.46], text: 'Трактир' },
                        { coords: [55.66, 37.48], text: 'Кафе' },
                        { coords: [55.65, 37.42], text: 'Ресторан' },
                        { coords: [55.64, 37.54], text: 'Музей' },
                        { coords: [55.54, 37.52], text: 'Библиотека' },
                        { coords: [55.53, 37.56], text: 'Школа' },
                        { coords: [55.61, 37.61], text: 'Аптека' },
                        { coords: [55.80, 37.58], text: 'Бар' },
                        { coords: [55.71, 37.35], text: 'Институт' },
                        { coords: [55.74, 37.57], text: 'Университет' },
                        { coords: [55.58, 37.69], text: 'Больница' },
                        { coords: [55.57, 37.70], text: 'Цирк' },
                        { coords: [55.55, 37.64], text: 'Магазин' },
                        { coords: [55.50, 37.75], text: 'Булочная' },
                        { coords: [55.81, 37.73], text: 'Полиция' },
                        { coords: [55.73, 37.68], text: 'Салон красоты' },
                        { coords: [55.86, 37.76], text: 'Баня' },
                        { coords: [55.38, 37.69], text: 'Гараж' },
                        { coords: [55.91, 37.50], text: 'Дом' },
                        { coords: [55.62, 37.32], text: 'Прачечная' },
                        { coords: [55.85, 37.41], text: 'Стадион' },
                        { coords: [55.67, 37.24], text: 'Вокзал' }
                    ];
            // Заполняем коллекцию данными.
            myPoints.forEach(function (point) {
                myCollection.add(new ymaps.Placemark(
                        point.coords, {
                            balloonContentBody: point.text
                        }
                ));
            });
            // Добавляем коллекцию меток на карту.
            myMap.geoObjects.add(myCollection);
            // Создаем экземпляр класса ymaps.control.SearchControl
            var mySearchControl = new ymaps.control.SearchControl({
                // Заменяем стандартный провайдер данных (геокодер) нашим собственным.
                provider: new CustomSearchProvider(myPoints),
                // Не будем показывать еще одну метку при выборе результата поиска,
                // т.к. метки коллекции myCollection уже добавлены на карту.
                noPlacemark: true,
                resultsPerPage: 5
            });
            // Добавляем контрол в верхний правый угол,
            myMap.controls
                    .add(mySearchControl, { right: 10, top: 10 })
                    .add('smallZoomControl');
            // Провайдер данных для элемента управления ymaps.control.SearchControl.
            // Осуществляет поиск геообъектов в по массиву points.
            // Реализует интерфейс IGeocodeProvider.
            function CustomSearchProvider(points) {
                this.points = points;
            }
            // Провайдер ищет по полю text стандартным методом String.ptototype.indexOf.
            CustomSearchProvider.prototype.geocode = function (request, options) {
                var promise = new ymaps.util.Promise(),
                        geoObjects = new ymaps.GeoObjectArray(),
                // Сколько результатов нужно пропустить.
                        offset = options.skip || 0,
                // Количество возвращаемых результатов.
                        limit = options.results || 20;
                this.points
                    // Ищем в свойстве text каждого элемента массива.
                        .filter(function (point) {
                            return point.text.toLowerCase().indexOf(request.toLowerCase()) != -1;
                        })
                    // При формировании ответа можно учитывать offset и limit.
                        .splice(offset, limit)
                    // Добавляем точки в результирующую коллекцию.
                        .forEach(function (point) {
                            var coords = point.coords,
                                    text = point.text;
                            geoObjects.add(new ymaps.Placemark(coords, {
                                name: text + ' name',
                                description: text + ' description',
                                balloonContentBody: '<p>' + text + '</p>',
                                boundedBy: [coords, coords]
                            }));
                        });
                promise.resolve({
                    // Геообъекты поисковой выдачи.
                    geoObjects: geoObjects,
                    // Метаинформация ответа.
                    metaData: {
                        geocoder: {
                            // Строка обработанного запроса.
                            request: request,
                            // Количество найденных результатов.
                            found: geoObjects.getLength(),
                            // Количество возвращенных результатов.
                            results: limit,
                            // Количество пропущенных результатов.
                            skip: offset
                        }
                    }
                });
                // Возвращаем объект-обещание.
                return promise;
            }
        }
    </script>
</head>
<body style="position: relative; padding: 0; margin: 0;">
<div id="map" style="height: 512px; width: 512px;"></div>
<p><a href="https://tech.yandex.ru/maps/archive/doc/jsapi/2.0/ref/reference/control.SearchControl-docpage/" target="_blank">Docs</a></p>
</body>
</html>