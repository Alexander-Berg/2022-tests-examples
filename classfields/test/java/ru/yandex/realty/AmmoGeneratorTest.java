package ru.yandex.realty;

import org.apache.commons.codec.binary.Base64;
import org.apache.commons.lang.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import ru.yandex.common.util.IOUtils;
import ru.yandex.common.util.URLUtils;
import ru.yandex.common.util.collections.Pair;

import java.io.File;
import java.io.Writer;

/**
 * User: daedra
 * Date: 25.09.14
 * Time: 20:58
 */
public class AmmoGeneratorTest {
    private static final Logger log = LoggerFactory.getLogger(AmmoGeneratorTest.class);
    private static final String INPUT_FILE_PATH = "/Users/daedra/tmp/realty2-wizard-access.log";
    private static final String OUTPUT_NNUL_FILE_PATH = "/Users/daedra/work/ammo/new/realty2_wizard_nnull.ammo";
    private static final String OUTPUT_NUL_FILE_PATH = "/Users/daedra/work/ammo/new/realty2_wizard.ammo";
    private static Base64 base64 = new Base64();

/*
    public static void main(String[] args) throws Exception {
        String line = "[Tue Nov 11 20:50:33.257]\tстраховая компания на первомайской \t4\tUNKNOWN\t0\t37.9.119.132\t\t213\t213\t\t\tстраховая компания на первомайской \t[{\"normalizedtext\":\"первомайская\",\"data\":{\"Variants\":[{\"Street\":\"первомайская\",\"Weight\":0.923,\"CommonIDs\":[2,4,5,6,8,9,10,11,12,13,15,16,19,20,21,22,23,25,33,35,36,37,38,41,42,44,45,46,47,49,50,51,54,55,56,63,64,65,66,67,74,76,77,78,141,142,145,146,153,155,157,158,162,163,165,172,187,191,193,194,195,197,213,214,215,216,235,238,239,240,960,963,964,965,968,969,970,972,975,976,1091,1093,1094,1104,1107,10276,10291,10292,10298,10306,10308,10347,10363,10365,10366,10367,10369,10645,10648,10649,10651,10652,10653,10654,10655,10656,10657,10658,10659,10661,10663,10664,10665,10666,10668,10669,10670,10673,10675,10678,10679,10683,10684,10685,10686,10695,10697,10702,10706,10710,10713,10714,10715,10716,10718,10721,10722,10725,10728,10729,10731,10732,10733,10734,10735,10737,10739,10740,10742,10745,10747,10748,10750,10752,10753,10754,10755,10756,10757,10758,10761,10762,10763,10765,10768,10770,10774,10775,10778,10780,10781,10783,10784,10788,10790,10792,10793,10794,10796,10797,10799,10800,10801,10806,10812,10813,10814,10815,10816,10821,10822,10825,10826,10827,10828,10829,10830,10831,10832,10833,10834,10835,10837,10838,10839,10840,10846,10847,10848,10849,10858,10859,10860,10861,10863,10864,10874,10875,10877,10885,10892,10894,10895,10902,10905,10907,10908,10914,10915,10917,10919,10927,10928,10930,10931,10932,10936,10937,10938,10941,10942,10943,10945,10947,10949,10951,10954,10955,10956,10961,10964,10965,10969,10970,10972,10977,10980,10982,10986,10987,10988,10990,10991,10993,11000,11005,11008,11009,11011,11019,11022,11023,11025,11026,11030,11031,11034,11037,11040,11041,11045,11048,11049,11051,11053,11054,11055,11057,11059,11060,11061,11063,11064,11065,11066,11067,11068,11069,11071,11074,11075,11076,11085,11089,11091,11093,11094,11097,11099,11100,11101,11104,11105,11106,11109,11113,11114,11115,11116,11121,11122,11123,11124,11125,11126,11129,11132,11133,11135,11136,11137,11138,11139,11141,11142,11144,11147,11150,11151,11152,11154,11155,11159,11160,11162,11163,11165,11166,11168,11170,11172,11173,11175,11178,11182,11183,11184,11190,11194,11196,11199,11200,11209,11212,11213,11216,11217,11218,11220,11222,11231,11234,11238,11239,11240,11242,11243,11246,11248,11249,11252,11253,11254,11259,11260,11262,11263,11270,11273,11274,11276,11286,11293,11296,11298,11299,11301,11304,11309,11314,11319,11326,11327,11333,11336,11341,11349,11351,11354,11355,11360,11361,11364,11366,11368,11369,11373,11374,11382,11385,11389,11391,11392,11394,11396,11404,11405,11406,11407,11409,11410,11411,11412,11413,11415,11416,11423,11425,11426,11429,11431,11435,11444,11445,11450,11456,11457,11460,11461,11463,11471,11472,20009,20010,20011,20013,20019,20020,20021,20025,20026,20027,20028,20030,20031,20035,20036,20037,20038,20039,20042,20043,20046,20051,20054,20056,20057,20058,20059,20060,20063,20064,20067,20069,20071,20072,20073,20074,20077,20078,20079,20080,20082,20085,20088,20089,20090,20091,20092,20093,20096,20097,20099,20100,20101,20102,20103,20106,20109,20111,20112,20113,20117,20119,20120,20124,20125,20126,20127,20128,20132,20134,20135,20138,20139,20141,20148,20155,20158,20161,20164,20165,20166,20170,20171,20172,20173,20174,20177,20178,20179,20180,20183,20184,20185,20186,20187,20189,20191,20192,20199,20201,20202,20203,20205,20206,20207,20210,20211,20213,20216,20218,20219,20221,20224,20231,20232,20233,20234,20235,20236,20237,20238,20239,20240,20243,20244,20247,20250,20252,20254,20255,20256,20257,20259,20261,20265,20267,20268,20273,20523,20531,20536,20537,20540,20542,20544,20548,20554,20555,20556,20580,20585,20586,20592,20596,20597,20601,20602,20603,20606,20607,20609,20610,20613,20616,20619,20621,20623,20624,20625,20626,20629,20632,20638,20639,20642,20645,20647,20648,20649,20653,20654,20656,20658,20659,20661,20663,20664,20665,20667,20669,20672,20673,20674,20675,20677,20679,20682,20683,20684,20685,20688,20690,20693,20694,20696,20697,20699,20700,20701,20702,20703,20704,20708,20711,20712,20713,20714,20716,20717,20718,20720,20724,20728,20729,20735,20809,20820,20909,20985,21018,21030,21094,21130,21141,21147,21154,21161,21274,21313,21494,21510,21521,21609,21619,21623,21624,21627,21630,21635,21637,21641,21642,21643,21645,21648,21650,21655,21656,21664,21666,21679,21680,21681,21684,21687,21690,21691,21695,21699,21701,21712,21720,21726,21733,21738,21740,21741,21742,21773,21774,21949,23329,24373,24375,24376,24377,24383,24402,24405,24408,24413,24415,24422,24426,24431,24434,24435,24437,24438,24465,24466,24468,24471,24497,24498,24499,24500,24501,24503,24504,24506,24509,24510,24511,24512,24513,24514,24515,24521,24538,24539,24543,24552,24554,24557,24559,24561,24607,24620,24627,24630,24641,24665,24668,24698,24699,24703,24708,24724,24751,24752,24756,24761,24764,24770,24773,24778,24788,24797,24822,24826,24850,24862,24865,24866,24867,24871,24874,24875,24876,24878,24880,24888,24889,24890,24891,24892,24893,24894,24904,26001,26004,26005,26006,26008,26010,26012,26014,26017,26018,26021,26023,26025,26026,26027,26032,26034,26554,26643,26753,26766,26774,26779,26834,26836,26846,26855,26878,26887,26923,26947,26955,26966,26974,26994,27012,27074,27080,27092,27101,27116,27164,27177,27188,27197,27210,27212,27217,27252,27265,27271,27274,27292,27305,27312,27318,27324,27326,27330,27331,27341,27363,27369,27379,27381,27382,27391,27394,27399,27408,27421,27431,27436,27455,27476,27497,27505,27511,27517,27528,27529,27555,27565,27613,27627,27633,27637,27639,27665,27670,27672,27675,27679,27699,27703,27706,27708,27720,27738,27744,27747,27748,27756,27763,27769,27779,27784,27794,27800,27810,27819,27822,27838,27849,27854,27877,27898,27902,27906,27921,27955,27959,27984,27998,28004,28013,28019,28052,28076,28082,28087,28122,28130,28169,28183,28190,28214,28221,28250,28252,28257,28293,28304,28306,28326,28327,28340,28355,28362,28382,28387,28391,28396,28398,28409,28410,28417,28443,28466,28476,28503,28525,28531,28539,28570,28578,28582,28590,28625,28635,28654,28655,28658,28662,28668,28682,28698,28708,28736,28770,28772,28783,28784,28798,28805,28809,28814,28837,28841,28865,28868,28879,28887,28891,28896,28900,28903,28904,28910,28911,28924,28927,28940,28948,28954,28976,28983,28993,29024,29054,29066,29074,29076,29127,29145,29173,29179,29190,29202,29246,29288,29382,29390,29391,29397,29399,29410,29411,29412,29416,29427,29451,29467,29492,29520,29545,29550,29590,29594,29600,29604,29629,29630,29631,29632,29633,29634,29652,30547,30629,30866,32090,33105,33106,34012,34567,37016,37118,37119,37122,37124,37129,37130,37133,37134,37140,37144,37146,37147,37152,37154,37159,37160,37162,37164,37166,37168,37170,98566,98580,98581,98582,98584,98586,98588,98593,98595,98598,98599,98603,98604,98605,98606,98607,98608,98611,98612,98617,98620,98621,98623,98626,98631,98634,98673,98686,98697,98698,98699,98700,98701,98702,98703,98705,98706,98708,98710,98711,98716,98717,98718,98719,98723,98725,98726,98727,98729,98730,98731,98732,98733,98734,98735,98736,98737,98739,98740,98741,98742,98743,98744,98746,98747,98748,98750,98751,98753,98754,98755,98758,98759,98760,98762,98763,98765,98769,98770,98771,98772,98773,98774,98775,98776,98777,98780,98781,98783,98785,98786,98787,98788,98789,98790,98794,98795,98798,98800,98807,98809,98810,98812,98816,98817,98821,98826,98838,98850,98855,98861,98864,98872,98873,98875,98877,98884,98886,98891,98893,98896,98897,98898,98902,98905,98913,98917,98924,98935,98949,98951,98955,98958,98962,98970,98973,98974,98987,98988,98989,98993,98996,99001,99005,99008,99010,99013,99014,99019,99023,99029,99038,99040,99041,99044,99045,99051,99052,99058,99060,99062,99071,99072,99076,99077,99080,99081,99082,99086,99087,99089,99091,99095,99096,99098,99100,99106,99107,99108,99109,99120,99124,99125,99126,99133,99152,99164,99183,99188,99190,99197,99198,99201,99202,99204,99210,99211,99214,99218,99222,99224,99225,99227,99228,99229,99232,99234,99238,99239,99240,99241,99242,99245,99248,99257,99259,99265,99267,99268,99269,99270,99271,99272,99273,99274,99275,99276,99277,99279,99280,99281,99282,99283,99284,99285,99286,99287,99288,99289,99290,99291,99292,99293,99295,99296,99297,99298,99299,99300,99301,99302,99303,99304,99305,99306,99307,99308,99327,99344,99354,99357,99358,99362,99371,99375,99376,99379,99383,99391,99393,99396,99397,99400,99408,99409,99410,99411,99413,99415,99417,99419,99421,99422,99423,99425,99426,99428,99429,99432,99433,99434,99435,99436,99437,99439,99440,99441,99444,99445,99446,99447,99449,99451,99453,99455,99456,99457,99458,99459,99460,99461,99462,99463,99465,99466,99467,99468,99470,99471,99476,99477,99478,99479,99480,99481,99482,99483,99485,99487,99488,99489,99490,99492,99493,99494,99497,99498,99500,99503,99506,99508,99509,99511,99513,99514,99515,99516,99517,99518,99519,99521,99522,99523,99524,99525,99526,99531,99532,99536,99539,99540,99543,99544,99545,99546,99550,99553,99556,99565,99573,99574,99577,99581,99585,99586,99598,99600,99603,99607,99609,99616,99618,99619,99623,99624,99628,99632,99633,99634,99642,99643,99646,99647,99648,99652,99653,99657,99658,99664,99665,99667,99671,99672,99675,99677,99681,99689,99691,99694,99695,99697,99705,99710,99712,99713,99714,99715,99723,99730,99735,99736,99741,99743,99749,99757,99759,99762,99763,99765,99766,99770,99772,99774,99783,99786,99787,99788,99790,99791,99792,99794,99796,99797,99799,99801,99802,99804,99806,99807,99809,99810,99812,99816,99817,99818,99822,99824,99828,99829,99832,99833,99844,99850,99851,99852,99855,99858,99863,99866,99868,99874,99877,99880,99883,99889,99896,99897,99898,99899,99904,99909,99910,99911,99912,99914,99916,99923,99925,99931,99946,99957,99963,99964,99972,99973,99976,99977,99978,99979,99980,99982,99983,99984,99986,99987,99989,99990,99991,99992,100000,100003,100004,100008,100011,100014,100018,100020,100035,100037,100042,100056,100062,100065,100066,100069,100087,100097,100101,100102,100107,100108,100109,100112,100114,100115,100118,100119,100121,100124,100126,100127,100129,100136,100143,100150,100151,100163,100167,100171,100179,100180,100181,100188,100192,100198,100199,100200,100205,100212,100213,100220,100222,100223,100225,100231,100232,100242,100252,100259,100266,100271,100272,100274,100280,100286,100291,100304,100311,100327,100329,100331,100332,100333,100338,100341,100404,100405,100425,100432,100437,100438,100440,100442,100444,100445,100446,100447,100448,100450,100462,100464,100468,100469,100470,100471,100472,100508,100522,100525,100530,100532,100535,100559,100562,100564,100568,100569,100573,100574,100578,100583,100591,100623,100626,100642,100660,100665,100666,100667,100668,100669,100671,100673,100675,100676,100677,100678,100680,100681,100682,100686,100689,100691,100693,100694,100696,100697,100698,100699,100700,100702,100705,100707,100710,100711,100714,100715,100716,100718,100719,100721,100722,100723,100724,100729,100732,100733,100736,100738,100739,100741,100743,100750,100753,100754,100755,100758,100759,100760,100762,100764,100769,100772,100773,100774,100775,100777,100779,100780,100781,100782,100783,100786,100787,100789,100791,100792,100793,100794,100795,100796,100797,100798,100799,100800,100803,100804,100805,100807,100808,100809,100812,100813,100816,100817,100818,100819,100820,100823,100824,100829,100830,100833,100834,100837,100840,100841,100842,100843,100844,100845,100846,100847,100848,100849,100850,100851,100852,100854,100862,100866,100867,100868,100870,100871,100873,100874,100878,100879,100884,100889,100896,100903,100904,100910,100914,100918,100919,100920,100921,100922,100925,100927,100928,100930,100933,100935,100936,100938,100939,100950,100955,100956,100957,100958,100960,100962,100964,100965,100967,100968,100973,100974,100975,100976,100987,100992,100999,101001,101002,101003,101010,101016,101017,101019,101026,101036,101040,101046,101048,101050,101051,101052,101054,101055,101056,101064,101071,101075,101077,101080,101081,101083,101084,101085,101086,101088,101089,101090,101091,101093,101095,101096,101097,101098,101099,101100,101101,101102,101103,101104,101105,101106,101107,101108,101113,101114,101117,101118,101125,101127,101132,101136,101137,101141,101142,101143,101145,101148,101151,101154,101157,101158,101163,101166,101168,101169,101172,101173,101176,101179,101181,101183,101184,101186,101188,101189,101192,101195,101198,101199,101200,101202,101205,101206,101207,101208,101209,101210,101212,101218,101221,101224,101225,101228,101230,101235,101242,101244,101245,101250,101253,101255,101257,101258,101260,101261,101262,101263,101265,101266,101267,101269,101271,101273,101275,101289,101301,101303,101314,101318,101320,101321,101323,101324,101325,101326,101328,101329,101331,101332,101333,101334,101336,101337,101338,101349,101355,101361,101363,101365,101367,101369,101370,101371,101373,101374,101375,101376,101379,101388,101395,101405,101411,101412,101413,101414,101416,101418,101461,101481,101484,101498,101503,101543,101568,101572,101577,101596,101605,101617,101618,101658,101666,101676,101678,101679,101682,101700,101707,101731,101732,101734,101735,101740,101742,101746,101749,101766,101824,101825,101829,101866,101988,102202,102203,102205,102206,102207,102208,102211,102218,102220,102221,102223,102225,102226,102227,102230,102232,102233,102234,102235,102237,102238,102239,102240,102242,102243,102245,102246,102530,102535,102539,102540,102541,102542,102543,102544,102545,102554,103812,103813,103814,103819,103820,104103,105573,105574,109774,110267,110268,110269,110273,110280,110289,110295,110297,110301,110302,110303,110305,110306,110307,110913,110918,110919,110939,110944,113187,113190,113204,114715,114735,114736,114748,114765]},{\"Street\":\"первомайская.\",\"Weight\":0.923,\"CommonIDs\":[101619]},{\"Street\":\"рустамова\",\"Weight\":0.923,\"CommonIDs\":[28]},{\"Weight\":0.923,\"Metro\":\"первомайская\",\"CommonIDs\":[157,213]},{\"Street\":\"веры миляевой\",\"Weight\":0.923,\"CommonIDs\":[141]},{\"Street\":\"нижняя первомайская\",\"Weight\":0.923,\"CommonIDs\":[213]},{\"Street\":\"верхняя первомайская\",\"Weight\":0.923,\"CommonIDs\":[213]},{\"Street\":\"братьев щегол\",\"Weight\":0.923,\"CommonIDs\":[24509]}]},\"length\":\"2\",\"nongeoquery\":\"страховая компания\",\"weight\":\"0.923474\",\"type\":\"Street\",\"pos\":\"2\",\"addr\":\"на первомайской\"}]\t0\t0\t0\t4130\t3\t4170\tOK\tUNKNOWN_PRAGMATIC_FOUND\tOK";
        System.out.println(" = " + getResult(line));
    }
*/

    public static void main(String[] args) throws Exception {
        File nnulFile = new File(OUTPUT_NNUL_FILE_PATH);
        nnulFile.createNewFile();
        Writer nnul = IOUtils.newFileWriter(OUTPUT_NNUL_FILE_PATH, "utf-8");
        File nulFile = new File(OUTPUT_NUL_FILE_PATH);
        nulFile.createNewFile();
        Writer nul = IOUtils.newFileWriter(OUTPUT_NUL_FILE_PATH, "utf-8");

        Iterable<String> lines = IOUtils.readLines(INPUT_FILE_PATH);

        int i=0;
        for (String line : lines) {
            try {
                i++;

                Pair<String, Boolean> r = getResult(line);
                if (r == null) continue;

                boolean isFound = r.second;
                String result = r.first;

                if (isFound) {
                    nnul.append(result);
                }
                nul.append(result);
                if (i % 100000 == 0) {
                    log.info("processed: " + i);
                }
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
        nnul.flush();
        nnul.close();
        nul.flush();
        nul.close();
    }

    private static Pair<String, Boolean> getResult(String line) throws Exception {
        String[] array = StringUtils.splitByWholeSeparatorPreserveAllTokens(line, "\t");
        String ip = array[5];
        if (ip.equals("127.0.0.1")) {
            return null;
        }
        String unknownPragmatic = array.length >= 21 ? array[20] : "";
        String type = array[3];
        String userRequest = URLUtils.encode(array[11], "utf-8");
        String geoaddr = array[12];
        geoaddr = URLUtils.encode(base64.encodeToString(org.apache.commons.codec.binary.StringUtils.getBytesUtf8(geoaddr)), "utf-8");
        String lr = array[7];

        boolean isFound = !type.equals("NONE");
        String tag = isFound ? "not_null" : " null";

        String result = "/wizard?";
        result += "user_request=" + userRequest;
        result += "&geoaddr=" + geoaddr;
        result += "&region_id=" + lr;
        result += " " + tag;
        result += "\n";

        return Pair.of(result, isFound);
    }
}
